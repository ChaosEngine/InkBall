"use strict";function asyncGeneratorStep(t,e,i,n,s,r,o){try{var a=t[r](o),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,s)}function _asyncToGenerator(t){return function(){var e=this,i=arguments;return new Promise(function(n,s){var r=t.apply(e,i);function o(t){asyncGeneratorStep(r,n,s,o,a,"next",t)}function a(t){asyncGeneratorStep(r,n,s,o,a,"throw",t)}o(void 0)})}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7}),GameTypeEnum=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),WinStatusEnum=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3}),DtoMsg=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"GetKind",value:function(){throw new Error("missing GetKind implementation!")}}]),t}(),InkBallPointViewModel=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:StatusEnum.POINT_FREE,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).iId=i,t.iGameId=n,t.iPlayerId=s,t.iX=r,t.iY=o,t.Status=a,t.iEnclosingPathId=l,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.POINT}}],[{key:"Format",value:function(t,e){return t+" places ["+(e.iX+" "+e.iY+" "+e.Status)+"] point"}}]),e}(),InkBallPathViewModel=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).iId=i,t.iGameId=n,t.iPlayerId=s,t.PointsAsString=r,t.OwnedPointsAsString=o,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PATH}}],[{key:"Format",value:function(t,e){var i="".concat(e.iPlayerId,"  [").concat(e.PointsAsString,"] [").concat(e.OwnedPointsAsString,"]");return"".concat(t," places [").concat(i,"] path")}}]),e}(),PlayerJoiningCommand=function(t){function e(t,i,n){var s;return _classCallCheck(this,e),(s=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).OtherPlayerId=t,s.OtherPlayerName=i,s.Message=n,s}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PLAYER_JOINING}}],[{key:"Format",value:function(t){return t.Message}}]),e}(),PlayerSurrenderingCommand=function(t){function e(t,i,n){var s;return _classCallCheck(this,e),(s=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).OtherPlayerId=t,s.thisOrOtherPlayerSurrenders=i,s.Message=n,s}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PLAYER_SURRENDER}}],[{key:"Format",value:function(t){return t.Message}}]),e}(),PingCommand=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Message=i,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PING}}],[{key:"Format",value:function(t,e){return t+" says "+e.Message}}]),e}(),WinCommand=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:WinStatusEnum.NO_WIN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"null";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Status=i,t.WinningPlayerId=n,t.Message=s,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.WIN}}],[{key:"Format",value:function(t){var e="";switch(t.Status){case WinStatusEnum.RED_WINS:e="red.";break;case WinStatusEnum.GREEN_WINS:e="green.";break;case WinStatusEnum.NO_WIN:e="no one!";break;case WinStatusEnum.DRAW_WIN:e="draw!"}return"And the winner is... "+e}}]),e}(),PlayerPointsAndPathsDTO=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Points=i,t.Paths=n,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.POINTS_AND_PATHS}}],[{key:"Deserialize",value:function(t){var e='{ "Points": '+t.Points+', "Paths": '+t.Paths+" }";return JSON.parse(e)}}]),e}(),ApplicationUserSettings=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).DesktopNotifications=i,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.USER_SETTINGS}}],[{key:"Serialize",value:function(t){return JSON.stringify(t)}}]),e}();function CountPointsDebug(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"svg",i=document.getElementsByTagName(e),n=0,s=[],r=!0,o=!1,a=void 0;try{for(var l,u=i[Symbol.iterator]();!(r=(l=u.next()).done);r=!0){var h=l.value;n+=h.childElementCount,s.push(h.childElementCount)}}catch(t){o=!0,a=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw a}}var m="";["circle","polyline"].forEach(function(t){m+=t+": "+document.getElementsByTagName(t).length+" "}),document.querySelector(t).innerHTML="SVG: ".concat(n," by tag: ").concat(m)}function LocalLog(t){console.log(t)}function LocalError(t){console.error(t)}var InkBallGame=function(){function t(e,i,n,s,r,o,a){var l,u=this,h=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],m=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],_=arguments.length>9&&void 0!==arguments[9]?arguments[9]:{width:32,height:32},c=arguments.length>10&&void 0!==arguments[10]&&arguments[10],d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:125;(_classCallCheck(this,t),this.g_iGameID=null,this.g_iPlayerID=null,this.GameType=GameTypeEnum[a],this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.m_bIsWon=!1,this.m_bPointsAndPathsLoaded=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=d,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSizeX=0,this.m_iGridSizeY=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize=_,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_DrawMode=null,this.m_CancelPath=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=h,this.m_bIsPlayerActive=m,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=c,this.m_MouseCursorOval=null,null!==e&&""!==e)&&(this.g_SignalRConnection=(new signalR.HubConnectionBuilder).withUrl(e,{transport:s,accessTokenFactory:o}).withHubProtocol(n).configureLogging(i).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=r,this.g_SignalRConnection.onclose((l=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:null!=e&&(LocalError(e),u.m_Screen.style.cursor="not-allowed",u.iConnErrCount<5&&u.iConnErrCount++,setTimeout(function(){return u.Connect()},4e3+u.iExponentialBackOffMillis*u.iConnErrCount));case 1:case"end":return t.stop()}},t)})),function(t){return l.apply(this,arguments)})))}return _createClass(t,[{key:"GetPlayerPointsAndPaths",value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.m_bPointsAndPathsLoaded){t.next=5;break}return t.next=3,this.g_SignalRConnection.invoke("GetPlayerPointsAndPaths",this.m_bViewOnly,this.g_iGameID).then(function(t){LocalLog(t);var e=PlayerPointsAndPathsDTO.Deserialize(t);return void 0!==e.Points&&this.SetAllPoints(e.Points),void 0!==e.Paths&&this.SetAllPaths2(e.Paths),this.m_bPointsAndPathsLoaded=!0,!0}.bind(this));case 3:t.next=6;break;case 5:return t.abrupt("return",!1);case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"Connect",value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.g_SignalRConnection.start();case 3:if(this.iConnErrCount=0,LocalLog("connected; iConnErrCount = "+this.iConnErrCount),!1!==this.m_bViewOnly||null!==sessionStorage.getItem("ApplicationUserSettings")){t.next=10;break}return t.next=8,this.g_SignalRConnection.invoke("GetUserSettings").then(function(t){if(LocalLog(t),t){var e=ApplicationUserSettings.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",e)}return t}.bind(this)).then(_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.GetPlayerPointsAndPaths();case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},t,this)})).bind(this)).then(_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}},t)})));case 8:t.next=13;break;case 10:if(this.m_bPointsAndPathsLoaded){t.next=13;break}return t.next=13,this.GetPlayerPointsAndPaths();case 13:t.next=21;break;case 15:t.prev=15,t.t0=t.catch(0),LocalError(t.t0+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount<5&&this.iConnErrCount++,setTimeout(function(){return e.Connect()},4e3+this.iExponentialBackOffMillis*this.iConnErrCount);case 21:case"end":return t.stop()}},t,this,[[0,15]])}));return function(){return t.apply(this,arguments)}}()},{key:"StartSignalRConnection",value:function(t,e,i,n,s,r){null!==this.g_SignalRConnection&&(this.g_iGameID=t,this.g_iPlayerID=e,this.m_sMsgInputSel=r,this.m_sMsgSendButtonSel=s,this.m_bPointsAndPathsLoaded=!i,this.g_SignalRConnection.on("ServerToClientPoint",function(t){var e=this.m_Player2Name.innerHTML,i=InkBallPointViewModel.Format(e,t),s=document.createElement("li");s.textContent=i,document.querySelector(n).appendChild(s),this.ReceivedPointProcessing(t)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")){var e=t,i=this.m_Player2Name.innerHTML,s=InkBallPathViewModel.Format(i,e),r=document.createElement("li");r.textContent=s,document.querySelector(n).appendChild(r),this.ReceivedPathProcessing(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");var o=t,a=WinCommand.Format(o),l=document.createElement("li");l.textContent=a,document.querySelector(n).appendChild(l),this.ReceivedWinProcessing(o)}}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(t){var e=PlayerJoiningCommand.Format(t),i=document.createElement("li");i.textContent=e,document.querySelector(n).appendChild(i),null!==this.m_SurrenderButton&&""!==t.OtherPlayerName&&(this.m_Player2Name.innerHTML=t.OtherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),null!==this.m_DrawMode&&(this.m_DrawMode.disabled=""),null!==this.m_CancelPath&&(this.m_CancelPath.disabled=""),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(t){var e=PlayerSurrenderingCommand.Format(t),i=document.createElement("li");i.textContent=e,document.querySelector(n).appendChild(i),this.m_bHandlingEvent=!1,alert(""===e?"Game interrupted!":e),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(t){var e=WinCommand.Format(t),i=document.createElement("li");i.textContent=e,document.querySelector(n).appendChild(i),this.ReceivedWinProcessing(t)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(t){var e=this.m_Player2Name.innerHTML,i=PingCommand.Format(e,t),s=document.createElement("li");s.textContent=i,document.querySelector(n).appendChild(s)}.bind(this)),document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",function(t){t.preventDefault();var e=document.querySelector(this.m_sMsgInputSel).value.trim();if(""!==e){var i=new PingCommand(e);this.SendAsyncData(i)}}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1),this.Connect())}},{key:"StopSignalRConnection",value:function(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),LocalLog("Stopped SignalR connection"))}},{key:"Debug",value:function(){switch(arguments.length){case 1:this.m_Debug.innerHTML=arguments.length<=0?void 0:arguments[0];break;case 2:document.getElementById("debug"+(arguments.length<=1?void 0:arguments[1])).innerHTML=arguments.length<=0?void 0:arguments[0]}}},{key:"DisableSelection",value:function(t){void 0!==_typeof(t.onselectstart)?t.onselectstart=function(){return!1}:void 0!==_typeof(t.style.MozUserSelect)?t.style.MozUserSelect="none":t.onmousedown=function(){return!1}}},{key:"f_clientWidth",value:function(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}},{key:"f_clientHeight",value:function(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}},{key:"f_scrollLeft",value:function(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}},{key:"f_scrollTop",value:function(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}},{key:"f_filterResults",value:function(t,e,i){var n=t||0;return e&&(!n||n>e)&&(n=e),i&&(!n||n>i)?i:n}},{key:"SetPoint",value:function(t,e,i){var n,s=t*this.m_iGridSizeX,r=e*this.m_iGridSizeY,o=$createOval(this.m_PointRadius,"true");switch(o.$move(s,r,this.m_PointRadius),i){case StatusEnum.POINT_FREE_RED:n=this.COLOR_RED,o.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_FREE_BLUE:n=this.COLOR_BLUE,o.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_FREE:n=this.m_sDotColor,o.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_STARTING:n=this.m_sDotColor,o.$SetStatus(StatusEnum.POINT_STARTING);break;case StatusEnum.POINT_IN_PATH:n=this.m_sDotColor,o.$SetStatus(i);break;case StatusEnum.POINT_OWNED_BY_RED:n=this.COLOR_OWNED_RED,o.$SetStatus(i);break;case StatusEnum.POINT_OWNED_BY_BLUE:n=this.COLOR_OWNED_BLUE,o.$SetStatus(i);break;default:alert("bad point")}o.$SetFillColor(n),o.$strokeColor(n),this.m_Points[e*this.m_iGridWidth+t]=o}},{key:"SetAllPoints",value:function(t){var e=this;t.forEach(function(t){if(t[3]===e.g_iPlayerID);else switch(t[2]){case StatusEnum.POINT_FREE:case StatusEnum.POINT_FREE_RED:case StatusEnum.POINT_FREE_BLUE:case StatusEnum.POINT_STARTING:case StatusEnum.POINT_OWNED_BY_RED:case StatusEnum.POINT_OWNED_BY_BLUE:break;case StatusEnum.POINT_IN_PATH:!0===e.m_bIsPlayingWithRed?t[2]=StatusEnum.POINT_FREE_BLUE:t[2]=StatusEnum.POINT_FREE_RED}e.SetPoint(t[0],t[1],t[2])})}},{key:"SetPath",value:function(t,e,i){var n,s,r=t.split(" "),o="",a="",l=null,u=StatusEnum.POINT_STARTING,h=!0,m=!1,_=void 0;try{for(var c,d=r[Symbol.iterator]();!(h=(c=d.next()).done);h=!0){l=c.value.split(","),n=parseInt(l[0]),s=parseInt(l[1]),n*=this.m_iGridSizeX,s*=this.m_iGridSizeY,a+="".concat(o).concat(n,",").concat(s),o=" ",null!=(l=this.m_Points[s*this.m_iGridWidth+n])&&(l.$SetStatus(u),u=StatusEnum.POINT_IN_PATH)}}catch(t){m=!0,_=t}finally{try{h||null==d.return||d.return()}finally{if(m)throw _}}l=r[0].split(","),n=parseInt(l[0]),s=parseInt(l[1]),a=a+o+(n*=this.m_iGridSizeX)+","+(s*=this.m_iGridSizeY),null!=(l=this.m_Points[s*this.m_iGridWidth+n])&&l.$SetStatus(u);var S=$createPolyline(3,a,i?this.m_sDotColor:e?this.COLOR_BLUE:this.COLOR_RED);this.m_Lines[this.m_Lines.length]=S}},{key:"SetAllPaths",value:function(t){var e=this;t.forEach(function(t){e.SetPath(t[0],e.m_bIsPlayingWithRed,t[1]===e.g_iPlayerID)})}},{key:"SetAllPaths2",value:function(t){var e=this;t.forEach(function(t){if(LocalLog(t),t.iGameId!==e.g_iGameID)throw new Error("Bad game from path!");e.SetPath(t.PointsAsString,e.m_bIsPlayingWithRed,t.iPlayerId===e.g_iPlayerID)})}},{key:"IsPointBelongingToLine",value:function(t,e,i){var n=!0,s=!1,r=void 0;try{for(var o,a=t[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var l=o.value.split(","),u=l[0],h=l[1];if(u===e&&h===i)return!0}}catch(t){s=!0,r=t}finally{try{n||null==a.return||a.return()}finally{if(s)throw r}}return!1}},{key:"pnpoly",value:function(t,e,i,n,s){var r,o,a=!1;for(r=0,o=t-1;r<t;o=r++)(i[r]<=s&&s<i[o]||i[o]<=s&&s<i[r])&&n<(e[o]-e[r])*(s-i[r])/(i[o]-i[r])+e[r]&&(a=!a);return a}},{key:"pnpoly2",value:function(t,e,i){var n,s,r=t.length,o=!1;for(n=0,s=r-1;n<r;s=n++){var a=t[n],l=t[s];(a.y<=i&&i<l.y||l.y<=i&&i<a.y)&&e<(l.x-a.x)*(i-a.y)/(l.y-a.y)+a.x&&(o=!o)}return o}},{key:"SurroundOponentPoints",value:function(){var t=this.m_Line.$GetPointsArray(),e=new Set;if(t.slice(0,-1).some(function(t){return e.size===e.add(t.x+"_"+t.y).size})||t[0].x!==t[t.length-1].x||t[0].y!==t[t.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",revertFillColor:void 0,revertStatus:void 0,revertStrokeColor:void 0};var i,n,s="",r="",o=!0,a=!1,l=void 0;try{for(var u,h=t[Symbol.iterator]();!(o=(u=h.next()).done);o=!0){var m=u.value;i=m.x,n=m.y,null!==i&&null!==n&&(i/=this.m_iGridSizeX,n/=this.m_iGridSizeY,s+="".concat(r).concat(i,",").concat(n),r=" ")}}catch(t){a=!0,l=t}finally{try{o||null==h.return||h.return()}finally{if(a)throw l}}var _=this.m_sDotColor===this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,c=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,d=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,S="",P=[];r="";var v=!0,y=!1,E=void 0;try{for(var f,g=this.m_Points[Symbol.iterator]();!(v=(f=g.next()).done);v=!0){var C=f.value;if(void 0!==C&&C.$GetStatus()===StatusEnum.POINT_FREE&&C.$GetFillColor()===_){var O=C.$GetPosition();i=O.x,n=O.y,!1!==this.pnpoly2(t,i,n)&&(C.$SetStatus(c),C.$SetFillColor(d),C.$strokeColor(d),S=S+r+(i/=this.m_iGridSizeX)+","+(n/=this.m_iGridSizeY),P.push(C),r=" ")}}}catch(t){y=!0,E=t}finally{try{v||null==g.return||g.return()}finally{if(y)throw E}}return{OwnedPoints:P,owned:S,path:s,revertFillColor:_,revertStatus:StatusEnum.POINT_FREE,revertStrokeColor:this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED}}},{key:"IsPointOutsideAllPaths",value:function(t,e){var i=!0,n=!1,s=void 0;try{for(var r,o=this.m_Lines[Symbol.iterator]();!(i=(r=o.next()).done);i=!0){var a=r.value.$GetPointsArray();if(!1!==this.pnpoly2(a,t,e))return!1}}catch(t){n=!0,s=t}finally{try{i||null==o.return||o.return()}finally{if(n)throw s}}return!0}},{key:"CreateXMLWaitForPlayerRequest",value:function(){}},{key:"CreateXMLPutPointRequest",value:function(t,e){return new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,t,e,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0)}},{key:"CreateXMLPutPathRequest",value:function(t){return new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,t.path,t.owned)}},{key:"SendAsyncData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;switch(t.GetKind()){case CommandKindEnum.POINT:LocalLog(InkBallPointViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",t).then(function(t){this.ReceivedPointProcessing(t)}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==e&&e()}.bind(this));break;case CommandKindEnum.PATH:LocalLog(InkBallPathViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",t).then(function(t){if(Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")){var e=t;this.ReceivedWinProcessing(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"PointsAsString"))throw new Error("ClientToServerPath bad GetKind!");var i=t;this.ReceivedPathProcessing(i)}}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==e&&e()}.bind(this));break;case CommandKindEnum.PING:this.g_SignalRConnection.invoke("ClientToServerPing",t).then(function(){document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}.bind(this)).catch(function(t){LocalError(t.toString())});break;default:LocalError("unknown object")}}},{key:"ReceivedPointProcessing",value:function(t){var e=t.iX,i=t.iY,n=t.Status;this.SetPoint(e,i,n),this.g_iPlayerID!==t.iPlayerId?(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""):(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"),this.m_bHandlingEvent=!1}},{key:"ReceivedPathProcessing",value:function(t){if(this.g_iPlayerID!==t.iPlayerId){var e=t.PointsAsString,i=t.OwnedPointsAsString;this.SetPath(e,this.m_sDotColor===this.COLOR_RED,!1);var n=i.split(" "),s=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,r=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED,o=!0,a=!1,l=void 0;try{for(var u,h=n[Symbol.iterator]();!(o=(u=h.next()).done);o=!0){var m=u.value.split(","),_=parseInt(m[0]),c=parseInt(m[1]);void 0!==(m=this.m_Points[c*this.m_iGridWidth+_])&&(m.$SetStatus(s),m.$SetFillColor(r),m.$strokeColor(r))}}catch(t){a=!0,l=t}finally{try{o||null==h.return||h.return()}finally{if(a)throw l}}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""}else{var d=this.m_Line.$GetPointsString(),S=d[0],P=d[1];S/=this.m_iGridSizeX,P/=this.m_iGridSizeY;var v=this.m_Points[P*this.m_iGridWidth+S];void 0!==v&&v.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"}this.m_bHandlingEvent=!1}},{key:"ReceivedWinProcessing",value:function(t){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;var e=WinCommand.Format(t);((t.Status===WinStatusEnum.RED_WINS||t.Status===WinStatusEnum.GREEN_WINS)&&t.WinningPlayerId>0||t.Status===WinStatusEnum.DRAW_WIN)&&(alert(""===e?"Game won!":e),window.location.href="Games")}},{key:"Check4Win",value:function(t,e,i,n){var s,r=this;switch(this.GameType){case GameTypeEnum.FIRST_CAPTURE:return t.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:e.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_CAPTURES:return s=0,n.forEach(function(t){if(null!==t.iEnclosingPathId&&++s,s>=5)return r.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS}),s=0,i.forEach(function(t){if(null!==t.iEnclosingPathId&&++s,s>=5)return r.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}),WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_PATHS:return t.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:e.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_ADVANTAGE_PATHS:var o=e,a=t.length-o.length;return a>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:a<=-5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;default:throw new Error("Wrong game type")}}},{key:"ShowMobileStatus",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";"???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_GameStatus.style.color=this.COLOR_RED,null!==t&&""!==t?this.Debug(t,0):this.Debug("",0)}},{key:"OnMouseMove",value:function(t){var e=this;if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)this.iConnErrCount<=0&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait");else{var i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,n=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;i=parseInt(i/this.m_iGridSizeX),n=parseInt(n/this.m_iGridSizeY);var s=i*this.m_iGridSizeX,r=n*this.m_iGridSizeY;if(this.m_MouseCursorOval.$move(s,r,this.m_PointRadius),this.m_MouseCursorOval.$Show(),this.m_Screen.style.cursor="crosshair",this.Debug("[".concat(i,",").concat(n,"]"),1),this.m_bDrawLines&&!0===this.m_bMouseDown&&(this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){var o=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],a=this.m_Points[n*this.m_iGridWidth+i];if(void 0!==o&&void 0!==a&&a.$GetStatus()!==StatusEnum.POINT_IN_PATH&&o.$GetFillColor()===this.m_sDotColor&&a.$GetFillColor()===this.m_sDotColor){if(this.m_Line.$AppendPoints(s+","+r),a.$GetStatus()!==StatusEnum.POINT_STARTING)a.$SetStatus(StatusEnum.POINT_IN_PATH);else{var l=this.SurroundOponentPoints();l.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(l),function(){e.OnCancelClick(),l.OwnedPoints.forEach(function(t){t.$SetStatus(l.revertStatus),t.$SetFillColor(l.revertFillColor),t.$strokeColor(l.revertStrokeColor)}),e.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=i,this.m_iLastY=n}}else{var u=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],h=this.m_Points[n*this.m_iGridWidth+i];if(void 0!==u&&void 0!==h&&u.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$GetStatus()!==StatusEnum.POINT_IN_PATH&&u.$GetFillColor()===this.m_sDotColor&&h.$GetFillColor()===this.m_sDotColor){var m=this.m_iLastX*this.m_iGridSizeX,_=this.m_iLastY*this.m_iGridSizeY;this.m_Line=$createPolyline(3,m+","+_+" "+s+","+r,this.m_sDotColor),u.$GetStatus()!==StatusEnum.POINT_IN_PATH&&u.$SetStatus(StatusEnum.POINT_STARTING),h.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_iLastX=i,this.m_iLastY=n}}}}},{key:"OnMouseDown",value:function(t){var e=this;if(this.m_bIsPlayerActive&&"???"!==this.m_Player2Name.innerHTML&&!0!==this.m_bHandlingEvent&&!(this.iConnErrCount>0)){var i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,n=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;if(i=this.m_iMouseX=parseInt(i/this.m_iGridSizeX),n=this.m_iMouseY=parseInt(n/this.m_iGridSizeY),this.m_bMouseDown=!0,this.m_bDrawLines){if((this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){var s=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],r=this.m_Points[n*this.m_iGridWidth+i];if(void 0!==s&&void 0!==r&&r.$GetStatus()!==StatusEnum.POINT_IN_PATH&&s.$GetFillColor()===this.m_sDotColor&&r.$GetFillColor()===this.m_sDotColor){var o=i*this.m_iGridSizeX,a=n*this.m_iGridSizeY;if(this.m_Line.$AppendPoints(o+","+a),r.$GetStatus()!==StatusEnum.POINT_STARTING)r.$SetStatus(StatusEnum.POINT_IN_PATH);else{var l=this.SurroundOponentPoints();l.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(l),function(){e.OnCancelClick(),l.OwnedPoints.forEach(function(t){t.$SetStatus(l.revertStatus),t.$SetFillColor(l.revertFillColor),t.$strokeColor(l.revertStrokeColor)}),e.m_bMouseDown=!1,e.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=i,this.m_iLastY=n}}else{var u=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],h=this.m_Points[n*this.m_iGridWidth+i];if(void 0!==u&&void 0!==h&&u.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$GetStatus()!==StatusEnum.POINT_IN_PATH&&u.$GetFillColor()===this.m_sDotColor&&h.$GetFillColor()===this.m_sDotColor){var m=this.m_iLastX*this.m_iGridSizeX,_=this.m_iLastY*this.m_iGridSizeY,c=i*this.m_iGridSizeX,d=n*this.m_iGridSizeY;this.m_Line=$createPolyline(3,m+","+_+" "+c+","+d,this.m_sDotColor),u.$GetStatus()!==StatusEnum.POINT_IN_PATH&&u.$SetStatus(StatusEnum.POINT_STARTING),h.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$SetStatus(StatusEnum.POINT_IN_PATH)}this.m_iLastX=i,this.m_iLastY=n}else if(this.m_iLastX<0||this.m_iLastY<0){var S=this.m_Points[n*this.m_iGridWidth+i];void 0!==S&&S.$GetStatus()===StatusEnum.POINT_FREE&&S.$GetFillColor()===this.m_sDotColor&&(this.m_iLastX=i,this.m_iLastY=n)}}else{this.m_iLastX=i,this.m_iLastY=n;var P=i,v=n;if(i=P*this.m_iGridSizeX,n=v*this.m_iGridSizeY,void 0!==this.m_Points[v*this.m_iGridWidth+P])return;if(!this.IsPointOutsideAllPaths(P,v))return;this.SendAsyncData(this.CreateXMLPutPointRequest(P,v),function(){e.m_bMouseDown=!1,e.m_bHandlingEvent=!1})}}}},{key:"OnMouseUp",value:function(){this.m_bMouseDown=!1}},{key:"OnMouseLeave",value:function(){this.m_MouseCursorOval.$Hide()}},{key:"OnDrawModeClick",value:function(t){this.m_bDrawLines=!this.m_bDrawLines;var e=t.target;this.m_bDrawLines?e.value="Draw dots":e.value="Draw lines",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}},{key:"OnCancelClick",value:function(){if(this.m_bDrawLines){if(null!==this.m_Line){var t=this.m_Line.$GetPointsArray(),e=!0,i=!1,n=void 0;try{for(var s,r=t[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){var o=s.value,a=o.x,l=o.y;if(null!==a&&null!==l){a/=this.m_iGridSizeX,l/=this.m_iGridSizeY;var u=this.m_Points[l*this.m_iGridWidth+a];void 0!==u&&u.$SetStatus(StatusEnum.POINT_FREE)}}}catch(t){i=!0,n=t}finally{try{e||null==r.return||r.return()}finally{if(i)throw n}}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1}}},{key:"OnTestClick",value:function(){LocalLog(this.m_Points.flat())}},{key:"PrepareDrawing",value:function(t,e,i,n,s,r,o){var a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:125;if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=a,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Debug=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(e),this.m_GameStatus=document.querySelector(i),this.m_SurrenderButton=document.querySelector(n),this.m_CancelPath=document.querySelector(r),this.m_DrawMode=document.querySelector(s),this.m_Screen=document.querySelector(t),this.m_Screen){this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop,this.m_Screen.style.width="calc(1em * ".concat(this.m_BoardSize.width,")"),this.m_Screen.style.height="calc(1em * ".concat(this.m_BoardSize.height,")");var l=this.m_Screen.clientWidth,u=this.m_Screen.clientHeight;this.m_iGridSizeX=parseInt(Math.ceil(l/this.m_BoardSize.width)),this.m_iGridSizeY=parseInt(Math.ceil(u/this.m_BoardSize.height)),this.m_iGridWidth=parseInt(Math.ceil(l/this.m_iGridSizeX)),this.m_iGridHeight=parseInt(Math.ceil(u/this.m_iGridSizeY)),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),this.m_bViewOnly?document.querySelector(o).innerHTML="back to Game List":(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$strokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1),this.m_MouseCursorOval.$Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_DrawMode.onclick=this.OnDrawModeClick.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),document.querySelector("#Test").onclick=this.OnTestClick.bind(this),document.querySelector(this.m_sMsgInputSel).disabled="",this.m_SurrenderButton.disabled="","???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled")))}else alert("no board")}}]),t}();