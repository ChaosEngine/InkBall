"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var StatusEnum=Object.freeze({POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLU:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDE:4}),InkBallPointViewModel=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,f=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,g=5<arguments.length&&void 0!==arguments[5]?arguments[5]:StatusEnum.POINT_FREE,h=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;_classCallCheck(this,a),this.iId=b,this.iGameId=c,this.iPlayerId=d,this.iX=e,this.iY=f,this.Status=g,this.iEnclosingPathId=h}return _createClass(a,null,[{key:"Format",value:function d(a,b){var c=b.iX+" "+b.iY+" "+b.Status;return a+" places "+c+" point"}}]),a}(),PingCommand=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck(this,a),this.Message=b}return _createClass(a,[{key:"Message",get:function a(){return this.sMessage},set:function b(a){this.sMessage=a}}]),_createClass(a,null,[{key:"Format",value:function d(a,b){var c=b.Message;return a+" says "+c}}]),a}();function htmlEncode(a){return document.createElement("a").appendChild(document.createTextNode(a)).parentNode.innerHTML}var InkBallGame=function(){function a(b,c,d,e,f){var g=!(5<arguments.length&&void 0!==arguments[5])||arguments[5],h=!(6<arguments.length&&void 0!==arguments[6])||arguments[6],i=7<arguments.length&&void 0!==arguments[7]?arguments[7]:125,j=!(8<arguments.length&&void 0!==arguments[8])||arguments[8],k=!!(9<arguments.length&&void 0!==arguments[9])&&arguments[9];_classCallCheck(this,a),self=this,this.g_iGameID=null,this.g_iPlayerID=null,this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.POINT_FREE_RED=-3,this.POINT_FREE_BLUE=-2,this.POINT_FREE=-1,this.POINT_STARTING=0,this.POINT_IN_PATH=1,this.POINT_OWNED_BY_RED=2,this.POINT_OWNED_BY_BLUE=3,this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=i,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSize=15,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_iScrollX=0,this.m_iScrollY=0,this.m_iClientWidth=0,this.m_iClientHeight=0,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_bMouseDown=!1,this.m_bDrawLines=!1,this.m_bIsMobile=j,this.m_sMessage="",this.m_bIsPlayingWithRed=g,this.m_bIsPlayerActive=h,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=k,null===b||""===b||(this.g_SignalRConnection=new signalR.HubConnectionBuilder().withUrl(b,{transport:e,accessTokenFactory:f}).withHubProtocol(d).configureLogging(c).build(),this.g_SignalRConnection.onclose(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(null===b){a.next=6;break}console.log(b),5>self.iConnErrCount&&self.iConnErrCount++,setTimeout(function(){return self.start()},4e3+self.iExponentialBackOffMillis*self.iConnErrCount),a.next=8;break;case 6:return a.next=8,self.start();case 8:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()))}var b=Math.abs;return _createClass(a,[{key:"start",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,self.g_SignalRConnection.start();case 3:self.iConnErrCount=0,console.log("connected; iConnErrCount = "+self.iConnErrCount),a.next=12;break;case 7:a.prev=7,a.t0=a["catch"](0),console.log(a.t0+"; iConnErrCount = "+self.iConnErrCount),5>self.iConnErrCount&&self.iConnErrCount++,setTimeout(function(){return self.start()},4e3+self.iExponentialBackOffMillis*self.iConnErrCount);case 12:case"end":return a.stop();}},a,this,[[0,7]])}));return function b(){return a.apply(this,arguments)}}()},{key:"StartSignalRConnection",value:function f(a,b,c,d,e){null===self.g_SignalRConnection||(self.g_iGameID=a,self.g_iPlayerID=b,self.g_SignalRConnection.on("ServerToClientPoint",function(a,b){var d=null;d=InkBallPointViewModel.Format(b,a);var e=document.createElement("li");e.textContent=d,document.getElementById(c).appendChild(e)}),self.g_SignalRConnection.on("ServerToClientPing",function(a,b){var d=null;d=PingCommand.Format(b,a);var e=document.createElement("li");e.textContent=d,document.getElementById(c).appendChild(e)}),document.getElementById(d).addEventListener("click",function(a){var b=document.getElementById(e).value,c=new PingCommand(b);self.g_SignalRConnection.invoke("ClientToServerPing",c).catch(function(a){return console.error(a.toString())}),a.preventDefault()}),document.getElementById(e).addEventListener("keyup",function(a){a.preventDefault(),13===a.keyCode&&document.getElementById(d).click()}),self.start())}},{key:"Debug",value:function b(){switch(self.Debug.arguments.length){case 1:self.m_Debug.innerHTML=self.Debug.arguments[0];break;case 2:var a=document.getElementById("debug"+self.Debug.arguments[1]);a.innerHTML=self.Debug.arguments[0];break;default:}}},{key:"SetTimer",value:function c(a){if(!1==a)!0==self.m_bIsTimerRunning&&clearInterval(self.m_iTimerID),self.m_bIsTimerRunning=!1;else{!0==self.m_bIsTimerRunning?clearInterval(self.m_iTimerID):self.m_WaitStartTime=new Date;var b=self.m_iTimerInterval*(1+.5*self.m_iSlowdownLevel);self.m_iTimerID=setInterval(self.GameLoop,b),self.m_bIsTimerRunning=!0}}},{key:"DisableSelection",value:function b(a){"undefined"==typeof a.onselectstart?"undefined"==typeof a.style.MozUserSelect?a.onmousedown=function(){return!1}:a.style.MozUserSelect="none":a.onselectstart=function(){return!1},a.style.cursor="default"}},{key:"f_clientWidth",value:function a(){return self.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}},{key:"f_clientHeight",value:function a(){return self.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}},{key:"f_scrollLeft",value:function a(){return self.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}},{key:"f_scrollTop",value:function a(){return self.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}},{key:"f_filterResults",value:function e(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}},{key:"SetPoint",value:function i(a,b,c){var d=a*self.m_iGridSize,e=b*self.m_iGridSize,f=4,g=$createOval(f,"true");g.$move(d,e,f);var h;c===self.POINT_FREE_RED?(h=self.COLOR_RED,g.$SetStatus(self.POINT_FREE)):c===self.POINT_FREE_BLUE?(h=self.COLOR_BLUE,g.$SetStatus(self.POINT_FREE)):c===self.POINT_FREE?(h=self.m_sDotColor,g.$SetStatus(self.POINT_FREE)):c===self.POINT_STARTING?(h=self.m_sDotColor,g.$SetStatus(self.POINT_IN_PATH)):c===self.POINT_IN_PATH?(h=self.m_sDotColor,g.$SetStatus(c)):c===self.POINT_OWNED_BY_RED?(h=self.COLOR_OWNED_RED,g.$SetStatus(c)):c===self.POINT_OWNED_BY_BLUE?(h=self.COLOR_OWNED_BLUE,g.$SetStatus(c)):alert("bad point"),g.$SetFillColor(h),g.$strokeColor(h),self.m_Points[b*self.m_iGridWidth+a]=g}},{key:"SetPath",value:function k(a,b,c){a=a.split(" ");for(var d=a.length,e="",f=null,g="",h=0;h<d;++h)f=a[h].split(","),x=parseInt(f[0]),y=parseInt(f[1]),x*=self.m_iGridSize,y*=self.m_iGridSize,g=g+e+x+","+y,e=" ",f=self.m_Points[y*self.m_iGridWidth+x],null!=f&&f.$SetStatus(self.POINT_IN_PATH);f=a[0].split(","),x=parseInt(f[0]),y=parseInt(f[1]),x*=self.m_iGridSize,y*=self.m_iGridSize,g=g+e+x+","+y,f=self.m_Points[y*self.m_iGridWidth+x],null!=f&&f.$SetStatus(self.POINT_IN_PATH);var j=$createPolyline(3,g,c?self.m_sDotColor:b?self.COLOR_BLUE:self.COLOR_RED);self.m_Lines[self.m_Lines.length]=j}},{key:"IsPointBelongingToLine",value:function j(a,b,c){for(var d,e,f,g=a.length,h=0;h<g;++h)if(f=a[h].split(","),d=f[0],e=f[1],d==b&&e==c)return!0;return!1}},{key:"pnpoly",value:function l(a,b,d,e,f){var g,h,k=0;for(g=0,h=a-1;g<a;h=g++)(d[g]<=f&&f<d[h]||d[h]<=f&&f<d[g])&&e<(b[h]-b[g])*(f-d[g])/(d[h]-d[g])+b[g]&&(k=!k);return k}},{key:"SurroundOponentPoints",value:function t(){var a,b=self.m_Line.$GetPoints();a=b.length;for(var c,d,e=[],f=[],g="",h="",j=0,l=0;l<a;l+=2)c=b[l],d=b[l+1],null==c||null==d||(c/=self.m_iGridSize,d/=self.m_iGridSize,e[j]=c,f[j]=d,g=g+h+c+","+d,h=" ",++j);if(e[0]!=e[e.length-1]||f[0]!=f[f.length-1])return{owned:"",path:""};var m=self.m_Points.length,n=self.m_sDotColor==self.COLOR_RED?self.COLOR_BLUE:self.COLOR_RED,o=self.m_sDotColor==self.COLOR_RED?self.POINT_OWNED_BY_RED:self.POINT_OWNED_BY_BLUE,p=self.m_sDotColor==self.COLOR_RED?self.COLOR_OWNED_RED:self.COLOR_OWNED_BLUE,q="";h="";for(var r,l=0;l<m;++l)if(r=self.m_Points[l],null!=r&&r.$GetStatus()==self.POINT_FREE&&r.$GetFillColor()==n){var s=r.$GetPosition();c=s.x,d=s.y,c/=self.m_iGridSize,d/=self.m_iGridSize,0!=self.pnpoly(a,e,f,c,d)&&(r.$SetStatus(o),r.$SetFillColor(p),r.$strokeColor(p),q=q+h+c+","+d,h=" ")}return{owned:q,path:g}}},{key:"IsPointOutsideAllPaths",value:function p(a,b){for(var c=self.m_Lines.length,d=0;d<c;++d){var e,f=self.m_Lines[d].$GetPoints();e=f.length;for(var g,h,l=[],m=[],n=0,o=0;o<e;o+=2)g=f[o],h=f[o+1],null==g||null==h||(g/=self.m_iGridSize,h/=self.m_iGridSize,l[n]=g,m[n]=h,++n);if(0!=self.pnpoly(e,l,m,a,b))return!1}return!0}},{key:"CreateXMLWaitForPlayerRequest",value:function b(){var a="<WaitForPlayer>"+(0<self.CreateXMLWaitForPlayerRequest.arguments.length&&!0==self.CreateXMLWaitForPlayerRequest.arguments[0]?"<ShowP2Name />":"")+"</WaitForPlayer>";return a}},{key:"CreateXMLPutPointRequest",value:function c(a,b){return"<PutPoint><Point x='"+a+"' y='"+b+"' /></PutPoint>"}},{key:"CreateXMLPutPathRequest",value:function c(a,b){return"<PutPath><Path>"+a+"</Path><Owned>"+b+"</Owned></PutPath>"}},{key:"SendAsyncData",value:function b(a){0==a.length}},{key:"AjaxResponseCallBack",value:function w(){if(null!=g_XmlHttp&&(4==g_XmlHttp.readyState||"complete"==g_XmlHttp.readyState)&&200==g_XmlHttp.status){var a=g_XmlHttp.responseXML,b=a.firstChild;1!=b.nodeType&&(b=b.nextSibling);var c=b.nodeName;switch(c){case"WaitForPlayer":var d=0<b.getElementsByTagName("P2Name").length?b.getElementsByTagName("P2Name")[0].firstChild.data:"",e="true"==b.getElementsByTagName("Active")[0].firstChild.data;if(e){""!=d&&(self.m_Player2Name.innerHTML=d,self.m_SurrenderButton.value="surrender"),"win"==self.m_SurrenderButton.value&&(self.m_SurrenderButton.value="surrender");var f=b.getElementsByTagName("LastMove")[0];switch(f=f.firstChild,f.nodeName){case"Point":var g=parseInt(f.getAttribute("x")),h=parseInt(f.getAttribute("y")),j=parseInt(f.getAttribute("status"));self.SetPoint(g,h,j),self.m_bIsPlayerActive=!0,self.SetTimer(!1),self.m_bIsMobile?self.ShowMobileStatus():self.Debug("Oponent has moved, your turn");break;case"Path":var k=f.firstChild.data,l=b.getElementsByTagName("Owned")[0].firstChild.data;self.SetPath(k,self.m_sDotColor==self.COLOR_RED,!1);for(var m=l.split(" "),n=m.length,o=null,q=self.m_sDotColor==self.COLOR_RED?self.POINT_OWNED_BY_RED:self.POINT_OWNED_BY_BLUE,r=self.m_sDotColor==self.COLOR_RED?self.COLOR_OWNED_BLUE:self.COLOR_OWNED_RED,s=0;s<n;++s)o=m[s].split(","),g=parseInt(o[0]),h=parseInt(o[1]),o=self.m_Points[h*self.m_iGridWidth+g],null!=o&&(o.$SetStatus(q),o.$SetFillColor(r),o.$strokeColor(r));self.m_bIsPlayerActive=!0,self.SetTimer(!1),self.m_bIsMobile?self.ShowMobileStatus():self.Debug("Oponent has moved, your turn");break;default:}}else self.m_sMessage="Waiting for oponent move",""!=d&&(self.m_Player2Name.innerHTML=d,self.m_SurrenderButton.value="surrender",self.m_bIsMobile&&self.ShowMobileStatus());break;case"PutPoint":self.m_bIsPlayerActive=!1,self.m_iSlowdownLevel=0,self.SetTimer(!0);break;case"PutPath":var t=self.m_Line.$GetPoints(),g=t[s],h=t[s+1];g/=self.m_iGridSize,h/=self.m_iGridSize;var u=self.m_Points[h*self.m_iGridWidth+g];null!=u&&u.$SetStatus(self.POINT_IN_PATH),self.m_Lines[self.m_Lines.length]=self.m_Line,self.m_iLastX=self.m_iLastY=-1,self.m_Line=null,self.m_bIsPlayerActive=!1,self.m_iSlowdownLevel=0,self.SetTimer(!0);break;case"InterruptGame":self.SetTimer(!1);var v=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"";""==v?alert("Game interrupted!"):alert(v),window.location.href="games.php"+(self.m_bIsMobile?"?IsMobile=true":"");break;case"WaitingForSecondPlayer":self.m_sMessage="Waiting for other player to connect";break;case"Err":var v=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"unknown error";alert(v),self.OnCancelClick();break;default:}}}},{key:"GameLoop",value:function c(){var a="???"==self.m_Player2Name.innerHTML;self.SendAsyncData(self.CreateXMLWaitForPlayerRequest(a));var b=parseInt((new Date-self.m_WaitStartTime)/1e3);if(0>=self.m_iSlowdownLevel&&b>=.25*self.m_iTooLong2Duration)self.m_iSlowdownLevel=1,self.SetTimer(!0);else if(1>=self.m_iSlowdownLevel&&b>=.5*self.m_iTooLong2Duration)self.m_iSlowdownLevel=2,self.SetTimer(!0);else if(2>=self.m_iSlowdownLevel&&b>=.75*self.m_iTooLong2Duration)self.m_iSlowdownLevel=4,self.SetTimer(!0);else if(b>=self.m_iTooLong2Duration)if(!a)self.SetTimer(!1),self.m_SurrenderButton.value="win",alert("Second player is not responding for quiet long. To walkover win click win - or continue to wait for oponent move"),self.SetTimer(!0);else if(self.SetTimer(!1),!0==confirm("Second player is still not connecting. Continue waiting?"))self.SetTimer(!0);else return void(window.location.href="Games");self.m_bIsMobile?self.ShowMobileStatus(b):""!=self.m_sMessage&&self.Debug(self.m_sMessage+"("+b+")")}},{key:"ShowMobileStatus",value:function c(a){var b=document.getElementById("GameStatus");"???"==self.m_Player2Name.innerHTML?-1==b.style.backgroundImage.indexOf("pjonbgcurrent.gif")?b.style.backgroundImage="url(img/pjonbgcurrent.gif)":b.style.backgroundImage="url(img/pjonbgcurrent2.gif)":self.m_bIsPlayerActive?(b.style.backgroundImage=self.m_bIsPlayingWithRed?"url(img/pjonbgcurrent.gif)":"url(img/pjonbgcurrent2.gif)",self.Debug("",0)):(b.style.backgroundImage=self.m_bIsPlayingWithRed?"url(img/pjonbgcurrent2.gif)":"url(img/pjonbgcurrent.gif)","undefined"!=a&&null!=a&&self.Debug(a))}},{key:"OnMouseMove",value:function l(a){if(self.m_bIsPlayerActive){var c=(a?a.clientX:window.event.clientX)-self.m_iPosX+self.m_iScrollX+.5*self.m_iGridSize,d=(a?a.clientY:window.event.clientY)-self.m_iPosY+self.m_iScrollY+.5*self.m_iGridSize;if(c=parseInt(c/self.m_iGridSize),d=parseInt(d/self.m_iGridSize),self.m_bDrawLines&&!0==self.m_bMouseDown&&(self.m_iLastX!=c||self.m_iLastY!=d)&&1>=b(parseInt(self.m_iLastX-c))&&1>=b(parseInt(self.m_iLastY-d))&&0<=self.m_iLastX&&0<=self.m_iLastY)if(null!=self.m_Line){var e=self.m_Points[self.m_iLastY*self.m_iGridWidth+self.m_iLastX],f=self.m_Points[d*self.m_iGridWidth+c];if(null!=e&&null!=f&&f.$GetStatus()!=self.POINT_IN_PATH&&e.$GetFillColor()==self.m_sDotColor&&f.$GetFillColor()==self.m_sDotColor){var g=c*self.m_iGridSize,h=d*self.m_iGridSize;if(self.m_Line.$AppendPoints(g+","+h),f.$GetStatus()!=self.POINT_STARTING)f.$SetStatus(self.POINT_IN_PATH);else{var i=self.SurroundOponentPoints();0<i.owned.length?(self.m_Line.$SetIsClosed(!0),self.Debug("Closing path",0),self.SendAsyncData(self.CreateXMLPutPathRequest(i.path,i.owned))):self.Debug("Wrong path, cancell it or refresh page",0)}self.m_iLastX=c,self.m_iLastY=d}}else{var e=self.m_Points[self.m_iLastY*self.m_iGridWidth+self.m_iLastX],f=self.m_Points[d*self.m_iGridWidth+c];if(null!=e&&null!=f&&e.$GetStatus()!=self.POINT_IN_PATH&&f.$GetStatus()!=self.POINT_IN_PATH&&e.$GetFillColor()==self.m_sDotColor&&f.$GetFillColor()==self.m_sDotColor){var j=self.m_iLastX*self.m_iGridSize,k=self.m_iLastY*self.m_iGridSize,g=c*self.m_iGridSize,h=d*self.m_iGridSize;self.m_Line=$createPolyline(3,j+","+k+" "+g+","+h,self.m_sDotColor),e.$GetStatus()!=self.POINT_IN_PATH&&e.$SetStatus(self.POINT_STARTING),f.$GetStatus()!=self.POINT_IN_PATH&&f.$SetStatus(self.POINT_STARTING),self.m_iLastX=c,self.m_iLastY=d}}}}},{key:"OnMouseDown",value:function o(a){if(self.m_bIsPlayerActive){var c=(a?a.clientX:window.event.clientX)-self.m_iPosX+self.m_iScrollX+.5*self.m_iGridSize,d=(a?a.clientY:window.event.clientY)-self.m_iPosY+self.m_iScrollY+.5*self.m_iGridSize;if(c=self.m_iMouseX=parseInt(c/self.m_iGridSize),d=self.m_iMouseY=parseInt(d/self.m_iGridSize),self.m_bMouseDown=!0,!self.m_bDrawLines){self.m_iLastX=c,self.m_iLastY=d;var e=c,f=d;if(c=e*self.m_iGridSize,d=f*self.m_iGridSize,null!=self.m_Points[f*self.m_iGridWidth+e])return;if(!self.IsPointOutsideAllPaths(e,f))return;var g=$createOval(4,"true");g.$SetFillColor(self.m_sDotColor),g.$strokeColor(self.m_sDotColor),g.$move(c,d,4),self.m_Points[f*self.m_iGridWidth+e]=g,self.SendAsyncData(self.CreateXMLPutPointRequest(e,f))}else if((self.m_iLastX!=c||self.m_iLastY!=d)&&1>=b(parseInt(self.m_iLastX-c))&&1>=b(parseInt(self.m_iLastY-d))&&0<=self.m_iLastX&&0<=self.m_iLastY){if(null!=self.m_Line){var h=self.m_Points[self.m_iLastY*self.m_iGridWidth+self.m_iLastX],i=self.m_Points[d*self.m_iGridWidth+c];if(null!=h&&null!=i&&i.$GetStatus()!=self.POINT_IN_PATH&&h.$GetFillColor()==self.m_sDotColor&&i.$GetFillColor()==self.m_sDotColor){var j=c*self.m_iGridSize,k=d*self.m_iGridSize;if(self.m_Line.$AppendPoints(j+","+k),i.$GetStatus()!=self.POINT_STARTING)i.$SetStatus(self.POINT_IN_PATH);else{var l=self.SurroundOponentPoints();0<l.owned.length?(self.m_Line.$SetIsClosed(!0),self.Debug("Closing path",0),self.SendAsyncData(self.CreateXMLPutPathRequest(l.path,l.owned))):self.Debug("Wrong path, cancell it or refresh page",0)}self.m_iLastX=c,self.m_iLastY=d}}else{var h=self.m_Points[self.m_iLastY*self.m_iGridWidth+self.m_iLastX],i=self.m_Points[d*self.m_iGridWidth+c];if(null!=h&&null!=i&&h.$GetStatus()!=self.POINT_IN_PATH&&i.$GetStatus()!=self.POINT_IN_PATH&&h.$GetFillColor()==self.m_sDotColor&&i.$GetFillColor()==self.m_sDotColor){var m=self.m_iLastX*self.m_iGridSize,n=self.m_iLastY*self.m_iGridSize,j=c*self.m_iGridSize,k=d*self.m_iGridSize;self.m_Line=$createPolyline(3,m+","+n+" "+j+","+k,self.m_sDotColor),h.$GetStatus()!=self.POINT_IN_PATH&&h.$SetStatus(self.POINT_STARTING),i.$GetStatus()!=self.POINT_IN_PATH&&i.$SetStatus(self.POINT_STARTING)}self.m_iLastX=c,self.m_iLastY=d}}else if(0>self.m_iLastX||0>self.m_iLastY){var i=self.m_Points[d*self.m_iGridWidth+c];null!=i&&i.$GetStatus()==self.POINT_FREE&&i.$GetFillColor()==self.m_sDotColor&&(self.m_iLastX=c,self.m_iLastY=d)}}}},{key:"OnMouseUp",value:function a(){self.m_bMouseDown=!1}},{key:"OnScroll",value:function a(){self.m_iScrollX=self.f_scrollLeft(),self.m_iScrollY=self.f_scrollTop()}},{key:"OnDrawModeClick",value:function b(){self.m_bDrawLines=!self.m_bDrawLines;var a=document.getElementById("DrawMode");a.value=self.m_bDrawLines?"Draw dots":"Draw lines",self.m_iLastX=self.m_iLastY=-1,self.m_Line=null}},{key:"OnCancelClick",value:function f(){if(self.m_bDrawLines){if(null!=self.m_Line){for(var a=self.m_Line.$GetPoints(),b=0;b<a.length;b+=2){var c=a[b],d=a[b+1];if(null!=c&&null!=d){c/=self.m_iGridSize,d/=self.m_iGridSize;var e=self.m_Points[d*self.m_iGridWidth+c];null!=e&&e.$SetStatus(self.POINT_FREE)}}$RemovePolyline(self.m_Line),self.m_Line=null}self.m_iLastX=self.m_iLastY=-1}}},{key:"OnTestClick",value:function d(){if(!self.m_bDrawLines){var a=self.m_Points[self.m_iLastY*self.m_iGridWidth+self.m_iLastX],b=a.$GetPosition();self.Debug(a.$GetFillColor()+" posX = "+b.x+" posY = "+b.y,1)}else if(null!=self.m_Line){var c=self.SurroundOponentPoints();0<c.owned.length&&(self.m_iLastX=self.m_iLastY=-1,self.m_Line=null)}}},{key:"PrepareDrawing",value:function i(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:15,c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],d=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:125,f=!(5<arguments.length&&void 0!==arguments[5])||arguments[5],g=!!(6<arguments.length&&void 0!==arguments[6])&&arguments[6];self.COLOR_RED="red",self.COLOR_BLUE="blue",self.COLOR_OWNED_RED="pink",self.COLOR_OWNED_BLUE="#8A2BE2",self.POINT_FREE_RED=-3,self.POINT_FREE_BLUE=-2,self.POINT_FREE=-1,self.POINT_STARTING=0,self.POINT_IN_PATH=1,self.POINT_OWNED_BY_RED=2,self.POINT_OWNED_BY_BLUE=3,self.m_bIsWon=!1,self.m_iDelayBetweenMultiCaptures=4e3,self.m_iTimerInterval=2e3,self.m_iTooLong2Duration=e,self.m_iTimerID=null,self.m_bIsTimerRunning=!1,self.m_WaitStartTime=null,self.m_iSlowdownLevel=0,self.m_iGridSize=b,self.m_iGridWidth=0,self.m_iGridHeight=0,self.m_iLastX=-1,self.m_iLastY=-1,self.m_iMouseX=0,self.m_iMouseY=0,self.m_iPosX=0,self.m_iPosY=0,self.m_iScrollX=0,self.m_iScrollY=0,self.m_iClientWidth=0,self.m_iClientHeight=0,self.m_Debug=null,self.m_Player2Name=null,self.m_SurrenderButton=null,self.m_bMouseDown=!1,self.m_bDrawLines=!1,self.m_bIsMobile=f,self.m_sMessage="",self.m_bIsPlayingWithRed=c,self.m_bIsPlayerActive=d,self.m_sDotColor=self.m_bIsPlayingWithRed?self.COLOR_RED:self.COLOR_BLUE,self.m_Line=null,self.m_Lines=[],self.m_Points=[],self.m_Debug=document.getElementById("debug0"),self.m_Player2Name=document.getElementById("Player2Name"),self.m_SurrenderButton=document.getElementById("SurrenderButton");var h=document.getElementById(a);if(!h)return void alert("no board");if(self.m_iPosX=h.offsetLeft,self.m_iPosY=h.offsetTop,self.m_iClientWidth=h.clientWidth,self.m_iClientHeight=h.clientHeight,self.m_iGridWidth=parseInt(self.m_iClientWidth/self.m_iGridSize),self.m_iGridHeight=parseInt(self.m_iClientHeight/self.m_iGridSize),self.m_iScrollX=self.f_scrollLeft(),self.m_iScrollY=self.f_scrollTop(),cont=$createSVGVML(h,h.style.width,h.style.height,!1),self.DisableSelection(h),!self.m_bViewOnly){h.onmousedown=self.OnMouseDown,h.onmousemove=self.OnMouseMove,h.onmouseup=self.OnMouseUp,window.onscroll=self.OnScroll;var j=document.getElementById("DrawMode");j.onclick=self.OnDrawModeClick,j=document.getElementById("Cancel"),j.onclick=self.OnCancelClick}}}]),a}();