"use strict";const StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5}),GameTypeEnum=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),WinStatusEnum=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class DtoMsg{GetKind(){throw new Error("missing GetKind implementation!")}}class InkBallPointViewModel extends DtoMsg{constructor(a=0,b=0,c=0,d=0,e=0,f=StatusEnum.POINT_FREE,g=0){super(),this.iId=a,this.iGameId=b,this.iPlayerId=c,this.iX=d,this.iY=e,this.Status=f,this.iEnclosingPathId=g}GetKind(){return CommandKindEnum.POINT}static Format(a,b){let c=b.iX+" "+b.iY+" "+b.Status;return a+" places ["+c+"] point"}}class InkBallPathViewModel extends DtoMsg{constructor(a=0,b=0,c=0,d="",e=""){super(),this.iId=a,this.iGameId=b,this.iPlayerId=c,this.PointsAsString=d,this.OwnedPointsAsString=e}GetKind(){return CommandKindEnum.PATH}static Format(a,b){let c=`${b.iPlayerId}  [${b.PointsAsString}] [${b.OwnedPointsAsString}]`;return`${a} places [${c}] path`}}class PlayerJoiningCommand extends DtoMsg{constructor(a,b,c){super(),this.OtherPlayerId=a,this.OtherPlayerName=b,this.Message=c}GetKind(){return CommandKindEnum.PLAYER_JOINING}static Format(a){return a.Message}}class PlayerSurrenderingCommand extends DtoMsg{constructor(a,b,c){super(),this.OtherPlayerId=a,this.thisOrOtherPlayerSurrenders=b,this.Message=c}GetKind(){return CommandKindEnum.PLAYER_SURRENDER}static Format(a){return a.Message}}class PingCommand extends DtoMsg{constructor(a=""){super(),this.Message=a}GetKind(){return CommandKindEnum.PING}static Format(a,b){let c=b.Message;return a+" says "+c}}class WinCommand extends DtoMsg{constructor(a=WinStatusEnum.NO_WIN,b=0,c="null"){super(),this.Status=a,this.WinningPlayerId=b,this.Message=c}GetKind(){return CommandKindEnum.WIN}static Format(a){let b="";switch(a.Status){case WinStatusEnum.RED_WINS:b="red.";break;case WinStatusEnum.GREEN_WINS:b="green.";break;case WinStatusEnum.NO_WIN:b="no one!";break;case WinStatusEnum.DRAW_WIN:b="draw!";}return"And the winner is... "+b}}function CountPointsDebug(a,b="svg"){let c=document.getElementsByTagName(b),d=0,e=[];for(let f,g=0;g<c.length;g++)f=c[g],d+=f.childElementCount,e.push(f.childElementCount);let f="";["circle","polyline"].forEach(a=>{f+=a+": "+document.getElementsByTagName(a).length+" "}),document.querySelector(a).innerHTML=`SVG: ${d} by tag: ${f}`}class InkBallGame{constructor(a,b,c,d,e,f,g,h=!0,i=!0,j={width:32,height:32},k=125,l=!1){this.g_iGameID=null,this.g_iPlayerID=null,this.GameType=g,this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=k,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSizeX=0,this.m_iGridSizeY=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize=j,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_DrawMode=null,this.m_CancelPath=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=h,this.m_bIsPlayerActive=i,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=l,this.m_MouseCursorOval=null;null===a||""===a||(this.g_SignalRConnection=new signalR.HubConnectionBuilder().withUrl(a,{transport:d,accessTokenFactory:f}).withHubProtocol(c).configureLogging(b).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=e,this.g_SignalRConnection.onclose(async a=>{null!==a&&a!==void 0&&(console.error(a),this.m_Screen.style.cursor="not-allowed",5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(()=>this.start(),4e3+this.iExponentialBackOffMillis*this.iConnErrCount))}))}async start(){try{await this.g_SignalRConnection.start(),this.iConnErrCount=0,console.log("connected; iConnErrCount = "+this.iConnErrCount)}catch(a){console.error(a+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(()=>this.start(),4e3+this.iExponentialBackOffMillis*this.iConnErrCount)}}StartSignalRConnection(a,b,c,d,e){null===this.g_SignalRConnection||(this.g_iGameID=a,this.g_iPlayerID=b,this.m_sMsgInputSel=e,this.m_sMsgSendButtonSel=d,this.g_SignalRConnection.on("ServerToClientPoint",function(a,b){let d=InkBallPointViewModel.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e),this.ReceivedPointProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(a,b){if(a.hasOwnProperty("PointsAsString")){let d=a,e=InkBallPathViewModel.Format(b,d),f=document.createElement("li");f.textContent=e,document.querySelector(c).appendChild(f),this.ReceivedPathProcessing(d)}else if(a.hasOwnProperty("WinningPlayerId")){let b=a,d=WinCommand.Format(b),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e),this.ReceivedWinProcessing(b)}else throw new Error("ServerToClientPath bad GetKind!")}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(a){let b=PlayerJoiningCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),null!==this.m_SurrenderButton&&""!==a.OtherPlayerName&&(this.m_Player2Name.innerHTML=a.OtherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),null!==this.m_DrawMode&&(this.m_DrawMode.disabled=""),null!==this.m_CancelPath&&(this.m_CancelPath.disabled=""),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(a){let b=PlayerSurrenderingCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.m_bHandlingEvent=!1,alert(""===b?"Game interrupted!":b),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(a){let b=WinCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.ReceivedWinProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(a,b){let d=PingCommand.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e)}.bind(this)),document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",function(a){a.preventDefault();let b=document.querySelector(this.m_sMsgInputSel).value.trim();if(""!==b){let a=new PingCommand(b);this.SendAsyncData(a)}}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(a){a.preventDefault(),13===a.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1),this.start())}StopSignalRConnection(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),console.log("Stopped SignalR connection"))}Debug(...a){switch(a.length){case 1:this.m_Debug.innerHTML=a[0];break;case 2:{let b=document.getElementById("debug"+a[1]);b.innerHTML=a[0];break}default:}}DisableSelection(a){typeof a.onselectstart===void 0?typeof a.style.MozUserSelect===void 0?a.onmousedown=function(){return!1}:a.style.MozUserSelect="none":a.onselectstart=function(){return!1}}f_clientWidth(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}f_clientHeight(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}f_scrollLeft(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}f_scrollTop(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}f_filterResults(a,b,c){let d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}SetPoint(a,b,c){let d=a*this.m_iGridSizeX,e=b*this.m_iGridSizeY,f=$createOval(this.m_PointRadius,"true");f.$move(d,e,this.m_PointRadius);let g;switch(c){case StatusEnum.POINT_FREE_RED:g=this.COLOR_RED,f.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_FREE_BLUE:g=this.COLOR_BLUE,f.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_FREE:g=this.m_sDotColor,f.$SetStatus(StatusEnum.POINT_FREE);break;case StatusEnum.POINT_STARTING:g=this.m_sDotColor,f.$SetStatus(StatusEnum.POINT_STARTING);break;case StatusEnum.POINT_IN_PATH:g=this.m_sDotColor,f.$SetStatus(c);break;case StatusEnum.POINT_OWNED_BY_RED:g=this.COLOR_OWNED_RED,f.$SetStatus(c);break;case StatusEnum.POINT_OWNED_BY_BLUE:g=this.COLOR_OWNED_BLUE,f.$SetStatus(c);break;default:alert("bad point");}f.$SetFillColor(g),f.$strokeColor(g),this.m_Points[b*this.m_iGridWidth+a]=f}SetAllPoints(a){a.forEach(a=>{if(a[3]===this.g_iPlayerID);else switch(a[2]){case StatusEnum.POINT_FREE:case StatusEnum.POINT_FREE_RED:case StatusEnum.POINT_FREE_BLUE:case StatusEnum.POINT_STARTING:case StatusEnum.POINT_OWNED_BY_RED:case StatusEnum.POINT_OWNED_BY_BLUE:break;case StatusEnum.POINT_IN_PATH:a[2]=!0===this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_BLUE:StatusEnum.POINT_FREE_RED;}this.SetPoint(a[0],a[1],a[2])})}SetPath(a,b,c){let d,e,f=a.split(" "),g=f.length,h="",j="",k=null,l=StatusEnum.POINT_STARTING;for(let m=0;m<g;++m)k=f[m].split(","),d=parseInt(k[0]),e=parseInt(k[1]),d*=this.m_iGridSizeX,e*=this.m_iGridSizeY,j=j+h+d+","+e,h=" ",k=this.m_Points[e*this.m_iGridWidth+d],null!==k&&void 0!==k&&(k.$SetStatus(l),l=StatusEnum.POINT_IN_PATH);k=f[0].split(","),d=parseInt(k[0]),e=parseInt(k[1]),d*=this.m_iGridSizeX,e*=this.m_iGridSizeY,j=j+h+d+","+e,k=this.m_Points[e*this.m_iGridWidth+d],null!==k&&k!==void 0&&k.$SetStatus(l);let i=$createPolyline(3,j,c?this.m_sDotColor:b?this.COLOR_BLUE:this.COLOR_RED);this.m_Lines[this.m_Lines.length]=i}SetAllPaths(a){a.forEach(a=>{this.SetPath(a[0],this.m_bIsPlayingWithRed,a[1]===this.g_iPlayerID)})}IsPointBelongingToLine(a,b,c){let d,e,f,g=a.length;for(let h=0;h<g;++h)if(f=a[h].split(","),d=f[0],e=f[1],d===b&&e===c)return!0;return!1}pnpoly(a,b,d,e,f){let g,h,k=!1;for(g=0,h=a-1;g<a;h=g++)(d[g]<=f&&f<d[h]||d[h]<=f&&f<d[g])&&e<(b[h]-b[g])*(f-d[g])/(d[h]-d[g])+b[g]&&(k=!k);return k}pnpoly2(a,b,d){let e,f,g=a.length,h=!1;for(e=0,f=g-1;e<g;f=e++){let c=a[e],g=a[f];(c.y<=d&&d<g.y||g.y<=d&&d<c.y)&&b<(g.x-c.x)*(d-c.y)/(g.y-c.y)+c.x&&(h=!h)}return h}SurroundOponentPoints(){let a=this.m_Line.$GetPointsArray(),b=new Set,c=a.slice(0,-1).some(function(a){return b.size===b.add(a.x+"_"+a.y).size});if(c||a[0].x!==a[a.length-1].x||a[0].y!==a[a.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",revertFillColor:void 0,revertStatus:void 0,revertStrokeColor:void 0};let d,e,f=a.length,g="",h="";for(let b=0;b<f;b++)d=a[b].x,e=a[b].y,null===d||null===e||(d/=this.m_iGridSizeX,e/=this.m_iGridSizeY,g=g+h+d+","+e,h=" ");let j=this.m_sDotColor===this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,i=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,k=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,l="",m=[];h="",f=this.m_Points.length;for(let b,c=0;c<f;++c)if(b=this.m_Points[c],void 0!==b&&b.$GetStatus()===StatusEnum.POINT_FREE&&b.$GetFillColor()===j){let c=b.$GetPosition();d=c.x,e=c.y,!1!==this.pnpoly2(a,d,e)&&(b.$SetStatus(i),b.$SetFillColor(k),b.$strokeColor(k),d/=this.m_iGridSizeX,e/=this.m_iGridSizeY,l=l+h+d+","+e,m.push(b),h=" ")}return{OwnedPoints:m,owned:l,path:g,revertFillColor:j,revertStatus:StatusEnum.POINT_FREE,revertStrokeColor:this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED}}IsPointOutsideAllPaths(a,b){let c=this.m_Lines.length;for(let d,e=0;e<c;++e)if(d=this.m_Lines[e].$GetPointsArray(),!1!==this.pnpoly2(d,a,b))return!1;return!0}CreateXMLWaitForPlayerRequest(){}CreateXMLPutPointRequest(a,b){let c=new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,a,b,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0);return c}CreateXMLPutPathRequest(a){let b=new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,a.path,a.owned);return b}SendAsyncData(a,b=void 0){switch(a.GetKind()){case CommandKindEnum.POINT:console.log(InkBallPointViewModel.Format("some player",a)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",a).then(function(a){this.ReceivedPointProcessing(a)}.bind(this)).catch(function(a){console.error(a.toString()),b!==void 0&&b()}.bind(this));break;case CommandKindEnum.PATH:console.log(InkBallPathViewModel.Format("some player",a)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",a).then(function(a){if(a.hasOwnProperty("WinningPlayerId")){this.ReceivedWinProcessing(a)}else if(a.hasOwnProperty("PointsAsString")){this.ReceivedPathProcessing(a)}else throw new Error("ClientToServerPath bad GetKind!")}.bind(this)).catch(function(a){console.error(a.toString()),b!==void 0&&b()}.bind(this));break;case CommandKindEnum.PING:this.g_SignalRConnection.invoke("ClientToServerPing",a).then(function(){document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}.bind(this)).catch(function(a){console.error(a.toString())});break;default:console.error("unknown object");}}ReceivedPointProcessing(a){let b=a.iX,c=a.iY,d=a.Status;this.SetPoint(b,c,d),this.g_iPlayerID===a.iPlayerId?(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"):(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""),this.m_bHandlingEvent=!1}ReceivedPathProcessing(a){if(this.g_iPlayerID!==a.iPlayerId){let b=a.PointsAsString,c=a.OwnedPointsAsString;this.SetPath(b,!(this.m_sDotColor!==this.COLOR_RED),!1);let d=c.split(" "),e=d.length,f=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,g=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED;for(let a=0;a<e;++a){let b=d[a].split(","),c=parseInt(b[0]),e=parseInt(b[1]);b=this.m_Points[e*this.m_iGridWidth+c],b!==void 0&&(b.$SetStatus(f),b.$SetFillColor(g),b.$strokeColor(g))}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""}else{let a=this.m_Line.$GetPointsString(),b=0,c=a[b],d=a[b+1];c/=this.m_iGridSizeX,d/=this.m_iGridSizeY;let e=this.m_Points[d*this.m_iGridWidth+c];e!==void 0&&e.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"}this.m_bHandlingEvent=!1}ReceivedWinProcessing(a){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;let b=WinCommand.Format(a);((a.Status===WinStatusEnum.RED_WINS||a.Status===WinStatusEnum.GREEN_WINS)&&0<a.WinningPlayerId||a.Status===WinStatusEnum.DRAW_WIN)&&(alert(""===b?"Game won!":b),window.location.href="Games")}Check4Win(a,b,c,d){let e,f,g;switch(this.GameType){case GameTypeEnum.FIRST_CAPTURE:return(e=a,0<e.length)?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:(e=b,0<e.length?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_CAPTURES:return f=d,g=0,f.forEach(a=>{if(null!==a.iEnclosingPathId&&++g,5<=g)return this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS}),f=c,g=0,f.forEach(a=>{if(null!==a.iEnclosingPathId&&++g,5<=g)return this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}),WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_PATHS:return(e=a,5<=e.length)?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:(e=b,5<=e.length?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_ADVANTAGE_PATHS:{let c=a.length-b.length;if(5<=c)return this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS;if(-5>=c)return this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}return WinStatusEnum.NO_WIN;default:throw new Error("Wrong game type");}}ShowMobileStatus(a=""){this.m_GameStatus.style.color="???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,null!==a&&""!==a?this.Debug(a,0):this.Debug("",0)}OnMouseMove(a){var b=Math.abs;if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||0<this.iConnErrCount)return void(0>=this.iConnErrCount&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait"));let c=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,d=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;c=parseInt(c/this.m_iGridSizeX),d=parseInt(d/this.m_iGridSizeY);let e=c*this.m_iGridSizeX,f=d*this.m_iGridSizeY;if(this.m_MouseCursorOval.$move(e,f,this.m_PointRadius),this.m_MouseCursorOval.$Show(),this.m_Screen.style.cursor="crosshair",this.Debug(`[${c},${d}]`,1),this.m_bDrawLines&&!0===this.m_bMouseDown&&(this.m_iLastX!==c||this.m_iLastY!==d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY)if(null!==this.m_Line){let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(void 0!==a&&void 0!==b&&b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$GetFillColor()===this.m_sDotColor&&b.$GetFillColor()===this.m_sDotColor){if(this.m_Line.$AppendPoints(e+","+f),b.$GetStatus()!==StatusEnum.POINT_STARTING)b.$SetStatus(StatusEnum.POINT_IN_PATH);else{let a=this.SurroundOponentPoints();0<a.owned.length?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(a),()=>{this.OnCancelClick(),a.OwnedPoints.forEach(b=>{b.$SetStatus(a.revertStatus),b.$SetFillColor(a.revertFillColor),b.$strokeColor(a.revertStrokeColor)}),this.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(void 0!==a&&void 0!==b&&a.$GetStatus()!==StatusEnum.POINT_IN_PATH&&b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$GetFillColor()===this.m_sDotColor&&b.$GetFillColor()===this.m_sDotColor){let g=this.m_iLastX*this.m_iGridSizeX,h=this.m_iLastY*this.m_iGridSizeY;this.m_Line=$createPolyline(3,g+","+h+" "+e+","+f,this.m_sDotColor),a.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$SetStatus(StatusEnum.POINT_STARTING),b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&b.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_iLastX=c,this.m_iLastY=d}}}OnMouseDown(a){var b=Math.abs;if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||0<this.iConnErrCount)return;let c=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,d=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;if(c=this.m_iMouseX=parseInt(c/this.m_iGridSizeX),d=this.m_iMouseY=parseInt(d/this.m_iGridSizeY),this.m_bMouseDown=!0,!this.m_bDrawLines){this.m_iLastX=c,this.m_iLastY=d;let a=c,b=d;if(c=a*this.m_iGridSizeX,d=b*this.m_iGridSizeY,void 0!==this.m_Points[b*this.m_iGridWidth+a])return;if(!this.IsPointOutsideAllPaths(a,b))return;this.SendAsyncData(this.CreateXMLPutPointRequest(a,b),()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1})}else if((this.m_iLastX!==c||this.m_iLastY!==d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY){if(null!==this.m_Line){let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(void 0!==a&&void 0!==b&&b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$GetFillColor()===this.m_sDotColor&&b.$GetFillColor()===this.m_sDotColor){let a=c*this.m_iGridSizeX,e=d*this.m_iGridSizeY;if(this.m_Line.$AppendPoints(a+","+e),b.$GetStatus()!==StatusEnum.POINT_STARTING)b.$SetStatus(StatusEnum.POINT_IN_PATH);else{let a=this.SurroundOponentPoints();0<a.owned.length?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(a),()=>{this.OnCancelClick(),a.OwnedPoints.forEach(b=>{b.$SetStatus(a.revertStatus),b.$SetFillColor(a.revertFillColor),b.$strokeColor(a.revertStrokeColor)}),this.m_bMouseDown=!1,this.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(void 0!==a&&void 0!==b&&a.$GetStatus()!==StatusEnum.POINT_IN_PATH&&b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$GetFillColor()===this.m_sDotColor&&b.$GetFillColor()===this.m_sDotColor){let e=this.m_iLastX*this.m_iGridSizeX,f=this.m_iLastY*this.m_iGridSizeY,g=c*this.m_iGridSizeX,h=d*this.m_iGridSizeY;this.m_Line=$createPolyline(3,e+","+f+" "+g+","+h,this.m_sDotColor),a.$GetStatus()!==StatusEnum.POINT_IN_PATH&&a.$SetStatus(StatusEnum.POINT_STARTING),b.$GetStatus()!==StatusEnum.POINT_IN_PATH&&b.$SetStatus(StatusEnum.POINT_IN_PATH)}this.m_iLastX=c,this.m_iLastY=d}}else if(0>this.m_iLastX||0>this.m_iLastY){let a=this.m_Points[d*this.m_iGridWidth+c];void 0!==a&&a.$GetStatus()===StatusEnum.POINT_FREE&&a.$GetFillColor()===this.m_sDotColor&&(this.m_iLastX=c,this.m_iLastY=d)}}OnMouseUp(){this.m_bMouseDown=!1}OnMouseLeave(){this.m_MouseCursorOval.$Hide()}OnDrawModeClick(a){this.m_bDrawLines=!this.m_bDrawLines;let b=a.target;b.value=this.m_bDrawLines?"Draw dots":"Draw lines",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}OnCancelClick(){if(this.m_bDrawLines){if(null!==this.m_Line){let a=this.m_Line.$GetPointsArray();for(let b=0;b<a.length;b++){let c=a[b].x,d=a[b].y;if(null===c||null===d)continue;c/=this.m_iGridSizeX,d/=this.m_iGridSizeY;let e=this.m_Points[d*this.m_iGridWidth+c];e!==void 0&&e.$SetStatus(StatusEnum.POINT_FREE)}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1}}OnTestClick(){console.log(this.m_Points.flat())}PrepareDrawing(a,b,c,d,e,f,g=125){var h=Math.ceil;if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=g,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Debug=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(b),this.m_GameStatus=document.querySelector(c),this.m_SurrenderButton=document.querySelector(d),this.m_CancelPath=document.querySelector(f),this.m_DrawMode=document.querySelector(e),this.m_Screen=document.querySelector(a),!this.m_Screen)return void alert("no board");this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop;let i=this.m_Screen.clientWidth,j=this.m_Screen.clientHeight;this.m_iGridSizeX=parseInt(h(i/this.m_BoardSize.width)),this.m_iGridSizeY=parseInt(h(j/this.m_BoardSize.height)),this.m_iGridWidth=parseInt(h(i/this.m_iGridSizeX)),this.m_iGridHeight=parseInt(h(j/this.m_iGridSizeY)),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),this.m_bViewOnly||(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$strokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1),this.m_MouseCursorOval.$Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_DrawMode.onclick=this.OnDrawModeClick.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),document.querySelector("#Test").onclick=this.OnTestClick.bind(this),"???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled")))}}