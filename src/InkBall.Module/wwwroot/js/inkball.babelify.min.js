"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5}),GameTypeEnum=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),WinStatusEnum=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3}),DtoMsg=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"GetKind",value:function a(){throw new Error("missing GetKind implementation!")}}]),a}(),InkBallPointViewModel=function(a){function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,h=5<arguments.length&&void 0!==arguments[5]?arguments[5]:StatusEnum.POINT_FREE,i=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),a.iId=c,a.iGameId=d,a.iPlayerId=e,a.iX=f,a.iY=g,a.Status=h,a.iEnclosingPathId=i,a}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.POINT}}],[{key:"Format",value:function d(a,b){var c=b.iX+" "+b.iY+" "+b.Status;return a+" places ["+c+"] point"}}]),b}(DtoMsg),InkBallPathViewModel=function(a){function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"",g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:"";return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),a.iId=c,a.iGameId=d,a.iPlayerId=e,a.PointsAsString=f,a.OwnedPointsAsString=g,a}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.PATH}}],[{key:"Format",value:function d(a,b){var c="".concat(b.iPlayerId,"  [").concat(b.PointsAsString,"] [").concat(b.OwnedPointsAsString,"]");return"".concat(a," places [").concat(c,"] path")}}]),b}(DtoMsg),PlayerJoiningCommand=function(a){function b(a,c,d){var e;return _classCallCheck(this,b),e=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),e.OtherPlayerId=a,e.OtherPlayerName=c,e.Message=d,e}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.PLAYER_JOINING}}],[{key:"Format",value:function b(a){return a.Message}}]),b}(DtoMsg),PlayerSurrenderingCommand=function(a){function b(a,c,d){var e;return _classCallCheck(this,b),e=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),e.OtherPlayerId=a,e.thisOrOtherPlayerSurrenders=c,e.Message=d,e}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.PLAYER_SURRENDER}}],[{key:"Format",value:function b(a){return a.Message}}]),b}(DtoMsg),PingCommand=function(a){function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),a.Message=c,a}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.PING}}],[{key:"Format",value:function d(a,b){var c=b.Message;return a+" says "+c}}]),b}(DtoMsg),WinCommand=function(a){function b(){var a,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:WinStatusEnum.NO_WIN,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"null";return _classCallCheck(this,b),a=_possibleConstructorReturn(this,_getPrototypeOf(b).call(this)),a.Status=c,a.WinningPlayerId=d,a.Message=e,a}return _inherits(b,a),_createClass(b,[{key:"GetKind",value:function a(){return CommandKindEnum.WIN}}],[{key:"Format",value:function c(a){var b="";switch(a.Status){case WinStatusEnum.RED_WINS:b="red.";break;case WinStatusEnum.GREEN_WINS:b="green.";break;case WinStatusEnum.NO_WIN:b="no one!";break;case WinStatusEnum.DRAW_WIN:b="draw!";}return"And the winner is... "+b}}]),b}(DtoMsg);function CountPointsDebug(a){for(var b,c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"svg",d=document.getElementsByTagName(c),e=0,f=[],g=0;g<d.length;g++)b=d[g],e+=b.childElementCount,f.push(b.childElementCount);var h="";["circle","polyline"].forEach(function(a){h+=a+": "+document.getElementsByTagName(a).length+" "}),document.querySelector(a).innerHTML="SVG: ".concat(e," by tag: ").concat(h)}var InkBallGame=function(){function a(b,c,d,e,f,g,h){var i=this,j=!(7<arguments.length&&void 0!==arguments[7])||arguments[7],k=!(8<arguments.length&&void 0!==arguments[8])||arguments[8],l=9<arguments.length&&void 0!==arguments[9]?arguments[9]:{width:32,height:32},m=10<arguments.length&&void 0!==arguments[10]?arguments[10]:125,n=!!(11<arguments.length&&void 0!==arguments[11])&&arguments[11];_classCallCheck(this,a),this.g_iGameID=null,this.g_iPlayerID=null,this.GameType=h,this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=m,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSizeX=0,this.m_iGridSizeY=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize=l,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_DrawMode=null,this.m_CancelPath=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=j,this.m_bIsPlayerActive=k,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=n,this.m_MouseCursorOval=null,null===b||""===b||(this.g_SignalRConnection=new signalR.HubConnectionBuilder().withUrl(b,{transport:e,accessTokenFactory:g}).withHubProtocol(d).configureLogging(c).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=f,this.g_SignalRConnection.onclose(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:null!==b&&void 0!==b&&(console.error(b),i.m_Screen.style.cursor="not-allowed",5>i.iConnErrCount&&i.iConnErrCount++,setTimeout(function(){return i.start()},4e3+i.iExponentialBackOffMillis*i.iConnErrCount));case 1:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}()))}var b=Math.abs;return _createClass(a,[{key:"start",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,this.g_SignalRConnection.start();case 3:this.iConnErrCount=0,console.log("connected; iConnErrCount = "+this.iConnErrCount),a.next=13;break;case 7:a.prev=7,a.t0=a["catch"](0),console.error(a.t0+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(function(){return b.start()},4e3+this.iExponentialBackOffMillis*this.iConnErrCount);case 13:case"end":return a.stop();}},a,this,[[0,7]])}));return function b(){return a.apply(this,arguments)}}()},{key:"StartSignalRConnection",value:function f(a,b,c,d,e){null===this.g_SignalRConnection||(this.g_iGameID=a,this.g_iPlayerID=b,this.m_sMsgInputSel=e,this.m_sMsgSendButtonSel=d,this.g_SignalRConnection.on("ServerToClientPoint",function(a,b){var d=InkBallPointViewModel.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e),this.ReceivedPointProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(a,b){if(a.hasOwnProperty("PointsAsString")){var d=a,e=InkBallPathViewModel.Format(b,d),f=document.createElement("li");f.textContent=e,document.querySelector(c).appendChild(f),this.ReceivedPathProcessing(d)}else if(a.hasOwnProperty("WinningPlayerId")){var g=a,h=WinCommand.Format(g),i=document.createElement("li");i.textContent=h,document.querySelector(c).appendChild(i),this.ReceivedWinProcessing(g)}else throw new Error("ServerToClientPath bad GetKind!")}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(a){var b=PlayerJoiningCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),null!==this.m_SurrenderButton&&""!==a.OtherPlayerName&&(this.m_Player2Name.innerHTML=a.OtherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),null!==this.m_DrawMode&&(this.m_DrawMode.disabled=""),null!==this.m_CancelPath&&(this.m_CancelPath.disabled=""),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(a){var b=PlayerSurrenderingCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.m_bHandlingEvent=!1,alert(""===b?"Game interrupted!":b),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(a){var b=WinCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.ReceivedWinProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(a,b){var d=PingCommand.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e)}.bind(this)),document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",function(a){a.preventDefault();var b=document.querySelector(this.m_sMsgInputSel).value.trim();if(""!==b){var c=new PingCommand(b);this.SendAsyncData(c)}}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(a){a.preventDefault(),13===a.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1),this.start())}},{key:"StopSignalRConnection",value:function a(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),console.log("Stopped SignalR connection"))}},{key:"Debug",value:function a(){switch(arguments.length){case 1:this.m_Debug.innerHTML=0>=arguments.length?void 0:arguments[0];break;case 2:{var b=document.getElementById("debug"+(1>=arguments.length?void 0:arguments[1]));b.innerHTML=0>=arguments.length?void 0:arguments[0];break}default:}}},{key:"DisableSelection",value:function b(a){void 0===_typeof(a.onselectstart)?void 0===_typeof(a.style.MozUserSelect)?a.onmousedown=function(){return!1}:a.style.MozUserSelect="none":a.onselectstart=function(){return!1}}},{key:"f_clientWidth",value:function a(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}},{key:"f_clientHeight",value:function a(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}},{key:"f_scrollLeft",value:function a(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}},{key:"f_scrollTop",value:function a(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}},{key:"f_filterResults",value:function e(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}},{key:"SetPoint",value:function h(a,b,c){var d=a*this.m_iGridSizeX,e=b*this.m_iGridSizeY,f=$createOval(this.m_PointRadius,"true");f.$move(d,e,this.m_PointRadius);var g;c===StatusEnum.POINT_FREE_RED?(g=this.COLOR_RED,f.$SetStatus(StatusEnum.POINT_FREE)):c===StatusEnum.POINT_FREE_BLUE?(g=this.COLOR_BLUE,f.$SetStatus(StatusEnum.POINT_FREE)):c===StatusEnum.POINT_FREE?(g=this.m_sDotColor,f.$SetStatus(StatusEnum.POINT_FREE)):c===StatusEnum.POINT_STARTING?(g=this.m_sDotColor,f.$SetStatus(StatusEnum.POINT_STARTING)):c===StatusEnum.POINT_IN_PATH?(g=this.m_sDotColor,f.$SetStatus(c)):c===StatusEnum.POINT_OWNED_BY_RED?(g=this.COLOR_OWNED_RED,f.$SetStatus(c)):c===StatusEnum.POINT_OWNED_BY_BLUE?(g=this.COLOR_OWNED_BLUE,f.$SetStatus(c)):alert("bad point"),f.$SetFillColor(g),f.$strokeColor(g),this.m_Points[b*this.m_iGridWidth+a]=f}},{key:"SetAllPoints",value:function c(a){var b=this;a.forEach(function(a){if(a[3]===b.g_iPlayerID);else switch(a[2]){case StatusEnum.POINT_FREE:case StatusEnum.POINT_FREE_RED:case StatusEnum.POINT_FREE_BLUE:case StatusEnum.POINT_STARTING:case StatusEnum.POINT_OWNED_BY_RED:case StatusEnum.POINT_OWNED_BY_BLUE:break;case StatusEnum.POINT_IN_PATH:a[2]=!0===b.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_BLUE:StatusEnum.POINT_FREE_RED;}b.SetPoint(a[0],a[1],a[2])})}},{key:"SetPath",value:function o(a,b,c){for(var d,e,f=a.split(" "),g=f.length,h="",j="",k=null,l=StatusEnum.POINT_STARTING,m=0;m<g;++m)k=f[m].split(","),d=parseInt(k[0]),e=parseInt(k[1]),d*=this.m_iGridSizeX,e*=this.m_iGridSizeY,j=j+h+d+","+e,h=" ",k=this.m_Points[e*this.m_iGridWidth+d],null!==k&&void 0!==k&&(k.$SetStatus(l),l=StatusEnum.POINT_IN_PATH);k=f[0].split(","),d=parseInt(k[0]),e=parseInt(k[1]),d*=this.m_iGridSizeX,e*=this.m_iGridSizeY,j=j+h+d+","+e,k=this.m_Points[e*this.m_iGridWidth+d],null!==k&&void 0!==k&&k.$SetStatus(l);var n=$createPolyline(3,j,c?this.m_sDotColor:b?this.COLOR_BLUE:this.COLOR_RED);this.m_Lines[this.m_Lines.length]=n}},{key:"SetAllPaths",value:function c(a){var b=this;a.forEach(function(a){b.SetPath(a[0],b.m_bIsPlayingWithRed,a[1]===b.g_iPlayerID)})}},{key:"IsPointBelongingToLine",value:function j(a,b,c){for(var d,e,f,g=a.length,h=0;h<g;++h)if(f=a[h].split(","),d=f[0],e=f[1],d===b&&e===c)return!0;return!1}},{key:"pnpoly",value:function l(a,b,d,e,f){var g,h,k=!1;for(g=0,h=a-1;g<a;h=g++)(d[g]<=f&&f<d[h]||d[h]<=f&&f<d[g])&&e<(b[h]-b[g])*(f-d[g])/(d[h]-d[g])+b[g]&&(k=!k);return k}},{key:"pnpoly2",value:function k(a,b,d){var e,f,g=a.length,h=!1;for(e=0,f=g-1;e<g;f=e++){var l=a[e],m=a[f];(l.y<=d&&d<m.y||m.y<=d&&d<l.y)&&b<(m.x-l.x)*(d-l.y)/(m.y-l.y)+l.x&&(h=!h)}return h}},{key:"SurroundOponentPoints",value:function p(){var a=this.m_Line.$GetPointsArray(),b=new Set,c=a.slice(0,-1).some(function(a){return b.size===b.add(a.x+"_"+a.y).size});if(c||a[0].x!==a[a.length-1].x||a[0].y!==a[a.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",revertFillColor:void 0,revertStatus:void 0,revertStrokeColor:void 0};for(var d,e,f=a.length,g="",h="",j=0;j<f;j++)d=a[j].x,e=a[j].y,null===d||null===e||(d/=this.m_iGridSizeX,e/=this.m_iGridSizeY,g=g+h+d+","+e,h=" ");var k=this.m_sDotColor===this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,l=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,m=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,n="",o=[];h="",f=this.m_Points.length;for(var q,r=0;r<f;++r)if(q=this.m_Points[r],void 0!==q&&q.$GetStatus()===StatusEnum.POINT_FREE&&q.$GetFillColor()===k){var s=q.$GetPosition();d=s.x,e=s.y,!1!==this.pnpoly2(a,d,e)&&(q.$SetStatus(l),q.$SetFillColor(m),q.$strokeColor(m),d/=this.m_iGridSizeX,e/=this.m_iGridSizeY,n=n+h+d+","+e,o.push(q),h=" ")}return{OwnedPoints:o,owned:n,path:g,revertFillColor:k,revertStatus:StatusEnum.POINT_FREE,revertStrokeColor:this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED}}},{key:"IsPointOutsideAllPaths",value:function f(a,b){for(var c,d=this.m_Lines.length,e=0;e<d;++e)if(c=this.m_Lines[e].$GetPointsArray(),!1!==this.pnpoly2(c,a,b))return!1;return!0}},{key:"CreateXMLWaitForPlayerRequest",value:function a(){}},{key:"CreateXMLPutPointRequest",value:function d(a,b){var c=new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,a,b,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0);return c}},{key:"CreateXMLPutPathRequest",value:function c(a){var b=new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,a.path,a.owned);return b}},{key:"SendAsyncData",value:function c(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0;switch(a.GetKind()){case CommandKindEnum.POINT:console.log(InkBallPointViewModel.Format("some player",a)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",a).then(function(a){this.ReceivedPointProcessing(a)}.bind(this)).catch(function(a){console.error(a.toString()),void 0!==b&&b()}.bind(this));break;case CommandKindEnum.PATH:console.log(InkBallPathViewModel.Format("some player",a)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",a).then(function(a){if(a.hasOwnProperty("WinningPlayerId")){this.ReceivedWinProcessing(a)}else if(a.hasOwnProperty("PointsAsString")){this.ReceivedPathProcessing(a)}else throw new Error("ClientToServerPath bad GetKind!")}.bind(this)).catch(function(a){console.error(a.toString()),void 0!==b&&b()}.bind(this));break;case CommandKindEnum.PING:this.g_SignalRConnection.invoke("ClientToServerPing",a).then(function(){document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}.bind(this)).catch(function(a){console.error(a.toString())});break;default:console.error("unknown object");}}},{key:"ReceivedPointProcessing",value:function e(a){var b=a.iX,c=a.iY,d=a.Status;this.SetPoint(b,c,d),this.g_iPlayerID===a.iPlayerId?(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"):(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""),this.m_bHandlingEvent=!1}},{key:"ReceivedPathProcessing",value:function o(a){if(this.g_iPlayerID!==a.iPlayerId){var q=a.PointsAsString,r=a.OwnedPointsAsString;this.SetPath(q,this.m_sDotColor===this.COLOR_RED,!1);for(var b=r.split(" "),c=b.length,d=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,e=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED,f=0;f<c;++f){var g=b[f].split(","),h=parseInt(g[0]),j=parseInt(g[1]);g=this.m_Points[j*this.m_iGridWidth+h],void 0!==g&&(g.$SetStatus(d),g.$SetFillColor(e),g.$strokeColor(e))}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""}else{var k=this.m_Line.$GetPointsString(),l=0,m=k[l],n=k[l+1];m/=this.m_iGridSizeX,n/=this.m_iGridSizeY;var s=this.m_Points[n*this.m_iGridWidth+m];void 0!==s&&s.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled"}this.m_bHandlingEvent=!1}},{key:"ReceivedWinProcessing",value:function c(a){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;var b=WinCommand.Format(a);((a.Status===WinStatusEnum.RED_WINS||a.Status===WinStatusEnum.GREEN_WINS)&&0<a.WinningPlayerId||a.Status===WinStatusEnum.DRAW_WIN)&&(alert(""===b?"Game won!":b),window.location.href="Games")}},{key:"Check4Win",value:function j(a,b,c,d){var e,f,g,h=this;switch(this.GameType){case GameTypeEnum.FIRST_CAPTURE:return(e=a,0<e.length)?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:(e=b,0<e.length?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_CAPTURES:return f=d,g=0,f.forEach(function(a){if(null!==a.iEnclosingPathId&&++g,5<=g)return h.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS}),f=c,g=0,f.forEach(function(a){if(null!==a.iEnclosingPathId&&++g,5<=g)return h.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}),WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_PATHS:return(e=a,5<=e.length)?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:(e=b,5<=e.length?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_ADVANTAGE_PATHS:{var i=a.length-b.length;if(5<=i)return this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS;if(-5>=i)return this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}return WinStatusEnum.NO_WIN;default:throw new Error("Wrong game type");}}},{key:"ShowMobileStatus",value:function b(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";this.m_GameStatus.style.color="???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,null!==a&&""!==a?this.Debug(a,0):this.Debug("",0)}},{key:"OnMouseMove",value:function n(a){var c=this;if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||0<this.iConnErrCount)return void(0>=this.iConnErrCount&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait"));var d=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,e=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;d=parseInt(d/this.m_iGridSizeX),e=parseInt(e/this.m_iGridSizeY);var f=d*this.m_iGridSizeX,g=e*this.m_iGridSizeY;if(this.m_MouseCursorOval.$move(f,g,this.m_PointRadius),this.m_MouseCursorOval.$Show(),this.m_Screen.style.cursor="crosshair",this.Debug("[".concat(d,",").concat(e,"]"),1),this.m_bDrawLines&&!0===this.m_bMouseDown&&(this.m_iLastX!==d||this.m_iLastY!==e)&&1>=b(parseInt(this.m_iLastX-d))&&1>=b(parseInt(this.m_iLastY-e))&&0<=this.m_iLastX&&0<=this.m_iLastY)if(null!==this.m_Line){var h=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],i=this.m_Points[e*this.m_iGridWidth+d];if(void 0!==h&&void 0!==i&&i.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$GetFillColor()===this.m_sDotColor&&i.$GetFillColor()===this.m_sDotColor){if(this.m_Line.$AppendPoints(f+","+g),i.$GetStatus()!==StatusEnum.POINT_STARTING)i.$SetStatus(StatusEnum.POINT_IN_PATH);else{var o=this.SurroundOponentPoints();0<o.owned.length?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(o),function(){c.OnCancelClick(),o.OwnedPoints.forEach(function(a){a.$SetStatus(o.revertStatus),a.$SetFillColor(o.revertFillColor),a.$strokeColor(o.revertStrokeColor)}),c.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=d,this.m_iLastY=e}}else{var j=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],k=this.m_Points[e*this.m_iGridWidth+d];if(void 0!==j&&void 0!==k&&j.$GetStatus()!==StatusEnum.POINT_IN_PATH&&k.$GetStatus()!==StatusEnum.POINT_IN_PATH&&j.$GetFillColor()===this.m_sDotColor&&k.$GetFillColor()===this.m_sDotColor){var l=this.m_iLastX*this.m_iGridSizeX,m=this.m_iLastY*this.m_iGridSizeY;this.m_Line=$createPolyline(3,l+","+m+" "+f+","+g,this.m_sDotColor),j.$GetStatus()!==StatusEnum.POINT_IN_PATH&&j.$SetStatus(StatusEnum.POINT_STARTING),k.$GetStatus()!==StatusEnum.POINT_IN_PATH&&k.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_iLastX=d,this.m_iLastY=e}}}},{key:"OnMouseDown",value:function r(a){var c=this;if(this.m_bIsPlayerActive&&"???"!==this.m_Player2Name.innerHTML&&!0!==this.m_bHandlingEvent&&!(0<this.iConnErrCount)){var d=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,e=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;if(d=this.m_iMouseX=parseInt(d/this.m_iGridSizeX),e=this.m_iMouseY=parseInt(e/this.m_iGridSizeY),this.m_bMouseDown=!0,!this.m_bDrawLines){this.m_iLastX=d,this.m_iLastY=e;var f=d,g=e;if(d=f*this.m_iGridSizeX,e=g*this.m_iGridSizeY,void 0!==this.m_Points[g*this.m_iGridWidth+f])return;if(!this.IsPointOutsideAllPaths(f,g))return;this.SendAsyncData(this.CreateXMLPutPointRequest(f,g),function(){c.m_bMouseDown=!1,c.m_bHandlingEvent=!1})}else if((this.m_iLastX!==d||this.m_iLastY!==e)&&1>=b(parseInt(this.m_iLastX-d))&&1>=b(parseInt(this.m_iLastY-e))&&0<=this.m_iLastX&&0<=this.m_iLastY){if(null!==this.m_Line){var h=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],i=this.m_Points[e*this.m_iGridWidth+d];if(void 0!==h&&void 0!==i&&i.$GetStatus()!==StatusEnum.POINT_IN_PATH&&h.$GetFillColor()===this.m_sDotColor&&i.$GetFillColor()===this.m_sDotColor){var j=d*this.m_iGridSizeX,k=e*this.m_iGridSizeY;if(this.m_Line.$AppendPoints(j+","+k),i.$GetStatus()!==StatusEnum.POINT_STARTING)i.$SetStatus(StatusEnum.POINT_IN_PATH);else{var s=this.SurroundOponentPoints();0<s.owned.length?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(s),function(){c.OnCancelClick(),s.OwnedPoints.forEach(function(a){a.$SetStatus(s.revertStatus),a.$SetFillColor(s.revertFillColor),a.$strokeColor(s.revertStrokeColor)}),c.m_bMouseDown=!1,c.m_bHandlingEvent=!1})):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=d,this.m_iLastY=e}}else{var l=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],m=this.m_Points[e*this.m_iGridWidth+d];if(void 0!==l&&void 0!==m&&l.$GetStatus()!==StatusEnum.POINT_IN_PATH&&m.$GetStatus()!==StatusEnum.POINT_IN_PATH&&l.$GetFillColor()===this.m_sDotColor&&m.$GetFillColor()===this.m_sDotColor){var n=this.m_iLastX*this.m_iGridSizeX,o=this.m_iLastY*this.m_iGridSizeY,p=d*this.m_iGridSizeX,q=e*this.m_iGridSizeY;this.m_Line=$createPolyline(3,n+","+o+" "+p+","+q,this.m_sDotColor),l.$GetStatus()!==StatusEnum.POINT_IN_PATH&&l.$SetStatus(StatusEnum.POINT_STARTING),m.$GetStatus()!==StatusEnum.POINT_IN_PATH&&m.$SetStatus(StatusEnum.POINT_IN_PATH)}this.m_iLastX=d,this.m_iLastY=e}}else if(0>this.m_iLastX||0>this.m_iLastY){var t=this.m_Points[e*this.m_iGridWidth+d];void 0!==t&&t.$GetStatus()===StatusEnum.POINT_FREE&&t.$GetFillColor()===this.m_sDotColor&&(this.m_iLastX=d,this.m_iLastY=e)}}}},{key:"OnMouseUp",value:function a(){this.m_bMouseDown=!1}},{key:"OnMouseLeave",value:function a(){this.m_MouseCursorOval.$Hide()}},{key:"OnDrawModeClick",value:function c(a){this.m_bDrawLines=!this.m_bDrawLines;var b=a.target;b.value=this.m_bDrawLines?"Draw dots":"Draw lines",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}},{key:"OnCancelClick",value:function f(){if(this.m_bDrawLines){if(null!==this.m_Line){for(var a=this.m_Line.$GetPointsArray(),b=0;b<a.length;b++){var c=a[b].x,d=a[b].y;if(null!==c&&null!==d){c/=this.m_iGridSizeX,d/=this.m_iGridSizeY;var e=this.m_Points[d*this.m_iGridWidth+c];void 0!==e&&e.$SetStatus(StatusEnum.POINT_FREE)}}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1}}},{key:"OnTestClick",value:function a(){console.log(this.m_Points.flat())}},{key:"PrepareDrawing",value:function k(a,b,c,d,e,f){var g=Math.ceil,h=6<arguments.length&&void 0!==arguments[6]?arguments[6]:125;if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=h,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Debug=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(b),this.m_GameStatus=document.querySelector(c),this.m_SurrenderButton=document.querySelector(d),this.m_CancelPath=document.querySelector(f),this.m_DrawMode=document.querySelector(e),this.m_Screen=document.querySelector(a),!this.m_Screen)return void alert("no board");this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop;var i=this.m_Screen.clientWidth,j=this.m_Screen.clientHeight;this.m_iGridSizeX=parseInt(g(i/this.m_BoardSize.width)),this.m_iGridSizeY=parseInt(g(j/this.m_BoardSize.height)),this.m_iGridWidth=parseInt(g(i/this.m_iGridSizeX)),this.m_iGridHeight=parseInt(g(j/this.m_iGridSizeY)),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),this.m_bViewOnly||(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$strokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1),this.m_MouseCursorOval.$Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_DrawMode.onclick=this.OnDrawModeClick.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),document.querySelector("#Test").onclick=this.OnTestClick.bind(this),"???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_DrawMode.disabled=this.m_CancelPath.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_DrawMode.disabled=this.m_CancelPath.disabled="disabled")))}}]),a}();