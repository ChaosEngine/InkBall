"use strict";const t=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3});function e(t){console.log(t)}function i(...t){let e="";for(let i=0;i<t.length;i++){const n=t[i];n&&(e+=n)}console.error(e)}const n="undefined"!=typeof myAlert?myAlert:(t,e=void 0)=>{window.alert(t),e&&e()};function r(t,e,i){const n=t.length;let r,s,o=!1;for(r=0,s=n-1;r<n;s=r++){const n=t[r],a=t[s];(n.y<=i&&i<a.y||a.y<=i&&i<n.y)&&e<(a.x-n.x)*(i-n.y)/(a.y-n.y)+n.x&&(o=!o)}return o}function s(t){return new Set(t).size!==t.length}async function o(t){return new Promise((e=>setTimeout(e,t)))}function a(t){const e=t.reduce(((t,e)=>(t.x+=e.x,t.y+=e.y,t)),{x:0,y:0});e.x/=t.length,e.y/=t.length;return t.map((t=>(t.angle=Math.atan2(t.y-e.y,t.x-e.x),t))).sort(((t,e)=>t.angle-e.angle))}function l(t,e,i){for(const n of i){if(!1!==r(n.GetPointsArray(),t,e))return!1}return!0}function h(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;for(const s of t)e=Math.min(e,s.x),i=Math.min(i,s.y),n=Math.max(n,s.x),r=Math.max(r,s.y);return{minX:e,minY:i,maxX:n,maxY:r,width:n-e,height:r-i}}class u{#t;#e;constructor(){const e="http://www.w3.org/2000/svg";let i,n,r,o=!1;if(this.#e=null,this.#t=null,self&&self.document&&self.document.createElementNS){const t=document.createElementNS(e,"svg");o=null!==t.x}o?(n=t=>t,r=function(t){switch(t){case"circle":case"line":case"polyline":case"rect":return document.createElementNS(e,t);default:throw new Error(`unknown type ${t}`)}}):(n=function(){return{attributes:new Map,children:[],setAttributeNS:function(t,e,i){this.attributes.set(e,i)},appendChild:function(t){this.children.push(t)},removeChild:function(t){const e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)}}},self.SVGCircleElement=function(){this.attributes=new Map},SVGCircleElement.prototype.setAttribute=function(t,e){this.attributes.set(t,e)},SVGCircleElement.prototype.getAttribute=function(t){return this.attributes.get(t)},SVGCircleElement.prototype.removeAttribute=function(t){this.attributes.delete(t)},self.SVGPolylineElement=function(){this.attributes=new Map},SVGPolylineElement.prototype.setAttribute=function(t,e){this.attributes.set(t,e)},SVGPolylineElement.prototype.getAttribute=function(t){return this.attributes.get(t)},SVGPolylineElement.prototype.removeAttribute=function(t){this.attributes.delete(t)},self.SVGRectElement=function(){this.attributes=new Map},r=function(t){switch(t){case"circle":return new SVGCircleElement;case"polyline":return new SVGPolylineElement;case"rect":return new SVGRectElement;default:throw new Error(`unknown type ${t}`)}}),SVGCircleElement.prototype.move=function(t,e){this.setAttribute("cx",t),this.setAttribute("cy",e)},SVGCircleElement.prototype.GetStrokeColor=function(){return this.getAttribute("stroke")},SVGCircleElement.prototype.SetStrokeColor=function(t){this.setAttribute("stroke",t)},SVGCircleElement.prototype.GetPosition=function(){return void 0===this.cachedPosition&&(this.cachedPosition={x:parseInt(this.getAttribute("cx")),y:parseInt(this.getAttribute("cy"))}),this.cachedPosition},SVGCircleElement.prototype.GetFillColor=function(){return void 0===this.cachedFillColor&&(this.cachedFillColor=this.getAttribute("fill")),this.cachedFillColor},SVGCircleElement.prototype.SetFillColor=function(t){this.cachedFillColor=t,this.setAttribute("fill",t)},SVGCircleElement.prototype.GetStatus=function(){return void 0===this.cachedStatus&&(this.cachedStatus=h(this.getAttribute("data-status"))),this.cachedStatus},SVGCircleElement.prototype.SetStatus=function(e,i=!1){if(i){const i=h(this.getAttribute("data-status"));this.cachedStatus=e,this.setAttribute("data-status",a(this.cachedStatus)),i!==t.POINT_FREE&&i!==e&&this.setAttribute("data-old-status",a(i))}else this.cachedStatus=e,this.setAttribute("data-status",a(e))},SVGCircleElement.prototype.RevertOldStatus=function(){const t=this.getAttribute("data-old-status");return t?(this.removeAttribute("data-old-status"),this.setAttribute("data-status",t),this.cachedStatus=h(t),this.cachedStatus):-1},SVGCircleElement.prototype.GetZIndex=function(){return this.getAttribute("z-index")},SVGCircleElement.prototype.SetZIndex=function(t){this.setAttribute("z-index",t)},SVGCircleElement.prototype.Hide=function(){this.setAttribute("visibility","hidden")},SVGCircleElement.prototype.Show=function(){this.setAttribute("visibility","visible")},SVGCircleElement.prototype.StrokeWeight=function(t){this.setAttribute("stroke-width",t)},SVGCircleElement.prototype.Serialize=function(){const{x:t,y:e}=this.GetPosition();return{x:t,y:e,Status:this.GetStatus(),Color:this.GetFillColor()}},SVGPolylineElement.prototype.AppendPoints=function(t,e,i=1){const n=this.getAttribute("points"),r=n.split(" ");if(r.length<=1||!0===s(r))return!1;const o=r.at(-1).split(",");if(2!==o.length)return!1;const a=parseInt(o[0]),l=parseInt(o[1]);return t=parseInt(t),e=parseInt(e),Math.abs(a-t)<=i&&Math.abs(l-e)<=i&&(this.setAttribute("points",n+` ${t},${e}`),!0)},SVGPolylineElement.prototype.RemoveLastPoint=function(){const t=this.getAttribute("points").replace(/(\s\d+,\d+)$/,"");return this.setAttribute("points",t),t},SVGPolylineElement.prototype.ContainsPoint=function(t,e){const i=this.getAttribute("points"),n=`${t},${e}`;let r=0,s=-n.length;for(;(s=i.indexOf(n,s+n.length))>-1;)r++;return r},SVGPolylineElement.prototype.GetPointsString=function(){return this.getAttribute("points")},SVGPolylineElement.prototype.GetPointsArray=function(){return void 0===this.cachedPoints&&(this.cachedPoints=this.getAttribute("points").split(" ").map((function(t){const[e,i]=t.split(",");return{x:parseInt(e),y:parseInt(i)}}))),this.cachedPoints},SVGPolylineElement.prototype.SetPoints=function(t){this.setAttribute("points",t)},SVGPolylineElement.prototype.GetIsClosed=function(){const t=this.getAttribute("points").split(" ");return t[0]===t.at(-1)},SVGPolylineElement.prototype.GetLength=function(){return this.getAttribute("points").split(" ").length},SVGPolylineElement.prototype.SetWidthAndColor=function(t,e){this.setAttribute("stroke",e),this.setAttribute("fill",e),this.setAttribute("stroke-width",t)},SVGPolylineElement.prototype.GetID=function(){return parseInt(this.getAttribute("data-id"))},SVGPolylineElement.prototype.SetID=function(t){this.setAttribute("data-id",t)},SVGPolylineElement.prototype.GetFillColor=function(){return this.getAttribute("fill")},SVGPolylineElement.prototype.Serialize=function(){return{iId:this.GetID(),Color:this.GetFillColor(),PointsAsString:this.GetPointsString()}},this.Init=function(t,e,r,{iGridWidth:s,iGridHeight:a},l){return this.#e=n(t),e&&this.#e.setAttributeNS(null,"width",e),r&&this.#e.setAttributeNS(null,"height",r),t&&(void 0!==s&&void 0!==a&&this.#e.setAttribute("viewBox",`0 0 ${s} ${a}`),this.#t=this.#e.createSVGPoint()),i=l,o?this.#e:null},this.CreatePolyline=function(t,e,n=void 0){const s=r("polyline");return void 0!==i&&s.setAttribute("shape-rendering",!0===i?"auto":"optimizeSpeed"),void 0!==n&&s.setAttribute("stroke-width",n),e&&(s.setAttribute("stroke",e),s.setAttribute("fill",e)),t&&s.setAttribute("points",t),s.setAttribute("data-id",0),this.#e.appendChild(s),s},this.CreateOval=function(e=void 0){const n=r("circle");return void 0!==i&&n.setAttribute("shape-rendering",!0===i?"auto":"optimizeSpeed"),void 0!==e&&n.setAttribute("r",e),n.setAttribute("data-status",a(t.POINT_FREE)),this.#e.appendChild(n),n},this.CreateRect=function(t,e,n,s,o="green",a="transparent"){const l=r("rect");return void 0!==i&&l.setAttribute("shape-rendering",!0===i?"auto":"optimizeSpeed"),l.setAttribute("x",t),l.setAttribute("y",e),l.setAttribute("width",n),l.setAttribute("height",s),l.setAttribute("fill",a),l.setAttribute("stroke",o),l.setAttribute("stroke-width",.1),this.#e.appendChild(l),l};const a=function(e){switch(e){case t.POINT_FREE_RED:return Object.keys(t)[0];case t.POINT_FREE_BLUE:return Object.keys(t)[1];case t.POINT_FREE:return Object.keys(t)[2];case t.POINT_STARTING:return Object.keys(t)[3];case t.POINT_IN_PATH:return Object.keys(t)[4];case t.POINT_OWNED_BY_RED:return Object.keys(t)[5];case t.POINT_OWNED_BY_BLUE:return Object.keys(t)[6];default:throw new Error("bad status enum value")}},l=Object.keys(t),h=function(e){switch(e.toUpperCase()){case l[0]:return t.POINT_FREE_RED;case l[1]:return t.POINT_FREE_BLUE;case l[2]:return t.POINT_FREE;case l[3]:return t.POINT_STARTING;case l[4]:return t.POINT_IN_PATH;case l[5]:return t.POINT_OWNED_BY_RED;case l[6]:return t.POINT_OWNED_BY_BLUE;default:throw new Error("bad status enum string")}}}RemoveOval(t){this.#e.removeChild(t)}RemovePolyline(t){this.#e.removeChild(t)}RemoveRect(t){this.#e.removeChild(t)}DeserializeOval(t,e=void 0){let{x:i,y:n,Status:r,Color:s}=t;i=parseInt(i),n=parseInt(n);const o=this.CreateOval(e);return o.move(i,n),o.SetFillColor(s),o.SetStatus(r),o}DeserializePolyline(t,e=void 0){const{iId:i,Color:n,PointsAsString:r}=t,s=this.CreatePolyline(r,n,e);return s.SetID(i),s}DeserializeRect(t){const{x:e,y:i,width:n,height:r,stroke:s,fill:o}=t;return this.CreateRect(e,i,n,r,s,o)}ToCursorPoint(t,e){this.#t.x=t,this.#t.y=e;return this.#t.matrixTransform(this.#e.getScreenCTM().inverse())}IsPointInCircle(t,e,i,n=4){const r=Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2),s=Math.pow(i,2);return Math.abs(r-s)<n?1:r===s?0:-1}}class c{#i;#n;#r;#s;#o;#a;#l;#h;#u;#c;constructor(t,i=null,n=null,r=null,s=""){t?"indexedDB"in self?t=!0:(e("This browser doesn't support IndexedDB"),t=!1):t=!1;const o=class{constructor(){this.store=new Map}async PrepareStore(){return!0}async BeginBulkStorage(){}async EndBulkStorage(){}async has(t){return this.store.has(t)}async set(t,e){return this.store.set(t,e)}async get(t){return this.store.get(t)}async values(){return this.store.values()}async count(){return this.store.size}},a=class{constructor(){this.store=[]}async PrepareStore(){return!0}async BeginBulkStorage(){}async EndBulkStorage(){}async push(t){return this.store.push(t)}async all(){return this.store}async count(){return this.store.length}},l=class extends o{#S;#p;#d;#P;#b;#E;constructor(t,e,i){super(),this.#S=t,this.#p=t.GetPoint.bind(this.#S),this.#d=t.StorePoint.bind(this.#S),this.#P=t.UpdatePoint.bind(this.#S),this.GetAllPoints=t.GetAllPoints.bind(this.#S),this.#b=t.UpdateState.bind(this.#S),this.#E=e,this.GetGameStateCallback=i}async PrepareStore(){if(this.#E&&this.GetGameStateCallback){const t=await this.GetAllPoints(),e=this.GetGameStateCallback();for(const i of t){const t=await this.#E(i.x,i.y,i.Status,i.Color),n=i.y*e.iGridWidth+i.x;this.store.set(n,t)}}return!0}async BeginBulkStorage(){await this.#S.BeginPointBulkStorage("readwrite"),null===this.#S.pointBulkBuffer&&(this.#S.pointBulkBuffer=new Map)}async EndBulkStorage(){await this.#S.StoreAllPoints(),await this.#S.EndPointBulkStorage()}async has(t){return this.store.has(t)}async set(t,e){const i=this.GetGameStateCallback(),n=e.GetPosition(),r=e.GetFillColor(),s={x:n.x,y:n.y,Status:e.GetStatus()};return r&&(s.Color=r),await this.has(t)?await this.#P(t,s):await this.#d(t,s),this.#b&&!0===i.bPointsAndPathsLoaded&&await this.#b(i.iGameID,i),this.store.set(t,e)}async get(t){return this.store.get(t)}async values(){let t=this.store.values();return t||(t=await this.GetAllPoints(),t)}},h=class extends a{#S;#y;#f;#b;#G;#B;constructor(t,e,i){super(),this.#S=t,this.#y=t.GetAllPaths.bind(this.#S),this.#f=t.StorePath.bind(this.#S),this.#b=t.UpdateState.bind(this.#S),this.#G=e,this.#B=i}async PrepareStore(){if(this.#G){const t=await this.#y();for(const e of t){const t=await this.#G(e.PointsAsString,e.Color,e.iId);this.store.push(t)}}return!0}async BeginBulkStorage(){await this.#S.BeginPathBulkStorage("readwrite"),null===this.#S.pathBulkBuffer&&(this.#S.pathBulkBuffer=new Map)}async EndBulkStorage(){await this.#S.StoreAllPaths(),await this.#S.EndPathBulkStorage()}async push(t){const e=this.#B(),i=t.GetID(),n={iId:i,Color:t.GetFillColor(),PointsAsString:t.GetPointsString().split(" ").map((t=>{let[e,i]=t.split(",");return e=parseInt(e),i=parseInt(i),`${e},${i}`})).join(" ")};return await this.#f(i,n),this.#b&&!0===e.bPointsAndPathsLoaded&&await this.#b(e.iGameID,e),this.store.push(t)}async all(){let t=this.store;return t||(t=await this.#y(),t)}};!0===t?(this.#n="InkballGame",this.#s="points",this.#o="paths",this.#a="state",this.#i=null,this.#l=null,this.pointBulkBuffer=null,this.pathBulkBuffer=null,!s||""===s||s.length<=0?this.#r=null:this.#r=parseInt(s.split(".").reduce(((t,e)=>(e=parseInt(e),10*t+(isNaN(e)?0:e))),0))-1010+4,this.#h=new l(this,i,r),this.#u=new h(this,n,r)):(this.#h=new o,this.#u=new a),this.#c="This engine doesn't know how to clone a Blob!??!!"}GetPointStore(){return this.#h}GetPathStore(){return this.#u}async#m(){return e("OpenDb ..."),new Promise(((t,n)=>{let r;r=null!==this.#r?indexedDB.open(this.#n,this.#r):indexedDB.open(this.#n),r.onsuccess=i=>{this.#i=i.currentTarget.result,e("OpenDb DONE"),t(i.currentTarget.result)},r.onerror=t=>{i("OpenDb:",t.target.errorCode||t.target.error),n()},r.onupgradeneeded=t=>{e(`OpenDb.onupgradeneeded(version: ${this.#r})`);const i=t.currentTarget.result,n=Array.from(i.objectStoreNames);n.includes(this.#s)&&i.deleteObjectStore(this.#s),n.includes(this.#o)&&i.deleteObjectStore(this.#o),n.includes(this.#a)&&i.deleteObjectStore(this.#a);i.createObjectStore(this.#s,{keyPath:["x","y"],autoIncrement:!1});i.createObjectStore(this.#o,{keyPath:"iId",autoIncrement:!1}),i.createObjectStore(this.#a,{autoIncrement:!1})}}))}#T(t,e){if(null!==this.#l&&this.#l.has(t))return this.#l.get(t);return this.#i.transaction(t,e).objectStore(t)}async#A(){const t=async t=>new Promise(((e,n)=>{const r=this.#T(t,"readwrite").clear();r.onsuccess=function(){e()},r.onerror=function(t){i("clearObjectStore:",t.target.errorCode),n()}}));await Promise.all([t(this.#s),t(this.#o),t(this.#a)])}async GetPoint(t){return new Promise(((e,i)=>{const n=this.#T(this.#s,"readonly").get(t);n.onerror=function(t){i(new Error("GetPoint => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetAllPoints(){return new Promise(((t,e)=>{const i=this.#T(this.#s,"readonly"),n=[],r=i.openCursor();r.onsuccess=function(e){const i=e.target.result;i?(n.push(i.value),i.continue()):t(n)},r.onerror=function(t){e(new Error("GetAllPoints => "+t))}}))}async GetState(t){return new Promise(((e,i)=>{const n=this.#T(this.#a,"readonly").get(t);n.onerror=function(t){i(new Error("GetState => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetPath(t){return new Promise(((e,i)=>{const n=this.#T(this.#o,"readonly").get(t);n.onerror=function(t){i(new Error("GetPath => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetAllPaths(){return new Promise(((t,e)=>{const i=this.#T(this.#o,"readonly"),n=[],r=i.openCursor();r.onsuccess=function(e){const i=e.target.result;i?(n.push(i.value),i.continue()):t(n)},r.onerror=function(t){e(new Error("GetAllPaths => "+t))}}))}async StorePoint(t,e){return null!==this.#l&&this.#l.has(this.#s)?(null===this.pointBulkBuffer&&(this.pointBulkBuffer=new Map),this.pointBulkBuffer.set(t,e),Promise.resolve()):new Promise(((t,n)=>{const r=this.#T(this.#s,"readwrite");let s;try{s=r.add(e)}catch(t){throw"DataCloneError"===t.name&&i(this.#c),t}s.onsuccess=function(){t()},s.onerror=function(){i("StorePoint error",this.error),n()}}))}async UpdatePoint(t,e){return null!==this.#l&&this.#l.has(this.#s)?(null===this.pointBulkBuffer&&(this.pointBulkBuffer=new Map),this.pointBulkBuffer.set(t,e),Promise.resolve()):new Promise(((t,n)=>{const r=this.#T(this.#s,"readwrite");let s;try{s=r.put(e)}catch(t){throw"DataCloneError"===t.name&&i(this.#c),t}s.onsuccess=function(){t()},s.onerror=function(){i("UpdatePoint error",this.error),n()}}))}async StoreAllPoints(t=null){return t||(t=this.pointBulkBuffer),t&&null!==this.#l?new Promise(((e,n)=>{const r=this.#T(this.#s,"readwrite");try{t.forEach((function(t){r.add(t)})),this.pointBulkBuffer=null,e()}catch(t){i(this.#c),n(t)}})):Promise.reject()}async#w(t,e){return new Promise(((n,r)=>{const s=this.#T(this.#a,"readwrite");let o;try{o=s.add(e,t)}catch(t){throw"DataCloneError"===t.name&&i(this.#c),t}o.onsuccess=function(){n()},o.onerror=function(){i("StoreState error",this.error),r()}}))}async UpdateState(t,e){return new Promise(((n,r)=>{const s=this.#T(this.#a,"readwrite");let o;try{o=s.put(e,t)}catch(t){throw"DataCloneError"===t.name&&i(this.#c),t}o.onsuccess=function(){n()},o.onerror=function(){i("UpdateState error",this.error),r()}}))}async StorePath(t,e){return null!==this.#l&&this.#l.has(this.#o)?(null===this.pathBulkBuffer&&(this.pathBulkBuffer=new Map),this.pathBulkBuffer.set(t,e),Promise.resolve()):new Promise(((t,n)=>{const r=this.#T(this.#o,"readwrite");let s;try{s=r.add(e)}catch(t){throw"DataCloneError"===t.name&&i(this.#c),t}s.onsuccess=function(){t()},s.onerror=function(){i("StorePath error",this.error),n()}}))}async StoreAllPaths(t=null){return t||(t=this.pathBulkBuffer),t&&null!==this.#l?new Promise(((e,n)=>{const r=this.#T(this.#o,"readwrite");try{t.forEach((function(t,e){r.add(t)})),this.pathBulkBuffer=null,e()}catch(t){i(this.#c),n(t)}})):Promise.reject()}async PrepareStore(){if(!this.#h.GetAllPoints)return!1;if(null!==this.#i)return!1;await this.#m();const t=this.#h.GetGameStateCallback(),e=await this.GetState(t.iGameID);if(!e)return await this.#A(),await this.#w(t.iGameID,t),!1;if(e.sLastMoveGameTimeStamp!==t.sLastMoveGameTimeStamp)return await this.#A(),!1;if(!1===t.bPointsAndPathsLoaded)try{return await this.#O([this.#s,this.#o],"readonly"),!0===await this.#h.PrepareStore()&&!0===await this.#u.PrepareStore()||(await this.#A(),!1)}finally{await this.#_([this.#s,this.#o])}}async#O(t,e){null===this.#l&&(this.#l=new Map);const i=Array.isArray(t)?t:[t];let n=null;for(const t of i)this.#l.has(t)||(null===n&&(n=this.#i.transaction(i,e)),this.#l.set(t,n.objectStore(t)))}async BeginPointBulkStorage(t){return await this.#O(this.#s,t)}async BeginPathBulkStorage(t){return await this.#O([this.#s,this.#o],t)}async#_(t){if(null!==this.#l){const e=Array.isArray(t)?t:[t];for(const t of e)this.#l.has(t)&&this.#l.delete(t);this.#l.size<=0&&(this.#l=null)}}async EndPointBulkStorage(){return await this.#_(this.#s)}async EndPathBulkStorage(){return await this.#_([this.#s,this.#o])}}export{u as SvgVml,t as StatusEnum,r as pnpoly,e as LocalLog,i as LocalError,n as LocalAlert,s as hasDuplicates,a as sortPointsClockwise,o as Sleep,l as IsPointOutsideAllPaths,c as GameStateStore,h as getBoundingBox};
//# sourceMappingURL=shared.min.js.map
