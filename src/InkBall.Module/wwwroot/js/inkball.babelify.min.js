"use strict";function asyncGeneratorStep(t,e,i,n,s,o,r){try{var a=t[o](r),l=a.value}catch(t){return void i(t)}a.done?e(l):Promise.resolve(l).then(n,s)}function _asyncToGenerator(t){return function(){var e=this,i=arguments;return new Promise(function(n,s){var o=t.apply(e,i);function r(t){asyncGeneratorStep(o,n,s,r,a,"next",t)}function a(t){asyncGeneratorStep(o,n,s,r,a,"throw",t)}r(void 0)})}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),GameTypeEnum=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),WinStatusEnum=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3}),DtoMsg=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"GetKind",value:function(){throw new Error("missing GetKind implementation!")}}]),t}(),InkBallPointViewModel=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:StatusEnum.POINT_FREE,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).iId=i,t.iGameId=n,t.iPlayerId=s,t.iX=o,t.iY=r,t.Status=a,t.iEnclosingPathId=l,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.POINT}}],[{key:"Format",value:function(t,e){var i="("+e.iX+","+e.iY+" - ";switch(e.Status||e.status){case StatusEnum.POINT_FREE_RED:i+="red";break;case StatusEnum.POINT_FREE_BLUE:i+="blue";break;case StatusEnum.POINT_FREE:i+="";break;case StatusEnum.POINT_STARTING:i+="starting";break;case StatusEnum.POINT_IN_PATH:i+="path";break;case StatusEnum.POINT_OWNED_BY_RED:i+="owned by red";break;case StatusEnum.POINT_OWNED_BY_BLUE:i+="owned by blue";break;default:throw new Error("Bad point type!")}return t+" places "+i+") point"}}]),e}(),InkBallPathViewModel=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).iId=i,t.iGameId=n,t.iPlayerId=s,t.PointsAsString=o,t.OwnedPointsAsString=r,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PATH}}],[{key:"Format",value:function(t,e){var i="(".concat(e.PointsAsString||e.pointsAsString,") [").concat(e.OwnedPointsAsString||e.ownedPointsAsString,"]");return"".concat(t," places ").concat(i," path")}}]),e}(),PlayerJoiningCommand=function(t){function e(t,i,n){var s;return _classCallCheck(this,e),(s=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).OtherPlayerId=t,s.OtherPlayerName=i,s.Message=n,s}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PLAYER_JOINING}}],[{key:"Format",value:function(t){return t.Message||t.message}}]),e}(),PlayerSurrenderingCommand=function(t){function e(t,i,n){var s;return _classCallCheck(this,e),(s=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).OtherPlayerId=t,s.thisOrOtherPlayerSurrenders=i,s.Message=n,s}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PLAYER_SURRENDER}}],[{key:"Format",value:function(t){return t.Message||t.message}}]),e}(),PingCommand=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Message=i,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.PING}}],[{key:"Format",value:function(t,e){return t+" says '"+(e.Message||e.message)+"'"}}]),e}(),WinCommand=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:WinStatusEnum.NO_WIN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"null";return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Status=i,t.WinningPlayerId=n,t.Message=s,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.WIN}}],[{key:"Format",value:function(t){var e="";switch(t.Status||t.status){case WinStatusEnum.RED_WINS:e="red.";break;case WinStatusEnum.GREEN_WINS:e="blue.";break;case WinStatusEnum.NO_WIN:e="no one!";break;case WinStatusEnum.DRAW_WIN:e="draw!"}return"And the winner is... "+e}}]),e}(),StopAndDrawCommand=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.STOP_AND_DRAW}}],[{key:"Format",value:function(t){return"User "+t+" started to draw path"}}]),e}(),PlayerPointsAndPathsDTO=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).Points=i,t.Paths=n,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.POINTS_AND_PATHS}}],[{key:"Deserialize",value:function(t){var e='{ "Points": '.concat(t.Points||t.points,', "Paths": ').concat(t.Paths||t.paths," }");return JSON.parse(e)}}]),e}(),ApplicationUserSettings=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return _classCallCheck(this,e),(t=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this))).DesktopNotifications=i,t}return _inherits(e,DtoMsg),_createClass(e,[{key:"GetKind",value:function(){return CommandKindEnum.USER_SETTINGS}}],[{key:"Serialize",value:function(t){return JSON.stringify(t)}},{key:"Deserialize",value:function(t){return JSON.parse(t)}}]),e}(),CountdownTimer=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.countdownSeconds,n=void 0===i?60:i,s=e.labelSelector,o=void 0===s?null:s,r=e.initialStart,a=void 0!==r&&r,l=e.countdownReachedHandler,h=void 0===l?void 0:l;_classCallCheck(this,t),this.countdownSeconds=n,this.totalSeconds=this.countdownSeconds,this.timerID=-1,this.label=null,this.countdownReachedHandler=h,o&&(this.label=document.querySelector(o)),a&&this.Start()}return _createClass(t,[{key:"setTimeFunc",value:function(){--this.totalSeconds<=0?(this.Stop(),this.countdownReachedHandler&&this.countdownReachedHandler(this.label)):this.label&&(this.label.innerHTML=this.pad(parseInt(this.totalSeconds/60))+":"+this.pad(this.totalSeconds%60))}},{key:"pad",value:function(t){var e=t+"";return e.length<2?"0"+e:e}},{key:"Start",value:function(){this.Stop(),this.timerID=setInterval(this.setTimeFunc.bind(this),1e3)}},{key:"Stop",value:function(){this.timerID>0&&clearInterval(this.timerID),this.label&&(this.label.innerHTML="")}},{key:"Reset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.countdownSeconds,i=void 0===e?60:e,n=t.labelSelector,s=void 0===n?null:n,o=t.initialStart,r=void 0!==o&&o,a=t.countdownReachedHandler,l=void 0===a?void 0:a;this.countdownSeconds=i,this.totalSeconds=this.countdownSeconds,this.label=null,this.countdownReachedHandler=l,s&&(this.label=document.querySelector(s)),r&&this.Start()}}]),t}();function CountPointsDebug(t){var e="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='2']",display:"intercepted(P1:%s, "},{query:"circle[data-status='3']",display:"P2:%s)"}].forEach(function(t){var i=document.querySelectorAll(t.query);e+=t.display.replace("%s",i.length)}),document.querySelector(t).innerHTML="SVGs by tags: "+e}function LocalLog(t){console.log(t)}function LocalError(t){console.error(t)}var InkBallGame=function(){function t(e,i,n,s,o,r,a){var l,h=this,u=!(arguments.length>7&&void 0!==arguments[7])||arguments[7],c=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],m=arguments.length>9&&void 0!==arguments[9]?arguments[9]:{width:32,height:32},_=arguments.length>10&&void 0!==arguments[10]&&arguments[10],d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:60,S=arguments.length>12&&void 0!==arguments[12]?arguments[12]:125;(_classCallCheck(this,t),this.g_iGameID=null,this.g_iPlayerID=null,this.GameType=GameTypeEnum[a],this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="#DC143C",this.COLOR_OWNED_BLUE="#8A2BE2",this.DRAWING_PATH_COLOR="black",this.m_bIsWon=!1,this.m_bPointsAndPathsLoaded=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=S,this.m_Timer=null,this.m_ReconnectTimer=null,this.m_WaitStartTime=null,this.m_TimerOpts={countdownSeconds:d,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.m_iSlowdownLevel=0,this.m_iGridSizeX=0,this.m_iGridSizeY=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize=m,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_CancelPath=null,this.m_StopAndDraw=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=u,this.m_bIsPlayerActive=c,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=new Map,this.m_bViewOnly=_,this.m_MouseCursorOval=null,this.m_ApplicationUserSettings=null,null!==e&&""!==e)&&(this.g_SignalRConnection=(new signalR.HubConnectionBuilder).withUrl(e,{transport:s,accessTokenFactory:r}).withHubProtocol(n).configureLogging(i).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=o,this.g_SignalRConnection.onclose((l=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:null!=e&&(LocalError(e),h.m_Screen.style.cursor="not-allowed",h.iConnErrCount++,setTimeout(function(){return h.Connect()},4e3+h.iExponentialBackOffMillis*Math.max(h.iConnErrCount,5)));case 1:case"end":return t.stop()}},t)})),function(t){return l.apply(this,arguments)})))}return _createClass(t,[{key:"GetPlayerPointsAndPaths",value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.m_bPointsAndPathsLoaded){t.next=5;break}return t.next=3,this.g_SignalRConnection.invoke("GetPlayerPointsAndPaths",this.m_bViewOnly,this.g_iGameID).then(function(t){var e=PlayerPointsAndPathsDTO.Deserialize(t);return void 0!==e.Points&&this.SetAllPoints(e.Points),void 0!==e.Paths&&this.SetAllPaths2(e.Paths),this.m_bPointsAndPathsLoaded=!0,!0}.bind(this));case 3:t.next=6;break;case 5:return t.abrupt("return",!1);case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"Connect",value:function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,i,n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this.g_SignalRConnection.start();case 3:if(this.iConnErrCount=0,LocalLog("connected; iConnErrCount = "+this.iConnErrCount),!1!==this.m_bViewOnly){t.next=14;break}if(null!==sessionStorage.getItem("ApplicationUserSettings")){t.next=11;break}return t.next=9,this.g_SignalRConnection.invoke("GetUserSettings").then(function(t){if(LocalLog(t),t){t=ApplicationUserSettings.Deserialize(t);var e=ApplicationUserSettings.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",e)}return t}.bind(this)).then(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.m_ApplicationUserSettings=new ApplicationUserSettings(e.DesktopNotifications),t.next=3,this.GetPlayerPointsAndPaths();case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}().bind(this)).then(_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}},t)})));case 9:t.next=14;break;case 11:e=sessionStorage.getItem("ApplicationUserSettings"),i=ApplicationUserSettings.Deserialize(e),this.m_ApplicationUserSettings=new ApplicationUserSettings(i.DesktopNotifications);case 14:if(this.m_bPointsAndPathsLoaded){t.next=17;break}return t.next=17,this.GetPlayerPointsAndPaths();case 17:null!==this.m_ApplicationUserSettings&&!0===this.m_ApplicationUserSettings.DesktopNotifications&&this.SetupNotifications(),t.next=26;break;case 20:t.prev=20,t.t0=t.catch(0),LocalError(t.t0+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout(function(){return n.Connect()},4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5));case 26:case"end":return t.stop()}},t,this,[[0,20]])}));return function(){return t.apply(this,arguments)}}()},{key:"SetupNotifications",value:function(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then(function(t){return"granted"===t||(LocalLog("User blocked notifications."),!1)}).catch(function(t){return LocalError(t),!1}):(LocalLog("Browser does not support notifications."),!1)}},{key:"NotifyBrowser",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Hi there!",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"How are you doing?";return!!document.hidden&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:e,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then(function(i){return"granted"===i?(new Notification(t,{body:e,icon:"../img/homescreen.webp"}),!0):(LocalLog("User blocked notifications."),!1)}).catch(function(t){return LocalError(t),!1}):(LocalLog("Browser does not support notifications."),!1))}},{key:"StartSignalRConnection",value:function(t,e,i,n,s,o){null!==this.g_SignalRConnection&&(this.g_iGameID=t,this.g_iPlayerID=e,this.m_sMsgInputSel=o,this.m_sMsgSendButtonSel=s,this.m_bPointsAndPathsLoaded=!i,this.g_SignalRConnection.on("ServerToClientPoint",function(t){var e=this.m_Player2Name.innerHTML,i=InkBallPointViewModel.Format(e,t),s=document.createElement("li");s.textContent=i,document.querySelector(n).appendChild(s),this.ReceivedPointProcessing(t),this.NotifyBrowser("New Point",i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){var e=t,i=this.m_Player2Name.innerHTML,s=InkBallPathViewModel.Format(i,e),o=document.createElement("li");o.textContent=s,document.querySelector(n).appendChild(o),this.ReceivedPathProcessing(e),this.NotifyBrowser("New Path",s)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");var r=t,a=WinCommand.Format(r),l=document.createElement("li");l.textContent=a,document.querySelector(n).appendChild(l),this.ReceivedWinProcessing(r),this.NotifyBrowser("We have a winner",a)}}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(t){var e=PlayerJoiningCommand.Format(t),i=document.createElement("li");i.innerHTML='<strong class="text-primary">'.concat(e,"</strong>"),document.querySelector(n).appendChild(i),null!==this.m_SurrenderButton&&""!==t.OtherPlayerName&&(this.m_Player2Name.innerHTML=t.OtherPlayerName||t.otherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),this.NotifyBrowser("Player joininig",e),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(t){var e=PlayerSurrenderingCommand.Format(t),i=document.createElement("li");i.innerHTML='<strong class="text-warning">'.concat(e,"</strong>"),document.querySelector(n).appendChild(i),this.m_bHandlingEvent=!1,e=""===e?"Game interrupted!":e,this.NotifyBrowser("Game interruption",e),alert(e),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(t){var e=WinCommand.Format(t),i=document.createElement("li");i.innerHTML='<strong class="text-warning">'.concat(e,"</strong>"),document.querySelector(n).appendChild(i),this.ReceivedWinProcessing(t),this.NotifyBrowser("We have a winner",e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(t){var e=this.m_Player2Name.innerHTML,i=PingCommand.Format(e,t),s=document.createElement("li");s.textContent=i,document.querySelector(n).appendChild(s),this.NotifyBrowser("User Message",i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerDisconnected",function(t){var e={countdownSeconds:5,initialStart:!0,countdownReachedHandler:function(){var e=t,i=document.createElement("li");i.innerHTML='<strong class="text-warning">'.concat(e,"</strong>"),document.querySelector(n).appendChild(i),this.NotifyBrowser("User disconnected",e),this.m_ReconnectTimer=null}.bind(this)};this.m_ReconnectTimer?this.m_ReconnectTimer.Reset(e):this.m_ReconnectTimer=new CountdownTimer(e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerConnected",function(t){if(this.m_ReconnectTimer)this.m_ReconnectTimer.Stop(),this.m_ReconnectTimer=null;else{var e=t,i=document.createElement("li");i.innerHTML='<strong class="text-primary">'.concat(e,"</strong>"),document.querySelector(n).appendChild(i),this.NotifyBrowser("User disconnected",e),this.m_ReconnectTimer=null}}.bind(this)),this.g_SignalRConnection.on("ServerToClientStopAndDraw",function(t){if(t){var e=this.m_Player2Name.innerHTML,i=StopAndDrawCommand.Format(e),s=document.createElement("li");s.innerHTML='<strong class="text-info">'.concat(i,"</strong>"),document.querySelector(n).appendChild(s),this.NotifyBrowser("User "+e+" started drawing new path",i)}}.bind(this)),document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",function(t){t.preventDefault();var e=document.querySelector(this.m_sMsgInputSel).value.trim();if(""!==e){var i=new PingCommand(e);this.SendAsyncData(i)}}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1),this.Connect())}},{key:"StopSignalRConnection",value:function(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),this.m_ReconnectTimer&&this.m_ReconnectTimer.Stop(),this.m_Timer&&this.m_Timer.Stop(),LocalLog("Stopped SignalR connection"))}},{key:"Debug",value:function(){switch(arguments.length){case 1:this.m_Debug.innerHTML=arguments.length<=0?void 0:arguments[0];break;case 2:document.getElementById("debug"+(arguments.length<=1?void 0:arguments[1])).innerHTML=arguments.length<=0?void 0:arguments[0];break;default:for(var t=0;t<arguments.length;t++){var e=t<0||arguments.length<=t?void 0:arguments[t];if(e){var i=document.getElementById("debug"+t);i&&(i.innerHTML=e)}}}}},{key:"DisableSelection",value:function(t){void 0!==_typeof(t.onselectstart)?t.onselectstart=function(){return!1}:void 0!==_typeof(t.style.MozUserSelect)?t.style.MozUserSelect="none":t.onmousedown=function(){return!1}}},{key:"f_clientWidth",value:function(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}},{key:"f_clientHeight",value:function(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}},{key:"f_scrollLeft",value:function(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}},{key:"f_scrollTop",value:function(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}},{key:"f_filterResults",value:function(t,e,i){var n=t||0;return e&&(!n||n>e)&&(n=e),i&&(!n||n>i)?i:n}},{key:"SetPoint",value:function(t,e,i,n){if(!this.m_Points.has(e*this.m_iGridWidth+t)){var s,o=t*this.m_iGridSizeX,r=e*this.m_iGridSizeY,a=$createOval(this.m_PointRadius,"true");switch(a.$move(o,r,this.m_PointRadius),i){case StatusEnum.POINT_FREE_RED:s=this.COLOR_RED,a.$SetStatus(i);break;case StatusEnum.POINT_FREE_BLUE:s=this.COLOR_BLUE,a.$SetStatus(i);break;case StatusEnum.POINT_FREE:s=this.m_sDotColor,a.$SetStatus(i),console.warn("TODO: generic FREE point, really? change it!");break;case StatusEnum.POINT_STARTING:s=this.m_sDotColor,a.$SetStatus(i);break;case StatusEnum.POINT_IN_PATH:s=this.g_iPlayerID===n?!0===this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:!0===this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,a.$SetStatus(i);break;case StatusEnum.POINT_OWNED_BY_RED:s=this.COLOR_OWNED_RED,a.$SetStatus(i);break;case StatusEnum.POINT_OWNED_BY_BLUE:s=this.COLOR_OWNED_BLUE,a.$SetStatus(i);break;default:alert("bad point")}a.$SetFillColor(s),a.$SetStrokeColor(s),this.m_Points.set(e*this.m_iGridWidth+t,a)}}},{key:"SetAllPoints",value:function(t){var e=this;t.forEach(function(t){e.SetPoint(t[0],t[1],t[2],t[3])})}},{key:"SetPath",value:function(t,e,i){var n,s,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=t.split(" "),a="",l="",h=null,u=StatusEnum.POINT_STARTING,c=!0,m=!1,_=void 0;try{for(var d,S=r[Symbol.iterator]();!(c=(d=S.next()).done);c=!0){h=d.value.split(","),n=parseInt(h[0]),s=parseInt(h[1]),null!=(h=this.m_Points.get(s*this.m_iGridWidth+n))&&(h.$SetStatus(u),u=StatusEnum.POINT_IN_PATH),n*=this.m_iGridSizeX,s*=this.m_iGridSizeY,l+="".concat(a).concat(n,",").concat(s),a=" "}}catch(t){m=!0,_=t}finally{try{c||null==S.return||S.return()}finally{if(m)throw _}}h=r[0].split(","),n=parseInt(h[0]),s=parseInt(h[1]),null!=(h=this.m_Points.get(s*this.m_iGridWidth+n))&&h.$SetStatus(u),n*=this.m_iGridSizeX,s*=this.m_iGridSizeY,l+="".concat(a).concat(n,",").concat(s);var y=$createPolyline(3,l,i?this.m_sDotColor:e?this.COLOR_BLUE:this.COLOR_RED);y.$SetID(o),this.m_Lines.push(y)}},{key:"SetAllPaths2",value:function(t){var e=this;t.forEach(function(t){if(t.iGameId!==e.g_iGameID)throw new Error("Bad game from path!");e.SetPath(t.PointsAsString,e.m_bIsPlayingWithRed,t.iPlayerId===e.g_iPlayerID,t.iId)})}},{key:"IsPointBelongingToLine",value:function(t,e,i){var n=!0,s=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var l=r.value.split(","),h=l[0],u=l[1];if(h===e&&u===i)return!0}}catch(t){s=!0,o=t}finally{try{n||null==a.return||a.return()}finally{if(s)throw o}}return!1}},{key:"pnpoly",value:function(t,e,i,n,s){var o,r,a=!1;for(o=0,r=t-1;o<t;r=o++)(i[o]<=s&&s<i[r]||i[r]<=s&&s<i[o])&&n<(e[r]-e[o])*(s-i[o])/(i[r]-i[o])+e[o]&&(a=!a);return a}},{key:"pnpoly2",value:function(t,e,i){var n,s,o=t.length,r=!1;for(n=0,s=o-1;n<o;s=n++){var a=t[n],l=t[s];(a.y<=i&&i<l.y||l.y<=i&&i<a.y)&&e<(l.x-a.x)*(i-a.y)/(l.y-a.y)+a.x&&(r=!r)}return r}},{key:"SurroundOponentPoints",value:function(){var t=this.m_Line.$GetPointsArray();if(hasDuplicates(t.slice(0,-1).map(function(t){return t.x+"_"+t.y}))||t[0].x!==t[t.length-1].x||t[0].y!==t[t.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};var e,i,n=this.m_sDotColor===this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,s=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,o=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,r="",a="",l="",h=[],u=!0,c=!1,m=void 0;try{for(var _,d=this.m_Points.values()[Symbol.iterator]();!(u=(_=d.next()).done);u=!0){var S=_.value;if(void 0!==S&&S.$GetFillColor()===n&&(S.$GetStatus()===StatusEnum.POINT_FREE_BLUE||S.$GetStatus()===StatusEnum.POINT_FREE_RED)){var y=S.$GetPosition();e=y.x,i=y.y,!1!==this.pnpoly2(t,e,i)&&(e/=this.m_iGridSizeX,i/=this.m_iGridSizeY,a+="".concat(l).concat(e,",").concat(i),l=" ",h.push({point:S,revertStatus:S.$GetStatus(),revertFillColor:S.$GetFillColor(),revertStrokeColor:S.$GetStrokeColor()}),S.$SetStatus(s,!0),S.$SetFillColor(o),S.$SetStrokeColor(o))}}}catch(t){c=!0,m=t}finally{try{u||null==d.return||d.return()}finally{if(c)throw m}}return""!==a&&(r=t.map(function(t){return e=t.x,i=t.y,null===e||null===i?"":(e/=this.m_iGridSizeX,i/=this.m_iGridSizeY,"".concat(e,",").concat(i))}.bind(this)).join(" ")),{OwnedPoints:h,owned:a,PathPoints:[],path:r,errorDesc:"No surrounded points"}}},{key:"IsPointOutsideAllPaths",value:function(t,e){var i=t*this.m_iGridSizeX,n=e*this.m_iGridSizeY,s=!0,o=!1,r=void 0;try{for(var a,l=this.m_Lines[Symbol.iterator]();!(s=(a=l.next()).done);s=!0){var h=a.value.$GetPointsArray();if(!1!==this.pnpoly2(h,i,n))return!1}}catch(t){o=!0,r=t}finally{try{s||null==l.return||l.return()}finally{if(o)throw r}}return!0}},{key:"CreateXMLWaitForPlayerRequest",value:function(){}},{key:"CreateXMLPutPointRequest",value:function(t,e){return new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,t,e,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0)}},{key:"CreateXMLPutPathRequest",value:function(t){return new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,t.path,t.owned)}},{key:"SendAsyncData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;switch(t.GetKind()){case CommandKindEnum.POINT:LocalLog(InkBallPointViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",t).then(function(t){this.ReceivedPointProcessing(t)}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==e&&e()}.bind(this));break;case CommandKindEnum.PATH:LocalLog(InkBallPathViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",t).then(function(t){if(Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(t,"winningPlayerId")){var e=t;this.ReceivedWinProcessing(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(t,"pointsAsString"))throw new Error("ClientToServerPath bad GetKind!");var i=t;this.ReceivedPathProcessing(i)}}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==e&&e()}.bind(this));break;case CommandKindEnum.PING:this.g_SignalRConnection.invoke("ClientToServerPing",t).then(function(){document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}.bind(this)).catch(function(t){LocalError(t.toString())});break;case CommandKindEnum.STOP_AND_DRAW:this.g_SignalRConnection.invoke("ClientToServerStopAndDraw",t).then(function(){this.m_bDrawLines=!0,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!0,this.m_StopAndDraw.disabled="disabled"}.bind(this)).catch(function(t){LocalError(t.toString())});break;default:LocalError("unknown object")}}},{key:"CountDownReachedHandler",value:function(t){t&&(t.innerHTML=""),this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",this.m_Timer=null,this.m_bIsPlayerActive=!1}},{key:"ReceivedPointProcessing",value:function(t){var e=t.iX,i=t.iY,n=t.Status||t.status;this.SetPoint(e,i,n,t.iPlayerId),this.g_iPlayerID!==t.iPlayerId?(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&this.OnCancelClick(),this.m_StopAndDraw.disabled="",this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)):(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_CancelPath.disabled="disabled",this.m_StopAndDraw.disabled="",this.m_StopAndDraw.value="Stop and Draw",this.m_Timer?this.m_Timer.Reset(this.m_TimerOpts):this.m_Timer=new CountdownTimer(this.m_TimerOpts)),this.m_bHandlingEvent=!1}},{key:"ReceivedPathProcessing",value:function(t){if(this.g_iPlayerID!==t.iPlayerId){var e=t.PointsAsString||t.pointsAsString,i=t.OwnedPointsAsString||t.ownedPointsAsString;this.SetPath(e,this.m_sDotColor===this.COLOR_RED,!1,t.iId);var n=i.split(" "),s=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,o=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,r=!0,a=!1,l=void 0;try{for(var h,u=n[Symbol.iterator]();!(r=(h=u.next()).done);r=!0){var c=h.value.split(","),m=parseInt(c[0]),_=parseInt(c[1]);void 0!==(c=this.m_Points.get(_*this.m_iGridWidth+m))&&(c.$SetStatus(s),c.$SetFillColor(o),c.$SetStrokeColor(o))}}catch(t){a=!0,l=t}finally{try{r||null==u.return||u.return()}finally{if(a)throw l}}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&this.OnCancelClick(),this.m_StopAndDraw.disabled=""}else{var d=this.m_Line.$GetPointsArray(),S=d[0].x,y=d[0].y;S/=this.m_iGridSizeX,y/=this.m_iGridSizeY;var g=this.m_Points.get(y*this.m_iGridWidth+S);void 0!==g&&g.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_Line.$SetWidthAndColor(3,this.m_sDotColor),this.m_Line.$SetID(t.iId),this.m_Lines.push(this.m_Line),this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled"}this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_bHandlingEvent=!1,this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)}},{key:"ReceivedWinProcessing",value:function(t){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;var e=WinCommand.Format(t),i=t.Status||t.status,n=t.WinningPlayerId||t.winningPlayerId;((i===WinStatusEnum.RED_WINS||i===WinStatusEnum.GREEN_WINS)&&n>0||i===WinStatusEnum.DRAW_WIN)&&(alert(""===e?"Game won!":e),window.location.href="Games")}},{key:"Check4Win",value:function(t,e,i,n){var s;switch(this.GameType){case GameTypeEnum.FIRST_CAPTURE:return t.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:e.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_CAPTURES:return s=this.m_bIsPlayingWithRed?StatusEnum.POINT_OWNED_BY_BLUE:StatusEnum.POINT_OWNED_BY_RED,n.filter(function(t){return null!==t.iEnclosingPathId&&t.$GetStatus()===s}).length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:(s=this.m_bIsPlayingWithRed?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,i.filter(function(t){return null!==t.iEnclosingPathId&&t.$GetStatus()===s}).length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_PATHS:return e.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:t.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_ADVANTAGE_PATHS:var o=t.length-e.length;return o>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:o<=-5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;default:throw new Error("Wrong game type")}}},{key:"ShowMobileStatus",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";"???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_GameStatus.style.color=this.COLOR_RED,null!==t&&""!==t?this.Debug(t,0):this.Debug("",0)}},{key:"OnMouseMove",value:function(t){var e=this;if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)this.iConnErrCount<=0&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait");else{var i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,n=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;i=parseInt(i/this.m_iGridSizeX),n=parseInt(n/this.m_iGridSizeY);var s=i*this.m_iGridSizeX,o=n*this.m_iGridSizeY;if(this.m_MouseCursorOval.$move(s,o,this.m_PointRadius),this.m_MouseCursorOval.$Show(),this.Debug("[".concat(i,",").concat(n,"]"),1),this.m_bDrawLines){if(null!==this.m_Line?this.m_Screen.style.cursor="move":this.m_Screen.style.cursor="crosshair",!0===this.m_bMouseDown&&(this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){var r=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),a=this.m_Points.get(n*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.$GetLength()>=2?"":"disabled",void 0!==r&&void 0!==a&&r.$GetFillColor()===this.m_sDotColor&&a.$GetFillColor()===this.m_sDotColor){var l=this.m_Line.$ContainsPoint(s,o);if(l<1&&a.$GetStatus()!==StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(s,o,this.m_iGridSizeX))a.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n;else if(1===l&&a.$GetStatus()===StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(s,o,this.m_iGridSizeX)){var h=this.SurroundOponentPoints();h.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(h),function(){e.OnCancelClick(),h.OwnedPoints.forEach(function(t){var e=t.point,i=t.revertFillColor,n=t.revertStrokeColor;e.$RevertOldStatus(),e.$SetFillColor(i),e.$SetStrokeColor(n)}),e.m_bHandlingEvent=!1})):this.Debug("".concat(h.errorDesc?h.errorDesc:"Wrong path",", cancell it or refresh page"),0),this.m_iLastX=i,this.m_iLastY=n}else l>=1&&r.$GetStatus()===StatusEnum.POINT_IN_PATH&&this.m_Line.$GetPointsString().endsWith("".concat(this.m_iLastX*this.m_iGridSizeX,",").concat(this.m_iLastY*this.m_iGridSizeY))&&(this.m_Line.$GetLength()>2?(r.$RevertOldStatus(),this.m_Line.$RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=n):this.OnCancelClick())}}else{var u=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),c=this.m_Points.get(n*this.m_iGridWidth+i);if(void 0!==u&&void 0!==c&&u.$GetFillColor()===this.m_sDotColor&&c.$GetFillColor()===this.m_sDotColor){var m=this.m_iLastX*this.m_iGridSizeX,_=this.m_iLastY*this.m_iGridSizeY;this.m_Line=$createPolyline(6,m+","+_+" "+s+","+o,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",u.$SetStatus(StatusEnum.POINT_STARTING,!0),c.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n}}}else this.m_Screen.style.cursor="crosshair"}}},{key:"OnMouseDown",value:function(t){var e=this;if(this.m_bIsPlayerActive&&"???"!==this.m_Player2Name.innerHTML&&!0!==this.m_bHandlingEvent&&!(this.iConnErrCount>0)){var i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,n=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;if(i=this.m_iMouseX=parseInt(i/this.m_iGridSizeX),n=this.m_iMouseY=parseInt(n/this.m_iGridSizeY),this.m_bMouseDown=!0,this.m_bDrawLines){if((this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){var s=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),o=this.m_Points.get(n*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.$GetLength()>=2?"":"disabled",void 0!==s&&void 0!==o&&s.$GetFillColor()===this.m_sDotColor&&o.$GetFillColor()===this.m_sDotColor){var r=i*this.m_iGridSizeX,a=n*this.m_iGridSizeY,l=this.m_Line.$ContainsPoint(r,a);if(l<1&&o.$GetStatus()!==StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(r,a,this.m_iGridSizeX))o.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n;else if(1===l&&o.$GetStatus()===StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(r,a,this.m_iGridSizeX)){var h=this.SurroundOponentPoints();h.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(h),function(){e.OnCancelClick(),h.OwnedPoints.forEach(function(t){var e=t.point,i=t.revertFillColor,n=t.revertStrokeColor;e.$RevertOldStatus(),e.$SetFillColor(i),e.$SetStrokeColor(n)}),e.m_bMouseDown=!1,e.m_bHandlingEvent=!1})):this.Debug("".concat(h.errorDesc?h.errorDesc:"Wrong path",", cancell it or refresh page"),0),this.m_iLastX=i,this.m_iLastY=n}else l>=1&&s.$GetStatus()===StatusEnum.POINT_IN_PATH&&this.m_Line.$GetPointsString().endsWith("".concat(this.m_iLastX*this.m_iGridSizeX,",").concat(this.m_iLastY*this.m_iGridSizeY))&&(this.m_Line.$GetLength()>2?(s.$RevertOldStatus(),this.m_Line.$RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=n):this.OnCancelClick())}}else{var u=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),c=this.m_Points.get(n*this.m_iGridWidth+i);if(void 0!==u&&void 0!==c&&u.$GetFillColor()===this.m_sDotColor&&c.$GetFillColor()===this.m_sDotColor){var m=this.m_iLastX*this.m_iGridSizeX,_=this.m_iLastY*this.m_iGridSizeY,d=i*this.m_iGridSizeX,S=n*this.m_iGridSizeY;this.m_Line=$createPolyline(6,m+","+_+" "+d+","+S,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",u.$SetStatus(StatusEnum.POINT_STARTING,!0),c.$SetStatus(StatusEnum.POINT_IN_PATH,!0)}this.m_iLastX=i,this.m_iLastY=n}else if(this.m_iLastX<0||this.m_iLastY<0){var y=this.m_Points.get(n*this.m_iGridWidth+i);void 0!==y&&y.$GetFillColor()===this.m_sDotColor&&(this.m_iLastX=i,this.m_iLastY=n)}}else{this.m_iLastX=i,this.m_iLastY=n;var g=i,v=n;if(i=g*this.m_iGridSizeX,n=v*this.m_iGridSizeY,void 0!==this.m_Points.get(v*this.m_iGridWidth+g))return void this.Debug("Wrong point - already existing",0);if(!this.IsPointOutsideAllPaths(g,v))return void this.Debug("Wrong point, Point is not outside all paths",0);this.SendAsyncData(this.CreateXMLPutPointRequest(g,v),function(){e.m_bMouseDown=!1,e.m_bHandlingEvent=!1})}}}},{key:"OnMouseUp",value:function(){this.m_bMouseDown=!1}},{key:"OnMouseLeave",value:function(){this.m_MouseCursorOval.$Hide()}},{key:"OnStopAndDraw",value:function(t){if(this.m_Timer)null===this.m_Line&&this.SendAsyncData(new StopAndDrawCommand);else{null!==this.m_Line&&this.OnCancelClick(),this.m_bDrawLines=!this.m_bDrawLines;var e=t.target;this.m_bDrawLines?e.value="Draw dot":e.value="Draw line",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}}},{key:"OnCancelClick",value:function(){if(this.m_bDrawLines){if(null!==this.m_Line){var t=this.m_Line.$GetPointsArray();this.m_CancelPath.disabled="disabled";var e=!0,i=!1,n=void 0;try{for(var s,o=t[Symbol.iterator]();!(e=(s=o.next()).done);e=!0){var r=s.value,a=r.x,l=r.y;if(null!==a&&null!==l){a/=this.m_iGridSizeX,l/=this.m_iGridSizeY;var h=this.m_Points.get(l*this.m_iGridWidth+a);void 0!==h&&h.$RevertOldStatus()}}}catch(t){i=!0,n=t}finally{try{e||null==o.return||o.return()}finally{if(i)throw n}}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1,this.m_Timer&&(this.m_StopAndDraw.disabled="disabled"),this.Debug("",0)}}},{key:"PrepareDrawing",value:function(t,e,i,n,s,o,r){var a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:125;if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=a,this.m_Timer=null,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=new Map,this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(e),this.m_GameStatus=document.querySelector(i),this.m_SurrenderButton=document.querySelector(n),this.m_CancelPath=document.querySelector(s),this.m_StopAndDraw=document.querySelector(r),this.m_Screen=document.querySelector(t),this.m_Screen){this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop,this.m_Screen.style.width="calc(1em * ".concat(this.m_BoardSize.width,")"),this.m_Screen.style.height="calc(1em * ".concat(this.m_BoardSize.height,")");var l=this.m_Screen.clientWidth,h=this.m_Screen.clientHeight;this.m_iGridSizeX=parseInt(Math.ceil(l/this.m_BoardSize.width)),this.m_iGridSizeY=parseInt(Math.ceil(h/this.m_BoardSize.height)),this.m_iGridWidth=parseInt(Math.ceil(l/this.m_iGridSizeX)),this.m_iGridHeight=parseInt(Math.ceil(h/this.m_iGridSizeY)),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),this.m_bViewOnly?document.querySelector(o).innerHTML="back to Game List":(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$SetStrokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1),this.m_MouseCursorOval.$Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),this.m_StopAndDraw.onclick=this.OnStopAndDraw.bind(this),document.querySelector(this.m_sMsgInputSel).disabled="",this.m_SurrenderButton.disabled="","???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_StopAndDraw.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"),this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line"))}else alert("no board")}}]),t}();