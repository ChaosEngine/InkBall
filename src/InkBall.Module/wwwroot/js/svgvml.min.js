"use strict";let SVG=!1;const svgNS="http://www.w3.org/2000/svg";let $createOval,$createPolyline,$RemovePolyline,$RemoveOval,$createSVGVML,$createLine,PointStore,PathStore,svgAntialias=!1,cont=null;if(document.createElementNS){SVG=null!==document.createElementNS(svgNS,"svg").x}function hasDuplicates(t){return new Set(t).size!==t.length}function sortPointsClockwise(t){const e=t.reduce((t,{x:e,y:n})=>(t.x+=e,t.y+=n,t),{x:0,y:0});e.x/=t.length,e.y/=t.length;return t.map(({x:t,y:n})=>({x:t,y:n,angle:180*Math.atan2(n-e.y,t-e.x)/Math.PI})).sort((t,e)=>t.angle-e.angle)}SVG?($createSVGVML=function(t,e,n,r){return cont=document.createElementNS(svgNS,"svg"),t.appendChild(cont),svgAntialias=r,cont},$createLine=function(t,e,n){const r=document.createElementNS(svgNS,"line");return r.setAttribute("shape-rendering",svgAntialias?"auto":"optimizeSpeed"),r.setAttribute("stroke-width",Math.round(t)+"px"),e&&r.setAttribute("stroke",e),n&&r.setAttribute("stroke-linecap",n),r.$move=function(t,e,n,r){this.setAttribute("x1",t),this.setAttribute("y1",e),this.setAttribute("x2",n),this.setAttribute("y2",r)},r.$RGBcolor=function(t,e,n){this.setAttribute("stroke","rgb("+Math.round(t)+","+Math.round(e)+","+Math.round(n)+")")},r.$SetColor=function(t){this.setAttribute("stroke",t)},r.$strokeWidth=function(t){this.setAttribute("stroke-width",Math.round(t)+"px")},cont.appendChild(r),r},$createPolyline=function(t,e,n){const r=document.createElementNS(svgNS,"polyline");return r.setAttribute("shape-rendering",svgAntialias?"auto":"optimizeSpeed"),r.setAttribute("stroke-width",Math.round(t)),n&&r.setAttribute("stroke",n),r.setAttribute("fill",n),r.setAttribute("fill-opacity","0.1"),e&&r.setAttribute("points",e),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round"),cont.appendChild(r),r.setAttribute("data-id",0),r.$AppendPoints=function(t,e,n=16){const r=this.getAttribute("points"),o=r.split(" ");if(!0===hasDuplicates(o))return!1;let i;if(o.length<=1||2!==(i=o[o.length-1].split(",")).length)return!1;const s=parseInt(i[0]),a=parseInt(i[1]),u=parseInt(t),c=parseInt(e);return Math.abs(s-u)<=n&&Math.abs(a-c)<=n&&(this.setAttribute("points",r+` ${t},${e}`),!0)},r.$RemoveLastPoint=function(){const t=this.getAttribute("points").replace(/(\s\d+,\d+)$/,"");return this.setAttribute("points",t),t},r.$ContainsPoint=function(t,e){const n=new RegExp(`${t},${e}`,"g");return(this.getAttribute("points").match(n)||[]).length},r.$GetPointsString=function(){return this.getAttribute("points")},r.$GetPointsArray=function(){return this.getAttribute("points").split(" ").map((function(t){const e=t.split(",");return{x:parseInt(e[0]),y:parseInt(e[1])}}))},r.$SetPoints=function(t){this.setAttribute("points",t)},r.$GetIsClosed=function(){const t=this.getAttribute("points").split(" ");return t[0]===t[t.length-1]},r.$GetLength=function(){return this.getAttribute("points").split(" ").length},r.$SetWidthAndColor=function(t,e){this.setAttribute("stroke",e),this.setAttribute("fill",e),this.setAttribute("stroke-width",Math.round(t))},r.$GetID=function(){return parseInt(this.getAttribute("data-id"))},r.$SetID=function(t){this.setAttribute("data-id",t)},r.$GetFillColor=function(){return this.getAttribute("fill")},r},$createOval=function(t){const e=document.createElementNS(svgNS,"circle");return e.setAttribute("shape-rendering",svgAntialias?"auto":"optimizeSpeed"),e.setAttribute("stroke-width",0),e.setAttribute("r",Math.round(t>>1)),e.setAttribute("data-status",-1),e.$move=function(t,e,n){this.setAttribute("cx",t),this.setAttribute("cy",e),this.setAttribute("r",Math.round(n))},e.$GetStrokeColor=function(){return this.getAttribute("stroke")},e.$SetStrokeColor=function(t){this.setAttribute("stroke",t)},e.$GetPosition=function(){return{x:this.getAttribute("cx"),y:this.getAttribute("cy")}},e.$GetFillColor=function(){return this.getAttribute("fill")},e.$SetFillColor=function(t){this.setAttribute("fill",t)},e.$GetStatus=function(){return parseInt(this.getAttribute("data-status"))},e.$SetStatus=function(t,e=!1){if(e){const e=parseInt(this.getAttribute("data-status"));this.setAttribute("data-status",t),-1!==e&&e!==t&&this.setAttribute("data-old-status",e)}else this.setAttribute("data-status",t)},e.$RevertOldStatus=function(){const t=this.getAttribute("data-old-status");return t?(this.removeAttribute("data-old-status"),this.setAttribute("data-status",t),parseInt(t)):-1},e.$GetZIndex=function(){return this.getAttribute("z-index")},e.$SetZIndex=function(t){this.setAttribute("z-index",t)},e.$Hide=function(){this.setAttribute("visibility","hidden")},e.$Show=function(){this.setAttribute("visibility","visible")},e.$strokeWeight=function(t){this.setAttribute("stroke-width",t)},cont.appendChild(e),e},$RemoveOval=function(t){cont.removeChild(t)},$RemovePolyline=function(t){cont.removeChild(t)}):document.createStyleSheet?($createSVGVML=function(t,e,n,r){document.namespaces.add("v","urn:schemas-microsoft-com:vml");const o=document.createStyleSheet();return o.addRule("v\\:*","behavior: url(#default#VML);"),o.addRule("v\\:*","antialias: "+r+";"),cont=t,t},$createLine=function(t,e,n){const r=document.createElement("v:line");if(r.strokeweight=Math.round(t)+"px",e&&(r.strokecolor=e),r.$move=function(t,e,n,r){this.to=t+","+e,this.from=n+","+r},r.$RGBcolor=function(t,e,n){this.strokecolor="rgb("+Math.round(t)+","+Math.round(e)+","+Math.round(n)+")"},r.$SetColor=function(t){this.strokecolor=t},r.$strokeWidth=function(t){this.strokeweight=Math.round(t)+"px"},n){let t=document.createElement("v:stroke");t.endcap=n,r.appendChild(t)}return cont.appendChild(r),r},$createPolyline=function(t,e,n){const r=document.createElement("v:polyline");r.strokeweight=Math.round(t)+"px",n&&(r.strokecolor=n),r.points=e;let o=document.createElement("v:fill");return o.color=n,o.opacity=.1,r.appendChild(o),cont.appendChild(r),r.setAttribute("data-id",0),r.$AppendPoints=function(t,e,n=16){const r=this.points.value,o=r.split(" ");if(!0===hasDuplicates(o))return!1;let i;if(o.length<=1||2!==(i=o[o.length-1].split(",")).length)return!1;const s=parseInt(i[0]),a=parseInt(i[1]),u=parseInt(t),c=parseInt(e);return Math.abs(s-u)<=n&&Math.abs(a-c)<=n&&(this.points.value=r+` ${t},${e}`,!0)},r.$RemoveLastPoint=function(){const t=this.points.value.replace(/(\s\d+,\d+)$/,"");return this.points.value=t,t},r.$ContainsPoint=function(t,e){const n=new RegExp(`${t},${e}`,"g");return(this.points.value.match(n)||[]).length},r.$GetPointsString=function(){return r.points.value},r.$GetPointsArray=function(){return this.points.value.split(" ").map((function(t){const e=t.split(",");return{x:parseInt(e[0]),y:parseInt(e[1])}}))},r.$SetPoints=function(t){this.points.value=t},r.$GetIsClosed=function(){const t=this.points.value.split(" ");return t[0]===t[t.length-1]},r.$GetLength=function(){return this.points.value.split(" ").length},r.$SetWidthAndColor=function(t,e){this.strokecolor=e,this.fill.color=e,this.strokeweight=Math.round(t)+"px"},r.$GetID=function(){return parseInt(this.getAttribute("data-id"))},r.$SetID=function(t){this.setAttribute("data-id",t)},r.$GetFillColor=function(){return this.fill.color},r},$createOval=function(t,e){const n=document.createElement("v:oval");return n.style.position="absolute",n.setAttribute("data-status",-1),n.strokeweight=1,n.filled=e,n.style.width=t+"px",n.style.height=t+"px",n.$move=function(t,e,n){this.style.left=Math.round(t-n)+"px",this.style.top=Math.round(e-n)+"px",this.style.width=Math.round(2*n)+"px",this.style.height=Math.round(2*n)+"px"},n.$GetStrokeColor=function(){return this.strokecolor},n.$SetStrokeColor=function(t){this.strokecolor=t},n.$GetPosition=function(){return{x:parseInt(this.style.left)+.5*parseInt(this.style.width),y:parseInt(this.style.top)+.5*parseInt(this.style.height)}},n.$GetFillColor=function(){return this.fillcolor},n.$SetFillColor=function(t){this.fillcolor=t},n.$GetStatus=function(){return parseInt(this.getAttribute("data-status"))},n.$SetStatus=function(t,e=!1){if(e){const e=parseInt(this.getAttribute("data-status"));this.setAttribute("data-status",t),-1!==e&&e!==t&&this.setAttribute("data-old-status",e)}else this.setAttribute("data-status",t)},n.$RevertOldStatus=function(){const t=this.getAttribute("data-old-status");return t?(this.removeAttribute("data-old-status"),this.setAttribute("data-status",t),parseInt(t)):-1},n.$GetZIndex=function(){return this.getAttribute("z-index")},n.$SetZIndex=function(t){this.setAttribute("z-index",t)},n.$Hide=function(){this.setAttribute("visibility","hidden")},n.$Show=function(){this.setAttribute("visibility","visible")},n.$strokeWeight=function(t){this.strokeweight=t},cont.appendChild(n),n},$RemoveOval=function(t){cont.removeChild(t)},$RemovePolyline=function(t){cont.removeChild(t)}):$createSVGVML=function(){return alert("SVG or VML is not supported!"),!1};const DB_NAME="InkballGame",DB_POINT_STORE="points",DB_PATH_STORE="paths",DB_STATE_STORE="state",DB_VERSION=1;let g_DB;async function OpenDb(){return console.log("OpenDb ..."),new Promise((t,e)=>{let n=indexedDB.open(DB_NAME,1);n.onsuccess=function(){g_DB=this.result,console.log("OpenDb DONE"),t(this.result)},n.onerror=function(t){console.error("OpenDb:",t.target.errorCode),e()},n.onupgradeneeded=function(t){console.log("OpenDb.onupgradeneeded");const e=Array.from(t.currentTarget.result.objectStoreNames);e.includes("points")&&t.currentTarget.result.deleteObjectStore("points"),e.includes("paths")&&t.currentTarget.result.deleteObjectStore("paths"),e.includes("state")&&t.currentTarget.result.deleteObjectStore("state");const n=t.currentTarget.result.createObjectStore("points",{autoIncrement:!1});n.createIndex("Status","Status",{unique:!1}),n.createIndex("Color","Color",{unique:!1});t.currentTarget.result.createObjectStore("paths",{autoIncrement:!1}).createIndex("iPlayerId","iPlayerId",{unique:!1});t.currentTarget.result.createObjectStore("state",{autoIncrement:!1})}})}function GetObjectStore(t,e){return g_DB.transaction(t,e).objectStore(t)}async function ClearObjectStore(t){return new Promise((e,n)=>{let r=GetObjectStore(t,"readwrite").clear();r.onsuccess=function(){e()},r.onerror=function(t){console.error("clearObjectStore:",t.target.errorCode),n()}})}async function GetPoint(t){return new Promise((e,n)=>{const r=GetObjectStore("points","readonly").get(t);r.onerror=function(t){n(new Error("GetPoint => "+t))},r.onsuccess=function(t){e(t.target.result)}})}async function GetAllPoints(){return new Promise((t,e)=>{const n=GetObjectStore("points","readonly").getAll();n.onsuccess=function(e){t(e.target.result)},n.onerror=function(t){e(new Error("GetAllPoints => "+t))}})}async function GetState(t){return new Promise((e,n)=>{const r=GetObjectStore("state","readonly").get(t);r.onerror=function(t){n(new Error("GetState => "+t))},r.onsuccess=function(t){e(t.target.result)}})}async function GetPath(t){return new Promise((e,n)=>{const r=GetObjectStore("paths","readonly").get(t);r.onerror=function(t){n(new Error("GetPath => "+t))},r.onsuccess=function(t){e(t.target.result)}})}async function GetAllPaths(){return new Promise((t,e)=>{const n=GetObjectStore("paths","readonly").getAll();n.onsuccess=function(e){t(e.target.result)},n.onerror=function(t){e(new Error("GetAllPaths => "+t))}})}async function StorePoint(t,e){return new Promise((n,r)=>{const o=e.$GetPosition(),i=e.$GetFillColor(),s={x:o.x/16,y:o.y/16,Status:e.$GetStatus(),Color:i},a=GetObjectStore("points","readwrite");let u;try{u=a.add(s,t)}catch(t){throw"DataCloneError"==t.name&&console.error("This engine doesn't know how to clone a Blob, use Firefox"),t}u.onsuccess=function(){n()},u.onerror=function(){console.error("StorePoint error",this.error),r()}})}async function StoreState(t,e){return new Promise((n,r)=>{const o={iGameID:e.g_iGameID,iPlayerID:e.g_iPlayerID,iOtherPlayerId:e.m_iOtherPlayerId,sLastMoveGameTimeStamp:e.m_sLastMoveGameTimeStamp},i=GetObjectStore("state","readwrite");let s;try{s=i.add(o,t)}catch(t){throw"DataCloneError"==t.name&&console.error("This engine doesn't know how to clone a Blob, use Firefox"),t}s.onsuccess=function(){n()},s.onerror=function(){console.error("StoreState error",this.error),r()}})}async function StorePath(t,e){return new Promise((n,r)=>{const o={Color:e.$GetFillColor(),PointsAsString:e.$GetPointsString()},i=GetObjectStore("paths","readwrite");let s;try{s=i.add(o,t)}catch(t){throw"DataCloneError"==t.name&&console.error("This engine doesn't know how to clone a Blob, use Firefox"),t}s.onsuccess=function(){n()},s.onerror=function(){console.error("StorePath error",this.error),r()}})}function DeletePublicationFromBib(t){console.log("deletePublicationFromBib:",arguments);let e=GetObjectStore("points","readwrite"),n=e.index("pos");n.get(t).onsuccess=function(t){void 0!==t.target.result?DeletePublication(t.target.result.id,e):console.error("No matching record found")},n.onerror=function(t){console.error("deletePublicationFromBib:",t.target.errorCode)}}function DeletePublication(t,e){console.log("deletePublication:",arguments),void 0===e&&(e=GetObjectStore("points","readwrite"));let n=e.get(t);n.onsuccess=function(r){let o=r.target.result;console.log("record:",o),void 0!==o?(n=e.delete(t),n.onsuccess=function(t){console.log("evt:",t),console.log("evt.target:",t.target),console.log("evt.target.result:",t.target.result),console.log("delete successful"),console.log("Deletion successful")},n.onerror=function(t){console.error("deletePublication:",t.target.errorCode)}):console.error("No matching record found")},n.onerror=function(t){console.error("deletePublication:",t.target.errorCode)}}class SimplePointStore{constructor(){}async PrepareStore(){this.store=new Map}async has(t){return this.store.has(t)}async set(t,e){return this.store.set(t,e)}async get(t){return this.store.get(t)}async values(){return this.store.values()}}class IDBPointStore extends SimplePointStore{constructor(){super()}async PrepareStore(t){g_DB||await OpenDb(),t.CreateScreenPointFromIndexedDb&&(this.PointCreationCallback=t.CreateScreenPointFromIndexedDb.bind(t));const e=await GetState(t.g_iGameID);if(e){if(e.sLastMoveGameTimeStamp!==t.m_sLastMoveGameTimeStamp)await ClearObjectStore("points"),await ClearObjectStore("paths"),await ClearObjectStore("state");else if(t.m_bPointsAndPathsLoaded=!0,this.PointCreationCallback){const t=await this.values();for(const e of t){this.PointCreationCallback(e.x,e.y,e.Status,e.Color)}}}else await ClearObjectStore("points"),await ClearObjectStore("paths"),await ClearObjectStore("state"),await StoreState(t.g_iGameID,t)}async has(t){const e=await GetPoint(t);return null!=e}async set(t,e){await StorePoint(t,e)}async get(t){const e=await GetPoint(t);if(e&&this.PointCreationCallback){return this.PointCreationCallback(e.x,e.y,e.Status,e.Color)}return null}async values(){return await GetAllPoints()}}class SimplePathStore{constructor(){this.store=[]}push(t){return this.store.push(t)}all(){return this.store}}class IDBPathStore extends SimplePathStore{constructor(){super()}async PrepareStore(t){t.CreateScreenPathFromIndexedDb&&(this.PathCreationCallback=t.CreateScreenPathFromIndexedDb.bind(t))}async push(t){await StorePath(t.$GetID(),t)}async all(){return await GetAllPaths()}}"indexedDB"in window?(PointStore=IDBPointStore,PathStore=IDBPathStore):(console.log("This browser doesn't support IndexedDB"),PointStore=SimplePointStore,PathStore=SimplePathStore);export{$createOval,$createPolyline,$RemovePolyline,$RemoveOval,$createSVGVML,$createLine,hasDuplicates,sortPointsClockwise,PointStore,PathStore};