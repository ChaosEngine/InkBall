"use strict";let t,i,e,s,n,o,a,r,h;const l=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),c=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),d=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class u{GetKind(){throw new Error("missing GetKind implementation!")}}class S extends u{constructor(t=0,i=0,e=0,n=0,o=s.POINT_FREE,a=0){super(),this.iGameId=t,this.iPlayerId=i,this.iX=e,this.iY=n,this.Status=o,this.iEnclosingPathId=a}GetKind(){return l.POINT}static Format(t,i){let e=`(${i.iX},${i.iY} - `;switch(void 0!==i.Status?i.Status:i.status){case s.POINT_FREE_RED:e+="red";break;case s.POINT_FREE_BLUE:e+="blue";break;case s.POINT_FREE:e+="";break;case s.POINT_STARTING:e+="starting";break;case s.POINT_IN_PATH:e+="path";break;case s.POINT_OWNED_BY_RED:e+="owned by red";break;case s.POINT_OWNED_BY_BLUE:e+="owned by blue";break;default:throw new Error("Bad point type!")}return`${t} places ${e}) point`}}class P extends u{constructor(t=0,i=0,e=0,s="",n=""){super(),this.iId=t,this.iGameId=i,this.iPlayerId=e,this.PointsAsString=s,this.OwnedPointsAsString=n}GetKind(){return l.PATH}static Format(t,i){return`${t} places ${`(${i.PointsAsString||i.pointsAsString}) [${i.OwnedPointsAsString||i.ownedPointsAsString}]`} path`}}class g extends u{constructor(t,i,e){super(),this.OtherPlayerId=t,this.OtherPlayerName=i,this.Message=e}GetKind(){return l.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class y extends u{constructor(t,i,e){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=i,this.Message=e}GetKind(){return l.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class p extends u{constructor(t=""){super(),this.Message=t}GetKind(){return l.PING}static Format(t,i){return i.Message||i.message}}class m extends u{constructor(t=d.NO_WIN,i=0,e="null"){super(),this.Status=t,this.WinningPlayerId=i,this.Message=e}GetKind(){return l.WIN}static Format(t){let i="";switch(void 0!==t.Status?t.Status:t.status){case d.RED_WINS:i="red.";break;case d.GREEN_WINS:i="blue.";break;case d.NO_WIN:i="no one!";break;case d.DRAW_WIN:i="draw!"}return"And the winner is... "+i}}class C extends u{constructor(){super()}GetKind(){return l.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class w extends u{constructor(t=[],i=[]){super(),this.Points=t,this.Paths=i}GetKind(){return l.POINTS_AND_PATHS}static Deserialize(t){const i=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(i)}}class I extends u{constructor({DesktopNotifications:t=!1,ShowChatNotifications:i=!1}){super(),this.DesktopNotifications=t,this.ShowChatNotifications=i}GetKind(){return l.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class O{#t;#i;#e;#s;#n;constructor(t=60,i=null,e=!1,s){this.#t=t,this.#i=this.#t,this.#e=-1,this.#s=null,this.#n=s,i&&(this.#s=document.querySelector(i)),e&&this.Start()}#o(){--this.#i<=0?(this.Stop(),this.#n&&this.#n(this.#s)):this.#s&&(this.#s.textContent=this.#a(parseInt(this.#i/60))+":"+this.#a(this.#i%60))}#a(t){const i=t+"";return i.length<2?"0"+i:i}Start(){this.Stop(),this.#e=setInterval(this.#o.bind(this),1e3)}Stop(){this.#e>0&&clearInterval(this.#e),this.#s&&(this.#s.textContent="")}Reset(t=60,i=null,e=!1,s){this.#t=t,this.#i=this.#t,this.#s=null,this.#n=s,i&&(this.#s=document.querySelector(i)),e&&this.Start()}}class R{#r;#h;#l;#c;constructor(t){this.#r="IB_MessagesBuffer",this.#h=t,this.#l=16,this.#c=null}#d(){const t=this.#h.getItem(this.#r);if(t){const i=JSON.parse(t);return i.conversationHash&&i.conversationHash===this.#c&&i.msgs||[]}return[]}#u(t){const i={conversationHash:this.#c,msgs:t},e=JSON.stringify(i);this.#h.setItem(this.#r,e)}#S(t,i,e,s,n,o){let a,r;const h=document.createElement("li"),l=document.createElement("span");return e?(s?(a=n.textContent,r="red"):(a=o.textContent,r="blue"),h.className="text-end py-1"):(s?(a=o.textContent,r="blue"):(a=n.textContent,r="red"),h.className="text-start py-1"),h.textContent=`${a}:`,l.textContent=i,l.classList=`px-1 rounded ${r}`,h.appendChild(l),t.appendChild(h),h}Append(t,i,e,s,n,o){const a=this.#d();a.push({msg:t,mine:i}),a.length>this.#l&&a.shift(),this.#u(a);const r=document.querySelector(e);this.#S(r,t,i,s,n,o).scrollIntoView()}RestoreMessages(t,i,e,s,n,o){this.#c=i&&e?`${i}_${e}`:null;const a=this.#d(),r=document.querySelector(t);r&&a.forEach((({msg:t,mine:i})=>this.#S(r,t,i,s,n,o)))}}function L(){return"#"+Math.floor(16777215*Math.random()).toString(16)}class b{#P;#g;#y;#p;#m;#C;#w;#I;#O;#R;#L;#b;#_;#D;#f;#E;#N;#G;#v;#T;#A;#W;#M;#k;#B;#F;#x;#U;#$;#H;#Y;#X;#q;#V;#j;#z;#K;#J;#Z;#Q;#tt;#it;#et;#st;#nt;#ot;#at;#rt;#ht;#lt;#ct;#dt;#ut;#St;#Pt;#gt;#yt;#pt;#mt;#Ct;#wt;#It;#Ot;#Rt;#Lt;#bt;#_t;#Dt;constructor(t,i,s,n,o,a,r,h,l,d=!0,u=!0,S=!1,P=60,g=125){this.#y=t,this.#p=i,this.#m=s,this.#v=-1===this.#m,this.#bt=c[l],this.#Rt=0,this.#Lt=2e3,this.#mt="var(--redish)",this.#Ct="var(--bluish)",this.#wt="var(--owned_by_red)",this.#It="var(--owned_by_blue)",this.#Ot="var(--path_draw)",this.#T=!1,this.#A=!1,this.#C=4e3,this.#w=g,this.#W=null,this.#M=null,this.#k=null,this.#B={countdownSeconds:P,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.#I=0,this.#O=0,this.#R=0,this.#L=0,this.#b=0,this.#F=0,this.#_=-1,this.#D=-1,this.#f=0,this.#E=0,this.#N=0,this.#G=0,this.#x=null,this.#U=null,this.#$=null,this.#H=null,this.#Y=null,this.#X=null,this.#q=null,this.#V=null,this.#j=null,this.#z=null,this.#K=!1,this.#J=!1,this.#Z=!1,this.#Q="",this.#tt=d,this.#it=u,this.#st=this.#tt?this.#mt:this.#Ct,this.#Dt=null,this.#nt=null,this.#ot=null,this.#at=null,this.#rt=S,this.#ht=null,this.#_t={x:-1,y:-1},this.#lt=null,this.#ct=null,this.#dt=null,this.#ut=null,null!==n&&""!==n&&(this.#P=(new signalR.HubConnectionBuilder).withUrl(n,{transport:r,accessTokenFactory:function(){return`iGameID=${this.#y}&iPlayerID=${this.#p}`}.bind(this)}).withHubProtocol(a).configureLogging(o).build(),this.#P.serverTimeoutInMilliseconds=h,this.#P.onclose((async t=>{null!=t&&(e(t),this.#x.style.cursor="not-allowed",this.#Rt++,setTimeout((()=>this.#ft()),4e3+this.#Lt*Math.max(this.#Rt,5)))})))}async#Et(){if(!1===this.#A){const t=await this.#P.invoke("GetPlayerPointsAndPaths",this.#rt,this.#y),i=w.Deserialize(t);return void 0!==i.Points&&await this.#Nt(i.Points),void 0!==i.Paths&&await this.#Gt(i.Paths),this.#A=!0,!0}return!1}async#ft(){try{if(await this.#P.start(),this.#Rt=0,i("connected; iConnErrCount = "+this.#Rt),!1===this.#rt)if(null===sessionStorage.getItem("ApplicationUserSettings")){let t=await this.#P.invoke("GetUserSettings");if(t){i(t),t=I.Deserialize(t);const e=I.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",e)}this.#lt=new I(t),await this.#Et()}else{const t=sessionStorage.getItem("ApplicationUserSettings"),i=I.Deserialize(t);this.#lt=new I(i)}!1===this.#A&&await this.#Et(),null!==this.#lt&&!0===this.#lt.DesktopNotifications&&this.#vt(),!0!==this.#v||this.#it||this.#Tt()}catch(t){e(t+"; iConnErrCount = "+this.#Rt),this.#x.style.cursor="not-allowed",this.#Rt++,setTimeout((()=>this.#ft()),4e3+this.#Lt*Math.max(this.#Rt,5))}}#vt(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then((function(t){return"granted"===t||(i("User blocked notifications."),!1)})).catch((function(t){return e(t),!1})):(i("Browser does not support notifications."),!1)}#At(t="Hi there!",s="How are you doing?"){return!(!document.hidden||null===this.#lt||!0!==this.#lt?.DesktopNotifications)&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then((function(e){return"granted"===e?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):(i("User blocked notifications."),!1)})).catch((function(t){return e(t),!1})):(i("Browser does not support notifications."),!1))}async StartSignalRConnection(i){return null===this.#P?Promise.reject(new Error("signalr conn is null")):(!1===this.#A&&(this.#A=!i),this.#P.on("ServerToClientPoint",async function(t){if(this.#p!==t.iPlayerId){const i=this.#tt?this.#H.textContent:this.#$.textContent;let e=S.Format(i,t);if(null!==this.#lt&&!0===this.#lt?.ShowChatNotifications){const t=document.createElement("li");t.textContent=e,t.style="font-style:italic",document.querySelector(this.#V).appendChild(t)}this.#At("New Point",e)}await this.#Wt(t)}.bind(this)),this.#P.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let i=t;if(this.#p!==i.iPlayerId){const t=this.#tt?this.#H.textContent:this.#$.textContent,e=P.Format(t,i);if(null!==this.#lt&&!0===this.#lt?.ShowChatNotifications){const t=document.createElement("li");t.textContent=e,t.style="font-style:italic",document.querySelector(this.#V).appendChild(t)}this.#At("New Path",e)}this.#Mt(i)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");{let i=t;const e=m.Format(i);let s=document.createElement("li");s.textContent=e,document.querySelector(this.#V).appendChild(s),this.#kt(i),this.#At("We have a winner",e)}}}.bind(this)),this.#P.on("ServerToClientPlayerJoin",function(t){const i=t.OtherPlayerId||t.otherPlayerId;this.#m=i;const e=g.Format(t);document.querySelector(".msgchat").dataset.otherplayerid=this.#m;const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-primary"),n.textContent=e,s.appendChild(n),document.querySelector(this.#V).appendChild(s),null!==this.#Y&&""!==t.OtherPlayerName&&(this.#H.textContent=t.OtherPlayerName||t.otherPlayerName,this.#Y.value="surrender",this.#Bt("Your move")),this.#g.RestoreMessages(this.#V,this.#p,this.#m,this.#tt,this.#$,this.#H),this.#At("Player joining",e),this.#J=!1}.bind(this)),this.#P.on("ServerToClientPlayerSurrender",function(i){let e=y.Format(i);const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-warning"),n.textContent=e,s.appendChild(n),document.querySelector(this.#V).appendChild(s),this.#J=!1,e=""===e?"Game interrupted!":e,this.#At("Game interruption",e),t.LocalAlert(e,"Game interruption",(()=>{window.location.href="GamesList"}))}.bind(this)),this.#P.on("ServerToClientPlayerWin",function(t){const i=m.Format(t),e=document.querySelector(this.#V);if(null!==e){const t=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=i,t.appendChild(s),e.appendChild(t)}this.#kt(t),this.#At("We have a winner",i)}.bind(this)),this.#P.on("ServerToClientPing",function(t){const i=this.#tt?this.#H.textContent:this.#$.textContent,e=p.Format(i,t);this.#g.Append(e,!1,this.#V,this.#tt,this.#$,this.#H),this.#At("User Message",e)}.bind(this)),this.#P.on("ServerToClientOtherPlayerDisconnected",function(t){const i={countdownSeconds:5,labelSelector:null,initialStart:!0,countdownReachedHandler:function(){const i=t,e=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=i,e.appendChild(s),document.querySelector(this.#V).appendChild(e),this.#At("User disconnected",i),this.#M=null}.bind(this)};this.#M?this.#M.Reset(i):this.#M=new O(i)}.bind(this)),this.#P.on("ServerToClientOtherPlayerConnected",function(t){if(this.#M)this.#M.Stop(),this.#M=null;else{const i=t,e=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-primary"),s.textContent=i,e.appendChild(s),document.querySelector(this.#V).appendChild(e),this.#At("User connected",i),this.#M=null}}.bind(this)),this.#P.on("ServerToClientStopAndDraw",function(t){if(!t)return;const i=this.#tt?this.#H.textContent:this.#$.textContent,e=C.Format(i),s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-info"),n.textContent=e,s.appendChild(n),document.querySelector(this.#V).appendChild(s),this.#At("User "+i+" started drawing new path",e)}.bind(this)),!1===this.#v&&(document.querySelector(this.#q).addEventListener("click",async function(t){t.preventDefault();const i=document.querySelector(this.#X).value.trim();if(""===i)return;let e=new p(i);await this.#Ft(e)}.bind(this),!1),document.querySelector(this.#X).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.#q).click()}.bind(this),!1)),this.#ft())}StopSignalRConnection(){null!==this.#P&&(this.#P.stop(),this.#M&&this.#M.Stop(),this.#W&&this.#W.Stop(),i("Stopped SignalR connection"))}#xt(...t){switch(t.length){case 1:this.#U.textContent=t[0];break;case 2:document.getElementById("debug"+t[1]).textContent=t[0];break;default:for(let i=0;i<t.length;i++){const e=t[i];if(e){const t=document.getElementById("debug"+i);t&&(t.textContent=e)}}}}async#Ut(t,i,e,n){if(await this.#at.has(i*this.#O+t))return;const o=t,a=i,r=this.#Dt.CreateOval();let h;switch(r.move(o,a),e){case s.POINT_FREE_RED:h=this.#mt,r.SetStatus(e);break;case s.POINT_FREE_BLUE:h=this.#Ct,r.SetStatus(e);break;case s.POINT_FREE:case s.POINT_STARTING:h=this.#st,r.SetStatus(e);break;case s.POINT_IN_PATH:h=this.#p===n?!0===this.#tt?this.#mt:this.#Ct:!0===this.#tt?this.#Ct:this.#mt,r.SetStatus(e);break;case s.POINT_OWNED_BY_RED:h=this.#wt,r.SetStatus(e);break;case s.POINT_OWNED_BY_BLUE:h=this.#It,r.SetStatus(e);break;default:alert("bad point")}r.SetFillColor(h),await this.#at.set(i*this.#O+t,r)}#$t(){return{iGameID:this.#y,iPlayerID:this.#p,iOtherPlayerId:this.#m,sLastMoveGameTimeStamp:this.#ct,bPointsAndPathsLoaded:this.#A,iGridWidth:this.#O,iGridHeight:this.#R}}#Ht(t,i,e,n){const o=t,a=i,r=this.#Dt.CreateOval();let h;switch(r.move(o,a),e){case s.POINT_FREE_RED:h=this.#mt,r.SetStatus(e);break;case s.POINT_FREE_BLUE:h=this.#Ct,r.SetStatus(e);break;case s.POINT_FREE:case s.POINT_STARTING:h=this.#st,r.SetStatus(e);break;case s.POINT_IN_PATH:h=n,r.SetStatus(e);break;case s.POINT_OWNED_BY_RED:h=this.#wt,r.SetStatus(e);break;case s.POINT_OWNED_BY_BLUE:h=this.#It,r.SetStatus(e);break;default:alert("bad point")}return r.SetFillColor(h),r}async#Nt(t){try{await this.#at.BeginBulkStorage();for(const[s,n,o,a]of t)await this.#Ut(s,n,(e=o,e-3),(i=a,i-1))}finally{await this.#at.EndBulkStorage()}var i,e}async#Yt(t,i,e,n=0){const o=t.split(" ");let a,r,h="",l="",c=null,d=s.POINT_STARTING;for(const t of o)c=t.split(","),a=parseInt(c[0]),r=parseInt(c[1]),c=await this.#at.get(r*this.#O+a),null!=c&&(c.SetStatus(d),d=s.POINT_IN_PATH),l+=`${h}${a},${r}`,h=" ";c=o[0].split(","),a=parseInt(c[0]),r=parseInt(c[1]),c=await this.#at.get(r*this.#O+a),null!=c&&c.SetStatus(d),o[0]!==o.at(-1)&&(l+=`${h}${a},${r}`);const u=this.#Dt.CreatePolyline(l,e?this.#st:i?this.#Ct:this.#mt);u.SetID(n),await this.#ot.push(u)}async#Xt(t,i,e){const n=t.split(" ");let o,a,r="",h="",l=null,c=s.POINT_STARTING;for(const t of n)l=t.split(","),o=parseInt(l[0]),a=parseInt(l[1]),l=await this.#at.get(a*this.#O+o),null!=l&&(l.SetStatus(c),c=s.POINT_IN_PATH),h+=`${r}${o},${a}`,r=" ";l=n[0].split(","),o=parseInt(l[0]),a=parseInt(l[1]),l=await this.#at.get(a*this.#O+o),null!=l&&l.SetStatus(c),n[0]!==n.at(-1)&&(h+=`${r}${o},${a}`);const d=this.#Dt.CreatePolyline(h,i);return d.SetID(e),d}async#Gt(t){try{await this.#ot.BeginBulkStorage();for(const i of t)await this.#Yt(i.PointsAsString,this.#tt,i.iPlayerId===this.#p,i.iId)}finally{await this.#ot.EndBulkStorage()}}#qt(t,i,e){for(const s of t){const[t,n]=s.split(",");if(t===i&&n===e)return!0}return!1}async#Vt(){const t=this.#nt.GetPointsArray();if(n(t.slice(0,-1).map((t=>t.x+"_"+t.y)))||t[0].x!==t.at(-1).x||t[0].y!==t.at(-1).y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};let i,e,a;this.#st===this.#mt?(i=this.#Ct,e=s.POINT_OWNED_BY_RED,a=this.#wt):(i=this.#mt,e=s.POINT_OWNED_BY_BLUE,a=this.#It);let r="",h="",l="",c=[];for(const n of await this.#at.values())if(void 0!==n&&n.GetFillColor()===i&&[s.POINT_FREE_BLUE,s.POINT_FREE_RED].includes(n.GetStatus())){const{x:i,y:s}=n.GetPosition();!1!==o(t,i,s)&&(h+=`${l}${i},${s}`,l=" ",c.push({point:n,revertStatus:n.GetStatus(),revertFillColor:n.GetFillColor()}),n.SetStatus(e,!0),n.SetFillColor(a))}return""!==h&&(r=t.map(function(t){const i=t.x,e=t.y;return null===i||null===e?"":`${i},${e}`}.bind(this)).join(" ")),{OwnedPoints:c,owned:h,PathPoints:[],path:r,errorDesc:"No surrounded points"}}async#jt(t,i,e){void 0===e&&(e=await this.#ot.all());for(const s of e){const e=s.GetPointsArray();if(!1!==o(e,t,i))return!1}return!0}#zt(){}#Kt(t,i){return new S(this.#y,this.#p,t,i,this.#tt?s.POINT_FREE_RED:s.POINT_FREE_BLUE,0)}#Jt(t){return new P(0,this.#y,this.#p,t.path,t.owned)}async#Ft(t,s){switch(t.GetKind()){case l.POINT:i(S.Format("some player",t)),this.#J=!0;try{const i=await this.#P.invoke("ClientToServerPoint",t);await this.#Wt(i)}catch(t){e(t.toString()),void 0!==s&&s()}break;case l.PATH:i(P.Format("some player",t)),this.#J=!0;try{const i=await this.#P.invoke("ClientToServerPath",t);if(Object.prototype.hasOwnProperty.call(i,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(i,"winningPlayerId")){let t=i;this.#kt(t)}else{if(!Object.prototype.hasOwnProperty.call(i,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(i,"pointsAsString"))throw new Error("ClientToServerPath bad GetKind!");{let t=i;await this.#Mt(t)}}}catch(t){e(t.toString()),void 0!==s&&s()}break;case l.PING:try{await this.#P.invoke("ClientToServerPing",t),document.querySelector(this.#X).value="",document.querySelector(this.#q).disabled="disabled";const i=t.Message;this.#g.Append(i,!0,this.#V,this.#tt,this.#$,this.#H)}catch(t){e(t.toString())}break;case l.STOP_AND_DRAW:try{await this.#P.invoke("ClientToServerStopAndDraw",t),this.#Z=!0,this.#_=this.#D=-1,this.#nt=null,this.#it=!0,this.#z.disabled="disabled"}catch(t){e(t.toString())}break;default:e("unknown object")}}CountDownReachedHandler(t){t&&(t.textContent=""),this.#z.disabled=this.#j.disabled="disabled",this.#W=null,this.#it=!1}async#Wt(t){const i=t.iX,e=t.iY,s=void 0!==t.Status?t.Status:t.status;this.#ct=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),await this.#Ut(i,e,s,t.iPlayerId),this.#p!==t.iPlayerId?(this.#it=!0,this.#Bt("Opponent has moved, your turn"),this.#x.style.cursor="crosshair",null!==this.#nt&&await this.#Zt(),this.#z.disabled="",this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line",this.#W&&(this.#W.Stop(),this.#W=null)):(this.#it=!1,this.#Bt("Waiting for opponent move"),this.#x.style.cursor="wait",this.#ht.Hide(),this.#j.disabled="disabled",this.#z.disabled="",this.#z.value="Stop and Draw",this.#W?this.#W.Reset(this.#B):this.#W=new O(this.#B),!0!==this.#v||this.#it||this.#Tt()),this.#J=!1}async#Mt(t){if(this.#ct=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),this.#p!==t.iPlayerId){const i=t.PointsAsString||t.pointsAsString,e=t.OwnedPointsAsString||t.ownedPointsAsString;await this.#Yt(i,this.#st===this.#mt,!1,t.iId);const n=e.split(" "),o=this.#st===this.#mt?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=this.#st===this.#mt?this.#wt:this.#It;for(const t of n){let[i,e]=t.split(",");i=parseInt(i),e=parseInt(e);const s=await this.#at.get(e*this.#O+i);void 0!==s&&(s.SetStatus(o),s.SetFillColor(a),await this.#at.set(e*this.#O+i,s))}this.#it=!0,this.#Bt("Opponent has moved, your turn"),this.#x.style.cursor="crosshair",this.#ht.Hide(),null!==this.#nt&&await this.#Zt(),this.#z.disabled=""}else{let i=this.#nt.GetPointsArray(),e=i[0].x,n=i[0].y;const o=await this.#at.get(n*this.#O+e);void 0!==o&&o.SetStatus(s.POINT_IN_PATH),this.#nt.SetWidthAndColor(this.#F,this.#st),this.#nt.SetID(t.iId),await this.#ot.push(this.#nt),this.#_=this.#D=-1,this.#nt=null;i=(t.OwnedPointsAsString||t.ownedPointsAsString).split(" ");const a=this.#st===this.#mt?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=this.#st===this.#mt?this.#wt:this.#It;for(const t of i){let[i,e]=t.split(",");i=parseInt(i),e=parseInt(e);const s=await this.#at.get(e*this.#O+i);void 0!==s&&(s.SetStatus(a),s.SetFillColor(r),await this.#at.set(e*this.#O+i,s))}this.#it=!1,this.#Bt("Waiting for opponent move"),this.#x.style.cursor="wait",this.#ht.Hide(),this.#z.disabled=this.#j.disabled="disabled",!0!==this.#v||this.#it||this.#Tt()}this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line",this.#J=!1,this.#W&&(this.#W.Stop(),this.#W=null)}#kt(i){this.#Bt("Win situation"),this.#J=!1;const e=m.Format(i),s=void 0!==i.Status?i.Status:i.status,n=i.WinningPlayerId||i.winningPlayerId;((s===d.RED_WINS||s===d.GREEN_WINS)&&n>0||s===d.DRAW_WIN)&&t.LocalAlert(""===e?"Game won!":e,"Win situation",(()=>{window.location.href="GamesList"}))}#Qt(t,i,e,n){let o,a;switch(this.#bt){case c.FIRST_CAPTURE:return t.length>0?this.#tt?d.RED_WINS:d.GREEN_WINS:i.length>0?this.#tt?d.GREEN_WINS:d.RED_WINS:d.NO_WIN;case c.FIRST_5_CAPTURES:return o=this.#tt?s.POINT_OWNED_BY_BLUE:s.POINT_OWNED_BY_RED,a=n.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#tt?d.GREEN_WINS:d.RED_WINS:(o=this.#tt?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=e.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#tt?d.RED_WINS:d.GREEN_WINS:d.NO_WIN);case c.FIRST_5_PATHS:return i.length>=5?this.#tt?d.GREEN_WINS:d.RED_WINS:t.length>=5?this.#tt?d.RED_WINS:d.GREEN_WINS:d.NO_WIN;case c.FIRST_5_ADVANTAGE_PATHS:{const e=t.length-i.length;if(e>=5)return this.#tt?d.RED_WINS:d.GREEN_WINS;if(e<=-5)return this.#tt?d.GREEN_WINS:d.RED_WINS}return d.NO_WIN;default:throw new Error("Wrong game type")}}#Bt(t=""){"???"===this.#H.textContent?this.#it?this.#et.style.color=this.#mt:this.#et.style.color=this.#Ct:this.#it?this.#tt?this.#et.style.color=this.#mt:this.#et.style.color=this.#Ct:this.#tt?this.#et.style.color=this.#Ct:this.#et.style.color=this.#mt,null!==t&&""!==t?this.#xt(t,0):this.#xt("",0)}async#ti(t){if(!this.#it||"???"===this.#H.textContent||!0===this.#J||this.#Rt>0)return void(this.#Rt<=0&&!this.#it&&(this.#x.style.cursor="wait"));const i=this.#Dt.ToCursorPoint(t.clientX,t.clientY);let e=i.x+.5,n=i.y+.5;e=parseInt(e),n=parseInt(n);let o=e,a=n;if(this.#_t.x===o&&this.#_t.y===a||(this.#ht.move(o,a),this.#ht.Show(),this.#xt(`[${e},${n}]`,1),this.#_t.x=o,this.#_t.y=a),this.#Z){if(null!==this.#nt?this.#x.style.cursor="move":this.#x.style.cursor="crosshair",!0===this.#K&&(this.#_!==e||this.#D!==n)&&Math.abs(parseInt(this.#_-e))<=1&&Math.abs(parseInt(this.#D-n))<=1&&this.#_>=0&&this.#D>=0)if(null!==this.#nt){let t=await this.#at.get(this.#D*this.#O+this.#_),i=await this.#at.get(n*this.#O+e);if(this.#j.disabled=this.#nt.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==i&&t.GetFillColor()===this.#st&&i.GetFillColor()===this.#st){const r=this.#nt.ContainsPoint(o,a);if(r<1&&i.GetStatus()!==s.POINT_STARTING&&!0===this.#nt.AppendPoints(o,a))i.SetStatus(s.POINT_IN_PATH,!0),this.#_=e,this.#D=n;else if(1===r&&i.GetStatus()===s.POINT_STARTING&&!0===this.#nt.AppendPoints(o,a)){const t=await this.#Vt();t.owned.length>0?(this.#xt("Closing path",0),this.#Pt=null,await this.#Ft(this.#Jt(t),(async()=>{await this.#Zt(),t.OwnedPoints.forEach((t=>{const i=t.point;i.RevertOldStatus(),i.SetFillColor(t.revertFillColor)})),this.#J=!1}))):this.#xt(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#_=e,this.#D=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#nt.GetPointsString().endsWith(`${this.#_},${this.#D}`)&&(this.#nt.GetLength()>2?(t.RevertOldStatus(),this.#nt.RemoveLastPoint(),this.#_=e,this.#D=n):await this.#Zt())}}else{let t=await this.#at.get(this.#D*this.#O+this.#_),i=await this.#at.get(n*this.#O+e);if(void 0!==t&&void 0!==i&&t.GetFillColor()===this.#st&&i.GetFillColor()===this.#st){const r=this.#_,h=this.#D;this.#nt=this.#Dt.CreatePolyline(`${r},${h} ${o},${a}`,this.#Ot),this.#j.disabled="",t.SetStatus(s.POINT_STARTING,!0),i.SetStatus(s.POINT_IN_PATH,!0),this.#_=e,this.#D=n}}}else this.#x.style.cursor="crosshair"}async#ii(t){if(!this.#it||"???"===this.#H.textContent||!0===this.#J||this.#Rt>0)return;const i=this.#Dt.ToCursorPoint(t.clientX,t.clientY);let e=i.x+.5,n=i.y+.5;if(e=this.#f=parseInt(e),n=this.#E=parseInt(n),this.#K=!0,this.#Z){if((this.#_!==e||this.#D!==n)&&Math.abs(parseInt(this.#_-e))<=1&&Math.abs(parseInt(this.#D-n))<=1&&this.#_>=0&&this.#D>=0)if(null!==this.#nt){let t=await this.#at.get(this.#D*this.#O+this.#_),i=await this.#at.get(n*this.#O+e);if(this.#j.disabled=this.#nt.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==i&&t.GetFillColor()===this.#st&&i.GetFillColor()===this.#st){const o=e,a=n,r=this.#nt.ContainsPoint(o,a);if(r<1&&i.GetStatus()!==s.POINT_STARTING&&!0===this.#nt.AppendPoints(o,a))i.SetStatus(s.POINT_IN_PATH,!0),this.#_=e,this.#D=n;else if(1===r&&i.GetStatus()===s.POINT_STARTING&&!0===this.#nt.AppendPoints(o,a)){const t=await this.#Vt();t.owned.length>0?(this.#xt("Closing path",0),this.#Pt=null,await this.#Ft(this.#Jt(t),(async()=>{await this.#Zt(),t.OwnedPoints.forEach((t=>{const i=t.point;i.RevertOldStatus(),i.SetFillColor(t.revertFillColor)})),this.#K=!1,this.#J=!1}))):this.#xt(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#_=e,this.#D=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#nt.GetPointsString().endsWith(`${this.#_},${this.#D}`)&&(this.#nt.GetLength()>2?(t.RevertOldStatus(),this.#nt.RemoveLastPoint(),this.#_=e,this.#D=n):await this.#Zt())}}else{let t=await this.#at.get(this.#D*this.#O+this.#_),i=await this.#at.get(n*this.#O+e);if(void 0!==t&&void 0!==i&&t.GetFillColor()===this.#st&&i.GetFillColor()===this.#st){const o=this.#_,a=this.#D,r=e,h=n;this.#nt=this.#Dt.CreatePolyline(`${o},${a} ${r},${h}`,this.#Ot),this.#j.disabled="",t.SetStatus(s.POINT_STARTING,!0),i.SetStatus(s.POINT_IN_PATH,!0)}this.#_=e,this.#D=n}else if(this.#_<0||this.#D<0){let t=await this.#at.get(n*this.#O+e);void 0!==t&&t.GetFillColor()===this.#st&&(this.#_=e,this.#D=n)}}else{this.#_=e,this.#D=n;const t=e,i=n;if(void 0!==await this.#at.get(i*this.#O+t))return void this.#xt("Wrong point - already existing",0);if(!await this.#jt(t,i))return void this.#xt("Wrong point, Point is not outside all paths",0);this.#Pt=null,await this.#Ft(this.#Kt(t,i),(()=>{this.#K=!1,this.#J=!1}))}}#ei(){this.#K=!1}#si(){this.#ht.Hide()}async#ni(t){if(this.#W)null===this.#nt&&await this.#Ft(new C);else{null!==this.#nt&&await this.#Zt(),this.#Z=!this.#Z;const i=t.target;this.#Z?i.value="Draw dot":i.value="Draw line",this.#_=this.#D=-1,this.#nt=null}}async#Zt(){if(this.#Z){if(null!==this.#nt){const t=this.#nt.GetPointsArray();this.#j.disabled="disabled";for(const i of t){const{x:t,y:e}=i;if(null===t||null===e)continue;const s=await this.#at.get(e*this.#O+t);void 0!==s&&s.RevertOldStatus()}this.#Dt.RemovePolyline(this.#nt),this.#nt=null}this.#_=this.#D=-1,this.#W&&(this.#z.disabled="disabled"),this.#xt("",0)}}CountPointsDebug(t){let i="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='POINT_OWNED_BY_RED']",display:"intercepted(P1:%s, "},{query:"circle[data-status='POINT_OWNED_BY_BLUE']",display:"P2:%s)"}].forEach((function(t){const e=document.querySelectorAll(t.query);i+=t.display.replace("%s",e.length)})),document.querySelector(t).textContent="SVGs by tags: "+i}async#oi(t){return new Promise(((i,s)=>{this.#ut=this.#ut??new Worker("../js/AIWorker.Bundle.js"),this.#ut.onerror=function(){this.#ut.terminate(),this.#ut=null,s(new Error("no data"))},this.#ut.onmessage=function(t){const n=t.data;switch(n.operation){case"BUILD_GRAPH":case"CONCAVEMAN":case"MARK_ALL_CYCLES":i(n);break;default:e(`unknown params.operation = ${n.operation}`),s(new Error(`unknown params.operation = ${n.operation}`))}},t&&t(this.#ut)}))}async#ai(t){t.preventDefault();const e=await this.#oi((t=>{const i=Array.from(this.#at.store.entries()).map((([t,i])=>({key:t,value:i.Serialize()}))),e=this.#ot.store.map((t=>t.Serialize()));t.postMessage({operation:"BUILD_GRAPH",boardSize:{iGridWidth:this.#O,iGridHeight:this.#R},state:this.#$t(),points:i,paths:e})}));i("Message received from worker:"),i(e)}async#ri(t){t.preventDefault();const e=await this.#oi((t=>{const i=Array.from(this.#at.store.entries()).map((([t,i])=>({key:t,value:i.Serialize()})));t.postMessage({operation:"CONCAVEMAN",boardSize:{iGridWidth:this.#O,iGridHeight:this.#R},state:this.#$t(),points:i})}));if(e.convex_hull&&e.convex_hull.length>0){const t=e.convex_hull;this.#Dt.CreatePolyline(t.map((([t,i])=>parseInt(t)+","+parseInt(i))).join(" "),"green"),i(`convex_hull = ${t}`);const s=e.cw_sorted_verts,n=L();for(const t of s){const{x:i,y:e}=t,s=document.querySelector(`svg > circle[cx="${i}"][cy="${e}"]`);s&&(s.SetStrokeColor(n),s.SetFillColor(n),s.SetZIndex(100),s.setAttribute("r",6/this.#L)),await r(50)}}}async#hi(t){t.preventDefault(),i(await this.#li(await this.#ci(),this.#mt))}async#di(t){t.preventDefault();const e=await this.#at.get(this.#E*this.#O+this.#f);void 0!==e?(await this.#ui([],e),this.#gt&&(this.#Dt.RemovePolyline(this.#gt),this.#gt=null),this.#yt.forEach((t=>{this.#Dt.CreatePolyline(t.map((function(t){const i=t.GetPosition();return`${i.x},${i.y}`})).join(" "),L())})),i("game.lastCycle = "),i(this.#yt),this.#yt=[]):i("!!!You need to click first 'blue' starting point with mouse!!!")}async#Si(t){t.preventDefault();const e=this.#mt,n=this.#Ct;let r;const h=await this.#at.get(this.#E*this.#O+this.#f),l=[...await this.#at.values()];r=void 0!==h?[h]:l;const c=await this.#ot.all();for(const t of r)if(void 0!==t&&t.GetFillColor()===e&&[s.POINT_FREE_RED,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:e,y:h}=t.GetPosition();if(!1===await this.#jt(e,h,c)){i("!!!Point inside path!!!");continue}const d=L(),u=2,S=this.#Dt.CreateOval(u);S.move(e,h),S.SetStrokeColor(d),S.StrokeWeight(.1),S.SetFillColor("transparent");const P=[];for(const t of l)if(void 0!==t&&t.GetFillColor()===n&&[s.POINT_FREE_BLUE,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:i,y:s}=t.GetPosition();if(!1===await this.#jt(i,s,c))continue;0<=this.#Dt.IsPointInCircle({x:i,y:s},{x:e,y:h},u)&&(t.x=i,t.y=s,P.push(t))}if(P.length>2){let t,s=a(P);for(const i of s){if(void 0!==t&&!(Math.abs(t.x-i.x)<=1&&Math.abs(t.y-i.y)<=1)){s=null;break}t=i}if(null===s||!(Math.abs(s.at(-1).x-s[0].x)<=1&&Math.abs(s.at(-1).y-s[0].y)<=1)||!1===o(s,e,h))continue;if(r.length<=1){for(const t of s){const i=document.querySelector(`svg > circle[cx="${t.x}"][cy="${t.y}"]`);i&&(i.SetStrokeColor(d),i.StrokeWeight("0.020em"),i.SetFillColor(d),i.setAttribute("r",6/this.#L))}await this.#Pi(s,250)}i("circle sorted possible path points: "),i(s)}}}async#gi(t){t.preventDefault(),await this.#yi(await this.#ci(),this.#mt)}async PrepareDrawing(i,e,s,n,o,a,r,h,l,c,d,u,S,P,g,y=125){if(this.#T=!1,this.#C=4e3,this.#w=y,this.#W=null,this.#k=null,this.#I=0,this.#_=-1,this.#D=-1,this.#f=0,this.#E=0,this.#N=0,this.#G=0,this.#K=!1,this.#J=!1,this.#Z=!1,this.#Q="",this.#st=this.#tt?this.#mt:this.#Ct,this.#nt=null,this.#U=document.getElementById("debug0"),this.#$=document.querySelector(e),this.#H=document.querySelector(s),this.#et=document.querySelector(n),this.#Y=document.querySelector(o),this.#j=document.querySelector(a),this.#z=document.querySelector(h),this.#X=l,this.#V=c,this.#q=d,this.#x=document.querySelector(i),!this.#x)return void alert("no board");this.#N=this.#x.offsetLeft,this.#G=this.#x.offsetTop;let[p,m]=[...this.#x.classList].find((t=>t.startsWith("boardsize"))).split("-")[1].split("x");this.#O=parseInt(p),this.#R=parseInt(m);let C=this.#x.clientWidth,w=this.#x.clientHeight,I=null;w<=0&&(w=16*this.#R,this.#x.style.height=w+"px",I="100%"),this.#L=Math.ceil(C/this.#O),this.#b=Math.ceil(w/this.#R),this.#F=3/this.#L,this.#ct=u,this.#dt=P,this.#St=null,this.#Pt=null,this.#gt=null,this.#yt=[],this.#pt=null,this.#Dt=new t.SvgVml,null===this.#Dt.CreateSVGVML(this.#x,I,I,{iGridWidth:this.#O,iGridHeight:this.#R})&&alert("SVG is not supported!");const O=new t.GameStateStore(S,this.#Ht.bind(this),this.#Xt.bind(this),this.#$t.bind(this),this.#dt);if(this.#ot=O.GetPathStore(),this.#at=O.GetPointStore(),this.#A=await O.PrepareStore(),!1===this.#rt){if(null===this.#ht&&(this.#ht=this.#Dt.CreateOval(),this.#ht.SetFillColor(this.#st),this.#ht.SetZIndex(-1),this.#ht.Hide(),this.#ht.setAttribute("data-status","MOUSE_POINTER")),this.#x.onmousedown=this.#ii.bind(this),this.#x.onmousemove=this.#ti.bind(this),this.#x.onmouseup=this.#ei.bind(this),this.#x.onmouseleave=this.#si.bind(this),this.#j.onclick=this.#Zt.bind(this),this.#z.onclick=this.#ni.bind(this),!1===this.#v)document.querySelector(this.#X).disabled="",document.getElementById("testArea").textContent="",this.#g=new R(window.localStorage,this),this.#g.RestoreMessages(this.#V,this.#p,this.#m,this.#tt,this.#$,this.#H);else{let t=0;g.length>t&&(document.querySelector(g[t++]).onclick=this.#ai.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#ri.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#hi.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#di.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#Si.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#gi.bind(this)),this.#pt=localStorage.getItem("AIMethod"),this.#pt||(this.#pt="centroid",localStorage.setItem("AIMethod",this.#pt))}this.#Y.disabled="","???"===this.#H.textContent?(this.#Bt("Waiting for other player to connect"),this.#x.style.cursor="wait"):(this.#Y.value="surrender",this.#it?(this.#Bt("Your move"),this.#x.style.cursor="crosshair",this.#z.disabled=""):(this.#Bt("Waiting for opponent move"),this.#x.style.cursor="wait"),this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line")}else document.querySelector(r).textContent="back to Game List"}static async OnLoad(l){const c=void 0!==window.msgpack5,d=l.inkBallHubName,u=l.iGameID;document.getElementById("gameID").textContent=u,document.querySelector(".container.inkgame form > input[type='hidden'][name='GameID']").value=u;const S=l.iPlayerID,P=parseInt(document.querySelector(".msgchat").dataset.otherplayerid)||null;l.iOtherPlayerID=P,document.getElementById("playerID").textContent=S;const g=l.bPlayingWithRed,y=l.bPlayerActive,p=l.gameType,m=c&&!0===l.isMessagePackProtocol?new signalR.protocols.msgpack.MessagePackHubProtocol:new signalR.JsonHubProtocol,C=l.servTimeoutMillis,w=l.isReadonly,I=l.pathAfterPointDrawAllowanceSecAmount,O=new Date(l.sLastMoveGameTimeStamp).toISOString(),R=l.version;await async function(l){const c=-1!==import.meta.url.split("/").at(-1).indexOf("min");if(t=c?await import("./shared.min.js"):await import("./shared.js"),i=t.LocalLog,e=t.LocalError,s=t.StatusEnum,n=t.hasDuplicates,o=t.pnpoly,a=t.sortPointsClockwise,r=t.Sleep,-1===l.iOtherPlayerID){const t=await import("./depthFirstSearch.js");h=t.default}}(l);const L=new b(u,S,P,d,signalR.LogLevel.Warning,m,signalR.HttpTransportType.None,C,p,g,y,w,I);await L.PrepareDrawing("#screen","#Player1Name","#Player2Name","#gameStatus","#SurrenderButton","#CancelPath","#Pause","#StopAndDraw","#messageInput","#messagesList","#sendButton",O,null===l.PointsAsJavaScriptArray,R,["#TestBuildGraph","#TestConcaveman","#TestMarkAllCycles","#TestGroupPoints","#TestFindSurroundablePoints","#TestDFS2"]),null!==l.PointsAsJavaScriptArray?(await L.StartSignalRConnection(!1),await L.#Nt(l.PointsAsJavaScriptArray),await L.#Gt(l.PathsAsJavaScriptArray)):await L.StartSignalRConnection(!0),document.getElementById("whichColor").style.color=g?"red":"blue",L.CountPointsDebug("#debug2"),window.game=L}static OnBeforeUnload(){window.game&&window.game.StopSignalRConnection()}#pi(t,i){return t=Math.max(0,Math.min(t,this.#O)),i=Math.max(0,Math.min(i,this.#O)),t=Math.ceil(t),i=Math.floor(i),Math.floor(Math.random()*(i-t))+t}async#mi(){let t,i,e=100;const n=await this.#ot.all();for(;--e>0&&(t=this.#pi(0,this.#O),i=this.#pi(0,this.#R),await this.#at.has(i*this.#O+t)||!await this.#jt(t,i,n)););return new S(this.#y,-1,t,i,s.POINT_FREE_BLUE,0)}async#Ci(){let t,e,n=0,o=0,a=0;const r=this.#mt;for(const t of await this.#at.values())if(void 0!==t&&t.GetFillColor()===r&&t.GetStatus()===s.POINT_FREE_RED){const{x:i,y:e}=t.GetPosition();n+=i,o+=e,a++}if(a<=0)return null;n=parseInt(n/a),o=parseInt(o/a),t=n,e=o;let h="";const l=new Set;let c=0,d=2;const u=await this.#ot.all();for(;++c<=50;){if(l.add(`${t}_${e}`),!1===await this.#at.has(e*this.#O+t)&&!0===await this.#jt(t,e,u)){h+=`checking centroid coords ${t}_${e} succeed\n`;break}h+=`checking coords ${t}_${e} failed #${c}\n`,c>=25&&(d*=2);let i=50;do{t=this.#pi(n-d,n+d+1),e=this.#pi(o-d,o+d+1)}while(--i>0&&l.has(`${t}_${e}`))}if(c>=50)return h+="finding centroid failed\n",i(h),null;i(h);return new S(this.#y,-1,t,e,s.POINT_FREE_BLUE,0)}async#wi(){if(this.#_>=0&&this.#D>=0){let t=this.#_,e=this.#D,n="";const o=new Set;let a=0,r=1;const h=await this.#ot.all();for(;++a<=50;){if(o.add(`${t}_${e}`),!1===await this.#at.has(e*this.#O+t)&&!0===await this.#jt(t,e,h)){n+=`checking nearest coords ${t}_${e} succeed\n`;break}n+=`checking coords ${t}_${e} failed #${a}\n`;let i=20;do{t=this.#pi(this.#_-r,this.#_+r+1),e=this.#pi(this.#D-r,this.#D+r+1)}while(--i>0&&o.has(`${t}_${e}`))}if(a>=50)return n+="finding nearest failed\n",i(n),null;i(n);return new S(this.#y,-1,t,e,s.POINT_FREE_BLUE,0)}return null}#Ii(t){const e=t.vertices,s=function(t,e){t.visited=!0;for(let n of t.adjacents)if(n.visited){if(n!==e){const{x:t,y:e}=n.GetPosition();return i(`cycle found at ${t},${e}`),!0}}else if(s(n,t))return!0;return!1}.bind(this);for(let t=0;t<e.length;t++)e[t].visited=!1;for(let t=0;t<e.length;t++)if(!e[t].visited&&s(e[t],-1))return!0;return!1}async#ci({freePointStatus:t=s.POINT_FREE_BLUE,cpufillCol:i=this.#Ct}={}){const e=[],n=new Map,o=function(t,e){const s=e.GetStatus();return!(!t.includes(s)||e.GetFillColor()!==i)},a=async function(i,s,a,r,h){if(s>=0&&s<this.#O&&a>=0&&a<this.#R){const l=await this.#at.get(a*this.#O+s);if(l&&!0===o([t],l)&&!1===n.has(`${r},${h}_${s},${a}`)&&!1===n.has(`${s},${a}_${r},${h}`)){const t={from:i,to:l};if(n.set(`${r},${h}_${s},${a}`,t),!1===e.includes(i))i.adjacents=[l],e.push(i);else{const t=e.find((t=>t===i));t.adjacents.push(l)}if(!1===e.includes(l))l.adjacents=[i],e.push(l);else{const t=e.find((t=>t===l));t.adjacents.push(i)}}}}.bind(this);for(const i of await this.#at.values())if(i&&!0===o([t,this.POINT_STARTING,this.POINT_IN_PATH],i)){const{x:t,y:e}=i.GetPosition();await a(i,t+1,e,t,e),await a(i,t-1,e,t,e),await a(i,t,e-1,t,e),await a(i,t,e+1,t,e),await a(i,t-1,e-1,t,e),await a(i,t+1,e-1,t,e),await a(i,t-1,e+1,t,e),await a(i,t+1,e+1,t,e)}return{vertices:e,edges:Array.from(n.values()),getNeighbors:function(t){const i=this.vertices.find((i=>i===t));return i?i.adjacents:null}}}async#li(t,e){const n=t.vertices,h=n.length;let l=new Array(h);const c=new Array(h),d=new Array(h),u=new Array(h);for(let t=0;t<h;t++)c[t]=[],l[t]=[];const S=async function(t,i){if(2===d[t])return;if(1===d[t]){g++;let e=i;for(c[e].push(g);e!==t;)e=u[e],c[e].push(g);return}u[t]=i,d[t]=1;const e=n[t];if(e){const{x:i,y:s}=e.GetPosition(),o=await this.#at.get(s*this.#O+i);o.SetStrokeColor("black"),o.SetFillColor("black"),o.StrokeWeight(.2),o.setAttribute("r",6/16),await r(25);for(const i of e.adjacents){const e=n.indexOf(i);e!==u[t]&&await S(e,t)}}d[t]=2}.bind(this),P=async function(t,h){for(let i=0;i<t;i++){const t=h[i];if(void 0!==t&&t.length>0)for(let e=0;e<t.length;e++){const s=l[t[e]];void 0!==s&&s.push(i)}}l=l.filter((t=>t.length>=4)).sort(((t,i)=>i.length-t.length));const c=[],d=await this.#ot.all();for(const t of await this.#at.values())if(void 0!==t&&t.GetFillColor()===e&&s.POINT_FREE_RED===t.GetStatus()){const{x:i,y:e}=t.GetPosition();if(!1===await this.#jt(i,e,d))continue;await this.#at.get(e*this.#O+i)&&c.push({x:i,y:e})}const u=[];for(let t=0;t<=g;t++){const e=l[t];if(e&&e.length>0){let s=`Cycle Number ${t}: `,h=[];const l="var(--bs-teal)",d=e.map(function(t){return n[t].GetPosition()}.bind(this)),S=a(d);for(const t of S){const{x:i,y:e}=t,n=await this.#at.get(e*this.#O+i);n&&(s+=`(${i},${e})`,n.SetStrokeColor(l),n.SetFillColor(l),n.StrokeWeight(.2),n.setAttribute("r",6/this.#L)),await r(50)}let P="",g="";for(const t of c)if(!1!==o(S,t.x,t.y)){P+=`${g}(${t.x},${t.y})`;const i=await this.#at.get(t.y*this.#O+t.x);i&&(i.SetStrokeColor("var(--bs-yellow)"),i.StrokeWeight(.2),i.SetFillColor("var(--bs-yellow)"),i.setAttribute("r",6/this.#L)),g=","}h.unshift(s),u.push(h),i(s+(""!==P?` possible intercepts: ${P}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${l}"][r="${6/this.#L}"]`)).forEach((t=>{t.SetStrokeColor(this.#Ct),t.StrokeWeight(.2),t.SetFillColor(this.#Ct),t.setAttribute("r",6/this.#L)}))}}return u}.bind(this);let g=0,y=h;for(let t=0;t<h;t++)await S(t+1,t);return await P(y,c)}async#yi(t,i){await h(t,t.vertices[0],{enterVertex:()=>{},leaveVertex:()=>{},showCycle:async(t,i)=>{(t=Object.values(t)).forEach((t=>{const{x:i,y:e}=t.GetPosition();t.x=i,t.y=e}));const e=a(t);await this.#Pi(e,250)}})}async#Pi(t,i=25){const e=t.map((t=>{const i=t.GetPosition();return`${i.x},${i.y}`})).join(" ");this.#gt?this.#gt.SetPoints(e):this.#gt=this.#Dt.CreatePolyline(e,"black"),await r(i)}async#ui(t,i){if(void 0===i||t.includes(i)||t.length>60||this.#yt.length>3)return t;if(!1===[s.POINT_FREE_BLUE,s.POINT_STARTING,s.POINT_IN_PATH].includes(i.GetStatus())||i.GetFillColor()!==this.#Ct)return t;const{x:e,y:n}=i.GetPosition();let o=null;if(t.length>0){o=t.at(-1);const{x:s,y:a}=o.GetPosition();if(!(Math.abs(s-e)<=1&&Math.abs(a-n)<=1))return t;t.push(i)}else t.push(i);if(t.length>2&&(await this.#Pi(t),t.length>=4)){const i=t[0].GetPosition();o=t.at(-1);const{x:e,y:s}=o.GetPosition();if(Math.abs(e-i.x)<=1&&Math.abs(s-i.y)<=1){const i=t.slice();i.push(t[0]),this.#yt.push(i)}}const[a,r,h,l,c,d,u,S]=await Promise.all([this.#at.get(n*this.#O+e+1),this.#at.get(n*this.#O+e-1),this.#at.get((n-1)*this.#O+e),this.#at.get((n+1)*this.#O+e),this.#at.get((n-1)*this.#O+e-1),this.#at.get((n-1)*this.#O+e+1),this.#at.get((n+1)*this.#O+e-1),this.#at.get((n+1)*this.#O+e+1)]);a&&await this.#ui(t,a),r&&await this.#ui(t,r),h&&await this.#ui(t,h),l&&await this.#ui(t,l),c&&await this.#ui(t,c),d&&await this.#ui(t,d),u&&await this.#ui(t,u),S&&await this.#ui(t,S);const P=t.lastIndexOf(i);return-1!==P&&(t.splice(P),t.length>=2&&await this.#Pi(t)),t}async#Oi({g:t=null}={}){if(!t)return;const i=t.vertices,e=[];let s;for(const t of i){s=t;const i=[];(await this.#ui(i,s)).length>0&&this.#yt.length>0&&(e.push(this.#yt),this.#yt=[])}return e}async#Ri(t){null===this.#St&&(this.#St=t);const i=t-this.#St;let e=null;switch(this.#pt){case"centroid":e=await this.#Ci(),null===e&&(e=await this.#mi());break;case"nearest":e=await this.#wi(),null===e&&(e=await this.#mi())}null===e?i<2e3&&(this.#Pt=window.requestAnimationFrame(this.#Ri.bind(this))):await this.#Ft(e,(()=>{this.#K=!1,this.#J=!1}))}#Tt(){null===this.#Pt&&(this.#Pt=window.requestAnimationFrame(this.#Ri.bind(this)))}}export{b as InkBallGame};
//# sourceMappingURL=inkball.min.js.map
