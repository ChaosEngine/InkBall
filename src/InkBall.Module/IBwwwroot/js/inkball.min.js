"use strict";let t,i,e,s,n,o,a,r,h;const l=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),c=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),m=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class _{GetKind(){throw new Error("missing GetKind implementation!")}}class d extends _{constructor(t=0,i=0,e=0,n=0,o=s.POINT_FREE,a=0){super(),this.iGameId=t,this.iPlayerId=i,this.iX=e,this.iY=n,this.Status=o,this.iEnclosingPathId=a}GetKind(){return l.POINT}static Format(t,i){let e="("+i.iX+","+i.iY+" - ";switch(void 0!==i.Status?i.Status:i.status){case s.POINT_FREE_RED:e+="red";break;case s.POINT_FREE_BLUE:e+="blue";break;case s.POINT_FREE:e+="";break;case s.POINT_STARTING:e+="starting";break;case s.POINT_IN_PATH:e+="path";break;case s.POINT_OWNED_BY_RED:e+="owned by red";break;case s.POINT_OWNED_BY_BLUE:e+="owned by blue";break;default:throw new Error("Bad point type!")}return t+" places "+e+") point"}}class u extends _{constructor(t=0,i=0,e=0,s="",n=""){super(),this.iId=t,this.iGameId=i,this.iPlayerId=e,this.PointsAsString=s,this.OwnedPointsAsString=n}GetKind(){return l.PATH}static Format(t,i){return`${t} places ${`(${i.PointsAsString||i.pointsAsString}) [${i.OwnedPointsAsString||i.ownedPointsAsString}]`} path`}}class S extends _{constructor(t,i,e){super(),this.OtherPlayerId=t,this.OtherPlayerName=i,this.Message=e}GetKind(){return l.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class P extends _{constructor(t,i,e){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=i,this.Message=e}GetKind(){return l.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class g extends _{constructor(t=""){super(),this.Message=t}GetKind(){return l.PING}static Format(t,i){return t+" says '"+(i.Message||i.message)+"'"}}class y extends _{constructor(t=m.NO_WIN,i=0,e="null"){super(),this.Status=t,this.WinningPlayerId=i,this.Message=e}GetKind(){return l.WIN}static Format(t){let i="";switch(void 0!==t.Status?t.Status:t.status){case m.RED_WINS:i="red.";break;case m.GREEN_WINS:i="blue.";break;case m.NO_WIN:i="no one!";break;case m.DRAW_WIN:i="draw!"}return"And the winner is... "+i}}class p extends _{constructor(){super()}GetKind(){return l.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class w extends _{constructor(t=[],i=[]){super(),this.Points=t,this.Paths=i}GetKind(){return l.POINTS_AND_PATHS}static Deserialize(t){const i=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(i)}}class C extends _{constructor(t=!1){super(),this.DesktopNotifications=t}GetKind(){return l.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class I{constructor({countdownSeconds:t=60,labelSelector:i=null,initialStart:e=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.timerID=-1,this.label=null,this.countdownReachedHandler=s,i&&(this.label=document.querySelector(i)),e&&this.Start()}setTimeFunc(){--this.totalSeconds<=0?(this.Stop(),this.countdownReachedHandler&&this.countdownReachedHandler(this.label)):this.label&&(this.label.textContent=this.pad(parseInt(this.totalSeconds/60))+":"+this.pad(this.totalSeconds%60))}pad(t){const i=t+"";return i.length<2?"0"+i:i}Start(){this.Stop(),this.timerID=setInterval(this.setTimeFunc.bind(this),1e3)}Stop(){this.timerID>0&&clearInterval(this.timerID),this.label&&(this.label.textContent="")}Reset({countdownSeconds:t=60,labelSelector:i=null,initialStart:e=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.label=null,this.countdownReachedHandler=s,i&&(this.label=document.querySelector(i)),e&&this.Start()}}function O(){return"#"+Math.floor(16777215*Math.random()).toString(16)}Function.prototype.callAsWorker=function(t,i){return new Promise(((e,s)=>{const n=`\n${t?[...t].reduce(((t,i)=>t+i.toString()+"\n")):""}\n\nself.onmessage = async function (e) { \n\tconst result = await ( ${this.toString()}.call(null, e.data) );\n\n\tself.postMessage( result ); \n}`,o=new Blob([n],{type:"text/javascript"}),a=new Worker(window.URL.createObjectURL(o));a.onmessage=t=>(e(t.data),a.terminate(),window.URL.revokeObjectURL(o)),a.onerror=t=>(s(t.message),a.terminate(),window.URL.revokeObjectURL(o)),a.postMessage(i)}))};class R{constructor(t,i,s,n,o,a,r,h,l,m=!0,_=!0,d=!1,u=60,S=125){this.g_iGameID=t,this.g_iPlayerID=i,this.m_iOtherPlayerId=s,this.m_bIsCPUGame=-1===this.m_iOtherPlayerId,this.GameType=c[l],this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="var(--redish)",this.COLOR_BLUE="var(--bluish)",this.COLOR_OWNED_RED="var(--owned_by_red)",this.COLOR_OWNED_BLUE="var(--owned_by_blue)",this.DRAWING_PATH_COLOR="var(--path_draw)",this.m_bIsWon=!1,this.m_bPointsAndPathsLoaded=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=S,this.m_Timer=null,this.m_ReconnectTimer=null,this.m_WaitStartTime=null,this.m_TimerOpts={countdownSeconds:u,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.m_iSlowdownLevel=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iGridSpacingX=0,this.m_iGridSpacingY=0,this.m_LineStrokeWidth=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player1Name=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_sMsgListSel=null,this.m_CancelPath=null,this.m_StopAndDraw=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=m,this.m_bIsPlayerActive=_,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.SvgVml=null,this.m_Line=null,this.m_Lines=null,this.m_Points=null,this.m_bViewOnly=d,this.m_MouseCursorOval=null,this.CursorPos={x:-1,y:-1},this.m_ApplicationUserSettings=null,this.m_sLastMoveGameTimeStamp=null,this.m_sVersion=null,this.m_Worker=null,null!==n&&""!==n&&(this.g_SignalRConnection=(new signalR.HubConnectionBuilder).withUrl(n,{transport:r,accessTokenFactory:function(){return`iGameID=${this.g_iGameID}&iPlayerID=${this.g_iPlayerID}`}.bind(this)}).withHubProtocol(a).configureLogging(o).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=h,this.g_SignalRConnection.onclose((async t=>{null!=t&&(e(t),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout((()=>this.Connect()),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5)))})))}async GetPlayerPointsAndPaths(){if(!1===this.m_bPointsAndPathsLoaded){const t=await this.g_SignalRConnection.invoke("GetPlayerPointsAndPaths",this.m_bViewOnly,this.g_iGameID),i=w.Deserialize(t);return void 0!==i.Points&&await this.SetAllPoints(i.Points),void 0!==i.Paths&&await this.SetAllPaths(i.Paths),this.m_bPointsAndPathsLoaded=!0,!0}return!1}async Connect(){try{if(await this.g_SignalRConnection.start(),this.iConnErrCount=0,i("connected; iConnErrCount = "+this.iConnErrCount),!1===this.m_bViewOnly)if(null===sessionStorage.getItem("ApplicationUserSettings")){let t=await this.g_SignalRConnection.invoke("GetUserSettings");if(t){i(t),t=C.Deserialize(t);const e=C.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",e)}this.m_ApplicationUserSettings=new C(t.DesktopNotifications),await this.GetPlayerPointsAndPaths()}else{const t=sessionStorage.getItem("ApplicationUserSettings"),i=C.Deserialize(t);this.m_ApplicationUserSettings=new C(i.DesktopNotifications)}!1===this.m_bPointsAndPathsLoaded&&await this.GetPlayerPointsAndPaths(),null!==this.m_ApplicationUserSettings&&!0===this.m_ApplicationUserSettings.DesktopNotifications&&this.SetupNotifications(),!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()}catch(t){e(t+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout((()=>this.Connect()),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5))}}SetupNotifications(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then((function(t){return"granted"===t||(i("User blocked notifications."),!1)})).catch((function(t){return e(t),!1})):(i("Browser does not support notifications."),!1)}NotifyBrowser(t="Hi there!",s="How are you doing?"){return!(!document.hidden||!0!==this?.m_ApplicationUserSettings?.DesktopNotifications)&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then((function(e){return"granted"===e?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):(i("User blocked notifications."),!1)})).catch((function(t){return e(t),!1})):(i("Browser does not support notifications."),!1))}async StartSignalRConnection(i){return null===this.g_SignalRConnection?Promise.reject(new Error("signalr conn is null")):(!1===this.m_bPointsAndPathsLoaded&&(this.m_bPointsAndPathsLoaded=!i),this.g_SignalRConnection.on("ServerToClientPoint",async function(t){if(this.g_iPlayerID!==t.iPlayerId){const i=this.m_bIsPlayingWithRed?this.m_Player2Name.textContent:this.m_Player1Name.textContent;let e=d.Format(i,t);const s=document.createElement("li");s.textContent=e,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("New Point",e)}await this.ReceivedPointProcessing(t)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let i=t;if(this.g_iPlayerID!==i.iPlayerId){const t=this.m_bIsPlayingWithRed?this.m_Player2Name.textContent:this.m_Player1Name.textContent,e=u.Format(t,i),s=document.createElement("li");s.textContent=e,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("New Path",e)}this.ReceivedPathProcessing(i)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");{let i=t;const e=y.Format(i);let s=document.createElement("li");s.textContent=e,document.querySelector(this.m_sMsgListSel).appendChild(s),this.ReceivedWinProcessing(i),this.NotifyBrowser("We have a winner",e)}}}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(t){const i=t.OtherPlayerId||t.otherPlayerId;this.m_iOtherPlayerId=i;const e=S.Format(t);document.querySelector(".msgchat").dataset.otherplayerid=i;const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-primary"),n.textContent=e,s.appendChild(n),document.querySelector(this.m_sMsgListSel).appendChild(s),null!==this.m_SurrenderButton&&""!==t.OtherPlayerName&&(this.m_Player2Name.textContent=t.OtherPlayerName||t.otherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowStatus("Your move")),this.NotifyBrowser("Player joininig",e),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(i){let e=P.Format(i);const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-warning"),n.textContent=e,s.appendChild(n),document.querySelector(this.m_sMsgListSel).appendChild(s),this.m_bHandlingEvent=!1,e=""===e?"Game interrupted!":e,this.NotifyBrowser("Game interruption",e),t.LocalAlert(e,"Game interruption",(()=>{window.location.href="GamesList"}))}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(t){const i=y.Format(t),e=document.querySelector(this.m_sMsgListSel);if(null!==e){const t=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=i,t.appendChild(s),e.appendChild(t)}this.ReceivedWinProcessing(t),this.NotifyBrowser("We have a winner",i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(t){const i=this.m_bIsPlayingWithRed?this.m_Player2Name.textContent:this.m_Player1Name.textContent,e=g.Format(i,t);let s=document.createElement("li");s.textContent=e,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("User Message",e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerDisconnected",function(t){const i={countdownSeconds:5,initialStart:!0,countdownReachedHandler:function(){const i=t,e=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=i,e.appendChild(s),document.querySelector(this.m_sMsgListSel).appendChild(e),this.NotifyBrowser("User disconnected",i),this.m_ReconnectTimer=null}.bind(this)};this.m_ReconnectTimer?this.m_ReconnectTimer.Reset(i):this.m_ReconnectTimer=new I(i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerConnected",function(t){if(this.m_ReconnectTimer)this.m_ReconnectTimer.Stop(),this.m_ReconnectTimer=null;else{const i=t,e=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-primary"),s.textContent=i,e.appendChild(s),document.querySelector(this.m_sMsgListSel).appendChild(e),this.NotifyBrowser("User connected",i),this.m_ReconnectTimer=null}}.bind(this)),this.g_SignalRConnection.on("ServerToClientStopAndDraw",function(t){if(!t)return;const i=this.m_bIsPlayingWithRed?this.m_Player2Name.textContent:this.m_Player1Name.textContent,e=p.Format(i),s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-info"),n.textContent=e,s.appendChild(n),document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("User "+i+" started drawing new path",e)}.bind(this)),!1===this.m_bIsCPUGame&&(document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",async function(t){t.preventDefault();const i=document.querySelector(this.m_sMsgInputSel).value.trim();if(""===i)return;let e=new g(i);await this.SendData(e)}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1)),this.Connect())}StopSignalRConnection(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),this.m_ReconnectTimer&&this.m_ReconnectTimer.Stop(),this.m_Timer&&this.m_Timer.Stop(),i("Stopped SignalR connection"))}Debug(...t){switch(t.length){case 1:this.m_Debug.textContent=t[0];break;case 2:document.getElementById("debug"+t[1]).textContent=t[0];break;default:for(let i=0;i<t.length;i++){const e=t[i];if(e){const t=document.getElementById("debug"+i);t&&(t.textContent=e)}}}}async SetPoint(t,i,e,n){if(await this.m_Points.has(i*this.m_iGridWidth+t))return;const o=t,a=i,r=this.SvgVml.CreateOval();let h;switch(r.move(o,a),e){case s.POINT_FREE_RED:h=this.COLOR_RED,r.SetStatus(e);break;case s.POINT_FREE_BLUE:h=this.COLOR_BLUE,r.SetStatus(e);break;case s.POINT_FREE:case s.POINT_STARTING:h=this.m_sDotColor,r.SetStatus(e);break;case s.POINT_IN_PATH:h=this.g_iPlayerID===n?!0===this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:!0===this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,r.SetStatus(e);break;case s.POINT_OWNED_BY_RED:h=this.COLOR_OWNED_RED,r.SetStatus(e);break;case s.POINT_OWNED_BY_BLUE:h=this.COLOR_OWNED_BLUE,r.SetStatus(e);break;default:alert("bad point")}r.SetFillColor(h),await this.m_Points.set(i*this.m_iGridWidth+t,r)}GetGameStateForIndexedDb(){return{iGameID:this.g_iGameID,iPlayerID:this.g_iPlayerID,iOtherPlayerId:this.m_iOtherPlayerId,sLastMoveGameTimeStamp:this.m_sLastMoveGameTimeStamp,bPointsAndPathsLoaded:this.m_bPointsAndPathsLoaded,iGridWidth:this.m_iGridWidth,iGridHeight:this.m_iGridHeight}}CreateScreenPointFromIndexedDb(t,i,e,n){const o=t,a=i,r=this.SvgVml.CreateOval();let h;switch(r.move(o,a),e){case s.POINT_FREE_RED:h=this.COLOR_RED,r.SetStatus(e);break;case s.POINT_FREE_BLUE:h=this.COLOR_BLUE,r.SetStatus(e);break;case s.POINT_FREE:case s.POINT_STARTING:h=this.m_sDotColor,r.SetStatus(e);break;case s.POINT_IN_PATH:h=n,r.SetStatus(e);break;case s.POINT_OWNED_BY_RED:h=this.COLOR_OWNED_RED,r.SetStatus(e);break;case s.POINT_OWNED_BY_BLUE:h=this.COLOR_OWNED_BLUE,r.SetStatus(e);break;default:alert("bad point")}return r.SetFillColor(h),r}async SetAllPoints(t){try{await this.m_Points.BeginBulkStorage();for(const[s,n,o,a]of t)await this.SetPoint(s,n,(e=o,e-3),(i=a,i-1))}finally{await this.m_Points.EndBulkStorage()}var i,e}async SetPath(t,i,e,n=0){const o=t.split(" ");let a,r,h="",l="",c=null,m=s.POINT_STARTING;for(const t of o)c=t.split(","),a=parseInt(c[0]),r=parseInt(c[1]),c=await this.m_Points.get(r*this.m_iGridWidth+a),null!=c&&(c.SetStatus(m),m=s.POINT_IN_PATH),l+=`${h}${a},${r}`,h=" ";c=o[0].split(","),a=parseInt(c[0]),r=parseInt(c[1]),c=await this.m_Points.get(r*this.m_iGridWidth+a),null!=c&&c.SetStatus(m),o[0]!==o.at(-1)&&(l+=`${h}${a},${r}`);const _=this.SvgVml.CreatePolyline(l,e?this.m_sDotColor:i?this.COLOR_BLUE:this.COLOR_RED);_.SetID(n),await this.m_Lines.push(_)}async CreateScreenPathFromIndexedDb(t,i,e){const n=t.split(" ");let o,a,r="",h="",l=null,c=s.POINT_STARTING;for(const t of n)l=t.split(","),o=parseInt(l[0]),a=parseInt(l[1]),l=await this.m_Points.get(a*this.m_iGridWidth+o),null!=l&&(l.SetStatus(c),c=s.POINT_IN_PATH),h+=`${r}${o},${a}`,r=" ";l=n[0].split(","),o=parseInt(l[0]),a=parseInt(l[1]),l=await this.m_Points.get(a*this.m_iGridWidth+o),null!=l&&l.SetStatus(c),n[0]!==n.at(-1)&&(h+=`${r}${o},${a}`);const m=this.SvgVml.CreatePolyline(h,i);return m.SetID(e),m}async SetAllPaths(t){try{await this.m_Lines.BeginBulkStorage();for(const i of t)await this.SetPath(i.PointsAsString,this.m_bIsPlayingWithRed,i.iPlayerId===this.g_iPlayerID,i.iId)}finally{await this.m_Lines.EndBulkStorage()}}IsPointBelongingToLine(t,i,e){for(const s of t){const[t,n]=s.split(",");if(t===i&&n===e)return!0}return!1}async SurroundOponentPoints(){const t=this.m_Line.GetPointsArray();if(n(t.slice(0,-1).map((t=>t.x+"_"+t.y)))||t[0].x!==t.at(-1).x||t[0].y!==t.at(-1).y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};let i,e,a;this.m_sDotColor===this.COLOR_RED?(i=this.COLOR_BLUE,e=s.POINT_OWNED_BY_RED,a=this.COLOR_OWNED_RED):(i=this.COLOR_RED,e=s.POINT_OWNED_BY_BLUE,a=this.COLOR_OWNED_BLUE);let r="",h="",l="",c=[];for(const n of await this.m_Points.values())if(void 0!==n&&n.GetFillColor()===i&&[s.POINT_FREE_BLUE,s.POINT_FREE_RED].includes(n.GetStatus())){const{x:i,y:s}=n.GetPosition();!1!==o(t,i,s)&&(h+=`${l}${i},${s}`,l=" ",c.push({point:n,revertStatus:n.GetStatus(),revertFillColor:n.GetFillColor()}),n.SetStatus(e,!0),n.SetFillColor(a))}return""!==h&&(r=t.map(function(t){const i=t.x,e=t.y;return null===i||null===e?"":`${i},${e}`}.bind(this)).join(" ")),{OwnedPoints:c,owned:h,PathPoints:[],path:r,errorDesc:"No surrounded points"}}async IsPointOutsideAllPaths(t,i,e){void 0===e&&(e=await this.m_Lines.all());for(const s of e){const e=s.GetPointsArray();if(!1!==o(e,t,i))return!1}return!0}CreateWaitForPlayerRequest(){}CreatePutPointRequest(t,i){return new d(this.g_iGameID,this.g_iPlayerID,t,i,this.m_bIsPlayingWithRed?s.POINT_FREE_RED:s.POINT_FREE_BLUE,0)}CreatePutPathRequest(t){return new u(0,this.g_iGameID,this.g_iPlayerID,t.path,t.owned)}async SendData(t,s){switch(t.GetKind()){case l.POINT:i(d.Format("some player",t)),this.m_bHandlingEvent=!0;try{const i=await this.g_SignalRConnection.invoke("ClientToServerPoint",t);await this.ReceivedPointProcessing(i)}catch(t){e(t.toString()),void 0!==s&&s()}break;case l.PATH:i(u.Format("some player",t)),this.m_bHandlingEvent=!0;try{const i=await this.g_SignalRConnection.invoke("ClientToServerPath",t);if(Object.prototype.hasOwnProperty.call(i,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(i,"winningPlayerId")){let t=i;this.ReceivedWinProcessing(t)}else{if(!Object.prototype.hasOwnProperty.call(i,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(i,"pointsAsString"))throw new Error("ClientToServerPath bad GetKind!");{let t=i;await this.ReceivedPathProcessing(t)}}}catch(t){e(t.toString()),void 0!==s&&s()}break;case l.PING:try{await this.g_SignalRConnection.invoke("ClientToServerPing",t),document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}catch(t){e(t.toString())}break;case l.STOP_AND_DRAW:try{await this.g_SignalRConnection.invoke("ClientToServerStopAndDraw",t),this.m_bDrawLines=!0,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!0,this.m_StopAndDraw.disabled="disabled"}catch(t){e(t.toString())}break;default:e("unknown object")}}CountDownReachedHandler(t){t&&(t.textContent=""),this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",this.m_Timer=null,this.m_bIsPlayerActive=!1}async ReceivedPointProcessing(t){const i=t.iX,e=t.iY,s=void 0!==t.Status?t.Status:t.status;this.m_sLastMoveGameTimeStamp=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),await this.SetPoint(i,e,s,t.iPlayerId),this.g_iPlayerID!==t.iPlayerId?(this.m_bIsPlayerActive=!0,this.ShowStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&await this.OnCancelClick(),this.m_StopAndDraw.disabled="",this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)):(this.m_bIsPlayerActive=!1,this.ShowStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_MouseCursorOval.Hide(),this.m_CancelPath.disabled="disabled",this.m_StopAndDraw.disabled="",this.m_StopAndDraw.value="Stop and Draw",this.m_Timer?this.m_Timer.Reset(this.m_TimerOpts):this.m_Timer=new I(this.m_TimerOpts),!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()),this.m_bHandlingEvent=!1}async ReceivedPathProcessing(t){if(this.m_sLastMoveGameTimeStamp=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),this.g_iPlayerID!==t.iPlayerId){const i=t.PointsAsString||t.pointsAsString,e=t.OwnedPointsAsString||t.ownedPointsAsString;await this.SetPath(i,this.m_sDotColor===this.COLOR_RED,!1,t.iId);const n=e.split(" "),o=this.m_sDotColor===this.COLOR_RED?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE;for(const t of n){let[i,e]=t.split(",");i=parseInt(i),e=parseInt(e);const s=await this.m_Points.get(e*this.m_iGridWidth+i);void 0!==s&&(s.SetStatus(o),s.SetFillColor(a),await this.m_Points.set(e*this.m_iGridWidth+i,s))}this.m_bIsPlayerActive=!0,this.ShowStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",this.m_MouseCursorOval.Hide(),null!==this.m_Line&&await this.OnCancelClick(),this.m_StopAndDraw.disabled=""}else{let i=this.m_Line.GetPointsArray(),e=i[0].x,n=i[0].y;const o=await this.m_Points.get(n*this.m_iGridWidth+e);void 0!==o&&o.SetStatus(s.POINT_IN_PATH),this.m_Line.SetWidthAndColor(this.m_LineStrokeWidth,this.m_sDotColor),this.m_Line.SetID(t.iId),await this.m_Lines.push(this.m_Line),this.m_iLastX=this.m_iLastY=-1,this.m_Line=null;i=(t.OwnedPointsAsString||t.ownedPointsAsString).split(" ");const a=this.m_sDotColor===this.COLOR_RED?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE;for(const t of i){let[i,e]=t.split(",");i=parseInt(i),e=parseInt(e);const s=await this.m_Points.get(e*this.m_iGridWidth+i);void 0!==s&&(s.SetStatus(a),s.SetFillColor(r),await this.m_Points.set(e*this.m_iGridWidth+i,s))}this.m_bIsPlayerActive=!1,this.ShowStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_MouseCursorOval.Hide(),this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()}this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_bHandlingEvent=!1,this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)}ReceivedWinProcessing(i){this.ShowStatus("Win situation"),this.m_bHandlingEvent=!1;const e=y.Format(i),s=void 0!==i.Status?i.Status:i.status,n=i.WinningPlayerId||i.winningPlayerId;((s===m.RED_WINS||s===m.GREEN_WINS)&&n>0||s===m.DRAW_WIN)&&t.LocalAlert(""===e?"Game won!":e,"Win situation",(()=>{window.location.href="GamesList"}))}Check4Win(t,i,e,n){let o,a;switch(this.GameType){case c.FIRST_CAPTURE:return t.length>0?this.m_bIsPlayingWithRed?m.RED_WINS:m.GREEN_WINS:i.length>0?this.m_bIsPlayingWithRed?m.GREEN_WINS:m.RED_WINS:m.NO_WIN;case c.FIRST_5_CAPTURES:return o=this.m_bIsPlayingWithRed?s.POINT_OWNED_BY_BLUE:s.POINT_OWNED_BY_RED,a=n.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.m_bIsPlayingWithRed?m.GREEN_WINS:m.RED_WINS:(o=this.m_bIsPlayingWithRed?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=e.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.m_bIsPlayingWithRed?m.RED_WINS:m.GREEN_WINS:m.NO_WIN);case c.FIRST_5_PATHS:return i.length>=5?this.m_bIsPlayingWithRed?m.GREEN_WINS:m.RED_WINS:t.length>=5?this.m_bIsPlayingWithRed?m.RED_WINS:m.GREEN_WINS:m.NO_WIN;case c.FIRST_5_ADVANTAGE_PATHS:{const e=t.length-i.length;if(e>=5)return this.m_bIsPlayingWithRed?m.RED_WINS:m.GREEN_WINS;if(e<=-5)return this.m_bIsPlayingWithRed?m.GREEN_WINS:m.RED_WINS}return m.NO_WIN;default:throw new Error("Wrong game type")}}ShowStatus(t=""){"???"===this.m_Player2Name.textContent?this.m_bIsPlayerActive?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_GameStatus.style.color=this.COLOR_RED,null!==t&&""!==t?this.Debug(t,0):this.Debug("",0)}async OnMouseMove(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.textContent||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return void(this.iConnErrCount<=0&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait"));const i=this.SvgVml.ToCursorPoint(t.clientX,t.clientY);let e=i.x+.5,n=i.y+.5;e=parseInt(e),n=parseInt(n);let o=e,a=n;if(this.CursorPos.x===o&&this.CursorPos.y===a||(this.m_MouseCursorOval.move(o,a),this.m_MouseCursorOval.Show(),this.Debug(`[${e},${n}]`,1),this.CursorPos.x=o,this.CursorPos.y=a),this.m_bDrawLines){if(null!==this.m_Line?this.m_Screen.style.cursor="move":this.m_Screen.style.cursor="crosshair",!0===this.m_bMouseDown&&(this.m_iLastX!==e||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-e))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),i=await this.m_Points.get(n*this.m_iGridWidth+e);if(this.m_CancelPath.disabled=this.m_Line.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==i&&t.GetFillColor()===this.m_sDotColor&&i.GetFillColor()===this.m_sDotColor){const r=this.m_Line.ContainsPoint(o,a);if(r<1&&i.GetStatus()!==s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,a))i.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=e,this.m_iLastY=n;else if(1===r&&i.GetStatus()===s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,a)){const t=await this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.rAF_FrameID=null,await this.SendData(this.CreatePutPathRequest(t),(async()=>{await this.OnCancelClick(),t.OwnedPoints.forEach((t=>{const i=t.point;i.RevertOldStatus(),i.SetFillColor(t.revertFillColor)})),this.m_bHandlingEvent=!1}))):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=e,this.m_iLastY=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.m_Line.GetPointsString().endsWith(`${this.m_iLastX},${this.m_iLastY}`)&&(this.m_Line.GetLength()>2?(t.RevertOldStatus(),this.m_Line.RemoveLastPoint(),this.m_iLastX=e,this.m_iLastY=n):await this.OnCancelClick())}}else{let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),i=await this.m_Points.get(n*this.m_iGridWidth+e);if(void 0!==t&&void 0!==i&&t.GetFillColor()===this.m_sDotColor&&i.GetFillColor()===this.m_sDotColor){const r=this.m_iLastX,h=this.m_iLastY;this.m_Line=this.SvgVml.CreatePolyline(`${r},${h} ${o},${a}`,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.SetStatus(s.POINT_STARTING,!0),i.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=e,this.m_iLastY=n}}}else this.m_Screen.style.cursor="crosshair"}async OnMouseDown(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.textContent||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return;const i=this.SvgVml.ToCursorPoint(t.clientX,t.clientY);let e=i.x+.5,n=i.y+.5;if(e=this.m_iMouseX=parseInt(e),n=this.m_iMouseY=parseInt(n),this.m_bMouseDown=!0,this.m_bDrawLines){if((this.m_iLastX!==e||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-e))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),i=await this.m_Points.get(n*this.m_iGridWidth+e);if(this.m_CancelPath.disabled=this.m_Line.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==i&&t.GetFillColor()===this.m_sDotColor&&i.GetFillColor()===this.m_sDotColor){const o=e,a=n,r=this.m_Line.ContainsPoint(o,a);if(r<1&&i.GetStatus()!==s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,a))i.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=e,this.m_iLastY=n;else if(1===r&&i.GetStatus()===s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,a)){const t=await this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.rAF_FrameID=null,await this.SendData(this.CreatePutPathRequest(t),(async()=>{await this.OnCancelClick(),t.OwnedPoints.forEach((t=>{const i=t.point;i.RevertOldStatus(),i.SetFillColor(t.revertFillColor)})),this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=e,this.m_iLastY=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.m_Line.GetPointsString().endsWith(`${this.m_iLastX},${this.m_iLastY}`)&&(this.m_Line.GetLength()>2?(t.RevertOldStatus(),this.m_Line.RemoveLastPoint(),this.m_iLastX=e,this.m_iLastY=n):await this.OnCancelClick())}}else{let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),i=await this.m_Points.get(n*this.m_iGridWidth+e);if(void 0!==t&&void 0!==i&&t.GetFillColor()===this.m_sDotColor&&i.GetFillColor()===this.m_sDotColor){const o=this.m_iLastX,a=this.m_iLastY,r=e,h=n;this.m_Line=this.SvgVml.CreatePolyline(`${o},${a} ${r},${h}`,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.SetStatus(s.POINT_STARTING,!0),i.SetStatus(s.POINT_IN_PATH,!0)}this.m_iLastX=e,this.m_iLastY=n}else if(this.m_iLastX<0||this.m_iLastY<0){let t=await this.m_Points.get(n*this.m_iGridWidth+e);void 0!==t&&t.GetFillColor()===this.m_sDotColor&&(this.m_iLastX=e,this.m_iLastY=n)}}else{this.m_iLastX=e,this.m_iLastY=n;const t=e,i=n;if(void 0!==await this.m_Points.get(i*this.m_iGridWidth+t))return void this.Debug("Wrong point - already existing",0);if(!await this.IsPointOutsideAllPaths(t,i))return void this.Debug("Wrong point, Point is not outside all paths",0);this.rAF_FrameID=null,await this.SendData(this.CreatePutPointRequest(t,i),(()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))}}OnMouseUp(){this.m_bMouseDown=!1}OnMouseLeave(){this.m_MouseCursorOval.Hide()}async OnStopAndDraw(t){if(this.m_Timer)null===this.m_Line&&await this.SendData(new p);else{null!==this.m_Line&&await this.OnCancelClick(),this.m_bDrawLines=!this.m_bDrawLines;const i=t.target;this.m_bDrawLines?i.value="Draw dot":i.value="Draw line",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}}async OnCancelClick(){if(this.m_bDrawLines){if(null!==this.m_Line){const t=this.m_Line.GetPointsArray();this.m_CancelPath.disabled="disabled";for(const i of t){const{x:t,y:e}=i;if(null===t||null===e)continue;const s=await this.m_Points.get(e*this.m_iGridWidth+t);void 0!==s&&s.RevertOldStatus()}this.SvgVml.RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1,this.m_Timer&&(this.m_StopAndDraw.disabled="disabled"),this.Debug("",0)}}CountPointsDebug(t){let i="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='POINT_OWNED_BY_RED']",display:"intercepted(P1:%s, "},{query:"circle[data-status='POINT_OWNED_BY_BLUE']",display:"P2:%s)"}].forEach((function(t){const e=document.querySelectorAll(t.query);i+=t.display.replace("%s",e.length)})),document.querySelector(t).textContent="SVGs by tags: "+i}async RunAIWorker(t){return new Promise(((i,s)=>{this.m_Worker=this.m_Worker??new Worker("../js/AIWorker.Bundle.js"),this.m_Worker.onerror=function(){this.m_Worker.terminate(),this.m_Worker=null,s(new Error("no data"))},this.m_Worker.onmessage=function(t){const n=t.data;switch(n.operation){case"BUILD_GRAPH":case"CONCAVEMAN":case"MARK_ALL_CYCLES":i(n);break;default:e(`unknown params.operation = ${n.operation}`),s(new Error(`unknown params.operation = ${n.operation}`))}},t&&t(this.m_Worker)}))}async OnTestBuildCurrentGraph(t){t.preventDefault();const e=await this.RunAIWorker((t=>{const i=Array.from(this.m_Points.store.entries()).map((([t,i])=>({key:t,value:i.Serialize()}))),e=this.m_Lines.store.map((t=>t.Serialize()));t.postMessage({operation:"BUILD_GRAPH",boardSize:{iGridWidth:this.m_iGridWidth,iGridHeight:this.m_iGridHeight},state:this.GetGameStateForIndexedDb(),points:i,paths:e})}));i("Message received from worker:"),i(e)}async OnTestConcaveman(t){t.preventDefault();const e=await this.RunAIWorker((t=>{const i=Array.from(this.m_Points.store.entries()).map((([t,i])=>({key:t,value:i.Serialize()})));t.postMessage({operation:"CONCAVEMAN",boardSize:{iGridWidth:this.m_iGridWidth,iGridHeight:this.m_iGridHeight},state:this.GetGameStateForIndexedDb(),points:i})}));if(e.convex_hull&&e.convex_hull.length>0){const t=e.convex_hull;this.SvgVml.CreatePolyline(t.map((([t,i])=>parseInt(t)+","+parseInt(i))).join(" "),"green"),i(`convex_hull = ${t}`);const s=e.cw_sorted_verts,n=O();for(const t of s){const{x:i,y:e}=t,s=document.querySelector(`svg > circle[cx="${i}"][cy="${e}"]`);s&&(s.SetStrokeColor(n),s.SetFillColor(n),s.SetZIndex(100),s.setAttribute("r",6/this.m_iGridSpacingX)),await r(50)}}}async OnTestMarkAllCycles(t){t.preventDefault(),i(await this.MarkAllCycles(await this.BuildGraph(),this.COLOR_RED))}async OnTestGroupPoints(t){t.preventDefault();const e=await this.m_Points.get(this.m_iMouseY*this.m_iGridWidth+this.m_iMouseX);void 0!==e?(await this.GroupPointsRecurse([],e),this.workingCyclePolyLine&&(this.SvgVml.RemovePolyline(this.workingCyclePolyLine),this.workingCyclePolyLine=null),this.lastCycle.forEach((t=>{this.SvgVml.CreatePolyline(t.map((function(t){const i=t.GetPosition();return`${i.x},${i.y}`})).join(" "),O())})),i("game.lastCycle = "),i(this.lastCycle),this.lastCycle=[]):i("!!!You need to click first 'blue' starting point with mouse!!!")}async OnTestFindSurroundablePoints(t){t.preventDefault();const e=this.COLOR_RED,n=this.COLOR_BLUE;let r;const h=await this.m_Points.get(this.m_iMouseY*this.m_iGridWidth+this.m_iMouseX),l=[...await this.m_Points.values()];r=void 0!==h?[h]:l;const c=await this.m_Lines.all();for(const t of r)if(void 0!==t&&t.GetFillColor()===e&&[s.POINT_FREE_RED,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:e,y:h}=t.GetPosition();if(!1===await this.IsPointOutsideAllPaths(e,h,c)){i("!!!Point inside path!!!");continue}const m=O(),_=2,d=this.SvgVml.CreateOval(_);d.move(e,h),d.SetStrokeColor(m),d.StrokeWeight(.1),d.SetFillColor("transparent");const u=[];for(const t of l)if(void 0!==t&&t.GetFillColor()===n&&[s.POINT_FREE_BLUE,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:i,y:s}=t.GetPosition();if(!1===await this.IsPointOutsideAllPaths(i,s,c))continue;0<=this.SvgVml.IsPointInCircle({x:i,y:s},{x:e,y:h},_)&&(t.x=i,t.y=s,u.push(t))}if(u.length>2){let t,s=a(u);for(const i of s){if(void 0!==t&&!(Math.abs(t.x-i.x)<=1&&Math.abs(t.y-i.y)<=1)){s=null;break}t=i}if(null===s||!(Math.abs(s.at(-1).x-s[0].x)<=1&&Math.abs(s.at(-1).y-s[0].y)<=1)||!1===o(s,e,h))continue;if(r.length<=1){for(const t of s){const i=document.querySelector(`svg > circle[cx="${t.x}"][cy="${t.y}"]`);i&&(i.SetStrokeColor(m),i.StrokeWeight("0.020em"),i.SetFillColor(m),i.setAttribute("r",6/this.m_iGridSpacingX))}await this.DisplayPointsProgressWithDelay(s,250)}i("circle sorted possible path points: "),i(s)}}}async OnTestDFS2(t){t.preventDefault(),await this.DFS2(await this.BuildGraph(),this.COLOR_RED)}async PrepareDrawing(i,e,s,n,o,a,r,h,l,c,m,_,d,u,S,P=125){if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=P,this.m_Timer=null,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Debug=document.getElementById("debug0"),this.m_Player1Name=document.querySelector(e),this.m_Player2Name=document.querySelector(s),this.m_GameStatus=document.querySelector(n),this.m_SurrenderButton=document.querySelector(o),this.m_CancelPath=document.querySelector(a),this.m_StopAndDraw=document.querySelector(h),this.m_sMsgInputSel=l,this.m_sMsgListSel=c,this.m_sMsgSendButtonSel=m,this.m_Screen=document.querySelector(i),!this.m_Screen)return void alert("no board");this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop;let[g,y]=[...this.m_Screen.classList].find((t=>t.startsWith("boardsize"))).split("-")[1].split("x");this.m_iGridWidth=parseInt(g),this.m_iGridHeight=parseInt(y);let p=this.m_Screen.clientWidth,w=this.m_Screen.clientHeight,C=null;w<=0&&(w=16*this.m_iGridHeight,this.m_Screen.style.height=w+"px",C="100%"),this.m_iGridSpacingX=Math.ceil(p/this.m_iGridWidth),this.m_iGridSpacingY=Math.ceil(w/this.m_iGridHeight),this.m_LineStrokeWidth=3/this.m_iGridSpacingX,this.m_sLastMoveGameTimeStamp=_,this.m_sVersion=u,this.rAF_StartTimeStamp=null,this.rAF_FrameID=null,this.workingCyclePolyLine=null,this.lastCycle=[],this.m_AIMethod=null,this.SvgVml=new t.SvgVml,null===this.SvgVml.CreateSVGVML(this.m_Screen,C,C,{iGridWidth:this.m_iGridWidth,iGridHeight:this.m_iGridHeight})&&alert("SVG is not supported!");const I=new t.GameStateStore(d,this.CreateScreenPointFromIndexedDb.bind(this),this.CreateScreenPathFromIndexedDb.bind(this),this.GetGameStateForIndexedDb.bind(this),this.m_sVersion);if(this.m_Lines=I.GetPathStore(),this.m_Points=I.GetPointStore(),this.m_bPointsAndPathsLoaded=await I.PrepareStore(),!1===this.m_bViewOnly){if(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=this.SvgVml.CreateOval(),this.m_MouseCursorOval.SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.SetZIndex(-1),this.m_MouseCursorOval.Hide(),this.m_MouseCursorOval.setAttribute("data-status","MOUSE_POINTER")),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),this.m_StopAndDraw.onclick=this.OnStopAndDraw.bind(this),!1===this.m_bIsCPUGame)document.querySelector(this.m_sMsgInputSel).disabled="",document.getElementById("testArea").textContent="";else{let t=0;S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestBuildCurrentGraph.bind(this)),S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestConcaveman.bind(this)),S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestMarkAllCycles.bind(this)),S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestGroupPoints.bind(this)),S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestFindSurroundablePoints.bind(this)),S.length>t&&(document.querySelector(S[t++]).onclick=this.OnTestDFS2.bind(this)),this.m_AIMethod=localStorage.getItem("AIMethod"),this.m_AIMethod||(this.m_AIMethod="centroid",localStorage.setItem("AIMethod",this.m_AIMethod))}this.m_SurrenderButton.disabled="","???"===this.m_Player2Name.textContent?(this.ShowStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_StopAndDraw.disabled=""):(this.ShowStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"),this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line")}else document.querySelector(r).textContent="back to Game List"}static async OnLoad(l){const c=void 0!==window.msgpack5,m=l.inkBallHubName,_=l.iGameID;document.getElementById("gameID").textContent=_,document.querySelector(".container.inkgame form > input[type='hidden'][name='GameID']").value=_;const d=l.iPlayerID,u=parseInt(document.querySelector(".msgchat").dataset.otherplayerid)||null;l.iOtherPlayerID=u,document.getElementById("playerID").textContent=d;const S=l.bPlayingWithRed,P=l.bPlayerActive,g=l.gameType,y=c&&!0===l.isMessagePackProtocol?new signalR.protocols.msgpack.MessagePackHubProtocol:new signalR.JsonHubProtocol,p=l.servTimeoutMillis,w=l.isReadonly,C=l.pathAfterPointDrawAllowanceSecAmount,I=new Date(l.sLastMoveGameTimeStamp).toISOString(),O=l.version;await async function(l){const c=-1!==import.meta.url.split("/").at(-1).indexOf("min");if(t=c?await import("./shared.min.js"):await import("./shared.js"),i=t.LocalLog,e=t.LocalError,s=t.StatusEnum,n=t.hasDuplicates,o=t.pnpoly2,a=t.sortPointsClockwise,r=t.Sleep,-1===l.iOtherPlayerID){const t=await import("./depthFirstSearch.js");h=t.default}}(l);const b=new R(_,d,u,m,signalR.LogLevel.Warning,y,signalR.HttpTransportType.None,p,g,S,P,w,C);await b.PrepareDrawing("#screen","#Player1Name","#Player2Name","#gameStatus","#SurrenderButton","#CancelPath","#Pause","#StopAndDraw","#messageInput","#messagesList","#sendButton",I,null===l.PointsAsJavaScriptArray,O,["#TestBuildGraph","#TestConcaveman","#TestMarkAllCycles","#TestGroupPoints","#TestFindSurroundablePoints","#TestDFS2"]),null!==l.PointsAsJavaScriptArray?(await b.StartSignalRConnection(!1),await b.SetAllPoints(l.PointsAsJavaScriptArray),await b.SetAllPaths(l.PathsAsJavaScriptArray)):await b.StartSignalRConnection(!0),document.getElementById("whichColor").style.color=S?"red":"blue",b.CountPointsDebug("#debug2"),window.game=b}static OnBeforeUnload(){window.game&&window.game.StopSignalRConnection()}GetRandomInt(t,i){return t=Math.max(0,Math.min(t,this.m_iGridWidth)),i=Math.max(0,Math.min(i,this.m_iGridWidth)),t=Math.ceil(t),i=Math.floor(i),Math.floor(Math.random()*(i-t))+t}async FindRandomCPUPoint(){let t,i,e=100;const n=await this.m_Lines.all();for(;--e>0&&(t=this.GetRandomInt(0,this.m_iGridWidth),i=this.GetRandomInt(0,this.m_iGridHeight),await this.m_Points.has(i*this.m_iGridWidth+t)||!await this.IsPointOutsideAllPaths(t,i,n)););return new d(this.g_iGameID,-1,t,i,s.POINT_FREE_BLUE,0)}async CalculateCPUCentroid(){let t,e,n=0,o=0,a=0;const r=this.COLOR_RED;for(const t of await this.m_Points.values())if(void 0!==t&&t.GetFillColor()===r&&t.GetStatus()===s.POINT_FREE_RED){const{x:i,y:e}=t.GetPosition();n+=i,o+=e,a++}if(a<=0)return null;n=parseInt(n/a),o=parseInt(o/a),t=n,e=o;let h="";const l=new Set;let c=0,m=2;const _=await this.m_Lines.all();for(;++c<=50;){if(l.add(`${t}_${e}`),!1===await this.m_Points.has(e*this.m_iGridWidth+t)&&!0===await this.IsPointOutsideAllPaths(t,e,_)){h+=`checking centroid coords ${t}_${e} succeed\n`;break}h+=`checking coords ${t}_${e} failed #${c}\n`,c>=25&&(m*=2);let i=50;do{t=this.GetRandomInt(n-m,n+m+1),e=this.GetRandomInt(o-m,o+m+1)}while(--i>0&&l.has(`${t}_${e}`))}if(c>=50)return h+="finding centroid failed\n",i(h),null;i(h);return new d(this.g_iGameID,-1,t,e,s.POINT_FREE_BLUE,0)}async FindNearestCPUPoint(){if(this.m_iLastX>=0&&this.m_iLastY>=0){let t=this.m_iLastX,e=this.m_iLastY,n="";const o=new Set;let a=0,r=1;const h=await this.m_Lines.all();for(;++a<=50;){if(o.add(`${t}_${e}`),!1===await this.m_Points.has(e*this.m_iGridWidth+t)&&!0===await this.IsPointOutsideAllPaths(t,e,h)){n+=`checking nearest coords ${t}_${e} succeed\n`;break}n+=`checking coords ${t}_${e} failed #${a}\n`;let i=20;do{t=this.GetRandomInt(this.m_iLastX-r,this.m_iLastX+r+1),e=this.GetRandomInt(this.m_iLastY-r,this.m_iLastY+r+1)}while(--i>0&&o.has(`${t}_${e}`))}if(a>=50)return n+="finding nearest failed\n",i(n),null;i(n);return new d(this.g_iGameID,-1,t,e,s.POINT_FREE_BLUE,0)}return null}IsGraphCyclic(t){const e=t.vertices,s=function(t,e){t.visited=!0;for(let n of t.adjacents)if(n.visited){if(n!==e){const{x:t,y:e}=n.GetPosition();return i(`cycle found at ${t},${e}`),!0}}else if(s(n,t))return!0;return!1}.bind(this);for(let t=0;t<e.length;t++)e[t].visited=!1;for(let t=0;t<e.length;t++)if(!e[t].visited&&s(e[t],-1))return!0;return!1}async BuildGraph({freePointStatus:t=s.POINT_FREE_BLUE,cpufillCol:i=this.COLOR_BLUE}={}){const e=[],n=new Map,o=function(t,e){const s=e.GetStatus();return!(!t.includes(s)||e.GetFillColor()!==i)},a=async function(i,s,a,r,h){if(s>=0&&s<this.m_iGridWidth&&a>=0&&a<this.m_iGridHeight){const l=await this.m_Points.get(a*this.m_iGridWidth+s);if(l&&!0===o([t],l)&&!1===n.has(`${r},${h}_${s},${a}`)&&!1===n.has(`${s},${a}_${r},${h}`)){const t={from:i,to:l};if(n.set(`${r},${h}_${s},${a}`,t),!1===e.includes(i))i.adjacents=[l],e.push(i);else{const t=e.find((t=>t===i));t.adjacents.push(l)}if(!1===e.includes(l))l.adjacents=[i],e.push(l);else{const t=e.find((t=>t===l));t.adjacents.push(i)}}}}.bind(this);for(const i of await this.m_Points.values())if(i&&!0===o([t,this.POINT_STARTING,this.POINT_IN_PATH],i)){const{x:t,y:e}=i.GetPosition();await a(i,t+1,e,t,e),await a(i,t-1,e,t,e),await a(i,t,e-1,t,e),await a(i,t,e+1,t,e),await a(i,t-1,e-1,t,e),await a(i,t+1,e-1,t,e),await a(i,t-1,e+1,t,e),await a(i,t+1,e+1,t,e)}return{vertices:e,edges:Array.from(n.values()),getNeighbors:function(t){const i=this.vertices.find((i=>i===t));return i?i.adjacents:null}}}async MarkAllCycles(t,e){const n=t.vertices,h=n.length;let l=new Array(h);const c=new Array(h),m=new Array(h),_=new Array(h);for(let t=0;t<h;t++)c[t]=[],l[t]=[];const d=async function(t,i){if(2===m[t])return;if(1===m[t]){S++;let e=i;for(c[e].push(S);e!==t;)e=_[e],c[e].push(S);return}_[t]=i,m[t]=1;const e=n[t];if(e){const{x:i,y:s}=e.GetPosition(),o=await this.m_Points.get(s*this.m_iGridWidth+i);o.SetStrokeColor("black"),o.SetFillColor("black"),o.StrokeWeight(.2),o.setAttribute("r",6/16),await r(25);for(const i of e.adjacents){const e=n.indexOf(i);e!==_[t]&&await d(e,t)}}m[t]=2}.bind(this),u=async function(t,h){for(let i=0;i<t;i++){const t=h[i];if(void 0!==t&&t.length>0)for(let e=0;e<t.length;e++){const s=l[t[e]];void 0!==s&&s.push(i)}}l=l.filter((t=>t.length>=4)).sort(((t,i)=>i.length-t.length));const c=[],m=await this.m_Lines.all();for(const t of await this.m_Points.values())if(void 0!==t&&t.GetFillColor()===e&&s.POINT_FREE_RED===t.GetStatus()){const{x:i,y:e}=t.GetPosition();if(!1===await this.IsPointOutsideAllPaths(i,e,m))continue;await this.m_Points.get(e*this.m_iGridWidth+i)&&c.push({x:i,y:e})}const _=[];for(let t=0;t<=S;t++){const e=l[t];if(e&&e.length>0){let s=`Cycle Number ${t}: `,h=[];const l="var(--bs-teal)",m=e.map(function(t){return n[t].GetPosition()}.bind(this)),d=a(m);for(const t of d){const{x:i,y:e}=t,n=await this.m_Points.get(e*this.m_iGridWidth+i);n&&(s+=`(${i},${e})`,n.SetStrokeColor(l),n.SetFillColor(l),n.StrokeWeight(.2),n.setAttribute("r",6/this.m_iGridSpacingX)),await r(50)}let u="",S="";for(const t of c)if(!1!==o(d,t.x,t.y)){u+=`${S}(${t.x},${t.y})`;const i=await this.m_Points.get(t.y*this.m_iGridWidth+t.x);i&&(i.SetStrokeColor("var(--bs-yellow)"),i.StrokeWeight(.2),i.SetFillColor("var(--bs-yellow)"),i.setAttribute("r",6/this.m_iGridSpacingX)),S=","}h.unshift(s),_.push(h),i(s+(""!==u?` possible intercepts: ${u}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${l}"][r="${6/this.m_iGridSpacingX}"]`)).forEach((t=>{t.SetStrokeColor(this.COLOR_BLUE),t.StrokeWeight(.2),t.SetFillColor(this.COLOR_BLUE),t.setAttribute("r",6/this.m_iGridSpacingX)}))}}return _}.bind(this);let S=0,P=h;for(let t=0;t<h;t++)await d(t+1,t);return await u(P,c)}async DFS2(t,i){await h(t,t.vertices[0],{enterVertex:()=>{},leaveVertex:()=>{},showCycle:async(t,i)=>{(t=Object.values(t)).forEach((t=>{const{x:i,y:e}=t.GetPosition();t.x=i,t.y=e}));const e=a(t);await this.DisplayPointsProgressWithDelay(e,250)}})}async DisplayPointsProgressWithDelay(t,i=25){const e=t.map((t=>{const i=t.GetPosition();return`${i.x},${i.y}`})).join(" ");this.workingCyclePolyLine?this.workingCyclePolyLine.SetPoints(e):this.workingCyclePolyLine=this.SvgVml.CreatePolyline(e,"black"),await r(i)}async GroupPointsRecurse(t,i){if(void 0===i||t.includes(i)||t.length>60||this.lastCycle.length>3)return t;if(!1===[s.POINT_FREE_BLUE,s.POINT_STARTING,s.POINT_IN_PATH].includes(i.GetStatus())||i.GetFillColor()!==this.COLOR_BLUE)return t;const{x:e,y:n}=i.GetPosition();let o=null;if(t.length>0){o=t.at(-1);const{x:s,y:a}=o.GetPosition();if(!(Math.abs(s-e)<=1&&Math.abs(a-n)<=1))return t;t.push(i)}else t.push(i);if(t.length>2&&(await this.DisplayPointsProgressWithDelay(t),t.length>=4)){const i=t[0].GetPosition();o=t.at(-1);const{x:e,y:s}=o.GetPosition();if(Math.abs(e-i.x)<=1&&Math.abs(s-i.y)<=1){const i=t.slice();i.push(t[0]),this.lastCycle.push(i)}}const[a,r,h,l,c,m,_,d]=await Promise.all([this.m_Points.get(n*this.m_iGridWidth+e+1),this.m_Points.get(n*this.m_iGridWidth+e-1),this.m_Points.get((n-1)*this.m_iGridWidth+e),this.m_Points.get((n+1)*this.m_iGridWidth+e),this.m_Points.get((n-1)*this.m_iGridWidth+e-1),this.m_Points.get((n-1)*this.m_iGridWidth+e+1),this.m_Points.get((n+1)*this.m_iGridWidth+e-1),this.m_Points.get((n+1)*this.m_iGridWidth+e+1)]);a&&await this.GroupPointsRecurse(t,a),r&&await this.GroupPointsRecurse(t,r),h&&await this.GroupPointsRecurse(t,h),l&&await this.GroupPointsRecurse(t,l),c&&await this.GroupPointsRecurse(t,c),m&&await this.GroupPointsRecurse(t,m),_&&await this.GroupPointsRecurse(t,_),d&&await this.GroupPointsRecurse(t,d);const u=t.lastIndexOf(i);return-1!==u&&(t.splice(u),t.length>=2&&await this.DisplayPointsProgressWithDelay(t)),t}async GroupPointsIterative({g:t=null}={}){if(!t)return;const i=t.vertices,e=[];let s;for(const t of i){s=t;const i=[];(await this.GroupPointsRecurse(i,s)).length>0&&this.lastCycle.length>0&&(e.push(this.lastCycle),this.lastCycle=[])}return e}async rAFCallBack(t){null===this.rAF_StartTimeStamp&&(this.rAF_StartTimeStamp=t);const i=t-this.rAF_StartTimeStamp;let e=null;switch(this.m_AIMethod){case"centroid":e=await this.CalculateCPUCentroid(),null===e&&(e=await this.FindRandomCPUPoint());break;case"nearest":e=await this.FindNearestCPUPoint(),null===e&&(e=await this.FindRandomCPUPoint())}null===e?i<2e3&&(this.rAF_FrameID=window.requestAnimationFrame(this.rAFCallBack.bind(this))):await this.SendData(e,(()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))}StartCPUCalculation(){null===this.rAF_FrameID&&(this.rAF_FrameID=window.requestAnimationFrame(this.rAFCallBack.bind(this)))}}export{R as InkBallGame};
//# sourceMappingURL=inkball.min.js.map
