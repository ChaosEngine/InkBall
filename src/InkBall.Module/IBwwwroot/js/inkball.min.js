"use strict";let t,e,i,s,n,o,a,r,l;const h=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),c=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),d=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class u{get Kind(){throw new Error("missing Kind implementation!")}}class S extends u{constructor(t=0,e=0,i=0,n=0,o=s.POINT_FREE,a=0){super(),this.iGameId=t,this.iPlayerId=e,this.iX=i,this.iY=n,this.Status=o,this.iEnclosingPathId=a}get Kind(){return h.POINT}static Format(t,e){let i=`(${e.iX},${e.iY} - `;switch(void 0!==e.Status?e.Status:e.status){case s.POINT_FREE_RED:i+="red";break;case s.POINT_FREE_BLUE:i+="blue";break;case s.POINT_FREE:i+="";break;case s.POINT_STARTING:i+="starting";break;case s.POINT_IN_PATH:i+="path";break;case s.POINT_OWNED_BY_RED:i+="owned by red";break;case s.POINT_OWNED_BY_BLUE:i+="owned by blue";break;default:throw new Error("Bad point type!")}return`${t} places ${i}) point`}}class P extends u{constructor(t=0,e=0,i=0,s="",n=""){super(),this.iId=t,this.iGameId=e,this.iPlayerId=i,this.PointsAsString=s,this.OwnedPointsAsString=n}get Kind(){return h.PATH}static Format(t,e){return`${t} places ${`(${e.PointsAsString||e.pointsAsString}) [${e.OwnedPointsAsString||e.ownedPointsAsString}]`} path`}}class y extends u{constructor(t,e,i){super(),this.OtherPlayerId=t,this.OtherPlayerName=e,this.Message=i}get Kind(){return h.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class g extends u{constructor(t,e,i){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=e,this.Message=i}get Kind(){return h.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class p extends u{constructor(t=""){super(),this.Message=t}get Kind(){return h.PING}static Format(t){return t.Message||t.message}}class m extends u{constructor(t=d.NO_WIN,e=0,i="null"){super(),this.Status=t,this.WinningPlayerId=e,this.Message=i}get Kind(){return h.WIN}static Format(t){let e="";switch(void 0!==t.Status?t.Status:t.status){case d.RED_WINS:e="red.";break;case d.GREEN_WINS:e="blue.";break;case d.NO_WIN:e="no one!";break;case d.DRAW_WIN:e="draw!"}return"And the winner is... "+e}}class C extends u{constructor(){super()}get Kind(){return h.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class w extends u{constructor(t=[],e=[]){super(),this.Points=t,this.Paths=e}get Kind(){return h.POINTS_AND_PATHS}static Deserialize(t){const e=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(e)}}class I extends u{constructor({DesktopNotifications:t=!1,ShowChatNotifications:e=!1}){super(),this.DesktopNotifications=t,this.ShowChatNotifications=e}get Kind(){return h.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class O{#t;#e;#i;#s;#n;constructor({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.#t=t,this.#e=this.#t,this.#i=-1,this.#s=null,this.#n=s,e&&(this.#s=document.querySelector(e)),i&&this.Start()}#o(){--this.#e<=0?(this.Stop(),this.#n&&this.#n(this.#s)):this.#s&&(this.#s.textContent=this.#a(parseInt(this.#e/60))+":"+this.#a(this.#e%60))}#a(t){const e=t+"";return e.length<2?"0"+e:e}Start(){this.Stop(),this.#i=setInterval(this.#o.bind(this),1e3)}Stop(){this.#i>0&&clearInterval(this.#i),this.#s&&(this.#s.textContent="")}Reset({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.#t=t,this.#e=this.#t,this.#s=null,this.#n=s,e&&(this.#s=document.querySelector(e)),i&&this.Start()}}class R{#r;#l;#h;#c;constructor(t){this.#r="IB_MessagesBuffer",this.#l=t,this.#h=16,this.#c=null}#d(){const t=this.#l.getItem(this.#r);if(t){const e=JSON.parse(t);return e.conversationHash&&e.conversationHash===this.#c&&e.msgs||[]}return[]}#u(t){const e={conversationHash:this.#c,msgs:t},i=JSON.stringify(e);this.#l.setItem(this.#r,i)}#S(t,e,i,s,n,o){let a,r;const l=document.createElement("li"),h=document.createElement("span");return i?(s?(a=n.textContent,r="red"):(a=o.textContent,r="blue"),l.className="text-end py-1"):(s?(a=o.textContent,r="blue"):(a=n.textContent,r="red"),l.className="text-start py-1"),l.textContent=`${a}:`,h.textContent=e,h.classList=`px-1 rounded ${r}`,l.appendChild(h),t.appendChild(l),l}Append(t,e,i,s,n,o){const a=this.#d();a.push({msg:t,mine:e}),a.length>this.#h&&a.shift(),this.#u(a);const r=document.querySelector(i);this.#S(r,t,e,s,n,o).scrollIntoView()}RestoreMessages(t,e,i,s,n,o){this.#c=e&&i?`${e}_${i}`:null;const a=this.#d(),r=document.querySelector(t);r&&a.forEach((({msg:t,mine:e})=>this.#S(r,t,e,s,n,o)))}}function L(){return"#"+Math.floor(16777215*Math.random()).toString(16)}class _{#P;#y;#g;#p;#m;#C;#w;#I;#O;#R;#L;#_;#D;#b;#E;#f;#N;#v;#G;#T;#A;#W;#M;#k;#F;#x;#B;#U;#$;#H;#Y;#q;#X;#V;#j;#z;#K;#J;#Z;#Q;#tt;#et;#it;#st;#nt;#ot;#at;#rt;#lt;#ht;#ct;#dt;#ut;#St;#Pt;#yt;#gt;#pt;#mt;#Ct;#wt;#It;#Ot;#Rt;#Lt;#_t;#Dt;#bt;#Et;constructor(t,e,s,n,o,a,r,l,h,d=!0,u=!0,S=!0,P=!1,y=60,g=125){this.#g=t,this.#p=e,this.#m=s,this.#G=-1===this.#m,this.#Dt=c[h],this.#Lt=0,this.#_t=2e3,this.#Ct="var(--redish)",this.#wt="var(--bluish)",this.#It="var(--owned_by_red)",this.#Ot="var(--owned_by_blue)",this.#Rt="var(--path_draw)",this.#T=!1,this.#A=!1,this.#C=4e3,this.#w=g,this.#W=null,this.#M=null,this.#k=null,this.#F={countdownSeconds:y,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.#I=0,this.#O=0,this.#R=0,this.#L=0,this.#_=0,this.#x=0,this.#D=-1,this.#b=-1,this.#E=0,this.#f=0,this.#N=0,this.#v=0,this.#B=null,this.#U=null,this.#$=null,this.#H=null,this.#Y=null,this.#q=null,this.#X=null,this.#V=null,this.#j=null,this.#z=null,this.#K=!1,this.#J=!1,this.#Z=!1,this.#Q="",this.#tt=d,this.#et=u,this.#it=S,this.#nt=this.#tt?this.#Ct:this.#wt,this.#Et=null,this.#ot=null,this.#at=null,this.#rt=null,this.#lt=P,this.#ht=null,this.#bt={x:-1,y:-1},this.#ct=null,this.#dt=null,this.#ut=null,this.#St=null,null!==n&&""!==n&&(this.#P=(new signalR.HubConnectionBuilder).withUrl(n,{transport:r,accessTokenFactory:()=>`iGameID=${this.#g}&iPlayerID=${this.#p}`}).withHubProtocol(a).configureLogging(o).build(),this.#P.serverTimeoutInMilliseconds=l,this.#P.onclose((async t=>{null!=t&&(i(t),this.#B.style.cursor="not-allowed",this.#Lt++,setTimeout((()=>this.#ft()),4e3+this.#_t*Math.max(this.#Lt,5)))})))}async#Nt(){if(!1===this.#A){const t=await this.#P.invoke("GetPlayerPointsAndPaths",this.#lt,this.#g),e=w.Deserialize(t);return void 0!==e.Points&&await this.#vt(e.Points),void 0!==e.Paths&&await this.#Gt(e.Paths),this.#A=!0,!0}return!1}async#ft(){try{if(await this.#P.start(),this.#Lt=0,e("connected; iConnErrCount = "+this.#Lt),!1===this.#lt)if(null===sessionStorage.getItem("ApplicationUserSettings")){let t=await this.#P.invoke("GetUserSettings");if(t){e(t),t=I.Deserialize(t);const i=I.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",i)}this.#ct=new I(t),await this.#Nt()}else{const t=sessionStorage.getItem("ApplicationUserSettings"),e=I.Deserialize(t);this.#ct=new I(e)}!1===this.#A&&await this.#Nt(),null!==this.#ct&&!0===this.#ct.DesktopNotifications&&this.#Tt(),!0!==this.#G||this.#it||this.#At()}catch(t){i(t+"; iConnErrCount = "+this.#Lt),this.#B.style.cursor="not-allowed",this.#Lt++,setTimeout((()=>this.#ft()),4e3+this.#_t*Math.max(this.#Lt,5))}}#Tt(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then((function(t){return"granted"===t||(e("User blocked notifications."),!1)})).catch((function(t){return i(t),!1})):(e("Browser does not support notifications."),!1)}#Wt(t="Hi there!",s="How are you doing?"){return!(!document.hidden||null===this.#ct||!0!==this.#ct?.DesktopNotifications)&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then((function(i){return"granted"===i?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):(e("User blocked notifications."),!1)})).catch((function(t){return i(t),!1})):(e("Browser does not support notifications."),!1))}async StartSignalRConnection(e){return null===this.#P?Promise.reject(new Error("signalr conn is null")):(!1===this.#A&&(this.#A=!e),this.#P.on("ServerToClientPoint",(async t=>{if(this.#p!==t.iPlayerId){const e=this.#tt?this.#H.textContent:this.#$.textContent;let i=S.Format(e,t);if(null!==this.#ct&&!0===this.#ct?.ShowChatNotifications){const t=document.createElement("li");t.textContent=i,t.style="font-style:italic",document.querySelector(this.#V).appendChild(t)}this.#Wt("New Point",i)}await this.#Mt(t)})),this.#P.on("ServerToClientPath",(t=>{if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let e=t;if(this.#p!==e.iPlayerId){const t=this.#tt?this.#H.textContent:this.#$.textContent,i=P.Format(t,e);if(null!==this.#ct&&!0===this.#ct?.ShowChatNotifications){const t=document.createElement("li");t.textContent=i,t.style="font-style:italic",document.querySelector(this.#V).appendChild(t)}this.#Wt("New Path",i)}this.#kt(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad Kind!");{let e=t;const i=m.Format(e);let s=document.createElement("li");s.textContent=i,document.querySelector(this.#V).appendChild(s),this.#Ft(e),this.#Wt("We have a winner",i)}}})),this.#P.on("ServerToClientPlayerJoin",(t=>{const e=t.OtherPlayerId||t.otherPlayerId;this.#m=e;const i=y.Format(t);document.querySelector(".msgchat").dataset.otherplayerid=this.#m;const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-primary"),n.textContent=i,s.appendChild(n),document.querySelector(this.#V).appendChild(s),null!==this.#Y&&""!==t.OtherPlayerName&&(this.#H.textContent=t.OtherPlayerName||t.otherPlayerName,this.#Y.value="surrender",this.#xt("Your move")),this.#y.RestoreMessages(this.#V,this.#p,this.#m,this.#tt,this.#$,this.#H),this.#Wt("Player joining",i),this.#J=!1})),this.#P.on("ServerToClientPlayerSurrender",(e=>{let i=g.Format(e);const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-warning"),n.textContent=i,s.appendChild(n),document.querySelector(this.#V).appendChild(s),this.#J=!1,i=""===i?"Game interrupted!":i,this.#Wt("Game interruption",i),t.LocalAlert(i,"Game interruption",(()=>{window.location.href="GamesList"}))})),this.#P.on("ServerToClientPlayerWin",(t=>{const e=m.Format(t),i=document.querySelector(this.#V);if(null!==i){const t=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=e,t.appendChild(s),i.appendChild(t)}this.#Ft(t),this.#Wt("We have a winner",e)})),this.#P.on("ServerToClientPing",(t=>{const e=p.Format(t);this.#y.Append(e,!1,this.#V,this.#tt,this.#$,this.#H),this.#Wt("User Message",e)})),this.#P.on("ServerToClientOtherPlayerDisconnected",(t=>{const e={countdownSeconds:5,labelSelector:null,initialStart:!0,countdownReachedHandler:()=>{const e=t,i=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=e,i.appendChild(s),document.querySelector(this.#V).appendChild(i),this.#Wt("User disconnected",e),this.#M=null}};this.#M?this.#M.Reset(e):this.#M=new O(e)})),this.#P.on("ServerToClientOtherPlayerConnected",(t=>{if(this.#M)this.#M.Stop(),this.#M=null;else{const e=t,i=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-primary"),s.textContent=e,i.appendChild(s),document.querySelector(this.#V).appendChild(i),this.#Wt("User connected",e),this.#M=null}})),this.#P.on("ServerToClientStopAndDraw",(t=>{if(!t)return;const e=this.#tt?this.#H.textContent:this.#$.textContent,i=C.Format(e),s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-info"),n.textContent=i,s.appendChild(n),document.querySelector(this.#V).appendChild(s),this.#Wt("User "+e+" started drawing new path",i)})),!1===this.#G&&(document.querySelector(this.#X).addEventListener("click",(async t=>{t.preventDefault();const e=document.querySelector(this.#q).value.trim();if(""===e)return;let i=new p(e);await this.#Bt(i)}),!1),document.querySelector(this.#q).addEventListener("keyup",(t=>{t.preventDefault(),13===t.keyCode&&document.querySelector(this.#X).click()}),!1)),this.#ft())}StopSignalRConnection(){null!==this.#P&&(this.#P.stop(),this.#M&&this.#M.Stop(),this.#W&&this.#W.Stop(),e("Stopped SignalR connection"))}#Ut(...t){switch(t.length){case 1:this.#U.textContent=t[0];break;case 2:document.getElementById("debug"+t[1]).textContent=t[0];break;default:for(let e=0;e<t.length;e++){const i=t[e];if(i){const t=document.getElementById("debug"+e);t&&(t.textContent=i)}}}}async#$t(t,e,i,n){if(await this.#rt.has(e*this.#O+t))return;const o=t,a=e,r=this.#Et.CreateOval();let l;switch(r.move(o,a),i){case s.POINT_FREE_RED:l=this.#Ct,r.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.#wt,r.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.#nt,r.SetStatus(i);break;case s.POINT_IN_PATH:l=this.#p===n?!0===this.#tt?this.#Ct:this.#wt:!0===this.#tt?this.#wt:this.#Ct,r.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.#It,r.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.#Ot,r.SetStatus(i);break;default:alert("bad point")}r.SetFillColor(l),await this.#rt.set(e*this.#O+t,r)}#Ht(){return{iGameID:this.#g,iPlayerID:this.#p,iOtherPlayerId:this.#m,sLastMoveGameTimeStamp:this.#dt,bPointsAndPathsLoaded:this.#A,iGridWidth:this.#O,iGridHeight:this.#R}}#Yt(t,e,i,n){const o=t,a=e,r=this.#Et.CreateOval();let l;switch(r.move(o,a),i){case s.POINT_FREE_RED:l=this.#Ct,r.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.#wt,r.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.#nt,r.SetStatus(i);break;case s.POINT_IN_PATH:l=n,r.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.#It,r.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.#Ot,r.SetStatus(i);break;default:alert("bad point")}return r.SetFillColor(l),r}async#vt(t){try{await this.#rt.BeginBulkStorage();for(const[s,n,o,a]of t)await this.#$t(s,n,(i=o,i-3),(e=a,e-1))}finally{await this.#rt.EndBulkStorage()}var e,i}async#qt(t,e,i,n=0){const o=t.split(" ");let a,r,l="",h="",c=null,d=s.POINT_STARTING;for(const t of o)[a,r]=t.split(","),a=parseInt(a),r=parseInt(r),c=await this.#rt.get(r*this.#O+a),null!=c&&(c.SetStatus(d),d=s.POINT_IN_PATH),h+=`${l}${a},${r}`,l=" ";[a,r]=o[0].split(","),a=parseInt(a),r=parseInt(r),c=await this.#rt.get(r*this.#O+a),null!=c&&c.SetStatus(d),o[0]!==o.at(-1)&&(h+=`${l}${a},${r}`);const u=this.#Et.CreatePolyline(h,i?this.#nt:e?this.#wt:this.#Ct);u.SetID(n),await this.#at.push(u)}async#Xt(t,e,i){const n=t.split(" ");let o,a,r="",l="",h=null,c=s.POINT_STARTING;for(const t of n)[o,a]=t.split(","),o=parseInt(o),a=parseInt(a),h=await this.#rt.get(a*this.#O+o),null!=h&&(h.SetStatus(c),c=s.POINT_IN_PATH),l+=`${r}${o},${a}`,r=" ";[o,a]=n[0].split(","),o=parseInt(o),a=parseInt(a),h=await this.#rt.get(a*this.#O+o),null!=h&&h.SetStatus(c),n[0]!==n.at(-1)&&(l+=`${r}${o},${a}`);const d=this.#Et.CreatePolyline(l,e);return d.SetID(i),d}async#Gt(t){try{await this.#at.BeginBulkStorage();for(const e of t)await this.#qt(e.PointsAsString,this.#tt,e.iPlayerId===this.#p,e.iId)}finally{await this.#at.EndBulkStorage()}}#Vt(t,e,i){for(const s of t){const[t,n]=s.split(",");if(t===e&&n===i)return!0}return!1}async#jt(){const t=this.#ot.GetPointsArray();if(n(t.slice(0,-1).map((t=>t.x+"_"+t.y)))||t[0].x!==t.at(-1).x||t[0].y!==t.at(-1).y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};let e,i,a;this.#nt===this.#Ct?(e=this.#wt,i=s.POINT_OWNED_BY_RED,a=this.#It):(e=this.#Ct,i=s.POINT_OWNED_BY_BLUE,a=this.#Ot);let r="",l="",h="",c=[];for(const n of await this.#rt.values())if(void 0!==n&&n.GetFillColor()===e&&[s.POINT_FREE_BLUE,s.POINT_FREE_RED].includes(n.GetStatus())){const{x:e,y:s}=n.GetPosition();!1!==o(t,e,s)&&(l+=`${h}${e},${s}`,h=" ",c.push({point:n,revertStatus:n.GetStatus(),revertFillColor:n.GetFillColor()}),n.SetStatus(i,!0),n.SetFillColor(a))}return""!==l&&(r=t.map((t=>{const e=t.x,i=t.y;return null===e||null===i?"":`${e},${i}`})).join(" ")),{OwnedPoints:c,owned:l,PathPoints:[],path:r,errorDesc:"No surrounded points"}}async#zt(t,e,i=undefined){void 0===i&&(i=await this.#at.all());for(const s of i){const i=s.GetPointsArray();if(!1!==o(i,t,e))return!1}return!0}#Kt(){}#Jt(t,e){return new S(this.#g,this.#p,t,e,this.#tt?s.POINT_FREE_RED:s.POINT_FREE_BLUE,0)}#Zt(t){return new P(0,this.#g,this.#p,t.path,t.owned)}async#Bt(t,s=undefined){switch(t.Kind){case h.POINT:e(S.Format("some player",t)),this.#J=!0;try{const e=await this.#P.invoke("ClientToServerPoint",t);await this.#Mt(e)}catch(t){i(t.toString()),void 0!==s&&s()}break;case h.PATH:e(P.Format("some player",t)),this.#J=!0;try{const e=await this.#P.invoke("ClientToServerPath",t);if(Object.prototype.hasOwnProperty.call(e,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(e,"winningPlayerId")){let t=e;this.#Ft(t)}else{if(!Object.prototype.hasOwnProperty.call(e,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(e,"pointsAsString"))throw new Error("ClientToServerPath bad Kind!");{let t=e;await this.#kt(t)}}}catch(t){i(t.toString()),void 0!==s&&s()}break;case h.PING:try{await this.#P.invoke("ClientToServerPing",t),document.querySelector(this.#q).value="",document.querySelector(this.#X).disabled="disabled";const e=t.Message;this.#y.Append(e,!0,this.#V,this.#tt,this.#$,this.#H)}catch(t){i(t.toString())}break;case h.STOP_AND_DRAW:try{await this.#P.invoke("ClientToServerStopAndDraw",t),this.#Z=!0,this.#D=this.#b=-1,this.#ot=null,this.#it=!0,this.#z.disabled="disabled"}catch(t){i(t.toString())}break;default:i("unknown object")}}CountDownReachedHandler(t){t&&(t.textContent=""),this.#z.disabled=this.#j.disabled="disabled",this.#W=null,this.#it=!1}async#Mt(t){const e=t.iX,i=t.iY,s=void 0!==t.Status?t.Status:t.status;this.#dt=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),await this.#$t(e,i,s,t.iPlayerId),this.#p!==t.iPlayerId?(this.#it=!0,this.#xt("Opponent has moved, your turn"),this.#B.style.cursor="crosshair",null!==this.#ot&&await this.#Qt(),this.#z.disabled="",this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line",this.#W&&(this.#W.Stop(),this.#W=null)):(this.#it=!1,this.#xt("Waiting for opponent move"),this.#B.style.cursor="wait",this.#ht.Hide(),this.#j.disabled="disabled",this.#z.disabled="",this.#z.value="Stop and Draw",this.#W?this.#W.Reset(this.#F):this.#W=new O(this.#F),!0!==this.#G||this.#it||this.#At()),this.#J=!1}async#kt(t){if(this.#dt=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),this.#p!==t.iPlayerId){const e=t.PointsAsString||t.pointsAsString,i=t.OwnedPointsAsString||t.ownedPointsAsString;await this.#qt(e,this.#nt===this.#Ct,!1,t.iId);const n=i.split(" "),o=this.#nt===this.#Ct?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=this.#nt===this.#Ct?this.#It:this.#Ot;for(const t of n){let[e,i]=t.split(",");e=parseInt(e),i=parseInt(i);const s=await this.#rt.get(i*this.#O+e);void 0!==s&&(s.SetStatus(o),s.SetFillColor(a),await this.#rt.set(i*this.#O+e,s))}this.#it=!0,this.#xt("Opponent has moved, your turn"),this.#B.style.cursor="crosshair",this.#ht.Hide(),null!==this.#ot&&await this.#Qt(),this.#z.disabled=""}else{let e=this.#ot.GetPointsArray(),i=e[0].x,n=e[0].y;const o=await this.#rt.get(n*this.#O+i);void 0!==o&&o.SetStatus(s.POINT_IN_PATH),this.#ot.SetWidthAndColor(this.#x,this.#nt),this.#ot.SetID(t.iId),await this.#at.push(this.#ot),this.#D=this.#b=-1,this.#ot=null;e=(t.OwnedPointsAsString||t.ownedPointsAsString).split(" ");const a=this.#nt===this.#Ct?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=this.#nt===this.#Ct?this.#It:this.#Ot;for(const t of e){let[e,i]=t.split(",");e=parseInt(e),i=parseInt(i);const s=await this.#rt.get(i*this.#O+e);void 0!==s&&(s.SetStatus(a),s.SetFillColor(r),await this.#rt.set(i*this.#O+e,s))}this.#it=!1,this.#xt("Waiting for opponent move"),this.#B.style.cursor="wait",this.#ht.Hide(),this.#z.disabled=this.#j.disabled="disabled",!0!==this.#G||this.#it||this.#At()}this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line",this.#J=!1,this.#W&&(this.#W.Stop(),this.#W=null)}#Ft(e){this.#xt("Win situation"),this.#J=!1;const i=m.Format(e),s=void 0!==e.Status?e.Status:e.status,n=e.WinningPlayerId||e.winningPlayerId;((s===d.RED_WINS||s===d.GREEN_WINS)&&n>0||s===d.DRAW_WIN)&&t.LocalAlert(""===i?"Game won!":i,"Win situation",(()=>{window.location.href="GamesList"}))}#te(t,e,i,n){let o,a;switch(this.#Dt){case c.FIRST_CAPTURE:return t.length>0?this.#tt?d.RED_WINS:d.GREEN_WINS:e.length>0?this.#tt?d.GREEN_WINS:d.RED_WINS:d.NO_WIN;case c.FIRST_5_CAPTURES:return o=this.#tt?s.POINT_OWNED_BY_BLUE:s.POINT_OWNED_BY_RED,a=n.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#tt?d.GREEN_WINS:d.RED_WINS:(o=this.#tt?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=i.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#tt?d.RED_WINS:d.GREEN_WINS:d.NO_WIN);case c.FIRST_5_PATHS:return e.length>=5?this.#tt?d.GREEN_WINS:d.RED_WINS:t.length>=5?this.#tt?d.RED_WINS:d.GREEN_WINS:d.NO_WIN;case c.FIRST_5_ADVANTAGE_PATHS:{const i=t.length-e.length;if(i>=5)return this.#tt?d.RED_WINS:d.GREEN_WINS;if(i<=-5)return this.#tt?d.GREEN_WINS:d.RED_WINS}return d.NO_WIN;default:throw new Error("Wrong game type")}}#xt(t=""){"???"===this.#H.textContent?this.#it?this.#st.style.color=this.#Ct:this.#st.style.color=this.#wt:this.#it?this.#tt?this.#st.style.color=this.#Ct:this.#st.style.color=this.#wt:this.#tt?this.#st.style.color=this.#wt:this.#st.style.color=this.#Ct,null!==t&&""!==t?this.#Ut(t,0):this.#Ut("",0)}async#ee(t){if(!this.#it||"???"===this.#H.textContent||!0===this.#J||this.#Lt>0)return void(this.#Lt<=0&&!this.#it&&(this.#B.style.cursor="wait"));const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;i=parseInt(i),n=parseInt(n);let o=i,a=n;if(this.#bt.x===o&&this.#bt.y===a||(this.#ht.move(o,a),this.#ht.Show(),this.#Ut(`[${i},${n}]`,1),this.#bt.x=o,this.#bt.y=a),this.#Z){if(null!==this.#ot?this.#B.style.cursor="move":this.#B.style.cursor="crosshair",!0===this.#K&&(this.#D!==i||this.#b!==n)&&Math.abs(parseInt(this.#D-i))<=1&&Math.abs(parseInt(this.#b-n))<=1&&this.#D>=0&&this.#b>=0)if(null!==this.#ot){let t=await this.#rt.get(this.#b*this.#O+this.#D),e=await this.#rt.get(n*this.#O+i);if(this.#j.disabled=this.#ot.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.#nt&&e.GetFillColor()===this.#nt){const r=this.#ot.ContainsPoint(o,a);if(r<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.#ot.AppendPoints(o,a))e.SetStatus(s.POINT_IN_PATH,!0),this.#D=i,this.#b=n;else if(1===r&&e.GetStatus()===s.POINT_STARTING&&!0===this.#ot.AppendPoints(o,a)){const t=await this.#jt();t.owned.length>0?(this.#Ut("Closing path",0),this.#yt=null,await this.#Bt(this.#Zt(t),(async()=>{await this.#Qt(),t.OwnedPoints.forEach((t=>{const e=t.point;e.RevertOldStatus(),e.SetFillColor(t.revertFillColor)})),this.#J=!1}))):this.#Ut(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#D=i,this.#b=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#ot.GetPointsString().endsWith(`${this.#D},${this.#b}`)&&(this.#ot.GetLength()>2?(t.RevertOldStatus(),this.#ot.RemoveLastPoint(),this.#D=i,this.#b=n):await this.#Qt())}}else{let t=await this.#rt.get(this.#b*this.#O+this.#D),e=await this.#rt.get(n*this.#O+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.#nt&&e.GetFillColor()===this.#nt){const r=this.#D,l=this.#b;this.#ot=this.#Et.CreatePolyline(`${r},${l} ${o},${a}`,this.#Rt),this.#j.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0),this.#D=i,this.#b=n}}}else this.#B.style.cursor="crosshair"}async#ie(t){if(!this.#it||"???"===this.#H.textContent||!0===this.#J||this.#Lt>0)return;const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;if(i=this.#E=parseInt(i),n=this.#f=parseInt(n),this.#K=!0,this.#Z){if((this.#D!==i||this.#b!==n)&&Math.abs(parseInt(this.#D-i))<=1&&Math.abs(parseInt(this.#b-n))<=1&&this.#D>=0&&this.#b>=0)if(null!==this.#ot){let t=await this.#rt.get(this.#b*this.#O+this.#D),e=await this.#rt.get(n*this.#O+i);if(this.#j.disabled=this.#ot.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.#nt&&e.GetFillColor()===this.#nt){const o=i,a=n,r=this.#ot.ContainsPoint(o,a);if(r<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.#ot.AppendPoints(o,a))e.SetStatus(s.POINT_IN_PATH,!0),this.#D=i,this.#b=n;else if(1===r&&e.GetStatus()===s.POINT_STARTING&&!0===this.#ot.AppendPoints(o,a)){const t=await this.#jt();t.owned.length>0?(this.#Ut("Closing path",0),this.#yt=null,await this.#Bt(this.#Zt(t),(async()=>{await this.#Qt(),t.OwnedPoints.forEach((t=>{const e=t.point;e.RevertOldStatus(),e.SetFillColor(t.revertFillColor)})),this.#K=!1,this.#J=!1}))):this.#Ut(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#D=i,this.#b=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#ot.GetPointsString().endsWith(`${this.#D},${this.#b}`)&&(this.#ot.GetLength()>2?(t.RevertOldStatus(),this.#ot.RemoveLastPoint(),this.#D=i,this.#b=n):await this.#Qt())}}else{let t=await this.#rt.get(this.#b*this.#O+this.#D),e=await this.#rt.get(n*this.#O+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.#nt&&e.GetFillColor()===this.#nt){const o=this.#D,a=this.#b,r=i,l=n;this.#ot=this.#Et.CreatePolyline(`${o},${a} ${r},${l}`,this.#Rt),this.#j.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0)}this.#D=i,this.#b=n}else if(this.#D<0||this.#b<0){let t=await this.#rt.get(n*this.#O+i);void 0!==t&&t.GetFillColor()===this.#nt&&(this.#D=i,this.#b=n)}}else{this.#D=i,this.#b=n;const t=i,e=n;if(void 0!==await this.#rt.get(e*this.#O+t))return void this.#Ut("Wrong point - already existing",0);if(!await this.#zt(t,e))return void this.#Ut("Wrong point, Point is not outside all paths",0);this.#yt=null,await this.#Bt(this.#Jt(t,e),(()=>{this.#K=!1,this.#J=!1}))}}#se(){this.#K=!1}#ne(){this.#ht.Hide()}async#oe(t){if(this.#W)null===this.#ot&&await this.#Bt(new C);else{null!==this.#ot&&await this.#Qt(),this.#Z=!this.#Z;const e=t.target;this.#Z?e.value="Draw dot":e.value="Draw line",this.#D=this.#b=-1,this.#ot=null}}async#Qt(){if(this.#Z){if(null!==this.#ot){const t=this.#ot.GetPointsArray();this.#j.disabled="disabled";for(const e of t){const{x:t,y:i}=e;if(null===t||null===i)continue;const s=await this.#rt.get(i*this.#O+t);void 0!==s&&s.RevertOldStatus()}this.#Et.RemovePolyline(this.#ot),this.#ot=null}this.#D=this.#b=-1,this.#W&&(this.#z.disabled="disabled"),this.#Ut("",0)}}CountPointsDebug(t){let e="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='POINT_OWNED_BY_RED']",display:"intercepted(P1:%s, "},{query:"circle[data-status='POINT_OWNED_BY_BLUE']",display:"P2:%s)"}].forEach((function(t){const i=document.querySelectorAll(t.query);e+=t.display.replace("%s",i.length)})),document.querySelector(t).textContent="SVGs by tags: "+e}async#ae(t){return new Promise(((e,s)=>{this.#St=this.#St??new Worker("../js/AIWorker.Bundle.js"),this.#St.onerror=function(){this.#St.terminate(),this.#St=null,s(new Error("no data"))},this.#St.onmessage=function(t){const n=t.data;switch(n.operation){case"BUILD_GRAPH":case"CONCAVEMAN":case"MARK_ALL_CYCLES":e(n);break;default:i(`unknown params.operation = ${n.operation}`),s(new Error(`unknown params.operation = ${n.operation}`))}},t&&t(this.#St)}))}async#re(t){t.preventDefault();const i=await this.#ae((t=>{const e=Array.from(this.#rt.store.entries()).map((([t,e])=>({key:t,value:e.Serialize()}))),i=this.#at.store.map((t=>t.Serialize()));t.postMessage({operation:"BUILD_GRAPH",boardSize:{iGridWidth:this.#O,iGridHeight:this.#R},state:this.#Ht(),points:e,paths:i})}));e("Message received from worker:"),e(i)}async#le(t){t.preventDefault();const i=await this.#ae((t=>{const e=Array.from(this.#rt.store.entries()).map((([t,e])=>({key:t,value:e.Serialize()})));t.postMessage({operation:"CONCAVEMAN",boardSize:{iGridWidth:this.#O,iGridHeight:this.#R},state:this.#Ht(),points:e})}));if(i.convex_hull&&i.convex_hull.length>0){const t=i.convex_hull;this.#Et.CreatePolyline(t.map((([t,e])=>parseInt(t)+","+parseInt(e))).join(" "),"green").SetID(-1),e(`convex_hull = ${t}`);const s=i.cw_sorted_verts,n=L();for(const t of s){const{x:e,y:i}=t,s=document.querySelector(`svg > circle[cx="${e}"][cy="${i}"]`);s&&(s.SetStrokeColor(n),s.SetFillColor(n),s.SetZIndex(100),s.setAttribute("r",6/this.#L)),await r(50)}}}async#he(t){t.preventDefault(),e(await this.#ce(await this.#de(),this.#Ct))}async#ue(t){t.preventDefault();const i=await this.#rt.get(this.#f*this.#O+this.#E);void 0!==i?(await this.#Se([],i),null!==this.#gt&&(this.#Et.RemovePolyline(this.#gt),this.#gt=null),this.#pt.forEach((t=>{this.#Et.CreatePolyline(t.map((function(t){const e=t.GetPosition();return`${e.x},${e.y}`})).join(" "),L()).SetID(-1)})),e("game.lastCycle = "),e(this.#pt),this.#pt=[]):e("!!!First you need to click 'blue' starting point with mouse!!!")}async#Pe(t){t.preventDefault();const i=this.#Ct,n=this.#wt;let r;const l=await this.#rt.get(this.#f*this.#O+this.#E),h=[...await this.#rt.values()];r=void 0!==l?[l]:h;const c=await this.#at.all();for(const t of r)if(void 0!==t&&t.GetFillColor()===i&&[s.POINT_FREE_RED,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:i,y:l}=t.GetPosition();if(!1===await this.#zt(i,l,c)){e("!!!Point inside path!!!");continue}const d=L(),u=2,S=this.#Et.CreateOval(u);S.move(i,l),S.SetStrokeColor(d),S.StrokeWeight(.1),S.SetFillColor("transparent");const P=[];for(const t of h)if(void 0!==t&&t.GetFillColor()===n&&[s.POINT_FREE_BLUE,s.POINT_IN_PATH].includes(t.GetStatus())){const{x:e,y:s}=t.GetPosition();if(!1===await this.#zt(e,s,c))continue;0<=this.#Et.IsPointInCircle({x:e,y:s},{x:i,y:l},u)&&(t.x=e,t.y=s,P.push(t))}if(P.length>2){let t=a(P),s=t.at(-1);for(let e=t.length-2;e>0;e--){const i=t[e];if(!(Math.abs(s.x-i.x)<=1&&Math.abs(s.y-i.y)<=1)){t=null;break}s=i}if(null===t||!(Math.abs(t.at(-1).x-t[0].x)<=1&&Math.abs(t.at(-1).y-t[0].y)<=1)||!1===o(t,i,l))continue;if(r.length<=1){for(const e of t){const t=document.querySelector(`svg > circle[cx="${e.x}"][cy="${e.y}"]`);t&&(t.SetStrokeColor(d),t.StrokeWeight("0.020em"),t.SetFillColor(d),t.setAttribute("r",6/this.#L))}await this.#ye(t,250)}e("circle sorted possible path points: "),e(t)}}}async#ge(t){t.preventDefault(),await this.#pe(await this.#de(),this.#Ct)}async#me(t){t.preventDefault();const i=this.#Ct,s=this.#wt,n=await this.#rt.get(this.#f*this.#O+this.#E);if(!n)return void e("!!!First you need to click starting point with mouse!!!");const{x:o,y:a}=n.GetPosition(),r=n.GetFillColor();e(`FloodFill start point (${o},${a}), color = '${r===i?"HUMAN":"CPU"}'`),await this.#Ce(n,r===i?s:i,"green")}async#we(t){document.getElementById("cbSrvMnuBlue").checked=!1}async#Ie(t){document.getElementById("cbSrvMnuRed").checked=!1}async PrepareDrawing(e,i,s,n,o,a,r,l,h,c,d,u,S,P,y,g,p=125){if(this.#T=!1,this.#C=4e3,this.#w=p,this.#W=null,this.#k=null,this.#I=0,this.#D=-1,this.#b=-1,this.#E=0,this.#f=0,this.#N=0,this.#v=0,this.#K=!1,this.#J=!1,this.#Z=!1,this.#Q="",this.#nt=this.#tt?this.#Ct:this.#wt,this.#ot=null,this.#U=document.getElementById("debug0"),this.#$=document.querySelector(i),this.#H=document.querySelector(s),this.#st=document.querySelector(n),this.#Y=document.querySelector(o),this.#j=document.querySelector(a),this.#z=document.querySelector(l),this.#q=h,this.#V=c,this.#X=d,this.#B=document.querySelector(e),!this.#B)return void alert("no board");this.#N=this.#B.offsetLeft,this.#v=this.#B.offsetTop;let[m,C]=[...this.#B.classList].find((t=>t.startsWith("boardsize"))).split("-")[1].split("x");this.#O=parseInt(m),this.#R=parseInt(C);let w=this.#B.clientWidth,I=this.#B.clientHeight,O=null;I<=0&&(I=16*this.#R,this.#B.style.height=I+"px",O="100%"),this.#L=Math.ceil(w/this.#O),this.#_=Math.ceil(I/this.#R),this.#x=3/this.#L,this.#dt=u,this.#ut=P,this.#Pt=null,this.#yt=null,this.#gt=null,this.#pt=[],this.#mt=null,this.#Et=new t.SvgVml,null===this.#Et.CreateSVGVML(this.#B,O,O,{iGridWidth:this.#O,iGridHeight:this.#R})&&alert("SVG is not supported!");const L=new t.GameStateStore(S,this.#Yt.bind(this),this.#Xt.bind(this),this.#Ht.bind(this),this.#ut);if(this.#at=L.GetPathStore(),this.#rt=L.GetPointStore(),this.#A=await L.PrepareStore(),!1===this.#lt){if(null===this.#ht&&(this.#ht=this.#Et.CreateOval(),this.#ht.SetFillColor(this.#nt),this.#ht.SetZIndex(-1),this.#ht.Hide(),this.#ht.setAttribute("data-status","MOUSE_POINTER")),this.#B.onmousedown=this.#ie.bind(this),this.#B.onmousemove=this.#ee.bind(this),this.#B.onmouseup=this.#se.bind(this),this.#B.onmouseleave=this.#ne.bind(this),this.#j.onclick=this.#Qt.bind(this),this.#z.onclick=this.#oe.bind(this),!1===this.#G)document.querySelector(this.#q).disabled="",document.getElementById("testArea").textContent="",this.#y=new R(window.localStorage,this),this.#y.RestoreMessages(this.#V,this.#p,this.#m,this.#tt,this.#$,this.#H);else{if(!0===JSON.parse(document.querySelector(g[0]).dataset.servicemode.toLowerCase())){let t=0;y.length>t&&(document.querySelector(y[t++]).onclick=this.#re.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#le.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#he.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#ue.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#Pe.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#ge.bind(this)),y.length>t&&(document.querySelector(y[t++]).onclick=this.#me.bind(this)),document.querySelector(g[1]).onclick=this.#we.bind(this),document.querySelector(g[2]).onclick=this.#Ie.bind(this)}this.#mt=localStorage.getItem("AIMethod"),this.#mt||(this.#mt="centroid",localStorage.setItem("AIMethod",this.#mt))}this.#Y.disabled="","???"===this.#H.textContent?(this.#xt("Waiting for other player to connect"),this.#B.style.cursor="wait"):(this.#Y.value="surrender",this.#it?(this.#xt("Your move"),this.#B.style.cursor="crosshair",this.#z.disabled=""):(this.#xt("Waiting for opponent move"),this.#B.style.cursor="wait"),this.#Z?this.#z.value="Draw dot":this.#z.value="Draw line")}else document.querySelector(r).textContent="back to Game List";const _=document.getElementById("whichColor"),D=document.getElementById("whichPlayer");_.style.color=this.#nt,this.#tt?(_.textContent="red",this.#et?(this.#$.style.color=this.#Ct,this.#H.style.color=this.#wt,D.textContent="Player1"):(this.#$.style.color=this.#wt,this.#H.style.color=this.#Ct,D.textContent="Player2")):(_.textContent="blue",this.#et?(this.#$.style.color=this.#wt,this.#H.style.color=this.#Ct,D.textContent="Player1"):(this.#$.style.color=this.#Ct,this.#H.style.color=this.#wt,D.textContent="Player2"))}static async OnLoad(h){const c=void 0!==window.msgpack5,d=h.inkBallHubName,u=h.iGameID;document.getElementById("gameID").textContent=u,document.querySelector(".container.inkgame form > input[type='hidden'][name='GameID']").value=u;const S=h.iPlayerID,P=parseInt(document.querySelector(".msgchat").dataset.otherplayerid)||null;h.iOtherPlayerID=P,document.getElementById("playerID").textContent=S;const y=h.bPlayingWithRed,g=h.bIsThisPlayer1,p=h.bPlayerActive,m=h.gameType,C=c&&!0===h.isMessagePackProtocol?new signalR.protocols.msgpack.MessagePackHubProtocol:new signalR.JsonHubProtocol,w=h.servTimeoutMillis,I=h.isReadonly,O=h.pathAfterPointDrawAllowanceSecAmount,R=new Date(h.sLastMoveGameTimeStamp).toISOString(),L=h.version;await async function(h){const c=-1!==import.meta.url.split("/").at(-1).indexOf("min");if(t=c?await import("./shared.min.js"):await import("./shared.js"),e=t.LocalLog,i=t.LocalError,s=t.StatusEnum,n=t.hasDuplicates,o=t.pnpoly,a=t.sortPointsClockwise,r=t.Sleep,-1===h.iOtherPlayerID){const t=await import("./depthFirstSearch.js");l=t.default}}(h);const D=new _(u,S,P,d,signalR.LogLevel.Warning,C,signalR.HttpTransportType.None,w,m,y,g,p,I,O);await D.PrepareDrawing("#screen","#Player1Name","#Player2Name","#gameStatus","#SurrenderButton","#CancelPath","#Pause","#StopAndDraw","#messageInput","#messagesList","#sendButton",R,null===h.PointsAsJavaScriptArray,L,["#TestBuildGraph","#TestConcaveman","#TestMarkAllCycles","#TestGroupPoints","#TestFindSurroundablePoints","#TestDFS2","#FloodFill"],["#serviceMenu","#cbSrvMnuRed","#cbSrvMnuBlue"]),null!==h.PointsAsJavaScriptArray?(await D.StartSignalRConnection(!1),await D.#vt(h.PointsAsJavaScriptArray),await D.#Gt(h.PathsAsJavaScriptArray)):await D.StartSignalRConnection(!0),D.CountPointsDebug("#debug2"),window.game=D}static OnBeforeUnload(){window.game&&window.game.StopSignalRConnection()}#Oe(t,e){return t=Math.max(0,Math.min(t,this.#O)),e=Math.max(0,Math.min(e,this.#O)),t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}async#Re(){let t,e,i=100;const n=await this.#at.all();for(;--i>0&&(t=this.#Oe(0,this.#O),e=this.#Oe(0,this.#R),await this.#rt.has(e*this.#O+t)||!await this.#zt(t,e,n)););return new S(this.#g,-1,t,e,s.POINT_FREE_BLUE,0)}async#Le(){let t,i,n=0,o=0,a=0;const r=this.#Ct;for(const t of await this.#rt.values())if(void 0!==t&&t.GetFillColor()===r&&t.GetStatus()===s.POINT_FREE_RED){const{x:e,y:i}=t.GetPosition();n+=e,o+=i,a++}if(a<=0)return null;n=parseInt(n/a),o=parseInt(o/a),t=n,i=o;let l="";const h=new Set;let c=0,d=2;const u=await this.#at.all();for(;++c<=50;){if(h.add(`${t}_${i}`),!1===await this.#rt.has(i*this.#O+t)&&!0===await this.#zt(t,i,u)){l+=`checking centroid coords ${t}_${i} succeed\n`;break}l+=`checking coords ${t}_${i} failed #${c}\n`,c>=25&&(d*=2);let e=50;do{t=this.#Oe(n-d,n+d+1),i=this.#Oe(o-d,o+d+1)}while(--e>0&&h.has(`${t}_${i}`))}if(c>=50)return l+="finding centroid failed\n",e(l),null;e(l);return new S(this.#g,-1,t,i,s.POINT_FREE_BLUE,0)}async#_e(){if(this.#D>=0&&this.#b>=0){let t=this.#D,i=this.#b,n="";const o=new Set;let a=0,r=1;const l=await this.#at.all();for(;++a<=50;){if(o.add(`${t}_${i}`),!1===await this.#rt.has(i*this.#O+t)&&!0===await this.#zt(t,i,l)){n+=`checking nearest coords ${t}_${i} succeed\n`;break}n+=`checking coords ${t}_${i} failed #${a}\n`;let e=20;do{t=this.#Oe(this.#D-r,this.#D+r+1),i=this.#Oe(this.#b-r,this.#b+r+1)}while(--e>0&&o.has(`${t}_${i}`))}if(a>=50)return n+="finding nearest failed\n",e(n),null;e(n);return new S(this.#g,-1,t,i,s.POINT_FREE_BLUE,0)}return null}#De(t){const i=t.vertices,s=(t,i)=>{t.visited=!0;for(let n of t.adjacents)if(n.visited){if(n!==i){const{x:t,y:i}=n.GetPosition();return e(`cycle found at ${t},${i}`),!0}}else if(s(n,t))return!0;return!1};for(let t=0;t<i.length;t++)i[t].visited=!1;for(let t=0;t<i.length;t++)if(!i[t].visited&&s(i[t],-1))return!0;return!1}async#de({freePointStatus:t=s.POINT_FREE_BLUE,cpufillCol:e=this.#wt}={}){const i=[],n=new Map,o=function(t,i){const s=i.GetStatus();return!(!t.includes(s)||i.GetFillColor()!==e)},a=async(e,s,a,r,l)=>{if(s>=0&&s<this.#O&&a>=0&&a<this.#R){const h=await this.#rt.get(a*this.#O+s);if(h&&!0===o([t],h)&&!1===n.has(`${r},${l}_${s},${a}`)&&!1===n.has(`${s},${a}_${r},${l}`)){const t={from:e,to:h};if(n.set(`${r},${l}_${s},${a}`,t),!1===i.includes(e))e.adjacents=[h],i.push(e);else{const t=i.find((t=>t===e));t.adjacents.push(h)}if(!1===i.includes(h))h.adjacents=[e],i.push(h);else{const t=i.find((t=>t===h));t.adjacents.push(e)}}}};for(const e of await this.#rt.values())if(e&&!0===o([t,this.POINT_STARTING,this.POINT_IN_PATH],e)){const{x:t,y:i}=e.GetPosition();await a(e,t+1,i,t,i),await a(e,t-1,i,t,i),await a(e,t,i-1,t,i),await a(e,t,i+1,t,i),await a(e,t-1,i-1,t,i),await a(e,t+1,i-1,t,i),await a(e,t-1,i+1,t,i),await a(e,t+1,i+1,t,i)}return{vertices:i,edges:Array.from(n.values()),getNeighbors:function(t){const e=this.vertices.find((e=>e===t));return e?e.adjacents:null}}}async#ce(t,i){const n=t.vertices,l=n.length;let h=new Array(l);const c=new Array(l),d=new Array(l),u=new Array(l);for(let t=0;t<l;t++)c[t]=[],h[t]=[];const S=async(t,e)=>{if(2===d[t])return;if(1===d[t]){P++;let i=e;for(c[i].push(P);i!==t;)i=u[i],c[i].push(P);return}u[t]=e,d[t]=1;const i=n[t];if(i){const{x:e,y:s}=i.GetPosition(),o=await this.#rt.get(s*this.#O+e);o.SetStrokeColor("black"),o.SetFillColor("black"),o.StrokeWeight(.2),o.setAttribute("r",6/16),await r(25);for(const e of i.adjacents){const i=n.indexOf(e);i!==u[t]&&await S(i,t)}}d[t]=2};let P=0,y=l;for(let t=0;t<l;t++)await S(t+1,t);return await(async(t,l)=>{for(let e=0;e<t;e++){const t=l[e];if(void 0!==t&&t.length>0)for(let i=0;i<t.length;i++){const s=h[t[i]];void 0!==s&&s.push(e)}}h=h.filter((t=>t.length>=4)).sort(((t,e)=>e.length-t.length));const c=[],d=await this.#at.all();for(const t of await this.#rt.values())if(void 0!==t&&t.GetFillColor()===i&&s.POINT_FREE_RED===t.GetStatus()){const{x:e,y:i}=t.GetPosition();if(!1===await this.#zt(e,i,d))continue;await this.#rt.get(i*this.#O+e)&&c.push({x:e,y:i})}const u=[];for(let t=0;t<=P;t++){const i=h[t];if(i&&i.length>0){let s=`Cycle Number ${t}: `,l=[];const h="var(--bs-teal)",d=i.map((t=>n[t].GetPosition())),S=a(d);for(const t of S){const{x:e,y:i}=t,n=await this.#rt.get(i*this.#O+e);n&&(s+=`(${e},${i})`,n.SetStrokeColor(h),n.SetFillColor(h),n.StrokeWeight(.2),n.setAttribute("r",6/this.#L)),await r(50)}let P="",y="";for(const t of c)if(!1!==o(S,t.x,t.y)){P+=`${y}(${t.x},${t.y})`;const e=await this.#rt.get(t.y*this.#O+t.x);e&&(e.SetStrokeColor("var(--bs-yellow)"),e.StrokeWeight(.2),e.SetFillColor("var(--bs-yellow)"),e.setAttribute("r",6/this.#L)),y=","}l.unshift(s),u.push(l),e(s+(""!==P?` possible intercepts: ${P}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${h}"][r="${6/this.#L}"]`)).forEach((t=>{t.SetStrokeColor(this.#wt),t.StrokeWeight(.2),t.SetFillColor(this.#wt),t.setAttribute("r",6/this.#L)}))}}return u})(y,c)}async#pe(t,e){await l(t,t.vertices[0],{enterVertex:()=>{},leaveVertex:()=>{},showCycle:async(t,e)=>{(t=Object.values(t)).forEach((t=>{const{x:e,y:i}=t.GetPosition();t.x=e,t.y=i}));const i=a(t);await this.#ye(i,250)}})}async#ye(t,e=25){const i=t.map((t=>{const e=t.GetPosition();return`${e.x},${e.y}`})).join(" ");null===this.#gt?(this.#gt=this.#Et.CreatePolyline(i,"black"),this.#gt.SetID(-1)):this.#gt.SetPoints(i),e>0&&await r(e)}#be(t,e){let i=t(e),s=t(t(e));for(;i!==s;)i=t(i),s=t(t(s));let n=0;for(i=e;i!==s;)i=t(i),s=t(s),n+=1;let o=1;for(s=t(i);i!==s;)s=t(s),o+=1;return{lam:o,mu:n}}async#Se(t,e){if(void 0===e||t.includes(e)||t.length>60||this.#pt.length>3)return t;if(!1===[s.POINT_FREE_BLUE,s.POINT_STARTING,s.POINT_IN_PATH].includes(e.GetStatus())||e.GetFillColor()!==this.#wt)return t;const{x:i,y:n}=e.GetPosition();if(t.length>0){const s=t.at(-1),{x:o,y:a}=s.GetPosition();if(!(Math.abs(o-i)<=1&&Math.abs(a-n)<=1))return t;t.push(e)}else t.push(e);if(t.length>2&&(await this.#ye(t),t.length>=4)){const e=t[0].GetPosition(),i=t.at(-1),{x:s,y:n}=i.GetPosition();if(Math.abs(s-e.x)<=1&&Math.abs(n-e.y)<=1){const e=t.slice();e.push(t[0]),this.#pt.push(e),this.#be((t=>Number.isInteger(t)?e[t]:e[e.indexOf(t)+1]),0)}}const[o,a,r,l,h,c,d,u]=await Promise.all([this.#rt.get(n*this.#O+i+1),this.#rt.get(n*this.#O+i-1),this.#rt.get((n-1)*this.#O+i),this.#rt.get((n+1)*this.#O+i),this.#rt.get((n-1)*this.#O+i-1),this.#rt.get((n-1)*this.#O+i+1),this.#rt.get((n+1)*this.#O+i-1),this.#rt.get((n+1)*this.#O+i+1)]);await this.#Se(t,o),await this.#Se(t,a),await this.#Se(t,r),await this.#Se(t,l),await this.#Se(t,h),await this.#Se(t,c),await this.#Se(t,d),await this.#Se(t,u);const S=t.lastIndexOf(e);return-1!==S&&(t.splice(S),t.length>=2&&await this.#ye(t)),t}async#Ce(t,i,n){const a=[t.GetPosition()],r=new Set,l=new Map;for(;a.length>0;){const{x:t,y:e}=a.shift(),o=[{x:t-1,y:e},{x:t+1,y:e},{x:t,y:e-1},{x:t,y:e+1}];for(const t of o)if(!1==(t.x<0||t.y<0||t.x>=this.#O||t.y>=this.#R)){const e=t.y*this.#O+t.x;let o,l;if(r.has(e)?(l=null,o=n):(l=await this.#rt.get(e),o=void 0!==l?l.GetFillColor():null),o===i)a.push(t);else if(null===o){const n=this.#Et.CreateOval();n.move(t.x,t.y),n.SetStrokeColor(i),n.StrokeWeight(.3),n.SetFillColor(i),n.SetStatus(s.POINT_FREE_BLUE),await this.#rt.set(e,n)}}}if(l.size>3){const i=[...l.values()],s=i.splice(-1,1);let n=s[0];for(let t=i.length;t>0;t--){const t=i.findIndex((t=>Math.abs(t.x-n.x)<=1&&Math.abs(t.y-n.y)<=1));if(-1===t)break;n=i.splice(t,1)[0],s.push(n)}const{x:a,y:r}=t.GetPosition();if(s.length<=3||!(Math.abs(s.at(-1).x-s[0].x)<=1&&Math.abs(s.at(-1).y-s[0].y)<=1)||!1===o(s,a,r))return;e(s),await this.#ye(s.map((({point:t})=>t)),0)}}async#Ee(t){null===this.#Pt&&(this.#Pt=t);const e=t-this.#Pt;let i=null;switch(this.#mt){case"centroid":i=await this.#Le(),null===i&&(i=await this.#Re());break;case"nearest":i=await this.#_e(),null===i&&(i=await this.#Re())}null===i?e<2e3&&(this.#yt=window.requestAnimationFrame(this.#Ee.bind(this))):await this.#Bt(i,(()=>{this.#K=!1,this.#J=!1}))}#At(){null===this.#yt&&(this.#yt=window.requestAnimationFrame(this.#Ee.bind(this)))}}export{_ as InkBallGame};
//# sourceMappingURL=inkball.min.js.map
