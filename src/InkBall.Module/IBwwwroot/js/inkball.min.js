"use strict";let t,e,i,s,n,o,a,r,l,h;const c=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),d=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),u=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class S{get Kind(){throw new Error("missing Kind implementation!")}}class P extends S{constructor(t=0,e=0,i=0,n=0,o=s.POINT_FREE,a=0){super(),this.iGameId=t,this.iPlayerId=e,this.iX=i,this.iY=n,this.Status=o,this.iEnclosingPathId=a}get Kind(){return c.POINT}static Format(t,e){let i=`(${e.iX},${e.iY} - `;switch(void 0!==e.Status?e.Status:e.status){case s.POINT_FREE_RED:i+="red";break;case s.POINT_FREE_BLUE:i+="blue";break;case s.POINT_FREE:i+="";break;case s.POINT_STARTING:i+="starting";break;case s.POINT_IN_PATH:i+="path";break;case s.POINT_OWNED_BY_RED:i+="owned by red";break;case s.POINT_OWNED_BY_BLUE:i+="owned by blue";break;default:throw new Error("Bad point type!")}return`${t} places ${i}) point`}}class g extends S{constructor(t=0,e=0,i=0,s="",n=""){super(),this.iId=t,this.iGameId=e,this.iPlayerId=i,this.PointsAsString=s,this.OwnedPointsAsString=n}get Kind(){return c.PATH}static Format(t,e){return`${t} places ${`(${e.PointsAsString||e.pointsAsString}) [${e.OwnedPointsAsString||e.ownedPointsAsString}]`} path`}}class m extends S{constructor(t,e,i){super(),this.OtherPlayerId=t,this.OtherPlayerName=e,this.Message=i}get Kind(){return c.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class y extends S{constructor(t,e,i){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=e,this.Message=i}get Kind(){return c.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class p extends S{constructor(t=""){super(),this.Message=t}get Kind(){return c.PING}static Format(t){return t.Message||t.message}}class C extends S{constructor(t=u.NO_WIN,e=0,i="null"){super(),this.Status=t,this.WinningPlayerId=e,this.Message=i}get Kind(){return c.WIN}static Format(t){let e="";switch(void 0!==t.Status?t.Status:t.status){case u.RED_WINS:e="red.";break;case u.GREEN_WINS:e="blue.";break;case u.NO_WIN:e="no one!";break;case u.DRAW_WIN:e="draw!"}return"And the winner is... "+e}}class w extends S{constructor(){super()}get Kind(){return c.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class O extends S{constructor(t=[],e=[]){super(),this.Points=t,this.Paths=e}get Kind(){return c.POINTS_AND_PATHS}static Deserialize(t){const e=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(e)}}class I extends S{constructor({DesktopNotifications:t=!1,ShowChatNotifications:e=!1}){super(),this.DesktopNotifications=t,this.ShowChatNotifications=e}get Kind(){return c.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class L{#t;#e;#i;#s;#n;constructor({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.#t=t,this.#e=this.#t,this.#i=-1,this.#s=null,this.#n=s,e&&(this.#s=document.querySelector(e)),i&&this.Start()}#o(){--this.#e<=0?(this.Stop(),this.#n&&this.#n(this.#s)):this.#s&&(this.#s.textContent=this.#a(parseInt(this.#e/60))+":"+this.#a(this.#e%60))}#a(t){const e=t+"";return e.length<2?"0"+e:e}Start(){this.Stop(),this.#i=setInterval(this.#o.bind(this),1e3)}Stop(){this.#i>0&&clearInterval(this.#i),this.#s&&(this.#s.textContent="")}Reset({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.#t=t,this.#e=this.#t,this.#s=null,this.#n=s,e&&(this.#s=document.querySelector(e)),i&&this.Start()}}class b{#r;#l;#h;#c;constructor(t){this.#r="IB_MessagesBuffer",this.#l=t,this.#h=16,this.#c=null}#d(){const t=this.#l.getItem(this.#r);if(t){const e=JSON.parse(t);return e.conversationHash&&e.conversationHash===this.#c&&e.msgs||[]}return[]}#u(t){const e={conversationHash:this.#c,msgs:t},i=JSON.stringify(e);this.#l.setItem(this.#r,i)}#S(t,e,i,s,n,o){let a,r;const l=document.createElement("li"),h=document.createElement("span");return i?(s?(a=n.textContent,r="red"):(a=o.textContent,r="blue"),l.className="text-end py-1"):(s?(a=o.textContent,r="blue"):(a=n.textContent,r="red"),l.className="text-start py-1"),l.textContent=`${a}:`,h.textContent=e,h.classList=`px-1 rounded ${r}`,l.appendChild(h),t.appendChild(l),l}Append(t,e,i,s,n,o){const a=this.#d();a.push({msg:t,mine:e}),a.length>this.#h&&a.shift(),this.#u(a);const r=document.querySelector(i);this.#S(r,t,e,s,n,o).scrollIntoView()}RestoreMessages(t,e,i,s,n,o){this.#c=e&&i?`${e}_${i}`:null;const a=this.#d(),r=document.querySelector(t);r&&a.forEach((({msg:t,mine:e})=>this.#S(r,t,e,s,n,o)))}}function R(){return"#"+((1<<24)*Math.random()|0).toString(16).padStart(6,"0")}class v{#P;#g;#m;#y;#p;#C;#w;#O;#I;#L;#b;#R;#v;#f;#D;#N;#E;#_;#G;#T;#A;#W;#k;#M;#F;#x;#B;#Y;#U;#X;#H;#$;#q;#V;#z;#j;#J;#K;#Z;#Q;#tt;#et;#it;#st;#nt;#ot;#at;#rt;#lt;#ht;#ct;#dt;#ut;#St;#Pt;#gt;#mt;#yt;#pt;#Ct;#wt;#Ot;#It;#Lt;#bt;#Rt;#vt;#ft;#Dt;#Nt;#Et;#_t;#Gt;#Tt;constructor(t,e,s,n,o,a,r,l,h,c=!0,u=!0,S=!0,P=!1,g=60,m=125){this.#m=t,this.#y=e,this.#p=s,this.#A=-1===this.#p,this.#Dt=d[h],this.#vt=0,this.#ft=2e3,this.#Ot="var(--redish)",this.#It="var(--bluish)",this.#Lt="var(--owned_by_red)",this.#bt="var(--owned_by_blue)",this.#Rt="var(--path_draw)",this.#W=!1,this.#k=!1,this.#C=4e3,this.#w=m,this.#M=null,this.#F=null,this.#x=null,this.#B={countdownSeconds:g,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.#O=0,this.#I=0,this.#L=0,this.#b=0,this.#R=0,this.#Y=0,this.#v=-1,this.#f=-1,this.#D=-1,this.#N=-1,this.#E=0,this.#_=0,this.#G=0,this.#T=0,this.#U=null,this.#X=null,this.#H=null,this.#$=null,this.#q=null,this.#V=null,this.#z=null,this.#j=null,this.#J=null,this.#K=null,this.#Z=!1,this.#Q=!1,this.#tt=!1,this.#et="",this.#it=c,this.#st=u,this.#nt=S,this.#at=this.#it?this.#Ot:this.#It,this.#Et=null,this.#rt=null,this.#lt=null,this.#ht=null,this.#ct=P,this.#dt=null,this.#Nt={x:-1,y:-1},this.#ut=null,this.#St=null,this.#Pt=null,this.#gt=null,this.#_t="Browser does not support notifications.",this.#Gt="User blocked notifications.",this.#Tt="We have a winner",null!==n&&""!==n&&(this.#P=(new signalR.HubConnectionBuilder).withUrl(n,{transport:r,accessTokenFactory:()=>`iGameID=${this.#m}&iPlayerID=${this.#y}`}).withHubProtocol(a).configureLogging(o).build(),this.#P.serverTimeoutInMilliseconds=l,this.#P.onclose((async t=>{null!=t&&(i(t),this.#U.style.cursor="not-allowed",this.#vt++,setTimeout((()=>this.#At()),4e3+this.#ft*Math.max(this.#vt,5)))})))}async#Wt(){if(!1===this.#k){const t=await this.#P.invoke("GetPlayerPointsAndPaths",this.#ct,this.#m),e=O.Deserialize(t);return void 0!==e.Points&&await this.#kt(e.Points),void 0!==e.Paths&&await this.#Mt(e.Paths),this.#k=!0,!0}return!1}async#At(){try{if(await this.#P.start(),this.#vt=0,e("connected; iConnErrCount = "+this.#vt),!1===this.#ct)if(null===sessionStorage.getItem("ApplicationUserSettings")){let t=await this.#P.invoke("GetUserSettings");if(t){e(t),t=I.Deserialize(t);const i=I.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",i)}this.#ut=new I(t),await this.#Wt()}else{const t=sessionStorage.getItem("ApplicationUserSettings"),e=I.Deserialize(t);this.#ut=new I(e)}!1===this.#k&&await this.#Wt(),null!==this.#ut&&!0===this.#ut.DesktopNotifications&&this.#Ft(),!0!==this.#A||this.#nt||this.#xt()}catch(t){i(t+"; iConnErrCount = "+this.#vt),this.#U.style.cursor="not-allowed",this.#vt++,setTimeout((()=>this.#At()),4e3+this.#ft*Math.max(this.#vt,5))}}#Ft(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then((function(t){return"granted"===t||(e(this.#Gt),!1)})).catch((function(t){return i(t),!1})):(e(this.#_t),!1)}#Bt(t="Hi there!",s="How are you doing?"){return!(!document.hidden||null===this.#ut||!0!==this.#ut?.DesktopNotifications)&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then((function(i){return"granted"===i?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):(e(this.#Gt),!1)})).catch((function(t){return i(t),!1})):(e(this.#_t),!1))}async StartSignalRConnection(e){return null===this.#P?Promise.reject(new Error("signalr conn is null")):(!1===this.#k&&(this.#k=!e),this.#P.on("ServerToClientPoint",(async t=>{if(this.#y!==t.iPlayerId){const e=this.#it?this.#$.textContent:this.#H.textContent;let i=P.Format(e,t);if(null!==this.#ut&&!0===this.#ut?.ShowChatNotifications){const t=document.createElement("li");t.textContent=i,t.style="font-style:italic",document.querySelector(this.#j).appendChild(t)}this.#Bt("New Point",i)}await this.#Yt(t)})),this.#P.on("ServerToClientPath",(t=>{if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let e=t;if(this.#y!==e.iPlayerId){const t=this.#it?this.#$.textContent:this.#H.textContent,i=g.Format(t,e);if(null!==this.#ut&&!0===this.#ut?.ShowChatNotifications){const t=document.createElement("li");t.textContent=i,t.style="font-style:italic",document.querySelector(this.#j).appendChild(t)}this.#Bt("New Path",i)}this.#Ut(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad Kind!");{let e=t;const i=C.Format(e);let s=document.createElement("li");s.textContent=i,document.querySelector(this.#j).appendChild(s),this.#Xt(e),this.#Bt(this.#Tt,i)}}})),this.#P.on("ServerToClientPlayerJoin",(t=>{const e=t.OtherPlayerId||t.otherPlayerId;this.#p=e;const i=m.Format(t);document.querySelector(".msgchat").dataset.otherplayerid=this.#p;const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-primary"),n.textContent=i,s.appendChild(n),document.querySelector(this.#j).appendChild(s),null!==this.#q&&""!==t.OtherPlayerName&&(this.#$.textContent=t.OtherPlayerName||t.otherPlayerName,this.#q.value="surrender",this.#Ht("Your move")),this.#g.RestoreMessages(this.#j,this.#y,this.#p,this.#it,this.#H,this.#$),this.#Bt("Player joining",i),this.#Q=!1})),this.#P.on("ServerToClientPlayerSurrender",(e=>{let i=y.Format(e);const s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-warning"),n.textContent=i,s.appendChild(n),document.querySelector(this.#j).appendChild(s),this.#Q=!1,i=""===i?"Game interrupted!":i,this.#Bt("Game interruption",i),t.LocalAlert(i,"Game interruption",(()=>{window.location.href="GamesList"}))})),this.#P.on("ServerToClientPlayerWin",(t=>{const e=C.Format(t),i=document.querySelector(this.#j);if(null!==i){const t=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=e,t.appendChild(s),i.appendChild(t)}this.#Xt(t),this.#Bt(this.#Tt,e)})),this.#P.on("ServerToClientPing",(t=>{const e=p.Format(t);this.#g.Append(e,!1,this.#j,this.#it,this.#H,this.#$),this.#Bt("User Message",e)})),this.#P.on("ServerToClientOtherPlayerDisconnected",(t=>{const e={countdownSeconds:5,labelSelector:null,initialStart:!0,countdownReachedHandler:()=>{const e=t,i=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-warning"),s.textContent=e,i.appendChild(s),document.querySelector(this.#j).appendChild(i),this.#Bt("User disconnected",e),this.#F=null}};this.#F?this.#F.Reset(e):this.#F=new L(e)})),this.#P.on("ServerToClientOtherPlayerConnected",(t=>{if(this.#F)this.#F.Stop(),this.#F=null;else{const e=t,i=document.createElement("li"),s=document.createElement("strong");s.classList.add("text-primary"),s.textContent=e,i.appendChild(s),document.querySelector(this.#j).appendChild(i),this.#Bt("User connected",e),this.#F=null}})),this.#P.on("ServerToClientStopAndDraw",(t=>{if(!t)return;const e=this.#it?this.#$.textContent:this.#H.textContent,i=w.Format(e),s=document.createElement("li"),n=document.createElement("strong");n.classList.add("text-info"),n.textContent=i,s.appendChild(n),document.querySelector(this.#j).appendChild(s),this.#Bt("User "+e+" started drawing new path",i)})),!1===this.#A&&(document.querySelector(this.#z).addEventListener("click",(async t=>{t.preventDefault();const e=document.querySelector(this.#V).value.trim();if(""===e)return;let i=new p(e);await this.#$t(i)}),!1),document.querySelector(this.#V).addEventListener("keyup",(t=>{t.preventDefault(),13===t.keyCode&&document.querySelector(this.#z).click()}),!1)),this.#At())}StopSignalRConnection(){null!==this.#P&&(this.#P.stop(),this.#F&&this.#F.Stop(),this.#M&&this.#M.Stop(),e("Stopped SignalR connection"))}#qt(...t){switch(t.length){case 1:this.#X.textContent=t[0];break;case 2:document.getElementById("debug"+t[1]).textContent=t[0];break;default:for(let e=0;e<t.length;e++){const i=t[e];if(i){const t=document.getElementById("debug"+e);t&&(t.textContent=i)}}}}async#Vt(t,e,i,n){if(await this.#ht.has(e*this.#I+t))return;const o=t,a=e,r=this.#Et.CreateOval();let l;switch(r.move(o,a),i){case s.POINT_FREE_RED:l=this.#Ot,r.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.#It,r.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.#at,r.SetStatus(i);break;case s.POINT_IN_PATH:l=this.#y===n?!0===this.#it?this.#Ot:this.#It:!0===this.#it?this.#It:this.#Ot,r.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.#Lt,r.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.#bt,r.SetStatus(i);break;default:alert("bad point")}r.SetFillColor(l),await this.#ht.set(e*this.#I+t,r)}#zt(){return{iGameID:this.#m,iPlayerID:this.#y,iOtherPlayerId:this.#p,sLastMoveGameTimeStamp:this.#St,bPointsAndPathsLoaded:this.#k,iGridWidth:this.#I,iGridHeight:this.#L}}#jt(t,e,i,n){const o=t,a=e,r=this.#Et.CreateOval();let l;switch(r.move(o,a),i){case s.POINT_FREE_RED:l=this.#Ot,r.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.#It,r.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.#at,r.SetStatus(i);break;case s.POINT_IN_PATH:l=n,r.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.#Lt,r.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.#bt,r.SetStatus(i);break;default:alert("bad point")}return r.SetFillColor(l),r}async#kt(t){try{await this.#ht.BeginBulkStorage();for(const[s,n,o,a]of t)await this.#Vt(s,n,(i=o,i-3),(e=a,e-1))}finally{await this.#ht.EndBulkStorage()}var e,i}async#Jt(t,e,i,n=0){const o=t.split(" ");let a,r,l="",h="",c=null,d=s.POINT_STARTING;for(const t of o)[a,r]=t.split(","),a=parseInt(a),r=parseInt(r),c=await this.#ht.get(r*this.#I+a),null!=c&&(c.SetStatus(d),d=s.POINT_IN_PATH),h+=`${l}${a},${r}`,l=" ";[a,r]=o[0].split(","),a=parseInt(a),r=parseInt(r),c=await this.#ht.get(r*this.#I+a),null!=c&&c.SetStatus(d),o[0]!==o.at(-1)&&(h+=`${l}${a},${r}`);const u=this.#Et.CreatePolyline(h,i?this.#at:e?this.#It:this.#Ot);u.SetID(n),await this.#lt.push(u)}async#Kt(t,e,i){const n=t.split(" ");let o,a,r="",l="",h=null,c=s.POINT_STARTING;for(const t of n)[o,a]=t.split(","),o=parseInt(o),a=parseInt(a),h=await this.#ht.get(a*this.#I+o),null!=h&&(h.SetStatus(c),c=s.POINT_IN_PATH),l+=`${r}${o},${a}`,r=" ";[o,a]=n[0].split(","),o=parseInt(o),a=parseInt(a),h=await this.#ht.get(a*this.#I+o),null!=h&&h.SetStatus(c),n[0]!==n.at(-1)&&(l+=`${r}${o},${a}`);const d=this.#Et.CreatePolyline(l,e);return d.SetID(i),d}async#Mt(t){try{await this.#lt.BeginBulkStorage();for(const e of t)await this.#Jt(e.PointsAsString,this.#it,e.iPlayerId===this.#y,e.iId)}finally{await this.#lt.EndBulkStorage()}}#Zt(t,e,i){for(const s of t){const[t,n]=s.split(",");if(t===e&&n===i)return!0}return!1}async#Qt(){const t=this.#rt.GetPointsArray();if(n(t.slice(0,-1).map((t=>t.x+"_"+t.y)))||t[0].x!==t.at(-1).x||t[0].y!==t.at(-1).y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};let e,i,a;this.#at===this.#Ot?(e=this.#It,i=s.POINT_OWNED_BY_RED,a=this.#Lt):(e=this.#Ot,i=s.POINT_OWNED_BY_BLUE,a=this.#bt);let r="",l="",h="",c=[];for(const n of await this.#ht.values())if(void 0!==n&&n.GetFillColor()===e&&[s.POINT_FREE_BLUE,s.POINT_FREE_RED].includes(n.GetStatus())){const{x:e,y:s}=n.GetPosition();!1!==o(t,e,s)&&(l+=`${h}${e},${s}`,h=" ",c.push({point:n,revertStatus:n.GetStatus(),revertFillColor:n.GetFillColor()}),n.SetStatus(i,!0),n.SetFillColor(a))}return""!==l&&(r=t.map((t=>{const e=t.x,i=t.y;return null===e||null===i?"":`${e},${i}`})).join(" ")),{OwnedPoints:c,owned:l,PathPoints:[],path:r,errorDesc:"No surrounded points"}}#te(){}#ee(t,e){return new P(this.#m,this.#y,t,e,this.#it?s.POINT_FREE_RED:s.POINT_FREE_BLUE,0)}#ie(t){return new g(0,this.#m,this.#y,t.path,t.owned)}async#$t(t,s=void 0){switch(t.Kind){case c.POINT:e(P.Format("some player",t)),this.#Q=!0;try{const e=await this.#P.invoke("ClientToServerPoint",t);await this.#Yt(e)}catch(t){i(t.toString()),void 0!==s&&s()}break;case c.PATH:e(g.Format("some player",t)),this.#Q=!0;try{const e=await this.#P.invoke("ClientToServerPath",t);if(Object.prototype.hasOwnProperty.call(e,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(e,"winningPlayerId")){let t=e;this.#Xt(t)}else{if(!Object.prototype.hasOwnProperty.call(e,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(e,"pointsAsString"))throw new Error("ClientToServerPath bad Kind!");{let t=e;await this.#Ut(t)}}}catch(t){i(t.toString()),void 0!==s&&s()}break;case c.PING:try{await this.#P.invoke("ClientToServerPing",t),document.querySelector(this.#V).value="",document.querySelector(this.#z).disabled="disabled";const e=t.Message;this.#g.Append(e,!0,this.#j,this.#it,this.#H,this.#$)}catch(t){i(t.toString())}break;case c.STOP_AND_DRAW:try{await this.#P.invoke("ClientToServerStopAndDraw",t),this.#tt=!0,this.#v=this.#f=-1,this.#rt=null,this.#nt=!0,this.#K.disabled="disabled"}catch(t){i(t.toString())}break;default:i("unknown object")}}CountDownReachedHandler(t){t&&(t.textContent=""),this.#K.disabled=this.#J.disabled="disabled",this.#M=null,this.#nt=!1}async#Yt(t){const e=t.iX,i=t.iY,s=void 0!==t.Status?t.Status:t.status;this.#St=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),await this.#Vt(e,i,s,t.iPlayerId),this.#y!==t.iPlayerId?(this.#nt=!0,this.#Ht("Opponent has moved, your turn"),this.#U.style.cursor="crosshair",null!==this.#rt&&await this.#se(),this.#K.disabled="",this.#tt?this.#K.value="Draw dot":this.#K.value="Draw line",this.#M&&(this.#M.Stop(),this.#M=null)):(this.#nt=!1,this.#Ht("Waiting for opponent move"),this.#U.style.cursor="wait",this.#dt.Hide(),this.#J.disabled="disabled",this.#K.disabled="",this.#K.value="Stop and Draw",this.#M?this.#M.Reset(this.#B):this.#M=new L(this.#B),!0!==this.#A||this.#nt||this.#xt()),this.#Q=!1}async#Ut(t){if(this.#St=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),this.#y!==t.iPlayerId){const e=t.PointsAsString||t.pointsAsString,i=t.OwnedPointsAsString||t.ownedPointsAsString;await this.#Jt(e,this.#at===this.#Ot,!1,t.iId);const n=i.split(" "),o=this.#at===this.#Ot?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=this.#at===this.#Ot?this.#Lt:this.#bt;for(const t of n){let[e,i]=t.split(",");e=parseInt(e),i=parseInt(i);const s=await this.#ht.get(i*this.#I+e);void 0!==s&&(s.SetStatus(o),s.SetFillColor(a),await this.#ht.set(i*this.#I+e,s))}this.#nt=!0,this.#Ht("Opponent has moved, your turn"),this.#U.style.cursor="crosshair",this.#dt.Hide(),null!==this.#rt&&await this.#se(),this.#K.disabled=""}else{let e=this.#rt.GetPointsArray(),i=e[0].x,n=e[0].y;const o=await this.#ht.get(n*this.#I+i);void 0!==o&&o.SetStatus(s.POINT_IN_PATH),this.#rt.SetWidthAndColor(this.#Y,this.#at),this.#rt.SetID(t.iId),await this.#lt.push(this.#rt),this.#v=this.#f=-1,this.#rt=null;e=(t.OwnedPointsAsString||t.ownedPointsAsString).split(" ");const a=this.#at===this.#Ot?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=this.#at===this.#Ot?this.#Lt:this.#bt;for(const t of e){let[e,i]=t.split(",");e=parseInt(e),i=parseInt(i);const s=await this.#ht.get(i*this.#I+e);void 0!==s&&(s.SetStatus(a),s.SetFillColor(r),await this.#ht.set(i*this.#I+e,s))}this.#nt=!1,this.#Ht("Waiting for opponent move"),this.#U.style.cursor="wait",this.#dt.Hide(),this.#K.disabled=this.#J.disabled="disabled",!0!==this.#A||this.#nt||this.#xt()}this.#tt?this.#K.value="Draw dot":this.#K.value="Draw line",this.#Q=!1,this.#M&&(this.#M.Stop(),this.#M=null)}#Xt(e){this.#Ht("Win situation"),this.#Q=!1;const i=C.Format(e),s=void 0!==e.Status?e.Status:e.status,n=e.WinningPlayerId||e.winningPlayerId;((s===u.RED_WINS||s===u.GREEN_WINS)&&n>0||s===u.DRAW_WIN)&&t.LocalAlert(""===i?"Game won!":i,"Win situation",(()=>{window.location.href="GamesList"}))}#ne(t,e,i,n){let o,a;switch(this.#Dt){case d.FIRST_CAPTURE:return t.length>0?this.#it?u.RED_WINS:u.GREEN_WINS:e.length>0?this.#it?u.GREEN_WINS:u.RED_WINS:u.NO_WIN;case d.FIRST_5_CAPTURES:return o=this.#it?s.POINT_OWNED_BY_BLUE:s.POINT_OWNED_BY_RED,a=n.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#it?u.GREEN_WINS:u.RED_WINS:(o=this.#it?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,a=i.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,a>=5?this.#it?u.RED_WINS:u.GREEN_WINS:u.NO_WIN);case d.FIRST_5_PATHS:return e.length>=5?this.#it?u.GREEN_WINS:u.RED_WINS:t.length>=5?this.#it?u.RED_WINS:u.GREEN_WINS:u.NO_WIN;case d.FIRST_5_ADVANTAGE_PATHS:{const i=t.length-e.length;if(i>=5)return this.#it?u.RED_WINS:u.GREEN_WINS;if(i<=-5)return this.#it?u.GREEN_WINS:u.RED_WINS}return u.NO_WIN;default:throw new Error("Wrong game type")}}#Ht(t=""){"???"===this.#$.textContent?this.#nt?this.#ot.style.color=this.#Ot:this.#ot.style.color=this.#It:this.#nt?this.#it?this.#ot.style.color=this.#Ot:this.#ot.style.color=this.#It:this.#it?this.#ot.style.color=this.#It:this.#ot.style.color=this.#Ot,null!==t&&""!==t?this.#qt(t,0):this.#qt("",0)}async#oe(t){if(!this.#nt||"???"===this.#$.textContent||!0===this.#Q||this.#vt>0)return void(this.#vt<=0&&!this.#nt&&(this.#U.style.cursor="wait"));const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;i=parseInt(i),n=parseInt(n);let o=i,a=n;if(this.#Nt.x===o&&this.#Nt.y===a||(this.#dt.move(o,a),this.#dt.Show(),this.#qt(`[${i},${n}]`,1),this.#Nt.x=o,this.#Nt.y=a),this.#tt){if(null!==this.#rt?this.#U.style.cursor="move":this.#U.style.cursor="crosshair",!0===this.#Z&&(this.#v!==i||this.#f!==n)&&Math.abs(parseInt(this.#v-i))<=1&&Math.abs(parseInt(this.#f-n))<=1&&this.#v>=0&&this.#f>=0)if(null!==this.#rt){let t=await this.#ht.get(this.#f*this.#I+this.#v),e=await this.#ht.get(n*this.#I+i);if(this.#J.disabled=this.#rt.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.#at&&e.GetFillColor()===this.#at){const r=this.#rt.ContainsPoint(o,a);if(r<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.#rt.AppendPoints(o,a))e.SetStatus(s.POINT_IN_PATH,!0),this.#v=i,this.#f=n;else if(1===r&&e.GetStatus()===s.POINT_STARTING&&!0===this.#rt.AppendPoints(o,a)){const t=await this.#Qt();t.owned.length>0?(this.#qt("Closing path",0),this.#yt=null,await this.#$t(this.#ie(t),(async()=>{await this.#se(),t.OwnedPoints.forEach((t=>{const e=t.point;e.RevertOldStatus(),e.SetFillColor(t.revertFillColor)})),this.#Q=!1}))):this.#qt(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#v=i,this.#f=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#rt.GetPointsString().endsWith(`${this.#v},${this.#f}`)&&(this.#rt.GetLength()>2?(t.RevertOldStatus(),this.#rt.RemoveLastPoint(),this.#v=i,this.#f=n):await this.#se())}}else{let t=await this.#ht.get(this.#f*this.#I+this.#v),e=await this.#ht.get(n*this.#I+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.#at&&e.GetFillColor()===this.#at){const r=this.#v,l=this.#f;this.#rt=this.#Et.CreatePolyline(`${r},${l} ${o},${a}`,this.#Rt),this.#J.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0),this.#v=i,this.#f=n}}}else this.#U.style.cursor="crosshair"}async#ae(t){if(!this.#nt||"???"===this.#$.textContent||!0===this.#Q||this.#vt>0)return;const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;if(i=this.#E=parseInt(i),n=this.#_=parseInt(n),this.#D=this.#v,this.#N=this.#f,this.#Z=!0,this.#tt){if((this.#v!==i||this.#f!==n)&&Math.abs(parseInt(this.#v-i))<=1&&Math.abs(parseInt(this.#f-n))<=1&&this.#v>=0&&this.#f>=0)if(null!==this.#rt){let t=await this.#ht.get(this.#f*this.#I+this.#v),e=await this.#ht.get(n*this.#I+i);if(this.#J.disabled=this.#rt.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.#at&&e.GetFillColor()===this.#at){const o=i,a=n,r=this.#rt.ContainsPoint(o,a);if(r<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.#rt.AppendPoints(o,a))e.SetStatus(s.POINT_IN_PATH,!0),this.#v=i,this.#f=n;else if(1===r&&e.GetStatus()===s.POINT_STARTING&&!0===this.#rt.AppendPoints(o,a)){const t=await this.#Qt();t.owned.length>0?(this.#qt("Closing path",0),this.#yt=null,await this.#$t(this.#ie(t),(async()=>{await this.#se(),t.OwnedPoints.forEach((t=>{const e=t.point;e.RevertOldStatus(),e.SetFillColor(t.revertFillColor)})),this.#Z=!1,this.#Q=!1}))):this.#qt(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancel it or refresh page`,0),this.#v=i,this.#f=n}else r>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.#rt.GetPointsString().endsWith(`${this.#v},${this.#f}`)&&(this.#rt.GetLength()>2?(t.RevertOldStatus(),this.#rt.RemoveLastPoint(),this.#v=i,this.#f=n):await this.#se())}}else{let t=await this.#ht.get(this.#f*this.#I+this.#v),e=await this.#ht.get(n*this.#I+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.#at&&e.GetFillColor()===this.#at){const o=this.#v,a=this.#f,r=i,l=n;this.#rt=this.#Et.CreatePolyline(`${o},${a} ${r},${l}`,this.#Rt),this.#J.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0)}this.#v=i,this.#f=n}else if(this.#v<0||this.#f<0){let t=await this.#ht.get(n*this.#I+i);void 0!==t&&t.GetFillColor()===this.#at&&(this.#v=i,this.#f=n)}}else{this.#v=i,this.#f=n;const t=i,e=n;if(await this.#ht.has(e*this.#I+t))return void this.#qt("Wrong point - already existing",0);if(!await a(t,e,await this.#lt.all()))return void this.#qt("Wrong point, Point is not outside all paths",0);this.#yt=null,await this.#$t(this.#ee(t,e),(()=>{this.#Z=!1,this.#Q=!1}))}}async#re(t){if(!this.#nt||"???"===this.#$.textContent||!0===this.#Q||this.#vt>0)return void(this.#vt<=0&&!this.#nt&&(this.#U.style.cursor="wait"));const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;i=parseInt(i),n=parseInt(n);let o=i,a=n;if(this.#Nt.x===o&&this.#Nt.y===a||(this.#dt.move(o,a),this.#dt.Show(),this.#qt(`[${i},${n}]`,1),this.#Nt.x=o,this.#Nt.y=a),null!==this.#rt?this.#U.style.cursor="move":this.#U.style.cursor="crosshair",!0===this.#Z&&!1===await this.#ht.has(n*this.#I+i)){let t,e;!0===document.getElementById("cbSrvMnuBlue").checked?(e=s.POINT_FREE_BLUE,t=this.#It):(e=s.POINT_FREE_RED,t=this.#Ot);const o=this.#Et.CreateOval();o.move(i,n),o.SetStrokeColor(t),o.StrokeWeight(.2),o.SetFillColor(t),o.SetStatus(e),await this.#ht.set(n*this.#I+i,o)}}async#le(t){if(!this.#nt||"???"===this.#$.textContent||!0===this.#Q||this.#vt>0)return;const e=this.#Et.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;if(i=this.#E=parseInt(i),n=this.#_=parseInt(n),this.#D=this.#v,this.#N=this.#f,this.#Z=!0,!1===await this.#ht.has(n*this.#I+i)){let t,e;!0===document.getElementById("cbSrvMnuBlue").checked?(e=s.POINT_FREE_BLUE,t=this.#It):(e=s.POINT_FREE_RED,t=this.#Ot);const o=this.#Et.CreateOval();o.move(i,n),o.SetStrokeColor(t),o.StrokeWeight(.2),o.SetFillColor(t),o.SetStatus(e),await this.#ht.set(n*this.#I+i,o)}}#he(){this.#Z=!1}#ce(){this.#dt.Hide()}async#de(t){if(this.#M)null===this.#rt&&await this.#$t(new w);else{null!==this.#rt&&await this.#se(),this.#tt=!this.#tt;const e=t.target;this.#tt?e.value="Draw dot":e.value="Draw line",this.#v=this.#f=-1,this.#rt=null}}async#se(){if(this.#tt){if(null!==this.#rt){const t=this.#rt.GetPointsArray();this.#J.disabled="disabled";for(const e of t){const{x:t,y:i}=e;if(null===t||null===i)continue;const s=await this.#ht.get(i*this.#I+t);void 0!==s&&s.RevertOldStatus()}this.#Et.RemovePolyline(this.#rt),this.#rt=null}this.#v=this.#f=-1,this.#M&&(this.#K.disabled="disabled"),this.#qt("",0)}}CountPointsDebug(t){let e="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='POINT_OWNED_BY_RED']",display:"intercepted(P1:%s, "},{query:"circle[data-status='POINT_OWNED_BY_BLUE']",display:"P2:%s)"}].forEach((function(t){const i=document.querySelectorAll(t.query);e+=t.display.replace("%s",i.length)})),document.querySelector(t).textContent="SVGs by tags: "+e}async#ue(t){return new Promise(((e,i)=>{this.#gt=this.#gt??new Worker("../js/AIWorker.Bundle.js?v="+h),this.#gt.onerror=function(t){this.#gt.terminate(),this.#gt=null,i(new Error(t||"no data"))},this.#gt.onmessage=function(t){const i=t.data;e(i)},t&&t(this.#gt)}))}async#Se(t){t.preventDefault(),e(await this.#Pe())}async#ge(t){t.preventDefault();const i=(t=>{let e=JSON.parse(t.getItem("AIConcaveman"))||{};const i={};if(void 0!==e?.concavity){let t=parseFloat(e.concavity);t=isNaN(t)||t<=0?2:t,i.concavity=t}else i.concavity=2;if(void 0!==e?.lengthThreshold){let t=parseFloat(e.lengthThreshold);t=isNaN(t)||t<=0?0:t,i.lengthThreshold=t}else i.lengthThreshold=0;if(e=JSON.parse(t.getItem("AIClustering"))||{},void 0!==e?.lastClickedX&&this.#v<0){let t=parseInt(e.lastClickedX);t=isNaN(t)||t<=0?this.#v:t,i.lastClickedX=t}else i.lastClickedX=this.#v;if(void 0!==e?.lastClickedY&&this.#f<0){let t=parseInt(e.lastClickedY);t=isNaN(t)||t<=0?this.#f:t,i.lastClickedY=t}else i.lastClickedY=this.#f;return i})(window.localStorage);if(!(i.lastClickedY>=0&&i.lastClickedX>=0))return void e("!!!First you need to click some point with mouse to pick the color!!!");const s=(await this.#ht.get(i.lastClickedY*this.#I+i.lastClickedX))?.GetStatus(),n=await this.#ue((t=>{const e=this.#Ct?.length>0?this.#Ct.map((t=>{const e=t.Serialize();return{key:e.y*this.#I+e.x,value:e}})):[...this.#ht.store.entries()].map((([t,e])=>({key:t,value:e.Serialize()})));t.postMessage({operation:"CONCAVEMAN",boardSize:{iGridWidth:this.#I,iGridHeight:this.#L},state:this.#zt(),points:e,clickedPointStatus:s,concavity:i.concavity,lengthThreshold:i.lengthThreshold})}));if(((t,e)=>{let i=JSON.parse(e.getItem("AIConcaveman"))||{},s=!1;t.concavity!==i?.concavity&&(i.concavity=t.concavity,s=!0),t.lengthThreshold!==i?.lengthThreshold&&(i.lengthThreshold=t.lengthThreshold,s=!0),!0===s&&e.setItem("AIConcaveman",JSON.stringify(i)),s=!1,i=JSON.parse(e.getItem("AIClustering"))||{},t.lastClickedX!==i?.lastClickedX&&(i.lastClickedX=t.lastClickedX,s=!0),t.lastClickedY!==i?.lastClickedY&&(i.lastClickedY=t.lastClickedY,s=!0),!0===s&&e.setItem("AIClustering",JSON.stringify(i))})(i,window.localStorage),n.convex_hull&&n.convex_hull.length>0){const t=n.convex_hull;this.#Et.CreatePolyline(t.map((([t,e])=>parseInt(t)+","+parseInt(e))).join(" "),"green").SetID(-1),e(`convex_hull = ${t}`);const i=n.cw_sorted_verts,s=R();for(const t of i){const{x:e,y:i}=t,n=await this.#ht.get(i*this.#I+e);n&&(n.SetStrokeColor(s),n.SetFillColor(s),n.SetZIndex(100),n.setAttribute("r",6/this.#b)),await l(50)}}}async#me(t){t.preventDefault(),e(await this.#ye(await this.#Pe(),this.#Ot))}async#pe(t){t.preventDefault();const i=await this.#ht.get(this.#_*this.#I+this.#E);void 0!==i?(await this.#Ce([],i),null!==this.#pt&&(this.#Et.RemovePolyline(this.#pt),this.#pt=null),this.#Ct.forEach((t=>{this.#Et.CreatePolyline(t.map((function(t){const e=t.GetPosition();return`${e.x},${e.y}`})).join(" "),R()).SetID(-1)})),e("game.#cyclesFound = "),e(this.#Ct),this.#Ct=[]):e("!!!First you need to click 'blue' starting point with mouse!!!")}async#we(t){t.preventDefault();const e=this.#Ot,i=this.#It,s=[...await this.#ht.values()].map((t=>t.Serialize())),n=this.#lt.store.map((t=>t.Serialize())),o=await this.#ht.get(this.#_*this.#I+this.#E),a=void 0!==o?[o.Serialize()]:s,r=await this.#ue((t=>{t.postMessage({operation:"FIND_SURROUNDABLE_POINTS",boardSize:{iGridWidth:this.#I,iGridHeight:this.#L},sHumanColor:e,sCPUColor:i,allPoints:s,workingPoints:a,allLines:n})}));r?.results?.length>0&&r.results.forEach((async t=>{const e=R(),i=this.#Et.CreateOval(t.radius);i.move(t.x,t.y),i.SetStrokeColor(e),i.StrokeWeight(.1),i.SetFillColor("transparent");const s=[];for(const i of t.cw_sorted_verts){const t=document.querySelector(`svg > circle[cx="${i.x}"][cy="${i.y}"]`);t&&(t.SetStrokeColor(e),t.StrokeWeight("0.020em"),t.SetFillColor(e),t.setAttribute("r",6/this.#b),s.push(t))}await this.#Oe(s,250)}))}async#Ie(t){if(t.preventDefault(),!(this.#f>=0&&this.#v>=0))return void e("!!!First you need to click starting point with mouse!!!");const i=await this.#ht.get(this.#f*this.#I+this.#v);await this.#Le(await this.#Pe(),i)}async#be(t){t.preventDefault();const i=this.#Ot,s=this.#It,n=await this.#ht.get(this.#_*this.#I+this.#E);if(!n)return void e("!!!First you need to click starting point with mouse!!!");const{x:o,y:a}=n.GetPosition(),r=n.GetFillColor();e(`FloodFill start point (${o},${a}), color = '${r===i?"HUMAN":"CPU"}'`),await this.#Re(n,r===i?i:s,"green")}async#ve(t){if(t.preventDefault(),!(this.#f>=0&&this.#v>=0&&this.#N>=0&&this.#D>=0)||this.#v===this.#D&&this.#f===this.#N)return void e("!!!First you need to click two (starting and ending) points with mouse!!!");const i=(await this.#ht.get(this.#f*this.#I+this.#v))?.GetFillColor();if(i!==(await this.#ht.get(this.#N*this.#I+this.#D))?.GetFillColor())return void e("!!!Clicked starting and ending point must be same color and not owned!!!");const n=i===this.#Ot?s.POINT_FREE_RED:s.POINT_FREE_BLUE,o=new Array(this.#L);for(let t=0;t<this.#L;t++){o[t]=new Array(this.#I);for(let e=0;e<this.#I;e++){const s=await this.#ht.get(t*this.#I+e);void 0!==s&&s.GetFillColor()===i&&s.GetStatus()===n?o[t][e]=1:o[t][e]=0}}const a=await this.#ue((t=>{t.postMessage({operation:"ASTAR",arr:o,start:{y:this.#f,x:this.#v},end:{y:this.#N,x:this.#D}})}));a.resultWithDiagonals.length>0&&await(async(t,e=25)=>{const i=t.map((t=>`${t.y},${t.x}`)).join(" ");null===this.#pt?(this.#pt=this.#Et.CreatePolyline(i,"black"),this.#pt.SetID(-1)):this.#pt.SetPoints(i),e>0&&await l(e)})(a.resultWithDiagonals,0)}async#fe(t){t.preventDefault();const i=(t=>{const e=JSON.parse(t.getItem("AIClustering"))||{},i={};if(void 0!==e?.lastClickedX&&this.#v<0){let t=parseInt(e.lastClickedX);t=isNaN(t)||t<=0?this.#v:t,i.lastClickedX=t}else i.lastClickedX=this.#v;if(void 0!==e?.lastClickedY&&this.#f<0){let t=parseInt(e.lastClickedY);t=isNaN(t)||t<=0?this.#f:t,i.lastClickedY=t}else i.lastClickedY=this.#f;if(void 0!==e?.numberOfClusters){let t=parseInt(e.numberOfClusters);t=isNaN(t)||t<=0?5:t,i.numberOfClusters=t}else i.numberOfClusters=5;if(void 0!==e?.neighborhoodRadius){let t=parseInt(e.neighborhoodRadius);t=isNaN(t)||t<=0?2:t,i.neighborhoodRadius=t}else i.neighborhoodRadius=2;if(void 0!==e?.minPointsPerCluster){let t=parseInt(e.minPointsPerCluster);t=isNaN(t)||t<=0?2:t,i.minPointsPerCluster=t}else i.minPointsPerCluster=2;return void 0!==e?.method&&["KMEANS","OPTICS","DBSCAN"].includes(e.method.toUpperCase())?i.method=e.method.toUpperCase():i.method="KMEANS",i})(window.localStorage);if(!(i.lastClickedY>=0&&i.lastClickedX>=0))return void e("!!!First you need to click some point with mouse to pick the color!!!");const n=(await this.#ht.get(i.lastClickedY*this.#I+i.lastClickedX))?.GetFillColor(),o=n===this.#Ot?s.POINT_FREE_RED:s.POINT_FREE_BLUE,a=[];for(const t of await this.#ht.values())if(void 0!==t&&t.GetFillColor()===n&&t.GetStatus()===o){const{x:e,y:i}=t.GetPosition();a.push([e,i])}((t,e)=>{const i=JSON.parse(e.getItem("AIClustering"))||{};let s=!1;t.lastClickedX!==i?.lastClickedX&&(i.lastClickedX=t.lastClickedX,s=!0),t.lastClickedY!==i?.lastClickedY&&(i.lastClickedY=t.lastClickedY,s=!0),t.numberOfClusters!==i?.numberOfClusters&&(i.numberOfClusters=t.numberOfClusters,s=!0),t.neighborhoodRadius!==i?.neighborhoodRadius&&(i.neighborhoodRadius=t.neighborhoodRadius,s=!0),t.minPointsPerCluster!==i?.minPointsPerCluster&&(i.minPointsPerCluster=t.minPointsPerCluster,s=!0),t.method!==i?.method&&(i.method=t.method.toUpperCase(),s=!0),!0===s&&e.setItem("AIClustering",JSON.stringify(i))})(i,window.localStorage);const r=await this.#ue((t=>{t.postMessage({operation:"CLUSTERING",dataset:a,method:i.method,numberOfClusters:i.numberOfClusters,neighborhoodRadius:i.neighborhoodRadius,minPointsPerCluster:i.minPointsPerCluster})}));if(r.clusters?.length>0){const t=[];for(const e of r.clusters){const s=R(),n=[];for(const t of e){const e=a[t],[o,r]=e,l=await this.#ht.get(r*this.#I+o);l&&(n.push(l),l.SetStrokeColor(s),l.SetFillColor(s),l.SetZIndex(100),l.setAttribute("r",2/this.#b),r===i.lastClickedY&&o===i.lastClickedX&&(this.#Ct=n))}t.push(n)}e({method:r.method,clusters:t,plot:r.plot,noise:r.noise})}}async#De(t){"cbSrvMnuRed"===t.target.id?(!0===document.getElementById("cbSrvMnuRed").checked?(this.#U.onmousedown=this.#le.bind(this),this.#U.onmousemove=this.#re.bind(this),e("red")):(this.#U.onmousedown=this.#ae.bind(this),this.#U.onmousemove=this.#oe.bind(this),e("red-off")),document.getElementById("cbSrvMnuBlue").checked=!1):"cbSrvMnuBlue"===t.target.id&&(!0===document.getElementById("cbSrvMnuBlue").checked?(this.#U.onmousedown=this.#le.bind(this),this.#U.onmousemove=this.#re.bind(this),e("blue")):(this.#U.onmousedown=this.#ae.bind(this),this.#U.onmousemove=this.#oe.bind(this),e("blue-off")),document.getElementById("cbSrvMnuRed").checked=!1)}async PrepareDrawing(e,i,s,n,o,a,r,l,h,c,d,u,S,P,g,m,y=125){if(this.#W=!1,this.#C=4e3,this.#w=y,this.#M=null,this.#x=null,this.#O=0,this.#v=-1,this.#f=-1,this.#E=0,this.#_=0,this.#G=0,this.#T=0,this.#Z=!1,this.#Q=!1,this.#tt=!1,this.#et="",this.#at=this.#it?this.#Ot:this.#It,this.#rt=null,this.#X=document.getElementById("debug0"),this.#H=document.querySelector(i),this.#$=document.querySelector(s),this.#ot=document.querySelector(n),this.#q=document.querySelector(o),this.#J=document.querySelector(a),this.#K=document.querySelector(l),this.#V=h,this.#j=c,this.#z=d,this.#U=document.querySelector(e),!this.#U)return void alert("no board");this.#G=this.#U.offsetLeft,this.#T=this.#U.offsetTop;let[p,C]=[...this.#U.classList].find((t=>t.startsWith("boardsize"))).split("-")[1].split("x");this.#I=parseInt(p),this.#L=parseInt(C);let w=this.#U.clientWidth,O=this.#U.clientHeight,I=null;O<=0&&(O=16*this.#L,this.#U.style.height=O+"px",I="100%"),this.#b=Math.ceil(w/this.#I),this.#R=Math.ceil(O/this.#L),this.#Y=3/this.#b,this.#St=u,this.#Pt=P,this.#mt=null,this.#yt=null,this.#pt=null,this.#Ct=[],this.#wt=null,this.#Et=new t.SvgVml,this.#Et.Init(this.#U,I,I,{iGridWidth:this.#I,iGridHeight:this.#L})||alert("SVG is not supported!");const L=new t.GameStateStore(S,this.#jt.bind(this),this.#Kt.bind(this),this.#zt.bind(this),this.#Pt);if(this.#lt=L.GetPathStore(),this.#ht=L.GetPointStore(),this.#k=await L.PrepareStore(),!1===this.#ct){if(null===this.#dt&&(this.#dt=this.#Et.CreateOval(),this.#dt.SetFillColor(this.#at),this.#dt.SetZIndex(-1),this.#dt.Hide(),this.#dt.setAttribute("data-status","MOUSE_POINTER")),this.#U.onmousedown=this.#ae.bind(this),this.#U.onmousemove=this.#oe.bind(this),this.#U.onmouseup=this.#he.bind(this),this.#U.onmouseleave=this.#ce.bind(this),this.#J.onclick=this.#se.bind(this),this.#K.onclick=this.#de.bind(this),!1===this.#A)document.querySelector(this.#V).disabled="",this.#g=new b(window.localStorage,this),this.#g.RestoreMessages(this.#j,this.#y,this.#p,this.#it,this.#H,this.#$);else{if(null!==document.querySelector(m[0])){document.getElementById("testArea").classList.remove("d-none");let t=0;g.length>t&&(document.querySelector(g[t++]).onclick=this.#Se.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#ge.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#me.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#pe.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#we.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#Ie.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#be.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#ve.bind(this)),g.length>t&&(document.querySelector(g[t++]).onclick=this.#fe.bind(this)),document.querySelector(m[1]).onclick=this.#De.bind(this),document.querySelector(m[2]).onclick=this.#De.bind(this)}this.#wt=window.localStorage.getItem("AIMethod"),this.#wt||(this.#wt="centroid",window.localStorage.setItem("AIMethod",this.#wt))}this.#q.disabled="","???"===this.#$.textContent?(this.#Ht("Waiting for other player to connect"),this.#U.style.cursor="wait"):(this.#q.value="surrender",this.#nt?(this.#Ht("Your move"),this.#U.style.cursor="crosshair",this.#K.disabled=""):(this.#Ht("Waiting for opponent move"),this.#U.style.cursor="wait"),this.#tt?this.#K.value="Draw dot":this.#K.value="Draw line")}else document.querySelector(r).textContent="back to Game List";const R=document.getElementById("whichColor"),v=document.getElementById("whichPlayer");R.style.color=this.#at,this.#it?(R.textContent="red",this.#st?(this.#H.style.color=this.#Ot,this.#$.style.color=this.#It,v.textContent="Player1"):(this.#H.style.color=this.#It,this.#$.style.color=this.#Ot,v.textContent="Player2")):(R.textContent="blue",this.#st?(this.#H.style.color=this.#It,this.#$.style.color=this.#Ot,v.textContent="Player1"):(this.#H.style.color=this.#Ot,this.#$.style.color=this.#It,v.textContent="Player2"))}static async OnLoad(c){const d=void 0!==window.msgpack5,u=c.inkBallHubName,S=c.iGameID;document.getElementById("gameID").textContent=S,document.querySelector(".container.inkgame form > input[type='hidden'][name='GameID']").value=S;const P=c.iPlayerID,g=parseInt(document.querySelector(".msgchat").dataset.otherplayerid)||null;c.iOtherPlayerID=g,document.getElementById("playerID").textContent=P;const m=c.bPlayingWithRed,y=c.bIsThisPlayer1,p=c.bPlayerActive,C=c.gameType,w=d&&!0===c.isMessagePackProtocol?new signalR.protocols.msgpack.MessagePackHubProtocol:new signalR.JsonHubProtocol,O=c.servTimeoutMillis,I=c.isReadonly,L=c.pathAfterPointDrawAllowanceSecAmount,b=new Date(c.sLastMoveGameTimeStamp).toISOString(),R=c.version;await async function(){const c=import.meta.url,d=new URL(c);h=d.searchParams.get("v");const u=-1!==d.pathname.split("/").at(-1).indexOf("min");t=u?await import("./shared.min.js?v="+h):await import("./shared.js?v="+h),e=t.LocalLog,i=t.LocalError,s=t.StatusEnum,n=t.hasDuplicates,o=t.pnpoly,a=t.IsPointOutsideAllPaths,r=t.sortPointsClockwise,l=t.Sleep}();const f=new v(S,P,g,u,signalR.LogLevel.Warning,w,signalR.HttpTransportType.None,O,C,m,y,p,I,L);await f.PrepareDrawing("#screen","#Player1Name","#Player2Name","#gameStatus","#SurrenderButton","#CancelPath","#Pause","#StopAndDraw","#messageInput","#messagesList","#sendButton",b,null===c.PointsAsJavaScriptArray,R,["#TestBuildGraph","#TestConcaveman","#TestMarkAllCycles","#TestGroupPoints","#TestFindSurroundablePoints","#TestDFS2","#FloodFill","#AStar","#Clustering"],["#serviceMenu","#cbSrvMnuRed","#cbSrvMnuBlue"]),null!==c.PointsAsJavaScriptArray?(await f.StartSignalRConnection(!1),await f.#kt(c.PointsAsJavaScriptArray),await f.#Mt(c.PathsAsJavaScriptArray)):await f.StartSignalRConnection(!0),f.CountPointsDebug("#debug2"),window.game=f}static OnBeforeUnload(){window.game&&window.game.StopSignalRConnection()}#Ne(t,e){return t=Math.max(0,Math.min(t,this.#I)),e=Math.max(0,Math.min(e,this.#I)),t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}async#Ee(){let t,e,i=100;const n=await this.#lt.all();for(;--i>0&&(t=this.#Ne(0,this.#I),e=this.#Ne(0,this.#L),await this.#ht.has(e*this.#I+t)||!await a(t,e,n)););return new P(this.#m,-1,t,e,s.POINT_FREE_BLUE,0)}async#_e(){let t,i,n=0,o=0,r=0;const l=this.#Ot;for(const t of await this.#ht.values())if(void 0!==t&&t.GetFillColor()===l&&t.GetStatus()===s.POINT_FREE_RED){const{x:e,y:i}=t.GetPosition();n+=e,o+=i,r++}if(r<=0)return null;n=parseInt(n/r),o=parseInt(o/r),t=n,i=o;let h="";const c=new Set;let d=0,u=2;const S=await this.#lt.all();for(;++d<=50;){if(c.add(`${t}_${i}`),!1===await this.#ht.has(i*this.#I+t)&&!0===await a(t,i,S)){h+=`checking centroid coords ${t}_${i} succeed\n`;break}h+=`checking coords ${t}_${i} failed #${d}\n`,d>=25&&(u*=2);let e=50;do{t=this.#Ne(n-u,n+u+1),i=this.#Ne(o-u,o+u+1)}while(--e>0&&c.has(`${t}_${i}`))}if(d>=50)return h+="finding centroid failed\n",e(h),null;e(h);return new P(this.#m,-1,t,i,s.POINT_FREE_BLUE,0)}async#Ge(){if(this.#v>=0&&this.#f>=0){let t=this.#v,i=this.#f,n="";const o=new Set;let r=0,l=1;const h=await this.#lt.all();for(;++r<=50;){if(o.add(`${t}_${i}`),!1===await this.#ht.has(i*this.#I+t)&&!0===await a(t,i,h)){n+=`checking nearest coords ${t}_${i} succeed\n`;break}n+=`checking coords ${t}_${i} failed #${r}\n`;let e=20;do{t=this.#Ne(this.#v-l,this.#v+l+1),i=this.#Ne(this.#f-l,this.#f+l+1)}while(--e>0&&o.has(`${t}_${i}`))}if(r>=50)return n+="finding nearest failed\n",e(n),null;e(n);return new P(this.#m,-1,t,i,s.POINT_FREE_BLUE,0)}return null}#Te(t){const i=t.vertices,s=(t,i)=>{t.visited=!0;for(let n of t.adjacents)if(n.visited){if(n!==i){const{x:t,y:i}=n.GetPosition();return e(`cycle found at ${t},${i}`),!0}}else if(s(n,t))return!0;return!1};for(let t=0;t<i.length;t++)i[t].visited=!1;for(let t=0;t<i.length;t++)if(!i[t].visited&&s(i[t],-1))return!0;return!1}async#Pe({freePointStatus:t=s.POINT_FREE_BLUE,cpufillCol:e=this.#It}={}){const i=new Map,n=new Map,o=function(t,i){const s=i.GetStatus();return!(!t.includes(s)||i.GetFillColor()!==e)},a=[t],r=async(t,e,s,r,l)=>{if(e>=0&&e<this.#I&&s>=0&&s<this.#L){const h=await this.#ht.get(s*this.#I+e);if(h&&!0===o(a,h)){const o=`${r},${l}`,a=`${e},${s}`;if(!1===n.has(`${o}_${a}`)&&!1===n.has(`${a}_${o}`)){if(n.set(`${o}_${a}`,{from:t,to:h}),i.has(o)){i.get(o).adjacents.push(h)}else t.adjacents=[h],i.set(o,t);if(i.has(a)){i.get(a).adjacents.push(t)}else h.adjacents=[t],i.set(a,h)}}}},l=await this.#ht.values(),h=[t,this.POINT_STARTING,this.POINT_IN_PATH];for(const t of l)if(t&&!0===o(h,t)){const{x:e,y:i}=t.GetPosition();await r(t,e+1,i,e,i),await r(t,e-1,i,e,i),await r(t,e,i-1,e,i),await r(t,e,i+1,e,i),await r(t,e-1,i-1,e,i),await r(t,e+1,i-1,e,i),await r(t,e-1,i+1,e,i),await r(t,e+1,i+1,e,i)}return{vertices:Array.from(i.values()),edges:Array.from(n.values()),getNeighbors:function(t){const e=this.vertices.find((e=>e===t));return e?e.adjacents:null}}}async#ye(t,i){const n=t.vertices,h=n.length;let c=new Array(h);const d=new Array(h),u=new Array(h),S=new Array(h);for(let t=0;t<h;t++)d[t]=[],c[t]=[];const P=async(t,e="black",i=25)=>{const{x:s,y:n}=t.GetPosition(),o=await this.#ht.get(n*this.#I+s);o.SetStrokeColor(e),o.SetFillColor(e),o.StrokeWeight(.2),o.setAttribute("r",6/this.#b),await l(i)},g=async(t,e)=>{if(2===u[t])return;if(1===u[t]){m++;let i=e;for(d[i].push(m);i!==t;)i=S[i],d[i].push(m);return}S[t]=e,u[t]=1;const i=n[t];if(i){await P(i);for(const e of i.adjacents){const i=n.indexOf(e);i!==S[t]&&await g(i,t)}}u[t]=2};let m=0;for(let t=0;t<h;t++)await g(t+1,t);return await(async(t,h)=>{for(let e=0;e<t;e++){const t=h[e];if(void 0!==t&&t.length>0)for(let i=0;i<t.length;i++){const s=c[t[i]];s&&s.push(e)}}c=c.filter((t=>t.length>=4)).sort(((t,e)=>e.length-t.length));const d=[],u=await this.#lt.all();for(const t of await this.#ht.values())if(void 0!==t&&t.GetFillColor()===i&&s.POINT_FREE_RED===t.GetStatus()){const{x:e,y:i}=t.GetPosition();if(!1===await a(e,i,u))continue;await this.#ht.get(i*this.#I+e)&&d.push({x:e,y:i})}const S=[];for(let t=0;t<=m;t++){const i=c[t];if(i&&i.length>0){let s=`Cycle Number ${t}: `,a=[];const h="var(--bs-teal)",c=i.map((t=>n[t].GetPosition())),u=r(c);for(const t of u){const{x:e,y:i}=t,n=await this.#ht.get(i*this.#I+e);n&&(s+=`(${e},${i})`,n.SetStrokeColor(h),n.SetFillColor(h),n.StrokeWeight(.2),n.setAttribute("r",6/this.#b)),await l(50)}let P="",g="";for(const t of d)if(!1!==o(u,t.x,t.y)){P+=`${g}(${t.x},${t.y})`;const e=await this.#ht.get(t.y*this.#I+t.x);if(e){const t="var(--bs-yellow)";e.SetStrokeColor(t),e.StrokeWeight(.2),e.SetFillColor(t),e.setAttribute("r",6/this.#b)}g=","}a.unshift(s),S.push(a),e(s+(""!==P?` possible intercepts: ${P}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${h}"][r="${6/this.#b}"]`)).forEach((t=>{t.SetStrokeColor(this.#It),t.StrokeWeight(.2),t.SetFillColor(this.#It),t.setAttribute("r",6/this.#b)}))}}return S})(h,d)}async#Le(t,e){const i=(await import("./depthFirstSearch.js?v="+h)).default;await i(t,e,{enterVertex:()=>{},leaveVertex:()=>{},showCycle:async(t,e)=>{(t=Object.values(t)).forEach((t=>{const{x:e,y:i}=t.GetPosition();t.x=e,t.y=i}));const i=r(t);await this.#Oe(i,250)}})}async#Oe(t,e=25){const i=t.map((t=>{const e=t.GetPosition();return`${e.x},${e.y}`})).join(" ");null===this.#pt?(this.#pt=this.#Et.CreatePolyline(i,"black"),this.#pt.SetID(-1)):this.#pt.SetPoints(i),e>0&&await l(e)}#Ae(t,e){let i=t(e),s=t(t(e));for(;void 0!==i&&void 0!==s&&i!==s;)i=t(i),s=t(t(s));return i===s}async#Ce(t,e){if(void 0===e||t.includes(e)||this.#Ct.length>3)return t;if(!1===[s.POINT_FREE_BLUE,s.POINT_STARTING,s.POINT_IN_PATH].includes(e.GetStatus())||e.GetFillColor()!==this.#It)return t;const{x:i,y:n}=e.GetPosition();if(t.length>0){const s=t.at(-1),{x:o,y:a}=s.GetPosition();if(!(Math.abs(o-i)<=1&&Math.abs(a-n)<=1))return t;t.push(e)}else t.push(e);if(t.length>=4){await this.#Oe(t);const e=t[0].GetPosition(),i=t.at(-1).GetPosition();if(Math.abs(i.x-e.x)<=1&&Math.abs(i.y-e.y)<=1){const e=t.slice();e.push(t[0]);!0===this.#Ae((t=>{if(void 0===t)return;let i;if(Number.isInteger(t)){if(i=t,i>=e.length)return}else if(i=e.indexOf(t)+1,i>=e.length)return;return e[i]}),0)&&this.#Ct.push(e)}}const[o,a,r,l,h,c,d,u]=await Promise.all([this.#ht.get(n*this.#I+i+1),this.#ht.get(n*this.#I+i-1),this.#ht.get((n-1)*this.#I+i),this.#ht.get((n+1)*this.#I+i),this.#ht.get((n-1)*this.#I+i-1),this.#ht.get((n-1)*this.#I+i+1),this.#ht.get((n+1)*this.#I+i-1),this.#ht.get((n+1)*this.#I+i+1)]);await this.#Ce(t,o),await this.#Ce(t,a),await this.#Ce(t,r),await this.#Ce(t,l),await this.#Ce(t,h),await this.#Ce(t,c),await this.#Ce(t,d),await this.#Ce(t,u);const S=t.lastIndexOf(e);return-1!==S&&(t.splice(S),t.length>=2&&await this.#Oe(t)),t}async#Re(t,i,s){const n=[t.GetPosition()],a=new Set,r=new Map;for(;n.length>0;){const{x:t,y:e}=n.shift(),o=[{x:t-1,y:e},{x:t+1,y:e},{x:t,y:e-1},{x:t,y:e+1}];for(const t of o)if(!1==(t.x<0||t.y<0||t.x>=this.#I||t.y>=this.#L)){const e=t.y*this.#I+t.x;if(!1===a.has(e)){const o=await this.#ht.get(e);if(void 0!==o){const a=o.GetFillColor();a===i?(o.SetFillColor(s),o.SetStrokeColor(s),o.StrokeWeight(.3),n.push(t)):a===s||r.has(e)||r.set(e,{point:o,x:t.x,y:t.y})}else a.add(e),n.push(t)}}}if(e("edge_points: "),e([...r.values().map((({point:t})=>t))]),r.size>3){const i=[...r.values()],s=i.splice(-1,1);let n=s[0];const a=(t,e,i)=>Math.abs(t.x-n.x)<=1&&Math.abs(t.y-n.y)<=1;for(let t=i.length;t>0;t--){let t=0;const e=i.filter(a);do{const o=e.at(t);if(void 0!==o){const t=i.indexOf(o);if(-1!==t){const e=i.splice(t,1)[0];n=e,s.push(n);break}}}while(++t<4)}const{x:l,y:h}=t.GetPosition();if(s.length<=3||!(Math.abs(s.at(-1).x-s[0].x)<=1&&Math.abs(s.at(-1).y-s[0].y)<=1)||!1===o(s,l,h))return void await this.#Oe(s.map((({point:t})=>t)),0);e(s),await this.#Oe(s.map((({point:t})=>t)),0)}}async#We(t){null===this.#mt&&(this.#mt=t);const e=t-this.#mt;let i=null;switch(this.#wt){case"centroid":i=await this.#_e(),null===i&&(i=await this.#Ee());break;case"nearest":i=await this.#Ge(),null===i&&(i=await this.#Ee())}null===i?e<2e3&&(this.#yt=window.requestAnimationFrame(this.#We.bind(this))):await this.#$t(i,(()=>{this.#Z=!1,this.#Q=!1}))}#xt(){null===this.#yt&&(this.#yt=window.requestAnimationFrame(this.#We.bind(this)))}}function f(t,e,i,s,n){const o=document.querySelector(".alert.alert-dismissible.inkhome"),a=t;if(""!==a){let t;t=-1!==a.toLowerCase().indexOf("exception")||-1!==a.toLowerCase().indexOf("error")?"danger":-1!==a.toLowerCase().indexOf("warning")?"warning":"success";const e="alert-"+t;o.classList.add(e);o.querySelector("span").textContent=a}else o.parentNode.removeChild(o);const r=""!==document.querySelector("p.inkhome span").textContent,l=document.querySelector(".inkhome form");let h="";r?(h+=e?"<a href='Game' class='btn btn-primary btn-lg rounded-top'>Continue</a>":"<input type='submit' name='action' value='New game' class='btn btn-primary btn-lg rounded-top' /><div class='w-100'><select name='GameType' id='GameType' class='form-select' required><option value='' selected='selected'>Choose game type</option><optgroup label='Game types'><option value='0'>First capture wins</option><option value='1'>First 5 captures wins</option><option value='2'>First 5 paths wins</option><option value='3'>Advantage of 5 paths wins</option></optgroup></select><div class='invalid-feedback'>Invalid game type</div></div><div class='w-100'><select name='BoardSize' id='BoardSize' class='form-select' required><option value='' selected='selected'>Choose board size</option><optgroup label='Board sizes'><option value='20'>20 x 26</option><option value='40'>40 x 52</option><option value='64'>64 x 64</option></optgroup></select><div class='invalid-feedback'>Invalid board size</div></div><div class='form-check form-switch w-100'><input type='checkbox' class='form-check-input form-control-input' name='CpuOponent' id='CpuOponent' /><label class='form-check-label' for='CpuOponent'>Play against CPU</label></div>",h+="<a href='GamesList' class='btn btn-primary'>Games list</a><a href='Highscores' class='btn btn-primary'>Best</a><a href='Rules' class='btn btn-primary'>Game rules</a>"+(i?"<input type='submit' name='action' value='Logout' class='btn btn-warning rounded-bottom' formnovalidate='formnovalidate' />":"")):(document.querySelector("p.inkhome").textContent="You are not logged in ... or allowed 😅",h+="<a href='Rules' class='btn btn-primary rounded-top'>Game rules</a>"+(s?"<a href='"+s+"' class='btn btn-primary'>Login</a>":"")+(n?"<a href='"+n+"' class='btn btn-primary rounded-bottom'>Register</a>":"")),l.innerHTML+=h}function D(){const t=document.querySelector(".alert.inkgames");let e=document.querySelector(".alert.inkgames > span").textContent;if(""!==e){let i;e=e.toLowerCase(),i=-1!==e.indexOf("exception")||-1!==e.indexOf("error")?"danger":-1!==e.indexOf("warning")?"warning":"success",t.classList.add("alert-"+i),t.classList.remove("d-none")}else t.parentNode.removeChild(t)}export{v as InkBallGame,f as HomeOnLoad,D as ListOnLoad};
//# sourceMappingURL=inkball.min.js.map
