"use strict";function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),j=h.value}catch(a){return void c(a)}h.done?b(j):Promise.resolve(j).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var StatusEnum=Object.freeze({POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLU:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDE:4}),InkBallPointViewModel=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,f=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,g=5<arguments.length&&void 0!==arguments[5]?arguments[5]:StatusEnum.POINT_FREE,h=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;_classCallCheck(this,a),this.iId=b,this.iGameId=c,this.iPlayerId=d,this.iX=e,this.iY=f,this.Status=g,this.iEnclosingPathId=h}return _createClass(a,null,[{key:"Format",value:function d(a,b){var c=b.iX+" "+b.iY+" "+b.Status;return a+" places "+c+" point"}}]),a}(),PingCommand=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck(this,a),this.Message=b}return _createClass(a,[{key:"Message",get:function a(){return this.message},set:function b(a){this.message=a}}]),_createClass(a,null,[{key:"Format",value:function d(a,b){var c=b.Message;return a+" says "+c}}]),a}();function htmlEncode(a){return document.createElement("a").appendChild(document.createTextNode(a)).parentNode.innerHTML}var InkBallGame=function(){function a(b,c,d,e,f){var g=this,h=!(5<arguments.length&&void 0!==arguments[5])||arguments[5],j=!(6<arguments.length&&void 0!==arguments[6])||arguments[6],k=7<arguments.length&&void 0!==arguments[7]?arguments[7]:125,l=!(8<arguments.length&&void 0!==arguments[8])||arguments[8],m=!!(9<arguments.length&&void 0!==arguments[9])&&arguments[9];_classCallCheck(this,a),this.g_iGameID=null,this.g_iPlayerID=null,this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.POINT_FREE_RED=-3,this.POINT_FREE_BLUE=-2,this.POINT_FREE=-1,this.POINT_STARTING=0,this.POINT_IN_PATH=1,this.POINT_OWNED_BY_RED=2,this.POINT_OWNED_BY_BLUE=3,this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=k,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSize=15,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_iScrollX=0,this.m_iScrollY=0,this.m_iClientWidth=0,this.m_iClientHeight=0,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_bMouseDown=!1,this.m_bDrawLines=!1,this.m_bIsMobile=l,this.m_sMessage="",this.m_bIsPlayingWithRed=h,this.m_bIsPlayerActive=j,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=m,null===b||""===b||(this.g_SignalRConnection=new signalR.HubConnectionBuilder().withUrl(b,{transport:e,accessTokenFactory:f}).withHubProtocol(d).configureLogging(c).build(),this.g_SignalRConnection.onclose(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(null===b){a.next=6;break}console.log(b),5>g.iConnErrCount&&g.iConnErrCount++,setTimeout(function(){return g.start()},4e3+g.iExponentialBackOffMillis*g.iConnErrCount),a.next=8;break;case 6:return a.next=8,g.start();case 8:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()))}var b=Math.abs;return _createClass(a,[{key:"start",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,this.g_SignalRConnection.start();case 3:this.iConnErrCount=0,console.log("connected; iConnErrCount = "+this.iConnErrCount),a.next=12;break;case 7:a.prev=7,a.t0=a["catch"](0),console.log(a.t0+"; iConnErrCount = "+this.iConnErrCount),5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(function(){return b.start()},4e3+this.iExponentialBackOffMillis*this.iConnErrCount);case 12:case"end":return a.stop();}},a,this,[[0,7]])}));return function b(){return a.apply(this,arguments)}}()},{key:"StartSignalRConnection",value:function f(a,b,c,d,e){null===this.g_SignalRConnection||(this.g_iGameID=a,this.g_iPlayerID=b,this.g_SignalRConnection.on("ServerToClientPoint",function(a,b){var d=null;d=InkBallPointViewModel.Format(b,a);var e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e)}),this.g_SignalRConnection.on("ServerToClientPing",function(a,b){var d=null;d=PingCommand.Format(b,a);var e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e)}),document.querySelector(d).addEventListener("click",function(a){var b=document.querySelector(e).value,c=new PingCommand(b);this.g_SignalRConnection.invoke("ClientToServerPing",c).catch(function(a){return console.error(a.toString())}),a.preventDefault()}.bind(this),!1),document.querySelector(e).addEventListener("keyup",function(a){a.preventDefault(),13===a.keyCode&&document.querySelector(d).click()}.bind(this),!1),this.start())}},{key:"Debug",value:function a(){switch(arguments.length){case 1:this.m_Debug.innerHTML=0>=arguments.length?void 0:arguments[0];break;case 2:var b=document.getElementById("debug"+(1>=arguments.length?void 0:arguments[1]));b.innerHTML=0>=arguments.length?void 0:arguments[0];break;default:}}},{key:"SetTimer",value:function b(a){if(!1==a)!0==this.m_bIsTimerRunning&&clearInterval(this.m_iTimerID),this.m_bIsTimerRunning=!1;else{!0==this.m_bIsTimerRunning?clearInterval(this.m_iTimerID):this.m_WaitStartTime=new Date;var c=this.m_iTimerInterval*(1+.5*this.m_iSlowdownLevel);this.m_iTimerID=setInterval(this.GameLoop,c),this.m_bIsTimerRunning=!0}}},{key:"DisableSelection",value:function b(a){"undefined"==typeof a.onselectstart?"undefined"==typeof a.style.MozUserSelect?a.onmousedown=function(){return!1}:a.style.MozUserSelect="none":a.onselectstart=function(){return!1},a.style.cursor="default"}},{key:"f_clientWidth",value:function a(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}},{key:"f_clientHeight",value:function a(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}},{key:"f_scrollLeft",value:function a(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}},{key:"f_scrollTop",value:function a(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}},{key:"f_filterResults",value:function e(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}},{key:"SetPoint",value:function j(a,b,c){var d=a*this.m_iGridSize,e=b*this.m_iGridSize,f=4,g=$createOval(f,"true");g.$move(d,e,f);var h;c===this.POINT_FREE_RED?(h=this.COLOR_RED,g.$SetStatus(this.POINT_FREE)):c===this.POINT_FREE_BLUE?(h=this.COLOR_BLUE,g.$SetStatus(this.POINT_FREE)):c===this.POINT_FREE?(h=this.m_sDotColor,g.$SetStatus(this.POINT_FREE)):c===this.POINT_STARTING?(h=this.m_sDotColor,g.$SetStatus(this.POINT_IN_PATH)):c===this.POINT_IN_PATH?(h=this.m_sDotColor,g.$SetStatus(c)):c===this.POINT_OWNED_BY_RED?(h=this.COLOR_OWNED_RED,g.$SetStatus(c)):c===this.POINT_OWNED_BY_BLUE?(h=this.COLOR_OWNED_BLUE,g.$SetStatus(c)):alert("bad point"),g.$SetFillColor(h),g.$strokeColor(h),this.m_Points[b*this.m_iGridWidth+a]=g}},{key:"SetPath",value:function k(a,b,c){a=a.split(" ");for(var d=a.length,e="",f=null,g="",h=0;h<d;++h)f=a[h].split(","),x=parseInt(f[0]),y=parseInt(f[1]),x*=this.m_iGridSize,y*=this.m_iGridSize,g=g+e+x+","+y,e=" ",f=this.m_Points[y*this.m_iGridWidth+x],null!=f&&f.$SetStatus(this.POINT_IN_PATH);f=a[0].split(","),x=parseInt(f[0]),y=parseInt(f[1]),x*=this.m_iGridSize,y*=this.m_iGridSize,g=g+e+x+","+y,f=this.m_Points[y*this.m_iGridWidth+x],null!=f&&f.$SetStatus(this.POINT_IN_PATH);var j=$createPolyline(3,g,c?this.m_sDotColor:b?this.COLOR_BLUE:this.COLOR_RED);this.m_Lines[this.m_Lines.length]=j}},{key:"IsPointBelongingToLine",value:function j(a,b,c){for(var d,e,f,g=a.length,h=0;h<g;++h)if(f=a[h].split(","),d=f[0],e=f[1],d==b&&e==c)return!0;return!1}},{key:"pnpoly",value:function l(a,b,d,e,f){var g,h,k=0;for(g=0,h=a-1;g<a;h=g++)(d[g]<=f&&f<d[h]||d[h]<=f&&f<d[g])&&e<(b[h]-b[g])*(f-d[g])/(d[h]-d[g])+b[g]&&(k=!k);return k}},{key:"SurroundOponentPoints",value:function r(){var a,b=this.m_Line.$GetPoints();a=b.length;for(var c,d,e=[],f=[],g="",h="",j=0,l=0;l<a;l+=2)c=b[l],d=b[l+1],null==c||null==d||(c/=this.m_iGridSize,d/=this.m_iGridSize,e[j]=c,f[j]=d,g=g+h+c+","+d,h=" ",++j);if(e[0]!=e[e.length-1]||f[0]!=f[f.length-1])return{owned:"",path:""};var m=this.m_Points.length,n=this.m_sDotColor==this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,o=this.m_sDotColor==this.COLOR_RED?this.POINT_OWNED_BY_RED:this.POINT_OWNED_BY_BLUE,p=this.m_sDotColor==this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,q="";h="";for(var s,t=0;t<m;++t)if(s=this.m_Points[t],null!=s&&s.$GetStatus()==this.POINT_FREE&&s.$GetFillColor()==n){var u=s.$GetPosition();c=u.x,d=u.y,c/=this.m_iGridSize,d/=this.m_iGridSize,0!=this.pnpoly(a,e,f,c,d)&&(s.$SetStatus(o),s.$SetFillColor(p),s.$strokeColor(p),q=q+h+c+","+d,h=" ")}return{owned:q,path:g}}},{key:"IsPointOutsideAllPaths",value:function n(a,b){for(var c=this.m_Lines.length,d=0;d<c;++d){var o=void 0,p=this.m_Lines[d].$GetPoints();o=p.length;for(var e=[],f=[],g=void 0,h=void 0,l=0,m=0;m<o;m+=2)g=p[m],h=p[m+1],null==g||null==h||(g/=this.m_iGridSize,h/=this.m_iGridSize,e[l]=g,f[l]=h,++l);if(0!=this.pnpoly(o,e,f,a,b))return!1}return!0}},{key:"CreateXMLWaitForPlayerRequest",value:function b(){var a="<WaitForPlayer>"+(0<arguments.length&&!0==(0>=arguments.length?void 0:arguments[0])?"<ShowP2Name />":"")+"</WaitForPlayer>";return a}},{key:"CreateXMLPutPointRequest",value:function c(a,b){return"<PutPoint><Point x='"+a+"' y='"+b+"' /></PutPoint>"}},{key:"CreateXMLPutPathRequest",value:function c(a,b){return"<PutPath><Path>"+a+"</Path><Owned>"+b+"</Owned></PutPath>"}},{key:"SendAsyncData",value:function b(a){0==a.length}},{key:"AjaxResponseCallBack",value:function u(){if(null!=g_XmlHttp&&(4==g_XmlHttp.readyState||"complete"==g_XmlHttp.readyState)&&200==g_XmlHttp.status){var a=g_XmlHttp.responseXML,b=a.firstChild;1!=b.nodeType&&(b=b.nextSibling);var v=b.nodeName;switch(v){case"WaitForPlayer":var c=0<b.getElementsByTagName("P2Name").length?b.getElementsByTagName("P2Name")[0].firstChild.data:"",d="true"==b.getElementsByTagName("Active")[0].firstChild.data;if(d){""!=c&&(this.m_Player2Name.innerHTML=c,this.m_SurrenderButton.value="surrender"),"win"==this.m_SurrenderButton.value&&(this.m_SurrenderButton.value="surrender");var w=b.getElementsByTagName("LastMove")[0];switch(w=w.firstChild,w.nodeName){case"Point":var e=parseInt(w.getAttribute("x")),f=parseInt(w.getAttribute("y")),g=parseInt(w.getAttribute("status"));this.SetPoint(e,f,g),this.m_bIsPlayerActive=!0,this.SetTimer(!1),this.m_bIsMobile?this.ShowMobileStatus():this.Debug("Oponent has moved, your turn");break;case"Path":var h=w.firstChild.data,j=b.getElementsByTagName("Owned")[0].firstChild.data;this.SetPath(h,this.m_sDotColor==this.COLOR_RED,!1);for(var k=j.split(" "),l=k.length,m=null,n=this.m_sDotColor==this.COLOR_RED?this.POINT_OWNED_BY_RED:this.POINT_OWNED_BY_BLUE,o=this.m_sDotColor==this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED,q=0;q<l;++q)m=k[q].split(","),e=parseInt(m[0]),f=parseInt(m[1]),m=this.m_Points[f*this.m_iGridWidth+e],null!=m&&(m.$SetStatus(n),m.$SetFillColor(o),m.$strokeColor(o));this.m_bIsPlayerActive=!0,this.SetTimer(!1),this.m_bIsMobile?this.ShowMobileStatus():this.Debug("Oponent has moved, your turn");break;default:}}else this.m_sMessage="Waiting for oponent move",""!=c&&(this.m_Player2Name.innerHTML=c,this.m_SurrenderButton.value="surrender",this.m_bIsMobile&&this.ShowMobileStatus());break;case"PutPoint":this.m_bIsPlayerActive=!1,this.m_iSlowdownLevel=0,this.SetTimer(!0);break;case"PutPath":var r=this.m_Line.$GetPoints(),s=r[i],t=r[i+1];s/=this.m_iGridSize,t/=this.m_iGridSize;var z=this.m_Points[t*this.m_iGridWidth+s];null!=z&&z.$SetStatus(this.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.m_iSlowdownLevel=0,this.SetTimer(!0);break;case"InterruptGame":this.SetTimer(!1);var A=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"";""==A?alert("Game interrupted!"):alert(A),window.location.href="Games";break;case"WaitingForSecondPlayer":this.m_sMessage="Waiting for other player to connect";break;case"Err":A=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"unknown error",alert(A),this.OnCancelClick();break;default:}}}},{key:"GameLoop",value:function c(){var a="???"==this.m_Player2Name.innerHTML;this.SendAsyncData(this.CreateXMLWaitForPlayerRequest(a));var b=parseInt((new Date-this.m_WaitStartTime)/1e3);if(0>=this.m_iSlowdownLevel&&b>=.25*this.m_iTooLong2Duration)this.m_iSlowdownLevel=1,this.SetTimer(!0);else if(1>=this.m_iSlowdownLevel&&b>=.5*this.m_iTooLong2Duration)this.m_iSlowdownLevel=2,this.SetTimer(!0);else if(2>=this.m_iSlowdownLevel&&b>=.75*this.m_iTooLong2Duration)this.m_iSlowdownLevel=4,this.SetTimer(!0);else if(b>=this.m_iTooLong2Duration)if(!a)this.SetTimer(!1),this.m_SurrenderButton.value="win",alert("Second player is not responding for quiet long. To walkover win click win - or continue to wait for oponent move"),this.SetTimer(!0);else if(this.SetTimer(!1),!0==confirm("Second player is still not connecting. Continue waiting?"))this.SetTimer(!0);else return void(window.location.href="Games");this.m_bIsMobile?this.ShowMobileStatus(b):""!=this.m_sMessage&&this.Debug(this.m_sMessage+"("+b+")")}},{key:"ShowMobileStatus",value:function c(a){var b=document.getElementById("GameStatus");"???"==this.m_Player2Name.innerHTML?-1==b.style.backgroundImage.indexOf("pjonbgcurrent.gif")?b.style.backgroundImage="url(img/pjonbgcurrent.gif)":b.style.backgroundImage="url(img/pjonbgcurrent2.gif)":this.m_bIsPlayerActive?(b.style.backgroundImage=this.m_bIsPlayingWithRed?"url(img/pjonbgcurrent.gif)":"url(img/pjonbgcurrent2.gif)",this.Debug("",0)):(b.style.backgroundImage=this.m_bIsPlayingWithRed?"url(img/pjonbgcurrent2.gif)":"url(img/pjonbgcurrent.gif)","undefined"!=a&&null!=a&&this.Debug(a))}},{key:"OnMouseMove",value:function p(a){if(this.m_bIsPlayerActive){var c=(a?a.clientX:window.event.clientX)-this.m_iPosX+this.m_iScrollX+.5*this.m_iGridSize,d=(a?a.clientY:window.event.clientY)-this.m_iPosY+this.m_iScrollY+.5*this.m_iGridSize;if(c=parseInt(c/this.m_iGridSize),d=parseInt(d/this.m_iGridSize),this.m_bDrawLines&&!0==this.m_bMouseDown&&(this.m_iLastX!=c||this.m_iLastY!=d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY)if(null!=this.m_Line){var e=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],f=this.m_Points[d*this.m_iGridWidth+c];if(null!=e&&null!=f&&f.$GetStatus()!=this.POINT_IN_PATH&&e.$GetFillColor()==this.m_sDotColor&&f.$GetFillColor()==this.m_sDotColor){var g=c*this.m_iGridSize,h=d*this.m_iGridSize;if(this.m_Line.$AppendPoints(g+","+h),f.$GetStatus()!=this.POINT_STARTING)f.$SetStatus(this.POINT_IN_PATH);else{var q=this.SurroundOponentPoints();0<q.owned.length?(this.m_Line.$SetIsClosed(!0),this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(q.path,q.owned))):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{var j=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],k=this.m_Points[d*this.m_iGridWidth+c];if(null!=j&&null!=k&&j.$GetStatus()!=this.POINT_IN_PATH&&k.$GetStatus()!=this.POINT_IN_PATH&&j.$GetFillColor()==this.m_sDotColor&&k.$GetFillColor()==this.m_sDotColor){var l=this.m_iLastX*this.m_iGridSize,m=this.m_iLastY*this.m_iGridSize,n=c*this.m_iGridSize,o=d*this.m_iGridSize;this.m_Line=$createPolyline(3,l+","+m+" "+n+","+o,this.m_sDotColor),j.$GetStatus()!=this.POINT_IN_PATH&&j.$SetStatus(this.POINT_STARTING),k.$GetStatus()!=this.POINT_IN_PATH&&k.$SetStatus(this.POINT_STARTING),this.m_iLastX=c,this.m_iLastY=d}}}}},{key:"OnMouseDown",value:function s(a){if(this.m_bIsPlayerActive){var c=(a?a.clientX:window.event.clientX)-this.m_iPosX+this.m_iScrollX+.5*this.m_iGridSize,d=(a?a.clientY:window.event.clientY)-this.m_iPosY+this.m_iScrollY+.5*this.m_iGridSize;if(c=this.m_iMouseX=parseInt(c/this.m_iGridSize),d=this.m_iMouseY=parseInt(d/this.m_iGridSize),this.m_bMouseDown=!0,!this.m_bDrawLines){this.m_iLastX=c,this.m_iLastY=d;var e=c,f=d;if(c=e*this.m_iGridSize,d=f*this.m_iGridSize,null!=this.m_Points[f*this.m_iGridWidth+e])return;if(!this.IsPointOutsideAllPaths(e,f))return;var g=$createOval(4,"true");g.$SetFillColor(this.m_sDotColor),g.$strokeColor(this.m_sDotColor),g.$move(c,d,4),this.m_Points[f*this.m_iGridWidth+e]=g,this.SendAsyncData(this.CreateXMLPutPointRequest(e,f))}else if((this.m_iLastX!=c||this.m_iLastY!=d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY){if(null!=this.m_Line){var h=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],j=this.m_Points[d*this.m_iGridWidth+c];if(null!=h&&null!=j&&j.$GetStatus()!=this.POINT_IN_PATH&&h.$GetFillColor()==this.m_sDotColor&&j.$GetFillColor()==this.m_sDotColor){var k=c*this.m_iGridSize,l=d*this.m_iGridSize;if(this.m_Line.$AppendPoints(k+","+l),j.$GetStatus()!=this.POINT_STARTING)j.$SetStatus(this.POINT_IN_PATH);else{var t=this.SurroundOponentPoints();0<t.owned.length?(this.m_Line.$SetIsClosed(!0),this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(t.path,t.owned))):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{var m=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],n=this.m_Points[d*this.m_iGridWidth+c];if(null!=m&&null!=n&&m.$GetStatus()!=this.POINT_IN_PATH&&n.$GetStatus()!=this.POINT_IN_PATH&&m.$GetFillColor()==this.m_sDotColor&&n.$GetFillColor()==this.m_sDotColor){var o=this.m_iLastX*this.m_iGridSize,p=this.m_iLastY*this.m_iGridSize,q=c*this.m_iGridSize,r=d*this.m_iGridSize;this.m_Line=$createPolyline(3,o+","+p+" "+q+","+r,this.m_sDotColor),m.$GetStatus()!=this.POINT_IN_PATH&&m.$SetStatus(this.POINT_STARTING),n.$GetStatus()!=this.POINT_IN_PATH&&n.$SetStatus(this.POINT_STARTING)}this.m_iLastX=c,this.m_iLastY=d}}else if(0>this.m_iLastX||0>this.m_iLastY){var u=this.m_Points[d*this.m_iGridWidth+c];null!=u&&u.$GetStatus()==this.POINT_FREE&&u.$GetFillColor()==this.m_sDotColor&&(this.m_iLastX=c,this.m_iLastY=d)}}}},{key:"OnMouseUp",value:function a(){this.m_bMouseDown=!1}},{key:"OnScroll",value:function a(){this.m_iScrollX=this.f_scrollLeft(),this.m_iScrollY=this.f_scrollTop()}},{key:"OnDrawModeClick",value:function b(){this.m_bDrawLines=!this.m_bDrawLines;var a=document.getElementById("DrawMode");a.value=this.m_bDrawLines?"Draw dots":"Draw lines",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}},{key:"OnCancelClick",value:function f(){if(this.m_bDrawLines){if(null!=this.m_Line){for(var a=this.m_Line.$GetPoints(),b=0;b<a.length;b+=2){var c=a[b],d=a[b+1];if(null!=c&&null!=d){c/=this.m_iGridSize,d/=this.m_iGridSize;var e=this.m_Points[d*this.m_iGridWidth+c];null!=e&&e.$SetStatus(this.POINT_FREE)}}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1}}},{key:"OnTestClick",value:function c(){if(!this.m_bDrawLines){var a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=a.$GetPosition();this.Debug("".concat(a.$GetFillColor()," posX = ").concat(b.x," posY = ").concat(b.y),1)}else if(null!=this.m_Line){var d=this.SurroundOponentPoints();0<d.owned.length&&(this.m_iLastX=this.m_iLastY=-1,this.m_Line=null)}}},{key:"PrepareDrawing",value:function g(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:15,c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],d=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:125;this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.POINT_FREE_RED=-3,this.POINT_FREE_BLUE=-2,this.POINT_FREE=-1,this.POINT_STARTING=0,this.POINT_IN_PATH=1,this.POINT_OWNED_BY_RED=2,this.POINT_OWNED_BY_BLUE=3,this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=e,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSize=b,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_iScrollX=0,this.m_iScrollY=0,this.m_iClientWidth=0,this.m_iClientHeight=0,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_bMouseDown=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=c,this.m_bIsPlayerActive=d,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.getElementById("Player2Name"),this.m_SurrenderButton=document.getElementById("SurrenderButton");var f=document.querySelector(a);if(!f)return void alert("no board");if(this.m_iPosX=f.offsetLeft,this.m_iPosY=f.offsetTop,this.m_iClientWidth=f.clientWidth,this.m_iClientHeight=f.clientHeight,this.m_iGridWidth=parseInt(this.m_iClientWidth/this.m_iGridSize),this.m_iGridHeight=parseInt(this.m_iClientHeight/this.m_iGridSize),this.m_iScrollX=this.f_scrollLeft(),this.m_iScrollY=this.f_scrollTop(),$createSVGVML(f,f.style.width,f.style.height,!1),this.DisableSelection(f),!this.m_bViewOnly){f.onmousedown=this.OnMouseDown.bind(this),f.onmousemove=this.OnMouseMove.bind(this),f.onmouseup=this.OnMouseUp.bind(this),window.onscroll=this.OnScroll.bind(this);var h=document.getElementById("DrawMode");h.onclick=this.OnDrawModeClick.bind(this),h=document.getElementById("Cancel"),h.onclick=this.OnCancelClick.bind(this)}}}]),a}();