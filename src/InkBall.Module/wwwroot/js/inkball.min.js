"use strict";let t,e,i,s,n,o,r,a;const l=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),h=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),c=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class m{GetKind(){throw new Error("missing GetKind implementation!")}}class _ extends m{constructor(t=0,e=0,i=0,n=0,o=0,r=s.POINT_FREE,a=0){super(),this.iId=t,this.iGameId=e,this.iPlayerId=i,this.iX=n,this.iY=o,this.Status=r,this.iEnclosingPathId=a}GetKind(){return l.POINT}static Format(t,e){let i="("+e.iX+","+e.iY+" - ";switch(void 0!==e.Status?e.Status:e.status){case s.POINT_FREE_RED:i+="red";break;case s.POINT_FREE_BLUE:i+="blue";break;case s.POINT_FREE:i+="";break;case s.POINT_STARTING:i+="starting";break;case s.POINT_IN_PATH:i+="path";break;case s.POINT_OWNED_BY_RED:i+="owned by red";break;case s.POINT_OWNED_BY_BLUE:i+="owned by blue";break;default:throw new Error("Bad point type!")}return t+" places "+i+") point"}}class d extends m{constructor(t=0,e=0,i=0,s="",n=""){super(),this.iId=t,this.iGameId=e,this.iPlayerId=i,this.PointsAsString=s,this.OwnedPointsAsString=n}GetKind(){return l.PATH}static Format(t,e){return`${t} places ${`(${e.PointsAsString||e.pointsAsString}) [${e.OwnedPointsAsString||e.ownedPointsAsString}]`} path`}}class u extends m{constructor(t,e,i){super(),this.OtherPlayerId=t,this.OtherPlayerName=e,this.Message=i}GetKind(){return l.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class S extends m{constructor(t,e,i){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=e,this.Message=i}GetKind(){return l.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class P extends m{constructor(t=""){super(),this.Message=t}GetKind(){return l.PING}static Format(t,e){return t+" says '"+(e.Message||e.message)+"'"}}class g extends m{constructor(t=c.NO_WIN,e=0,i="null"){super(),this.Status=t,this.WinningPlayerId=e,this.Message=i}GetKind(){return l.WIN}static Format(t){let e="";switch(void 0!==t.Status?t.Status:t.status){case c.RED_WINS:e="red.";break;case c.GREEN_WINS:e="blue.";break;case c.NO_WIN:e="no one!";break;case c.DRAW_WIN:e="draw!"}return"And the winner is... "+e}}class y extends m{constructor(){super()}GetKind(){return l.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class p extends m{constructor(t=[],e=[]){super(),this.Points=t,this.Paths=e}GetKind(){return l.POINTS_AND_PATHS}static Deserialize(t){const e=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(e)}}class w extends m{constructor(t=!1){super(),this.DesktopNotifications=t}GetKind(){return l.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class I{constructor({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.timerID=-1,this.label=null,this.countdownReachedHandler=s,e&&(this.label=document.querySelector(e)),i&&this.Start()}setTimeFunc(){--this.totalSeconds<=0?(this.Stop(),this.countdownReachedHandler&&this.countdownReachedHandler(this.label)):this.label&&(this.label.innerHTML=this.pad(parseInt(this.totalSeconds/60))+":"+this.pad(this.totalSeconds%60))}pad(t){const e=t+"";return e.length<2?"0"+e:e}Start(){this.Stop(),this.timerID=setInterval(this.setTimeFunc.bind(this),1e3)}Stop(){this.timerID>0&&clearInterval(this.timerID),this.label&&(this.label.innerHTML="")}Reset({countdownSeconds:t=60,labelSelector:e=null,initialStart:i=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.label=null,this.countdownReachedHandler=s,e&&(this.label=document.querySelector(e)),i&&this.Start()}}function C(){return"#"+Math.floor(16777215*Math.random()).toString(16)}Function.prototype.callAsWorker=function(t,e){return new Promise(((i,s)=>{const n=`\n${t?[...t].reduce(((t,e)=>t+e.toString()+"\n")):""}\n\nself.onmessage = async function (e) { \n\tconst result = await ( ${this.toString()}.call(null, e.data) );\n\n\tself.postMessage( result ); \n}`,o=new Blob([n],{type:"text/javascript"}),r=new Worker(window.URL.createObjectURL(o));r.onmessage=t=>(i(t.data),r.terminate(),window.URL.revokeObjectURL(o)),r.onerror=t=>(s(t.message),r.terminate(),window.URL.revokeObjectURL(o)),r.postMessage(e)}))};class L{constructor(t,e,s,n,o,r,a,l,c,m=!0,_=!0,d=!1,u=60,S=125){this.g_iGameID=t,this.g_iPlayerID=e,this.m_iOtherPlayerId=s,this.m_bIsCPUGame=-1===this.m_iOtherPlayerId,this.GameType=h[c],this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="#DC143C",this.COLOR_OWNED_BLUE="#8A2BE2",this.DRAWING_PATH_COLOR="black",this.m_bIsWon=!1,this.m_bPointsAndPathsLoaded=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=S,this.m_Timer=null,this.m_ReconnectTimer=null,this.m_WaitStartTime=null,this.m_TimerOpts={countdownSeconds:u,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.m_iSlowdownLevel=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize={logicalWidth:0,logicalHeight:0},this.m_iGridSpacingX=0,this.m_iGridSpacingY=0,this.m_PointRadius=0,this.m_LineStrokeWidth=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_sMsgListSel=null,this.m_CancelPath=null,this.m_StopAndDraw=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=m,this.m_bIsPlayerActive=_,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.SvgVml=null,this.m_Line=null,this.m_Lines=null,this.m_Points=null,this.m_bViewOnly=d,this.m_MouseCursorOval=null,this.CursorPos={x:-1,y:-1},this.m_ApplicationUserSettings=null,this.m_sLastMoveGameTimeStamp=null,this.m_sVersion=null,this.m_Worker=null,null!==n&&""!==n&&(this.g_SignalRConnection=(new signalR.HubConnectionBuilder).withUrl(n,{transport:a,accessTokenFactory:function(){return`iGameID=${this.g_iGameID}&iPlayerID=${this.g_iPlayerID}`}.bind(this)}).withHubProtocol(r).configureLogging(o).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=l,this.g_SignalRConnection.onclose((async t=>{null!=t&&(i(t),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout((()=>this.Connect()),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5)))})))}async GetPlayerPointsAndPaths(){if(!1===this.m_bPointsAndPathsLoaded){const t=await this.g_SignalRConnection.invoke("GetPlayerPointsAndPaths",this.m_bViewOnly,this.g_iGameID),e=p.Deserialize(t);return void 0!==e.Points&&await this.SetAllPoints(e.Points),void 0!==e.Paths&&await this.SetAllPaths(e.Paths),this.m_bPointsAndPathsLoaded=!0,!0}return!1}async Connect(){try{if(await this.g_SignalRConnection.start(),this.iConnErrCount=0,e("connected; iConnErrCount = "+this.iConnErrCount),!1===this.m_bViewOnly)if(null===sessionStorage.getItem("ApplicationUserSettings")){let t=await this.g_SignalRConnection.invoke("GetUserSettings");if(t){e(t),t=w.Deserialize(t);const i=w.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",i)}this.m_ApplicationUserSettings=new w(t.DesktopNotifications),await this.GetPlayerPointsAndPaths()}else{const t=sessionStorage.getItem("ApplicationUserSettings"),e=w.Deserialize(t);this.m_ApplicationUserSettings=new w(e.DesktopNotifications)}!1===this.m_bPointsAndPathsLoaded&&await this.GetPlayerPointsAndPaths(),null!==this.m_ApplicationUserSettings&&!0===this.m_ApplicationUserSettings.DesktopNotifications&&this.SetupNotifications(),!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()}catch(t){i(t+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout((()=>this.Connect()),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5))}}SetupNotifications(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then((function(t){return"granted"===t||(e("User blocked notifications."),!1)})).catch((function(t){return i(t),!1})):(e("Browser does not support notifications."),!1)}NotifyBrowser(t="Hi there!",s="How are you doing?"){return!!document.hidden&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then((function(i){return"granted"===i?(new Notification(t,{body:s,icon:"../img/homescreen.webp"}),!0):(e("User blocked notifications."),!1)})).catch((function(t){return i(t),!1})):(e("Browser does not support notifications."),!1))}async StartSignalRConnection(t){return null===this.g_SignalRConnection?Promise.reject(new Error("signalr conn is null")):(!1===this.m_bPointsAndPathsLoaded&&(this.m_bPointsAndPathsLoaded=!t),this.g_SignalRConnection.on("ServerToClientPoint",async function(t){if(this.g_iPlayerID!==t.iPlayerId){const e=this.m_Player2Name.innerHTML;let i=_.Format(e,t);const s=document.createElement("li");s.textContent=i,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("New Point",i)}await this.ReceivedPointProcessing(t)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let e=t;if(this.g_iPlayerID!==e.iPlayerId){const t=this.m_Player2Name.innerHTML;let i=d.Format(t,e);const s=document.createElement("li");s.textContent=i,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("New Path",i)}this.ReceivedPathProcessing(e)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");{let e=t,i=g.Format(e),s=document.createElement("li");s.textContent=i,document.querySelector(this.m_sMsgListSel).appendChild(s),this.ReceivedWinProcessing(e),this.NotifyBrowser("We have a winner",i)}}}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(t){const e=t.OtherPlayerId||t.otherPlayerId;this.m_iOtherPlayerId=e;const i=u.Format(t);document.querySelector(".msgchat").dataset.otherplayerid=e;let s=document.createElement("li");s.innerHTML=`<strong class="text-primary">${i}</strong>`,document.querySelector(this.m_sMsgListSel).appendChild(s),null!==this.m_SurrenderButton&&""!==t.OtherPlayerName&&(this.m_Player2Name.innerHTML=t.OtherPlayerName||t.otherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),this.NotifyBrowser("Player joininig",i),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(t){let e=S.Format(t),i=document.createElement("li");i.innerHTML=`<strong class="text-warning">${e}</strong>`,document.querySelector(this.m_sMsgListSel).appendChild(i),this.m_bHandlingEvent=!1,e=""===e?"Game interrupted!":e,this.NotifyBrowser("Game interruption",e),alert(e),window.location.href="GamesList"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(t){let e=g.Format(t);const i=document.querySelector(this.m_sMsgListSel);if(null!==i){let t=document.createElement("li");t.innerHTML=`<strong class="text-warning">${e}</strong>`,i.appendChild(t)}this.ReceivedWinProcessing(t),this.NotifyBrowser("We have a winner",e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(t){const e=this.m_Player2Name.innerHTML;let i=P.Format(e,t),s=document.createElement("li");s.textContent=i,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("User Message",i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerDisconnected",function(t){const e={countdownSeconds:5,initialStart:!0,countdownReachedHandler:function(){let e=t,i=document.createElement("li");i.innerHTML=`<strong class="text-warning">${e}</strong>`,document.querySelector(this.m_sMsgListSel).appendChild(i),this.NotifyBrowser("User disconnected",e),this.m_ReconnectTimer=null}.bind(this)};this.m_ReconnectTimer?this.m_ReconnectTimer.Reset(e):this.m_ReconnectTimer=new I(e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerConnected",function(t){if(this.m_ReconnectTimer)this.m_ReconnectTimer.Stop(),this.m_ReconnectTimer=null;else{let e=t,i=document.createElement("li");i.innerHTML=`<strong class="text-primary">${e}</strong>`,document.querySelector(this.m_sMsgListSel).appendChild(i),this.NotifyBrowser("User disconnected",e),this.m_ReconnectTimer=null}}.bind(this)),this.g_SignalRConnection.on("ServerToClientStopAndDraw",function(t){if(!t)return;const e=this.m_Player2Name.innerHTML;let i=y.Format(e),s=document.createElement("li");s.innerHTML=`<strong class="text-info">${i}</strong>`,document.querySelector(this.m_sMsgListSel).appendChild(s),this.NotifyBrowser("User "+e+" started drawing new path",i)}.bind(this)),!1===this.m_bIsCPUGame&&(document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",async function(t){t.preventDefault();let e=document.querySelector(this.m_sMsgInputSel).value.trim();if(""===e)return;let i=new P(e);await this.SendAsyncData(i)}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1)),this.Connect())}StopSignalRConnection(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),this.m_ReconnectTimer&&this.m_ReconnectTimer.Stop(),this.m_Timer&&this.m_Timer.Stop(),e("Stopped SignalR connection"))}Debug(...t){switch(t.length){case 1:this.m_Debug.innerHTML=t[0];break;case 2:document.getElementById("debug"+t[1]).innerHTML=t[0];break;default:for(let e=0;e<t.length;e++){const i=t[e];if(i){const t=document.getElementById("debug"+e);t&&(t.innerHTML=i)}}}}DisableSelection(t){void 0!==typeof t.onselectstart?t.onselectstart=function(){return!1}:void 0!==typeof t.style.MozUserSelect?t.style.MozUserSelect="none":t.onmousedown=function(){return!1}}f_clientWidth(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}f_clientHeight(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}f_scrollLeft(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}f_scrollTop(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}f_filterResults(t,e,i){let s=t||0;return e&&(!s||s>e)&&(s=e),i&&(!s||s>i)?i:s}async SetPoint(t,e,i,n){if(await this.m_Points.has(e*this.m_iGridWidth+t))return;const o=t,r=e,a=this.SvgVml.CreateOval(this.m_PointRadius);let l;switch(a.move(o,r,this.m_PointRadius),i){case s.POINT_FREE_RED:l=this.COLOR_RED,a.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.COLOR_BLUE,a.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.m_sDotColor,a.SetStatus(i);break;case s.POINT_IN_PATH:l=this.g_iPlayerID===n?!0===this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:!0===this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,a.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.COLOR_OWNED_RED,a.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.COLOR_OWNED_BLUE,a.SetStatus(i);break;default:alert("bad point")}a.SetFillColor(l),a.SetStrokeColor(l),await this.m_Points.set(e*this.m_iGridWidth+t,a)}GetGameStateForIndexedDb(){return{iGameID:this.g_iGameID,iPlayerID:this.g_iPlayerID,iOtherPlayerId:this.m_iOtherPlayerId,sLastMoveGameTimeStamp:this.m_sLastMoveGameTimeStamp,bPointsAndPathsLoaded:this.m_bPointsAndPathsLoaded,iGridWidth:this.m_iGridWidth,iGridHeight:this.m_iGridHeight}}CreateScreenPointFromIndexedDb(t,e,i,n){const o=t,r=e,a=this.SvgVml.CreateOval(this.m_PointRadius);let l;switch(a.move(o,r,this.m_PointRadius),i){case s.POINT_FREE_RED:l=this.COLOR_RED,a.SetStatus(i);break;case s.POINT_FREE_BLUE:l=this.COLOR_BLUE,a.SetStatus(i);break;case s.POINT_FREE:case s.POINT_STARTING:l=this.m_sDotColor,a.SetStatus(i);break;case s.POINT_IN_PATH:l=n,a.SetStatus(i);break;case s.POINT_OWNED_BY_RED:l=this.COLOR_OWNED_RED,a.SetStatus(i);break;case s.POINT_OWNED_BY_BLUE:l=this.COLOR_OWNED_BLUE,a.SetStatus(i);break;default:alert("bad point")}return a.SetFillColor(l),a.SetStrokeColor(l),a}async SetAllPoints(t){try{await this.m_Points.BeginBulkStorage();for(const[s,n,o,r]of t)await this.SetPoint(s,n,(i=o,i-3),(e=r,e-1))}finally{await this.m_Points.EndBulkStorage()}var e,i}async SetPath(t,e,i,n=0){const o=t.split(" ");let r,a,l="",h="",c=null,m=s.POINT_STARTING;for(const t of o)c=t.split(","),r=parseInt(c[0]),a=parseInt(c[1]),c=await this.m_Points.get(a*this.m_iGridWidth+r),null!=c&&(c.SetStatus(m),m=s.POINT_IN_PATH),h+=`${l}${r},${a}`,l=" ";c=o[0].split(","),r=parseInt(c[0]),a=parseInt(c[1]),c=await this.m_Points.get(a*this.m_iGridWidth+r),null!=c&&c.SetStatus(m),o[0]!==o[o.length-1]&&(h+=`${l}${r},${a}`);const _=this.SvgVml.CreatePolyline(this.m_LineStrokeWidth,h,i?this.m_sDotColor:e?this.COLOR_BLUE:this.COLOR_RED);_.SetID(n),await this.m_Lines.push(_)}async CreateScreenPathFromIndexedDb(t,e,i){const n=t.split(" ");let o,r,a="",l="",h=null,c=s.POINT_STARTING;for(const t of n)h=t.split(","),o=parseInt(h[0]),r=parseInt(h[1]),h=await this.m_Points.get(r*this.m_iGridWidth+o),null!=h&&(h.SetStatus(c),c=s.POINT_IN_PATH),l+=`${a}${o},${r}`,a=" ";h=n[0].split(","),o=parseInt(h[0]),r=parseInt(h[1]),h=await this.m_Points.get(r*this.m_iGridWidth+o),null!=h&&h.SetStatus(c),n[0]!==n[n.length-1]&&(l+=`${a}${o},${r}`);const m=this.SvgVml.CreatePolyline(this.m_LineStrokeWidth,l,e);return m.SetID(i),m}async SetAllPaths(t){try{await this.m_Lines.BeginBulkStorage();for(const e of t)await this.SetPath(e.PointsAsString,this.m_bIsPlayingWithRed,e.iPlayerId===this.g_iPlayerID,e.iId)}finally{await this.m_Lines.EndBulkStorage()}}IsPointBelongingToLine(t,e,i){for(const s of t){const[t,n]=s.split(",");if(t===e&&n===i)return!0}return!1}async SurroundOponentPoints(){const t=this.m_Line.GetPointsArray();if(n(t.slice(0,-1).map((t=>t.x+"_"+t.y)))||t[0].x!==t[t.length-1].x||t[0].y!==t[t.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};let e,i,r;this.m_sDotColor===this.COLOR_RED?(e=this.COLOR_BLUE,i=s.POINT_OWNED_BY_RED,r=this.COLOR_OWNED_RED):(e=this.COLOR_RED,i=s.POINT_OWNED_BY_BLUE,r=this.COLOR_OWNED_BLUE);let a="",l="",h="",c=[];for(const n of await this.m_Points.values())if(void 0!==n&&n.GetFillColor()===e&&[s.POINT_FREE_BLUE,s.POINT_FREE_RED].includes(n.GetStatus())){let{x:e,y:s}=n.GetPosition();!1!==o(t,e,s)&&(l+=`${h}${e},${s}`,h=" ",c.push({point:n,revertStatus:n.GetStatus(),revertFillColor:n.GetFillColor(),revertStrokeColor:n.GetStrokeColor()}),n.SetStatus(i,!0),n.SetFillColor(r),n.SetStrokeColor(r))}return""!==l&&(a=t.map(function(t){let e=t.x,i=t.y;return null===e||null===i?"":`${e},${i}`}.bind(this)).join(" ")),{OwnedPoints:c,owned:l,PathPoints:[],path:a,errorDesc:"No surrounded points"}}async IsPointOutsideAllPaths(t,e){const i=t,s=e,n=await this.m_Lines.all();for(const t of n){const e=t.GetPointsArray();if(!1!==o(e,i,s))return!1}return!0}CreateXMLWaitForPlayerRequest(){}CreateXMLPutPointRequest(t,e){return new _(0,this.g_iGameID,this.g_iPlayerID,t,e,this.m_bIsPlayingWithRed?s.POINT_FREE_RED:s.POINT_FREE_BLUE,0)}CreateXMLPutPathRequest(t){return new d(0,this.g_iGameID,this.g_iPlayerID,t.path,t.owned)}async SendAsyncData(t,s){switch(t.GetKind()){case l.POINT:e(_.Format("some player",t)),this.m_bHandlingEvent=!0;try{const e=await this.g_SignalRConnection.invoke("ClientToServerPoint",t);await this.ReceivedPointProcessing(e)}catch(t){i(t.toString()),void 0!==s&&s()}break;case l.PATH:e(d.Format("some player",t)),this.m_bHandlingEvent=!0;try{const e=await this.g_SignalRConnection.invoke("ClientToServerPath",t);if(Object.prototype.hasOwnProperty.call(e,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(e,"winningPlayerId")){let t=e;this.ReceivedWinProcessing(t)}else{if(!Object.prototype.hasOwnProperty.call(e,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(e,"pointsAsString"))throw new Error("ClientToServerPath bad GetKind!");{let t=e;await this.ReceivedPathProcessing(t)}}}catch(t){i(t.toString()),void 0!==s&&s()}break;case l.PING:try{await this.g_SignalRConnection.invoke("ClientToServerPing",t),document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}catch(t){i(t.toString())}break;case l.STOP_AND_DRAW:try{await this.g_SignalRConnection.invoke("ClientToServerStopAndDraw",t),this.m_bDrawLines=!0,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!0,this.m_StopAndDraw.disabled="disabled"}catch(t){i(t.toString())}break;default:i("unknown object")}}CountDownReachedHandler(t){t&&(t.innerHTML=""),this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",this.m_Timer=null,this.m_bIsPlayerActive=!1}async ReceivedPointProcessing(t){const e=t.iX,i=t.iY,s=void 0!==t.Status?t.Status:t.status;this.m_sLastMoveGameTimeStamp=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),await this.SetPoint(e,i,s,t.iPlayerId),this.g_iPlayerID!==t.iPlayerId?(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&await this.OnCancelClick(),this.m_StopAndDraw.disabled="",this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)):(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_CancelPath.disabled="disabled",this.m_StopAndDraw.disabled="",this.m_StopAndDraw.value="Stop and Draw",this.m_Timer?this.m_Timer.Reset(this.m_TimerOpts):this.m_Timer=new I(this.m_TimerOpts),!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()),this.m_bHandlingEvent=!1}async ReceivedPathProcessing(t){if(this.m_sLastMoveGameTimeStamp=(void 0!==t.TimeStamp?t.TimeStamp:new Date(t.timeStamp)).toISOString(),this.g_iPlayerID!==t.iPlayerId){const e=t.PointsAsString||t.pointsAsString,i=t.OwnedPointsAsString||t.ownedPointsAsString;await this.SetPath(e,this.m_sDotColor===this.COLOR_RED,!1,t.iId);const n=i.split(" "),o=this.m_sDotColor===this.COLOR_RED?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE;for(const t of n){let e=t.split(",");const i=parseInt(e[0]),s=parseInt(e[1]);e=await this.m_Points.get(s*this.m_iGridWidth+i),void 0!==e&&(e.SetStatus(o),e.SetFillColor(r),e.SetStrokeColor(r))}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&await this.OnCancelClick(),this.m_StopAndDraw.disabled=""}else{const e=this.m_Line.GetPointsArray();let i=e[0].x,n=e[0].y;const o=await this.m_Points.get(n*this.m_iGridWidth+i);void 0!==o&&o.SetStatus(s.POINT_IN_PATH),this.m_Line.SetWidthAndColor(3,this.m_sDotColor),this.m_Line.SetID(t.iId),await this.m_Lines.push(this.m_Line),this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",!0!==this.m_bIsCPUGame||this.m_bIsPlayerActive||this.StartCPUCalculation()}this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_bHandlingEvent=!1,this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)}ReceivedWinProcessing(t){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;let e=g.Format(t);const i=void 0!==t.Status?t.Status:t.status,s=t.WinningPlayerId||t.winningPlayerId;((i===c.RED_WINS||i===c.GREEN_WINS)&&s>0||i===c.DRAW_WIN)&&(alert(""===e?"Game won!":e),window.location.href="GamesList")}Check4Win(t,e,i,n){let o,r;switch(this.GameType){case h.FIRST_CAPTURE:return t.length>0?this.m_bIsPlayingWithRed?c.RED_WINS:c.GREEN_WINS:e.length>0?this.m_bIsPlayingWithRed?c.GREEN_WINS:c.RED_WINS:c.NO_WIN;case h.FIRST_5_CAPTURES:return o=this.m_bIsPlayingWithRed?s.POINT_OWNED_BY_BLUE:s.POINT_OWNED_BY_RED,r=n.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,r>=5?this.m_bIsPlayingWithRed?c.GREEN_WINS:c.RED_WINS:(o=this.m_bIsPlayingWithRed?s.POINT_OWNED_BY_RED:s.POINT_OWNED_BY_BLUE,r=i.filter((function(t){return null!==t.iEnclosingPathId&&t.GetStatus()===o})).length,r>=5?this.m_bIsPlayingWithRed?c.RED_WINS:c.GREEN_WINS:c.NO_WIN);case h.FIRST_5_PATHS:return e.length>=5?this.m_bIsPlayingWithRed?c.GREEN_WINS:c.RED_WINS:t.length>=5?this.m_bIsPlayingWithRed?c.RED_WINS:c.GREEN_WINS:c.NO_WIN;case h.FIRST_5_ADVANTAGE_PATHS:{const i=t.length-e.length;if(i>=5)return this.m_bIsPlayingWithRed?c.RED_WINS:c.GREEN_WINS;if(i<=-5)return this.m_bIsPlayingWithRed?c.GREEN_WINS:c.RED_WINS}return c.NO_WIN;default:throw new Error("Wrong game type")}}ShowMobileStatus(t=""){"???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_GameStatus.style.color=this.COLOR_RED,null!==t&&""!==t?this.Debug(t,0):this.Debug("",0)}async OnMouseMove(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return void(this.iConnErrCount<=0&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait"));const e=this.SvgVml.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;i=parseInt(i),n=parseInt(n);let o=i,r=n;if(this.CursorPos.x===o&&this.CursorPos.y===r||(this.m_MouseCursorOval.move(o,r,this.m_PointRadius),this.m_MouseCursorOval.Show(),this.Debug(`[${i},${n}]`,1),this.CursorPos.x=o,this.CursorPos.y=r),this.m_bDrawLines){if(null!==this.m_Line?this.m_Screen.style.cursor="move":this.m_Screen.style.cursor="crosshair",!0===this.m_bMouseDown&&(this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),e=await this.m_Points.get(n*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.m_sDotColor&&e.GetFillColor()===this.m_sDotColor){const a=this.m_Line.ContainsPoint(o,r);if(a<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,r))e.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n;else if(1===a&&e.GetStatus()===s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,r)){const t=await this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.rAF_FrameID=null,await this.SendAsyncData(this.CreateXMLPutPathRequest(t),(async()=>{await this.OnCancelClick(),t.OwnedPoints.forEach((t=>{const e=t.point,i=t.revertFillColor,s=t.revertStrokeColor;e.RevertOldStatus(),e.SetFillColor(i),e.SetStrokeColor(s)})),this.m_bHandlingEvent=!1}))):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=i,this.m_iLastY=n}else a>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.m_Line.GetPointsString().endsWith(`${this.m_iLastX},${this.m_iLastY}`)&&(this.m_Line.GetLength()>2?(t.RevertOldStatus(),this.m_Line.RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=n):await this.OnCancelClick())}}else{let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),e=await this.m_Points.get(n*this.m_iGridWidth+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.m_sDotColor&&e.GetFillColor()===this.m_sDotColor){const a=this.m_iLastX,l=this.m_iLastY;this.m_Line=this.SvgVml.CreatePolyline(2*this.m_LineStrokeWidth,a+","+l+" "+o+","+r,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n}}}else this.m_Screen.style.cursor="crosshair"}async OnMouseDown(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return;const e=this.SvgVml.ToCursorPoint(t.clientX,t.clientY);let i=e.x+.5,n=e.y+.5;if(i=this.m_iMouseX=parseInt(i),n=this.m_iMouseY=parseInt(n),this.m_bMouseDown=!0,this.m_bDrawLines){if((this.m_iLastX!==i||this.m_iLastY!==n)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-n))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),e=await this.m_Points.get(n*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.GetLength()>=2?"":"disabled",void 0!==t&&void 0!==e&&t.GetFillColor()===this.m_sDotColor&&e.GetFillColor()===this.m_sDotColor){const o=i,r=n,a=this.m_Line.ContainsPoint(o,r);if(a<1&&e.GetStatus()!==s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,r))e.SetStatus(s.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=n;else if(1===a&&e.GetStatus()===s.POINT_STARTING&&!0===this.m_Line.AppendPoints(o,r)){const t=await this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.rAF_FrameID=null,await this.SendAsyncData(this.CreateXMLPutPathRequest(t),(async()=>{await this.OnCancelClick(),t.OwnedPoints.forEach((t=>{const e=t.point,i=t.revertFillColor,s=t.revertStrokeColor;e.RevertOldStatus(),e.SetFillColor(i),e.SetStrokeColor(s)})),this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=i,this.m_iLastY=n}else a>=1&&t.GetStatus()===s.POINT_IN_PATH&&this.m_Line.GetPointsString().endsWith(`${this.m_iLastX},${this.m_iLastY}`)&&(this.m_Line.GetLength()>2?(t.RevertOldStatus(),this.m_Line.RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=n):await this.OnCancelClick())}}else{let t=await this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),e=await this.m_Points.get(n*this.m_iGridWidth+i);if(void 0!==t&&void 0!==e&&t.GetFillColor()===this.m_sDotColor&&e.GetFillColor()===this.m_sDotColor){const o=this.m_iLastX,r=this.m_iLastY,a=i,l=n;this.m_Line=this.SvgVml.CreatePolyline(2*this.m_LineStrokeWidth,o+","+r+" "+a+","+l,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.SetStatus(s.POINT_STARTING,!0),e.SetStatus(s.POINT_IN_PATH,!0)}this.m_iLastX=i,this.m_iLastY=n}else if(this.m_iLastX<0||this.m_iLastY<0){let t=await this.m_Points.get(n*this.m_iGridWidth+i);void 0!==t&&t.GetFillColor()===this.m_sDotColor&&(this.m_iLastX=i,this.m_iLastY=n)}}else{this.m_iLastX=i,this.m_iLastY=n;const t=i,e=n;if(void 0!==await this.m_Points.get(e*this.m_iGridWidth+t))return void this.Debug("Wrong point - already existing",0);if(!await this.IsPointOutsideAllPaths(t,e))return void this.Debug("Wrong point, Point is not outside all paths",0);this.rAF_FrameID=null,await this.SendAsyncData(this.CreateXMLPutPointRequest(t,e),(()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))}}OnMouseUp(){this.m_bMouseDown=!1}OnMouseLeave(){this.m_MouseCursorOval.Hide()}async OnStopAndDraw(t){if(this.m_Timer)null===this.m_Line&&await this.SendAsyncData(new y);else{null!==this.m_Line&&await this.OnCancelClick(),this.m_bDrawLines=!this.m_bDrawLines;const e=t.target;this.m_bDrawLines?e.value="Draw dot":e.value="Draw line",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}}async OnCancelClick(){if(this.m_bDrawLines){if(null!==this.m_Line){const t=this.m_Line.GetPointsArray();this.m_CancelPath.disabled="disabled";for(const e of t){let t=e.x,i=e.y;if(null===t||null===i)continue;t=parseInt(t),i=parseInt(i);const s=await this.m_Points.get(i*this.m_iGridWidth+t);void 0!==s&&s.RevertOldStatus()}this.SvgVml.RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1,this.m_Timer&&(this.m_StopAndDraw.disabled="disabled"),this.Debug("",0)}}CountPointsDebug(t){let e="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='2']",display:"intercepted(P1:%s, "},{query:"circle[data-status='3']",display:"P2:%s)"}].forEach((function(t){const i=document.querySelectorAll(t.query);e+=t.display.replace("%s",i.length)})),document.querySelector(t).innerHTML="SVGs by tags: "+e}async RunAIWorker(t){return new Promise(((e,s)=>{this.m_Worker=this.m_Worker??new Worker("../js/AIWorker.Bundle.js"),this.m_Worker.onerror=function(){this.m_Worker.terminate(),this.m_Worker=null,s(new Error("no data"))},this.m_Worker.onmessage=function(t){const n=t.data;switch(n.operation){case"BUILD_GRAPH":case"CONCAVEMAN":case"MARK_ALL_CYCLES":e(n);break;default:i(`unknown params.operation = ${n.operation}`),s(new Error(`unknown params.operation = ${n.operation}`))}},t&&t(this.m_Worker)}))}async OnTestBuildCurrentGraph(t){t.preventDefault();const i=await this.RunAIWorker((t=>{const e=Array.from(this.m_Points.store.entries()).map((([t,e])=>({key:t,value:e.Serialize()}))),i=this.m_Lines.store.map((t=>t.Serialize()));t.postMessage({operation:"BUILD_GRAPH",boardSize:this.m_BoardSize,state:this.GetGameStateForIndexedDb(),points:e,paths:i})}));e("Message received from worker "+i)}async OnTestConcaveman(t){t.preventDefault();const i=await this.RunAIWorker((t=>{const e=Array.from(this.m_Points.store.entries()).map((([t,e])=>({key:t,value:e.Serialize()})));t.postMessage({operation:"CONCAVEMAN",boardSize:this.m_BoardSize,state:this.GetGameStateForIndexedDb(),points:e})}));if(i.convex_hull&&i.convex_hull.length>0){const t=i.convex_hull;this.SvgVml.CreatePolyline(2*this.m_LineStrokeWidth,t.map((([t,e])=>parseInt(t)+","+parseInt(e))).join(" "),"green"),e(`convex_hull = ${t}`);const s=i.cw_sorted_verts,n=C();for(const t of s){const{x:e,y:i}=t,s=e,o=i,r=document.querySelector(`svg > circle[cx="${s}"][cy="${o}"]`);r&&(r.SetStrokeColor(n),r.SetFillColor(n),r.SetZIndex(100),r.setAttribute("r",6/this.m_iGridSpacingX)),await a(50)}}}async OnTestMarkAllCycles(t){t.preventDefault();const i=await this.RunAIWorker((t=>{const e=Array.from(this.m_Points.store.entries()).map((([t,e])=>({key:t,value:e.Serialize()}))),i=this.m_Lines.store.map((t=>t.Serialize()));t.postMessage({operation:"MARK_ALL_CYCLES",boardSize:this.m_BoardSize,state:this.GetGameStateForIndexedDb(),points:e,paths:i,colorRed:this.COLOR_RED,colorBlue:this.COLOR_BLUE})}));if(i.cycles&&i.free_human_player_points&&i.free_human_player_points.length>0){const t=[];for(const e of i.free_human_player_points){const{x:i,y:s}=e,n=i,o=s;document.querySelector(`svg > circle[cx="${n}"][cy="${o}"]`)&&t.push({x:i,y:s})}const s=[];for(let n=0;n<=i.cyclenumber;n++){const r=i.cycles[n];if(r&&r.cycl&&r.cycl.length>0&&r.cw_sorted_verts){let i=`Cycle Number ${n}: `,l=[];const h="var(--bs-indigo)",c=r.cw_sorted_verts;for(const t of c){const{x:e,y:s}=t,n=document.querySelector(`svg > circle[cx="${e}"][cy="${s}"]`);n&&(i+=`(${e},${s})`,n.SetStrokeColor(h),n.SetFillColor(h),n.setAttribute("r",6/this.m_iGridSpacingX)),await a(50)}let m="",_="";for(const e of t)if(!1!==o(c,e.x,e.y)){m+=`${_}(${e.x},${e.y})`;const t=document.querySelector(`svg > circle[cx="${e.x}"][cy="${e.y}"]`);t&&(t.SetStrokeColor("var(--bs-yellow)"),t.SetFillColor("var(--bs-yellow)"),t.setAttribute("r",6/this.m_iGridSpacingX)),_=","}l.unshift(i),s.push(l),e(i+(""!==m?` possible intercepts: ${m}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${h}"][r="${2*this.m_LineStrokeWidth}"]`)).forEach((t=>{t.SetStrokeColor(this.COLOR_BLUE),t.SetFillColor(this.COLOR_BLUE),t.setAttribute("r",6/this.m_iGridSpacingX)}))}}}}async OnTestGroupPoints(t){t.preventDefault();const i=await this.m_Points.get(this.m_iMouseY*this.m_iGridWidth+this.m_iMouseX);await this.GroupPointsRecurse([],i),this.workingCyclePolyLine&&(this.SvgVml.RemovePolyline(this.workingCyclePolyLine),this.workingCyclePolyLine=null),this.lastCycle.forEach((t=>{this.SvgVml.CreatePolyline(2*this.m_LineStrokeWidth,t.map((function(t){const e=t.GetPosition();return`${e.x},${e.y}`})).join(" "),C())})),e("game.lastCycle = ",this.lastCycle),this.lastCycle=[]}async OnTestFindSurroundablePoints(t){t.preventDefault();const e=this.COLOR_RED,i=C();for(const t of await this.m_Points.values())if(void 0!==t&&t.GetFillColor()===e&&s.POINT_FREE_RED===t.GetStatus()){const{x:e,y:s}=t.GetPosition(),n=parseInt(e),o=parseInt(s);if(!1===await this.IsPointOutsideAllPaths(n,o))continue;const r=document.querySelector(`svg > circle[cx="${e}"][cy="${s}"]`);r&&(r.SetStrokeColor(i),r.SetFillColor(i),r.setAttribute("r",6/this.m_iGridSpacingX))}}async OnTestWorkerify(t){t.preventDefault()}async PrepareDrawing(e,i,s,n,o,r,a,l,h,c,m,_,d,u,S=125){if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=S,this.m_Timer=null,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(i),this.m_GameStatus=document.querySelector(s),this.m_SurrenderButton=document.querySelector(n),this.m_CancelPath=document.querySelector(o),this.m_StopAndDraw=document.querySelector(a),this.m_sMsgInputSel=l,this.m_sMsgListSel=h,this.m_sMsgSendButtonSel=c,this.m_Screen=document.querySelector(e),!this.m_Screen)return void alert("no board");this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop;const P=[...this.m_Screen.classList].find((t=>t.startsWith("boardsize"))).split("-")[1].split("x");this.m_BoardSize={logicalWidth:parseInt(P[0]),logicalHeight:parseInt(P[1])};let g=this.m_Screen.clientWidth,y=this.m_Screen.clientHeight,p=null;y<=0&&(y=16*this.m_BoardSize.logicalHeight,this.m_Screen.style.height=y+"px",p="100%"),this.m_iGridSpacingX=Math.ceil(g/this.m_BoardSize.logicalWidth),this.m_iGridSpacingY=Math.ceil(y/this.m_BoardSize.logicalHeight),this.m_iGridWidth=this.m_BoardSize.logicalWidth,this.m_iGridHeight=this.m_BoardSize.logicalHeight,this.m_PointRadius=4/this.m_iGridSpacingX,this.m_LineStrokeWidth=3/this.m_iGridSpacingX,this.m_sLastMoveGameTimeStamp=m,this.m_sVersion=d,this.rAF_StartTimestamp=null,this.rAF_FrameID=null,this.lastCycle=[],this.SvgVml=new t.SvgVml,null===this.SvgVml.CreateSVGVML(this.m_Screen,p,p,!0,this.m_BoardSize)&&alert("SVG is not supported!"),this.DisableSelection(this.m_Screen);const w=new t.GameStateStore(_,this.CreateScreenPointFromIndexedDb.bind(this),this.CreateScreenPathFromIndexedDb.bind(this),this.GetGameStateForIndexedDb.bind(this),this.m_sVersion);if(this.m_Lines=w.GetPathStore(),this.m_Points=w.GetPointStore(),this.m_bPointsAndPathsLoaded=await w.PrepareStore(),!1===this.m_bViewOnly){if(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=this.SvgVml.CreateOval(this.m_PointRadius),this.m_MouseCursorOval.SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.SetStrokeColor(this.m_sDotColor),this.m_MouseCursorOval.SetZIndex(-1),this.m_MouseCursorOval.Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),this.m_StopAndDraw.onclick=this.OnStopAndDraw.bind(this),!1===this.m_bIsCPUGame)document.querySelector(this.m_sMsgInputSel).disabled="",document.getElementById("testArea").textContent="";else{let t=0;u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestBuildCurrentGraph.bind(this)),u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestConcaveman.bind(this)),u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestMarkAllCycles.bind(this)),u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestGroupPoints.bind(this)),u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestFindSurroundablePoints.bind(this)),u.length>t&&(document.querySelector(u[t++]).onclick=this.OnTestWorkerify.bind(this))}this.m_SurrenderButton.disabled="","???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_StopAndDraw.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"),this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line")}else document.querySelector(r).innerHTML="back to Game List"}GetRandomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}async FindRandomCPUPoint(){let t,e,i=100;for(;--i>0&&(t=this.GetRandomInt(0,this.m_iGridWidth),e=this.GetRandomInt(0,this.m_iGridHeight),await this.m_Points.has(e*this.m_iGridWidth+t)||!await this.IsPointOutsideAllPaths(t,e)););return new _(0,this.g_iGameID,-1,t,e,s.POINT_FREE_BLUE,0)}async CalculateCPUCentroid(){let t,e,i=0,n=0,o=0;const r=this.COLOR_RED;for(const a of await this.m_Points.values())if(void 0!==a&&a.GetFillColor()===r&&a.GetStatus()===s.POINT_FREE_RED){const s=a.GetPosition();t=parseInt(s.x),e=parseInt(s.y),i+=t,n+=e,o++}if(o<=0)return null;t=i/o,e=n/o;const a=parseInt(t),l=parseInt(e);t=a,e=l;let h=20;for(;--h>0&&(this.m_Points.has(e*this.m_iGridWidth+t)||!await this.IsPointOutsideAllPaths(t,e));)t=this.GetRandomInt(a-2,a+3),e=this.GetRandomInt(l-2,l+3);if(h<=0)return null;return new _(0,this.g_iGameID,-1,t,e,s.POINT_FREE_BLUE,0)}IsGraphCyclic(t){const i=t.vertices,s=function(t,i){t.visited=!0;for(let n of t.adjacents)if(n.visited){if(n!==i){const{x:t,y:i}=n.GetPosition(),s=parseInt(t),o=parseInt(i);return e(`cycle found at ${s},${o}`),!0}}else if(s(n,t))return!0;return!1}.bind(this);for(let t=0;t<i.length;t++)i[t].visited=!1;for(let t=0;t<i.length;t++)if(!i[t].visited&&s(i[t],-1))return!0;return!1}async MarkAllCycles(t){const i=t.vertices,n=i.length;let l=new Array(n);const h=new Array(n),c=new Array(n),m=new Array(n);for(let t=0;t<n;t++)h[t]=[],l[t]=[];const _=async function(t,e){if(2===c[t])return;if(1===c[t]){u++;let i=e;for(h[i].push(u);i!==t;)i=m[i],h[i].push(u);return}m[t]=e,c[t]=1;const s=i[t];if(s){s.SetStrokeColor("black"),s.SetFillColor("black"),await a(10);for(const e of s.adjacents){const s=i.indexOf(e);s!==m[t]&&await _(s,t)}}c[t]=2},d=async function(t,n){for(let e=0;e<t;e++){const t=n[e];if(void 0!==t&&t.length>0)for(let i=0;i<t.length;i++){const s=l[t[i]];void 0!==s&&s.push(e)}}l=l.filter((t=>t.length>=4)).sort(((t,e)=>e.length-t.length));const h=[],c=this.COLOR_RED;for(const t of await this.m_Points.values())if(void 0!==t&&t.GetFillColor()===c&&s.POINT_FREE_RED===t.GetStatus()){const{x:e,y:i}=t.GetPosition(),s=parseInt(e),n=parseInt(i);if(!1===await this.IsPointOutsideAllPaths(s,n))continue;document.querySelector(`svg > circle[cx="${e}"][cy="${i}"]`)&&h.push({x:s,y:n})}const m=[];for(let t=0;t<=u;t++){const s=l[t];if(s&&s.length>0){let n=`Cycle Number ${t}: `,l=[];const c="var(--bs-indigo)",_=s.map(function(t){const e=i[t].GetPosition();return{x:parseInt(e.x),y:parseInt(e.y)}}.bind(this)),d=r(_);for(const t of d){const{x:e,y:i}=t,s=document.querySelector(`svg > circle[cx="${e}"][cy="${i}"]`);s&&(n+=`(${e},${i})`,s.SetStrokeColor(c),s.SetFillColor(c),s.setAttribute("r",6/this.m_iGridSpacingX)),await a(50)}let u="",S="";for(const t of h)if(!1!==o(d,t.x,t.y)){u+=`${S}(${t.x},${t.y})`;const e=document.querySelector(`svg > circle[cx="${t.x}"][cy="${t.y}"]`);e&&(e.SetStrokeColor("var(--bs-yellow)"),e.SetFillColor("var(--bs-yellow)"),e.setAttribute("r",6/this.m_iGridSpacingX)),S=","}l.unshift(n),m.push(l),e(n+(""!==u?` possible intercepts: ${u}`:""));Array.from(document.querySelectorAll(`svg > circle[fill="${c}"][r="${6/this.m_iGridSpacingX}"]`)).forEach((t=>{t.SetStrokeColor(this.COLOR_BLUE),t.SetFillColor(this.COLOR_BLUE),t.setAttribute("r",6/this.m_iGridSpacingX)}))}}return m}.bind(this);let u=0,S=n;for(let t=0;t<n;t++)await _(t+1,t);return await d(S,h)}async GroupPointsRecurse(t,e){if(void 0===e||t.includes(e)||t.length>60||this.lastCycle.length>3)return t;if(!1===[s.POINT_FREE_BLUE,s.POINT_STARTING,s.POINT_IN_PATH].includes(e.GetStatus())||e.GetFillColor()!==this.COLOR_BLUE)return t;let{x:i,y:n}=e.GetPosition();i=parseInt(i),n=parseInt(n);let o,r,l=null;if(t.length>0){l=t[t.length-1];const s=l.GetPosition();if(o=parseInt(s.x),r=parseInt(s.y),!(Math.abs(parseInt(o-i))<=1&&Math.abs(parseInt(r-n))<=1))return t;t.push(e)}else t.push(e);if(t.length>2&&null!==l){const e=t[0].GetPosition();e.x=parseInt(e.x),e.y=parseInt(e.y),l=t[t.length-1];const i=l.GetPosition();if(o=parseInt(i.x),r=parseInt(i.y),Math.abs(parseInt(o-e.x))<=1&&Math.abs(parseInt(r-e.y))<=1&&t.length>=4){const e=t.slice();e.push(t[0]),this.lastCycle.push(e)}}const[h,c,m,_,d,u,S,P]=await Promise.all([this.m_Points.get(n*this.m_iGridWidth+i+1),this.m_Points.get(n*this.m_iGridWidth+i-1),this.m_Points.get((n-1)*this.m_iGridWidth+i),this.m_Points.get((n+1)*this.m_iGridWidth+i),this.m_Points.get((n-1)*this.m_iGridWidth+i-1),this.m_Points.get((n-1)*this.m_iGridWidth+i+1),this.m_Points.get((n+1)*this.m_iGridWidth+i-1),this.m_Points.get((n+1)*this.m_iGridWidth+i+1)]);h&&await this.GroupPointsRecurse(t,h),c&&await this.GroupPointsRecurse(t,c),m&&await this.GroupPointsRecurse(t,m),_&&await this.GroupPointsRecurse(t,_),d&&await this.GroupPointsRecurse(t,d),u&&await this.GroupPointsRecurse(t,u),S&&await this.GroupPointsRecurse(t,S),P&&await this.GroupPointsRecurse(t,P);const g=t.lastIndexOf(e);if(-1!==g){t.splice(g);const e=t.map((function(t){const e=t.GetPosition();return`${e.x},${e.y}`})).join(" ");this.workingCyclePolyLine?this.workingCyclePolyLine.SetPoints(e):this.workingCyclePolyLine=this.SvgVml.CreatePolyline(2*this.m_LineStrokeWidth,e,"black"),await a(50)}return t}async GroupPointsIterative({g:t=null}={}){if(!t)return;const e=t.vertices,i=[];let s;for(const t of e){s=t;const e=[];(await this.GroupPointsRecurse(e,s)).length>0&&this.lastCycle.length>0&&(i.push(this.lastCycle),this.lastCycle=[])}return i}async rAFCallBack(t){null===this.rAF_StartTimestamp&&(this.rAF_StartTimestamp=t);const e=t-this.rAF_StartTimestamp;let i=null;const s=await this.CalculateCPUCentroid();i=null!==s?s:await this.FindRandomCPUPoint(),null===i?e<2e3&&(this.rAF_FrameID=window.requestAnimationFrame(this.rAFCallBack.bind(this))):await this.SendAsyncData(i,(()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1}))}StartCPUCalculation(){null===this.rAF_FrameID&&(this.rAF_FrameID=window.requestAnimationFrame(this.rAFCallBack.bind(this)))}}window.addEventListener("load",(async function(){const l=void 0!==window.msgpack5,h=window.gameOptions,c=h.inkBallHubName,m=h.iGameID;document.getElementById("gameID").innerHTML=m,document.querySelector(".container.inkgame form > input[type='hidden'][name='GameID']").value=m;const _=h.iPlayerID,d=parseInt(document.querySelector(".msgchat").dataset.otherplayerid)||null;document.getElementById("playerID").innerHTML=_;const u=h.bPlayingWithRed,S=h.bPlayerActive,P=h.gameType,g=l&&!0===h.isMessagePackProtocol?new signalR.protocols.msgpack.MessagePackHubProtocol:new signalR.JsonHubProtocol,y=h.servTimeoutMillis,p=h.isReadonly,w=h.pathAfterPointDrawAllowanceSecAmount,I=new Date(h.sLastMoveGameTimeStamp).toISOString(),C=h.version;await async function(){const l=-1!==Array.prototype.slice.call(document.getElementsByTagName("script")).map((t=>t.src)).find((t=>-1!==t.indexOf("inkball"))).split("/").pop().indexOf("min");t=l?await import("./shared.min.js"):await import("./shared.js"),e=t.LocalLog,i=t.LocalError,s=t.StatusEnum,n=t.hasDuplicates,o=t.pnpoly2,r=t.sortPointsClockwise,a=t.Sleep}();const O=new L(m,_,d,c,signalR.LogLevel.Warning,g,signalR.HttpTransportType.None,y,P,u,S,p,w);await O.PrepareDrawing("#screen","#Player2Name","#gameStatus","#SurrenderButton","#CancelPath","#Pause","#StopAndDraw","#messageInput","#messagesList","#sendButton",I,null===h.PointsAsJavaScriptArray,C,["#TestBuildGraph","#TestConcaveman","#TestMarkAllCycles","#TestGroupPoints","#TestFindSurroundablePoints","#TestWorkerify"]),null!==h.PointsAsJavaScriptArray?(await O.StartSignalRConnection(!1),await O.SetAllPoints(h.PointsAsJavaScriptArray),await O.SetAllPaths(h.PathsAsJavaScriptArray)):await O.StartSignalRConnection(!0),document.getElementsByClassName("whichColor")[0].style.color=u?"red":"blue",O.CountPointsDebug("#debug2"),delete window.gameOptions,window.game=O})),window.addEventListener("beforeunload",(function(){window.game&&window.game.StopSignalRConnection()}));
//# sourceMappingURL=inkball.min.js.map
