"use strict";const StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4});class InkBallPointViewModel{constructor(a=0,b=0,c=0,d=0,e=0,f=StatusEnum.POINT_FREE,g=0){this.iId=a,this.iGameId=b,this.iPlayerId=c,this.iX=d,this.iY=e,this.Status=f,this.iEnclosingPathId=g}static Format(a,b){let c=b.iX+" "+b.iY+" "+b.Status;return a+" places ["+c+"] point"}}class InkBallPathViewModel{constructor(a=0,b=0,c=0,d="",e=""){this.iId=a,this.iGameId=b,this.iPlayerId=c,this.sPointsAsString=d,this.sOwnedPointsAsString=e}static Format(a,b){let c=b.iPlayerID+" "+b.sPointsAsString+" "+b.sOwnedPointsAsString;return a+" places ["+c+"] path"}}class WaitForPlayerCommand{get ShowP2Name(){return this.showP2Name}set ShowP2Name(a){this.showP2Name=a}constructor(a=!1){this.ShowP2Name=a}}class PlayerJoiningCommand{get OtherPlayerId(){return this.otherPlayerId}get OtherPlayerName(){return this.otherPlayerName}get Message(){return this.message}constructor(a,b,c){this.otherPlayerId=a,this.otherPlayerName=b,this.message=c}static Format(a){return a.Message}}class PlayerSurrenderingCommand{get OtherPlayerId(){return this.otherPlayerId}get ThisOrOtherPlayerSurrenders(){return this.thisOrOtherPlayerSurrenders}get Message(){return this.message}constructor(a,b,c){this.otherPlayerId=a,this.thisOrOtherPlayerSurrenders=b,this.message=c}static Format(a){return a.Message}}class PingCommand{get Message(){return this.message}set Message(a){this.message=a}constructor(a=""){this.Message=a}static Format(a,b){let c=b.Message;return a+" says "+c}}function htmlEncode(a){return document.createElement("a").appendChild(document.createTextNode(a)).parentNode.innerHTML}function CountPointsDebug(a,b="svg"){let c=$(b),d=0,e=[];for(let f,g=0;g<c.length;g++)f=c[g],d+=f.childElementCount,e.push(f.childElementCount);let f="";["circle","path"].forEach(a=>{f+=a+": "+$(a).length+" "}),$(a).text("SVG elements - totalChildren:"+d+" SVG childElements:"+e+" by tag:"+f)}class InkBallGame{constructor(a,b,c,d,e,f=!0,g=!0,h=15,j=125,k=!1){this.g_iGameID=null,this.g_iPlayerID=null,this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="pink",this.COLOR_OWNED_BLUE="#8A2BE2",this.POINT_FREE_RED=-3,this.POINT_FREE_BLUE=-2,this.POINT_FREE=-1,this.POINT_STARTING=0,this.POINT_IN_PATH=1,this.POINT_OWNED_BY_RED=2,this.POINT_OWNED_BY_BLUE=3,this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=j,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridSize=h,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_iClientWidth=0,this.m_iClientHeight=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=f,this.m_bIsPlayerActive=g,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_bViewOnly=k,this.m_MouseCursorOval=null;null===a||""===a||(this.g_SignalRConnection=new signalR.HubConnectionBuilder().withUrl(a,{transport:d,accessTokenFactory:e}).withHubProtocol(c).configureLogging(b).build(),this.g_SignalRConnection.onclose(async a=>{null!==a&&a!==void 0&&(console.log(a),this.m_Screen.style.cursor="not-allowed",5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(()=>this.start(),4e3+this.iExponentialBackOffMillis*this.iConnErrCount))}))}async start(){try{await this.g_SignalRConnection.start(),this.iConnErrCount=0,console.log("connected; iConnErrCount = "+this.iConnErrCount)}catch(a){console.log(a+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",5>this.iConnErrCount&&this.iConnErrCount++,setTimeout(()=>this.start(),4e3+this.iExponentialBackOffMillis*this.iConnErrCount)}}StartSignalRConnection(a,b,c,d,e){null===this.g_SignalRConnection||(this.g_iGameID=a,this.g_iPlayerID=b,this.g_SignalRConnection.on("ServerToClientPoint",function(a,b){let d=InkBallPointViewModel.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e),this.ReceivedPointProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(a,b){let d=InkBallPathViewModel.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e),this.ReceivedPathProcessing(a)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(a){let b=PlayerJoiningCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.m_Player2Name.innerHTML=a.OtherPlayerName,this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(a){let b=PlayerSurrenderingCommand.Format(a),d=document.createElement("li");d.textContent=b,document.querySelector(c).appendChild(d),this.m_bHandlingEvent=!1,alert(""==b?"Game interrupted!":b),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(a,b){let d=PingCommand.Format(b,a),e=document.createElement("li");e.textContent=d,document.querySelector(c).appendChild(e)}.bind(this)),document.querySelector(d).addEventListener("click",function(a){let b=document.querySelector(e).value,c=new PingCommand(b);this.g_SignalRConnection.invoke("ClientToServerPing",c).catch(function(a){return console.error(a.toString())}),a.preventDefault()}.bind(this),!1),document.querySelector(e).addEventListener("keyup",function(a){a.preventDefault(),13===a.keyCode&&document.querySelector(d).click()}.bind(this),!1),this.start())}StopSignalRConnection(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),console.log("Stopped SignalR connection"))}Debug(...a){switch(a.length){case 1:this.m_Debug.innerHTML=a[0];break;case 2:let b=document.getElementById("debug"+a[1]);b.innerHTML=a[0];break;default:}}SetTimer(a){if(!1==a)!0==this.m_bIsTimerRunning&&clearInterval(this.m_iTimerID),this.m_bIsTimerRunning=!1;else{!0==this.m_bIsTimerRunning?clearInterval(this.m_iTimerID):this.m_WaitStartTime=new Date;let a=this.m_iTimerInterval*(1+.5*this.m_iSlowdownLevel);this.m_iTimerID=setInterval(this.GameLoop,a),this.m_bIsTimerRunning=!0}}DisableSelection(a){"undefined"==typeof a.onselectstart?"undefined"==typeof a.style.MozUserSelect?a.onmousedown=function(){return!1}:a.style.MozUserSelect="none":a.onselectstart=function(){return!1},a.style.cursor="default"}f_clientWidth(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}f_clientHeight(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}f_scrollLeft(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}f_scrollTop(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}f_filterResults(a,b,c){let d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}SetPoint(a,b,c){let d=a*this.m_iGridSize,e=b*this.m_iGridSize,f=$createOval(this.m_PointRadius,"true");f.$move(d,e,this.m_PointRadius);let g;switch(c){case this.POINT_FREE_RED:case StatusEnum.POINT_FREE_RED:g=this.COLOR_RED,f.$SetStatus(this.POINT_FREE);break;case this.POINT_FREE_BLUE:case StatusEnum.POINT_FREE_BLUE:g=this.COLOR_BLUE,f.$SetStatus(this.POINT_FREE);break;case this.POINT_FREE:case StatusEnum.POINT_FREE:g=this.m_sDotColor,f.$SetStatus(this.POINT_FREE);break;case this.POINT_STARTING:case StatusEnum.POINT_STARTING:g=this.m_sDotColor,f.$SetStatus(this.POINT_IN_PATH);break;case this.POINT_IN_PATH:case StatusEnum.POINT_IN_PATH:g=this.m_sDotColor,f.$SetStatus(c);break;case this.POINT_OWNED_BY_RED:case StatusEnum.POINT_OWNED_BY_RED:g=this.COLOR_OWNED_RED,f.$SetStatus(c);break;case this.POINT_OWNED_BY_BLUE:case StatusEnum.POINT_OWNED_BY_BLUE:g=this.COLOR_OWNED_BLUE,f.$SetStatus(c);break;default:alert("bad point");}f.$SetFillColor(g),f.$strokeColor(g),this.m_Points[b*this.m_iGridWidth+a]=f}SetAllPoints(a){a.forEach(a=>{this.SetPoint(a[0],a[1],a[2])})}SetPath(a,b,c){a=a.split(" ");let d,e,f=a.length,g="",h="",j=null;for(let k=0;k<f;++k)j=a[k].split(","),d=parseInt(j[0]),e=parseInt(j[1]),d*=this.m_iGridSize,e*=this.m_iGridSize,h=h+g+d+","+e,g=" ",j=this.m_Points[e*this.m_iGridWidth+d],null!=j&&j.$SetStatus(this.POINT_IN_PATH);j=a[0].split(","),d=parseInt(j[0]),e=parseInt(j[1]),d*=this.m_iGridSize,e*=this.m_iGridSize,h=h+g+d+","+e,j=this.m_Points[e*this.m_iGridWidth+d],null!=j&&j.$SetStatus(this.POINT_IN_PATH);let k=$createPolyline(3,h,c?this.m_sDotColor:b?this.COLOR_BLUE:this.COLOR_RED);this.m_Lines[this.m_Lines.length]=k}SetAllPaths(a){a.forEach(a=>{this.SetPath(a[0],a[1],a[2])})}IsPointBelongingToLine(a,b,c){let d,e,f,g=a.length;for(let h=0;h<g;++h)if(f=a[h].split(","),d=f[0],e=f[1],d==b&&e==c)return!0;return!1}pnpoly(a,b,d,e,f){let g,h,k=0;for(g=0,h=a-1;g<a;h=g++)(d[g]<=f&&f<d[h]||d[h]<=f&&f<d[g])&&e<(b[h]-b[g])*(f-d[g])/(d[h]-d[g])+b[g]&&(k=!k);return k}SurroundOponentPoints(){let a,b=this.m_Line.$GetPoints();a=b.length;let c,d,e=[],f=[],g="",h="",j=0;for(let k=0;k<a;k+=2)c=b[k],d=b[k+1],null==c||null==d||(c/=this.m_iGridSize,d/=this.m_iGridSize,e[j]=c,f[j]=d,g=g+h+c+","+d,h=" ",++j);if(e[0]!=e[e.length-1]||f[0]!=f[f.length-1])return{owned:"",path:""};let l=this.m_Points.length,m=this.m_sDotColor==this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,n=this.m_sDotColor==this.COLOR_RED?this.POINT_OWNED_BY_RED:this.POINT_OWNED_BY_BLUE,o=this.m_sDotColor==this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE,p="";h="";for(let b,g=0;g<l;++g)if(b=this.m_Points[g],null!=b&&b.$GetStatus()==this.POINT_FREE&&b.$GetFillColor()==m){let g=b.$GetPosition();c=g.x,d=g.y,c/=this.m_iGridSize,d/=this.m_iGridSize,0!=this.pnpoly(a,e,f,c,d)&&(b.$SetStatus(n),b.$SetFillColor(o),b.$strokeColor(o),p=p+h+c+","+d,h=" ")}return{owned:p,path:g}}IsPointOutsideAllPaths(a,b){let c=this.m_Lines.length;for(let d=0;d<c;++d){let c,e=this.m_Lines[d].$GetPoints();c=e.length;let f,g,h=[],j=[],l=0;for(let a=0;a<c;a+=2)f=e[a],g=e[a+1],null==f||null==g||(f/=this.m_iGridSize,g/=this.m_iGridSize,h[l]=f,j[l]=g,++l);if(0!=this.pnpoly(c,h,j,a,b))return!1}return!0}CreateXMLWaitForPlayerRequest(...a){let b=new WaitForPlayerCommand(!!(0<a.length&&!0==a[0]));return b}CreateXMLPutPointRequest(a,b){let c=new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,a,b,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0);return c}CreateXMLPutPathRequest(a){let b=new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,a.path,a.owned);return b}SendAsyncData(a){switch(a.constructor.name){case"InkBallPointViewModel":this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",a).then(function(a){this.ReceivedPointProcessing(a)}.bind(this)).catch(function(a){return console.error(a.toString())});break;case"InkBallPathViewModel":this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",a).then(function(a){this.ReceivedPathProcessing(a)}.bind(this)).catch(function(a){return console.error(a.toString())});break;default:console.log("unknown object");}}AjaxResponseCallBack(){if(null!=g_XmlHttp&&(4==g_XmlHttp.readyState||"complete"==g_XmlHttp.readyState)&&200==g_XmlHttp.status){let a=g_XmlHttp.responseXML,b=a.firstChild;1!=b.nodeType&&(b=b.nextSibling);let c=b.nodeName;switch(c){case"WaitForPlayer":let a=0<b.getElementsByTagName("P2Name").length?b.getElementsByTagName("P2Name")[0].firstChild.data:"",d=!("true"!=b.getElementsByTagName("Active")[0].firstChild.data);if(d){""!=a&&(this.m_Player2Name.innerHTML=a,this.m_SurrenderButton.value="surrender"),"win"==this.m_SurrenderButton.value&&(this.m_SurrenderButton.value="surrender");let c=b.getElementsByTagName("LastMove")[0];switch(c=c.firstChild,c.nodeName){case"Point":let a=parseInt(c.getAttribute("x")),d=parseInt(c.getAttribute("y")),e=parseInt(c.getAttribute("status"));this.SetPoint(a,d,e),this.m_bIsPlayerActive=!0,this.SetTimer(!1),this.ShowMobileStatus("Oponent has moved, your turn");break;case"Path":let f=c.firstChild.data,g=b.getElementsByTagName("Owned")[0].firstChild.data;this.SetPath(f,this.m_sDotColor==this.COLOR_RED,!1);let h=g.split(" "),j=h.length,k=null,l=this.m_sDotColor==this.COLOR_RED?this.POINT_OWNED_BY_RED:this.POINT_OWNED_BY_BLUE,m=this.m_sDotColor==this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED;for(let b=0;b<j;++b)k=h[b].split(","),a=parseInt(k[0]),d=parseInt(k[1]),k=this.m_Points[d*this.m_iGridWidth+a],null!=k&&(k.$SetStatus(l),k.$SetFillColor(m),k.$strokeColor(m));this.m_bIsPlayerActive=!0,this.SetTimer(!1),this.ShowMobileStatus("Oponent has moved, your turn");break;default:}}else this.m_sMessage="Waiting for oponent move",""!=a&&(this.m_Player2Name.innerHTML=a,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus());break;case"PutPoint":this.m_bIsPlayerActive=!1,this.m_iSlowdownLevel=0,this.SetTimer(!0);break;case"PutPath":let e=this.m_Line.$GetPoints(),f=e[i],g=e[i+1];f/=this.m_iGridSize,g/=this.m_iGridSize;let h=this.m_Points[g*this.m_iGridWidth+f];null!=h&&h.$SetStatus(this.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.m_iSlowdownLevel=0,this.SetTimer(!0);break;case"InterruptGame":this.SetTimer(!1);let j=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"";""==j?alert("Game interrupted!"):alert(j),window.location.href="Games";break;case"WaitingForSecondPlayer":this.m_sMessage="Waiting for other player to connect";break;case"Err":j=0<b.getElementsByTagName("msg").length?b.getElementsByTagName("msg")[0].firstChild.data:"unknown error",alert(j),this.OnCancelClick();break;default:}}}ReceivedPointProcessing(a){let b=a.iX,c=a.iY,d=a.Status;this.SetPoint(b,c,d),this.g_iPlayerID==a.iPlayerId?(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"):(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair"),this.m_bHandlingEvent=!1}ReceivedPathProcessing(a){if(this.g_iPlayerID!=a.iPlayerId){let b=a.sPointsAsString,c=a.sOwnedPointsAsString;this.SetPath(b,!(this.m_sDotColor!=this.COLOR_RED),!1);let d=c.split(" "),e=d.length,f=this.m_sDotColor==this.COLOR_RED?this.POINT_OWNED_BY_RED:this.POINT_OWNED_BY_BLUE,g=this.m_sDotColor==this.COLOR_RED?this.COLOR_OWNED_BLUE:this.COLOR_OWNED_RED;for(let a=0;a<e;++a){let b=d[a].split(","),c=parseInt(b[0]),e=parseInt(b[1]);b=this.m_Points[e*this.m_iGridWidth+c],null!=b&&(b.$SetStatus(f),b.$SetFillColor(g),b.$strokeColor(g))}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair"}else{let a=this.m_Line.$GetPoints(),b=0,c=a[b],d=a[b+1];c/=this.m_iGridSize,d/=this.m_iGridSize;let e=this.m_Points[d*this.m_iGridWidth+c];null!=e&&e.$SetStatus(this.POINT_IN_PATH),this.m_Lines[this.m_Lines.length]=this.m_Line,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"}this.m_bHandlingEvent=!1}GameLoop(){let a=!("???"!=this.m_Player2Name.innerHTML);this.SendAsyncData(this.CreateXMLWaitForPlayerRequest(a));let b=parseInt((new Date-this.m_WaitStartTime)/1e3);if(0>=this.m_iSlowdownLevel&&b>=.25*this.m_iTooLong2Duration)this.m_iSlowdownLevel=1,this.SetTimer(!0);else if(1>=this.m_iSlowdownLevel&&b>=.5*this.m_iTooLong2Duration)this.m_iSlowdownLevel=2,this.SetTimer(!0);else if(2>=this.m_iSlowdownLevel&&b>=.75*this.m_iTooLong2Duration)this.m_iSlowdownLevel=4,this.SetTimer(!0);else if(b>=this.m_iTooLong2Duration)if(!a)this.SetTimer(!1),this.m_SurrenderButton.value="win",alert("Second player is not responding for quiet long. To walkover win click win - or continue to wait for oponent move"),this.SetTimer(!0);else if(this.SetTimer(!1),!0==confirm("Second player is still not connecting. Continue waiting?"))this.SetTimer(!0);else return void(window.location.href="Games");this.ShowMobileStatus(this.m_sMessage)}ShowMobileStatus(a){this.m_GameStatus.style.color="???"==this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,null==a?this.Debug("",0):this.Debug(a,0)}OnMouseMove(a){var b=Math.abs;if(!this.m_bIsPlayerActive||"???"==this.m_Player2Name.innerHTML||!0==this.m_bHandlingEvent||0<this.iConnErrCount)return;let c=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSize,d=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSize;null==this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$strokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1)),c=parseInt(c/this.m_iGridSize),d=parseInt(d/this.m_iGridSize);let e=c*this.m_iGridSize,f=d*this.m_iGridSize;if(this.m_MouseCursorOval.$move(e,f,this.m_PointRadius),this.m_Screen.style.cursor="crosshair",this.m_bDrawLines&&!0==this.m_bMouseDown&&(this.m_iLastX!=c||this.m_iLastY!=d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY)if(null!=this.m_Line){let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(null!=a&&null!=b&&b.$GetStatus()!=this.POINT_IN_PATH&&a.$GetFillColor()==this.m_sDotColor&&b.$GetFillColor()==this.m_sDotColor){if(this.m_Line.$AppendPoints(e+","+f),b.$GetStatus()!=this.POINT_STARTING)b.$SetStatus(this.POINT_IN_PATH);else{let a=this.SurroundOponentPoints();0<a.owned.length?(this.m_Line.$SetIsClosed(!0),this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(a))):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(null!=a&&null!=b&&a.$GetStatus()!=this.POINT_IN_PATH&&b.$GetStatus()!=this.POINT_IN_PATH&&a.$GetFillColor()==this.m_sDotColor&&b.$GetFillColor()==this.m_sDotColor){let g=this.m_iLastX*this.m_iGridSize,h=this.m_iLastY*this.m_iGridSize;this.m_Line=$createPolyline(3,g+","+h+" "+e+","+f,this.m_sDotColor),a.$GetStatus()!=this.POINT_IN_PATH&&a.$SetStatus(this.POINT_STARTING),b.$GetStatus()!=this.POINT_IN_PATH&&b.$SetStatus(this.POINT_STARTING),this.m_iLastX=c,this.m_iLastY=d}}}OnMouseDown(a){var b=Math.abs;if(!this.m_bIsPlayerActive||"???"==this.m_Player2Name.innerHTML||!0==this.m_bHandlingEvent||0<this.iConnErrCount)return;let c=(a?a.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSize,d=(a?a.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSize;if(c=this.m_iMouseX=parseInt(c/this.m_iGridSize),d=this.m_iMouseY=parseInt(d/this.m_iGridSize),this.m_bMouseDown=!0,!this.m_bDrawLines){this.m_iLastX=c,this.m_iLastY=d;let a=c,b=d;if(c=a*this.m_iGridSize,d=b*this.m_iGridSize,null!=this.m_Points[b*this.m_iGridWidth+a])return;if(!this.IsPointOutsideAllPaths(a,b))return;this.SendAsyncData(this.CreateXMLPutPointRequest(a,b))}else if((this.m_iLastX!=c||this.m_iLastY!=d)&&1>=b(parseInt(this.m_iLastX-c))&&1>=b(parseInt(this.m_iLastY-d))&&0<=this.m_iLastX&&0<=this.m_iLastY){if(null!=this.m_Line){let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(null!=a&&null!=b&&b.$GetStatus()!=this.POINT_IN_PATH&&a.$GetFillColor()==this.m_sDotColor&&b.$GetFillColor()==this.m_sDotColor){let a=c*this.m_iGridSize,e=d*this.m_iGridSize;if(this.m_Line.$AppendPoints(a+","+e),b.$GetStatus()!=this.POINT_STARTING)b.$SetStatus(this.POINT_IN_PATH);else{let a=this.SurroundOponentPoints();0<a.owned.length?(this.m_Line.$SetIsClosed(!0),this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(a))):this.Debug("Wrong path, cancell it or refresh page",0)}this.m_iLastX=c,this.m_iLastY=d}}else{let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=this.m_Points[d*this.m_iGridWidth+c];if(null!=a&&null!=b&&a.$GetStatus()!=this.POINT_IN_PATH&&b.$GetStatus()!=this.POINT_IN_PATH&&a.$GetFillColor()==this.m_sDotColor&&b.$GetFillColor()==this.m_sDotColor){let e=this.m_iLastX*this.m_iGridSize,f=this.m_iLastY*this.m_iGridSize,g=c*this.m_iGridSize,h=d*this.m_iGridSize;this.m_Line=$createPolyline(3,e+","+f+" "+g+","+h,this.m_sDotColor),a.$GetStatus()!=this.POINT_IN_PATH&&a.$SetStatus(this.POINT_STARTING),b.$GetStatus()!=this.POINT_IN_PATH&&b.$SetStatus(this.POINT_STARTING)}this.m_iLastX=c,this.m_iLastY=d}}else if(0>this.m_iLastX||0>this.m_iLastY){let a=this.m_Points[d*this.m_iGridWidth+c];null!=a&&a.$GetStatus()==this.POINT_FREE&&a.$GetFillColor()==this.m_sDotColor&&(this.m_iLastX=c,this.m_iLastY=d)}}OnMouseUp(){this.m_bMouseDown=!1}OnDrawModeClick(){this.m_bDrawLines=!this.m_bDrawLines;let a=document.getElementById("DrawMode");a.value=this.m_bDrawLines?"Draw dots":"Draw lines",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}OnCancelClick(){if(this.m_bDrawLines){if(null!=this.m_Line){let a=this.m_Line.$GetPoints();for(let b=0;b<a.length;b+=2){let c=a[b],d=a[b+1];if(null==c||null==d)continue;c/=this.m_iGridSize,d/=this.m_iGridSize;let e=this.m_Points[d*this.m_iGridWidth+c];null!=e&&e.$SetStatus(this.POINT_FREE)}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1}}OnTestClick(){if(!this.m_bDrawLines){let a=this.m_Points[this.m_iLastY*this.m_iGridWidth+this.m_iLastX],b=a.$GetPosition();this.Debug(`${a.$GetFillColor()} posX = ${b.x} posY = ${b.y}`,1)}else if(null!=this.m_Line){let a=this.SurroundOponentPoints();0<a.owned.length&&(this.m_iLastX=this.m_iLastY=-1,this.m_Line=null)}}PrepareDrawing(a,b,c,d=125){if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTimerInterval=2e3,this.m_iTooLong2Duration=d,this.m_iTimerID=null,this.m_bIsTimerRunning=!1,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_iClientWidth=0,this.m_iClientHeight=0,this.m_Debug=null,this.m_SurrenderButton=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=[],this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(b),this.m_GameStatus=document.querySelector(c),this.m_SurrenderButton=document.getElementById("SurrenderButton"),this.m_Screen=document.querySelector(a),!this.m_Screen)return void alert("no board");if(this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop,this.m_iClientWidth=this.m_Screen.clientWidth,this.m_iClientHeight=this.m_Screen.clientHeight,this.m_iGridWidth=parseInt(this.m_iClientWidth/this.m_iGridSize),this.m_iGridHeight=parseInt(this.m_iClientHeight/this.m_iGridSize),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),!this.m_bViewOnly){this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this);let a=document.getElementById("DrawMode");a.onclick=this.OnDrawModeClick.bind(this),a=document.getElementById("Cancel"),a.onclick=this.OnCancelClick.bind(this),this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair"):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait")}}}