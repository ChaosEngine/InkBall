"use strict";const t=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3});function e(t){console.log(t)}function r(...t){let e="";for(let r=0;r<t.length;r++){const n=t[r];n&&(e+=n)}console.error(e)}function n(t,e,r,n,i){let s,o,a=!1;for(s=0,o=t-1;s<t;o=s++)(r[s]<=i&&i<r[o]||r[o]<=i&&i<r[s])&&n<(e[o]-e[s])*(i-r[s])/(r[o]-r[s])+e[s]&&(a=!a);return a}function i(t,e,r){const n=t.length;let i,s,o=!1;for(i=0,s=n-1;i<n;s=i++){const n=t[i],a=t[s];(n.y<=r&&r<a.y||a.y<=r&&r<n.y)&&e<(a.x-n.x)*(r-n.y)/(a.y-n.y)+n.x&&(o=!o)}return o}function s(t){return new Set(t).size!==t.length}async function o(t){return new Promise((e=>setTimeout(e,t)))}function a(t){const e=t.reduce(((t,{x:e,y:r})=>(t.x+=e,t.y+=r,t)),{x:0,y:0});e.x/=t.length,e.y/=t.length;return t.map((t=>(t.angle=180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI,t))).sort(((t,e)=>t.angle-e.angle))}class l{constructor(){const e="http://www.w3.org/2000/svg";let r,n,i,o=!1;if(this.cont=null,this.mathSVGPoint=null,self&&self.document&&self.document.createElementNS){const t=document.createElementNS(e,"svg");o=null!==t.x}o?(n=function(t){return t}.bind(this),i=function(t){switch(t){case"circle":case"line":case"polyline":return document.createElementNS(e,t);default:throw new Error(`unknwn type ${t}`)}}):(n=function(){return{attributes:new Map,children:[],setAttributeNS:function(t,e,r){this.attributes.set(e,r)},appendChild:function(t){this.children.push(t)},removeChild:function(t){const e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)}}},self.SVGCircleElement=function(){this.attributes=new Map},SVGCircleElement.prototype.setAttribute=function(t,e){this.attributes.set(t,e)},SVGCircleElement.prototype.getAttribute=function(t){return this.attributes.get(t)},SVGCircleElement.prototype.removeAttribute=function(t){this.attributes.delete(t)},self.SVGLineElement=function(){this.attributes=new Map},SVGLineElement.prototype.setAttribute=function(t,e){this.attributes.set(t,e)},SVGLineElement.prototype.getAttribute=function(t){return this.attributes.get(t)},SVGLineElement.prototype.removeAttribute=function(t){this.attributes.delete(t)},self.SVGPolylineElement=function(){this.attributes=new Map},SVGPolylineElement.prototype.setAttribute=function(t,e){this.attributes.set(t,e)},SVGPolylineElement.prototype.getAttribute=function(t){return this.attributes.get(t)},SVGPolylineElement.prototype.removeAttribute=function(t){this.attributes.delete(t)},i=function(t){switch(t){case"circle":return new SVGCircleElement;case"line":return new SVGLineElement;case"polyline":return new SVGPolylineElement;default:throw new Error(`unknwn type ${t}`)}}),SVGCircleElement.prototype.move=function(t,e,r){this.setAttribute("cx",t),this.setAttribute("cy",e),this.setAttribute("r",r)},SVGCircleElement.prototype.GetStrokeColor=function(){return this.getAttribute("stroke")},SVGCircleElement.prototype.SetStrokeColor=function(t){this.setAttribute("stroke",t)},SVGCircleElement.prototype.GetPosition=function(){return{x:parseInt(this.getAttribute("cx")),y:parseInt(this.getAttribute("cy"))}},SVGCircleElement.prototype.GetFillColor=function(){return this.getAttribute("fill")},SVGCircleElement.prototype.SetFillColor=function(t){this.setAttribute("fill",t)},SVGCircleElement.prototype.GetStatus=function(){return l.StringToStatusEnum(this.getAttribute("data-status"))},SVGCircleElement.prototype.SetStatus=function(e,r=!1){if(r){const r=l.StringToStatusEnum(this.getAttribute("data-status"));this.setAttribute("data-status",l.StatusEnumToString(e)),r!==t.POINT_FREE&&r!==e&&this.setAttribute("data-old-status",l.StatusEnumToString(r))}else this.setAttribute("data-status",l.StatusEnumToString(e))},SVGCircleElement.prototype.RevertOldStatus=function(){const t=this.getAttribute("data-old-status");return t?(this.removeAttribute("data-old-status"),this.setAttribute("data-status",t),l.StringToStatusEnum(t)):-1},SVGCircleElement.prototype.GetZIndex=function(){return this.getAttribute("z-index")},SVGCircleElement.prototype.SetZIndex=function(t){this.setAttribute("z-index",t)},SVGCircleElement.prototype.Hide=function(){this.setAttribute("visibility","hidden")},SVGCircleElement.prototype.Show=function(){this.setAttribute("visibility","visible")},SVGCircleElement.prototype.StrokeWeight=function(t){this.setAttribute("stroke-width",t)},SVGCircleElement.prototype.Serialize=function(){const{x:t,y:e}=this.GetPosition();return{x:t,y:e,Status:this.GetStatus(),Color:this.GetFillColor()}},SVGLineElement.prototype.move=function(t,e,r,n){this.setAttribute("x1",t),this.setAttribute("y1",e),this.setAttribute("x2",r),this.setAttribute("y2",n)},SVGLineElement.prototype.RGBcolor=function(t,e,r){this.setAttribute("stroke",`rgb(${Math.round(t)},${Math.round(e)},${Math.round(r)})`)},SVGLineElement.prototype.SetColor=function(t){this.setAttribute("stroke",t)},SVGLineElement.prototype.strokeWidth=function(t){this.setAttribute("stroke-width",t+"px")},SVGPolylineElement.prototype.AppendPoints=function(t,e,r=1,n=1){const i=this.getAttribute("points"),o=i.split(" ");if(!0===s(o))return!1;let a;if(o.length<=1||2!==(a=o[o.length-1].split(",")).length)return!1;const l=parseInt(a[0]),u=parseInt(a[1]),h=parseInt(t),c=parseInt(e);return Math.abs(l-h)<=r&&Math.abs(u-c)<=n&&(this.setAttribute("points",i+` ${t},${e}`),!0)},SVGPolylineElement.prototype.RemoveLastPoint=function(){const t=this.getAttribute("points").replace(/(\s\d+,\d+)$/,"");return this.setAttribute("points",t),t},SVGPolylineElement.prototype.ContainsPoint=function(t,e){const r=new RegExp(`${t},${e}`,"g");return(this.getAttribute("points").match(r)||[]).length},SVGPolylineElement.prototype.GetPointsString=function(){return this.getAttribute("points")},SVGPolylineElement.prototype.GetPointsArray=function(){return this.getAttribute("points").split(" ").map((function(t){const[e,r]=t.split(",");return{x:parseInt(e),y:parseInt(r)}}))},SVGPolylineElement.prototype.SetPoints=function(t){this.setAttribute("points",t)},SVGPolylineElement.prototype.GetIsClosed=function(){const t=this.getAttribute("points").split(" ");return t[0]===t[t.length-1]},SVGPolylineElement.prototype.GetLength=function(){return this.getAttribute("points").split(" ").length},SVGPolylineElement.prototype.SetWidthAndColor=function(t,e){this.setAttribute("stroke",e),this.setAttribute("fill",e),this.setAttribute("stroke-width",t)},SVGPolylineElement.prototype.GetID=function(){return parseInt(this.getAttribute("data-id"))},SVGPolylineElement.prototype.SetID=function(t){this.setAttribute("data-id",t)},SVGPolylineElement.prototype.GetFillColor=function(){return this.getAttribute("fill")},SVGPolylineElement.prototype.Serialize=function(){return{iId:this.GetID(),Color:this.GetFillColor(),PointsAsString:this.GetPointsString()}},this.CreateSVGVML=function(t,e,i,{iGridWidth:s,iGridHeight:a},l){return this.cont=n(t),e&&this.cont.setAttributeNS(null,"width",e),i&&this.cont.setAttributeNS(null,"height",i),t&&(void 0!==s&&void 0!==a&&this.cont.setAttribute("viewBox",`0 0 ${s} ${a}`),this.mathSVGPoint=this.cont.createSVGPoint()),r=l,o?this.cont:null},this.CreateLine=function(t,e,n){const s=i("line");return void 0!==r&&s.setAttribute("shape-rendering",!0===r?"auto":"optimizeSpeed"),s.setAttribute("stroke-width",t+"px"),e&&s.setAttribute("stroke",e),n&&s.setAttribute("stroke-linecap",n),this.cont.appendChild(s),s},this.CreatePolyline=function(t,e,n){const s=i("polyline");return void 0!==r&&s.setAttribute("shape-rendering",!0===r?"auto":"optimizeSpeed"),s.setAttribute("stroke-width",t),n&&s.setAttribute("stroke",n),s.setAttribute("fill",n),s.setAttribute("fill-opacity","0.1"),e&&s.setAttribute("points",e),s.setAttribute("stroke-linecap","round"),s.setAttribute("stroke-linejoin","round"),s.setAttribute("data-id",0),this.cont.appendChild(s),s},this.CreateOval=function(e){const n=i("circle");return void 0!==r&&n.setAttribute("shape-rendering",!0===r?"auto":"optimizeSpeed"),n.setAttribute("stroke-width",0),n.setAttribute("r",e/2),n.setAttribute("data-status",l.StatusEnumToString(t.POINT_FREE)),this.cont.appendChild(n),n}}RemoveOval(t){this.cont.removeChild(t)}RemovePolyline(t){this.cont.removeChild(t)}DeserializeOval(t,e=4){let{x:r,y:n,Status:i,Color:s}=t;r=parseInt(r),n=parseInt(n);const o=this.CreateOval(e);return o.move(r,n,e),o.SetStrokeColor(s),o.SetFillColor(s),o.SetStatus(i),o}DeserializePolyline(t,e=3){const{iId:r,Color:n,PointsAsString:i}=t,s=this.CreatePolyline(e,i,n);return s.SetID(r),s}static StatusEnumToString(e){switch(e){case t.POINT_FREE_RED:return Object.keys(t)[0];case t.POINT_FREE_BLUE:return Object.keys(t)[1];case t.POINT_FREE:return Object.keys(t)[2];case t.POINT_STARTING:return Object.keys(t)[3];case t.POINT_IN_PATH:return Object.keys(t)[4];case t.POINT_OWNED_BY_RED:return Object.keys(t)[5];case t.POINT_OWNED_BY_BLUE:return Object.keys(t)[6];default:throw new Error("bad status enum value")}}static StringToStatusEnum(e){switch(e.toUpperCase()){case Object.keys(t)[0]:return t.POINT_FREE_RED;case Object.keys(t)[1]:return t.POINT_FREE_BLUE;case Object.keys(t)[2]:return t.POINT_FREE;case Object.keys(t)[3]:return t.POINT_STARTING;case Object.keys(t)[4]:return t.POINT_IN_PATH;case Object.keys(t)[5]:return t.POINT_OWNED_BY_RED;case Object.keys(t)[6]:return t.POINT_OWNED_BY_BLUE;default:throw new Error("bad status enum string")}}ToCursorPoint(t,e){this.mathSVGPoint.x=t,this.mathSVGPoint.y=e;return this.mathSVGPoint.matrixTransform(this.cont.getScreenCTM().inverse())}IsPointInCircle(t,r,n,i=8){const s=Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2),o=Math.pow(n,2);return Math.abs(s-o)<i?(e("lhs - rhs = "+(s-o)),1):s===o?0:-1}}class u{constructor(t,e=null,n=null,i=null,s=""){t?"indexedDB"in self?t=!0:(r("This browser doesn't support IndexedDB"),t=!1):t=!1;const o=class{constructor(){this.store=new Map}async PrepareStore(){return!0}async BeginBulkStorage(){}async EndBulkStorage(){}async has(t){return this.store.has(t)}async set(t,e){return this.store.set(t,e)}async get(t){return this.store.get(t)}async values(){return this.store.values()}async count(){return this.store.size}},a=class{constructor(){this.store=[]}async PrepareStore(){return!0}async BeginBulkStorage(){}async EndBulkStorage(){}async push(t){return this.store.push(t)}async all(){return this.store}async count(){return this.store.length}},l=class extends o{constructor(t,e,r){super(),this.MainGameStateStore=t,this.GetPoint=t.GetPoint.bind(this.MainGameStateStore),this.StorePoint=t.StorePoint.bind(this.MainGameStateStore),this.GetAllPoints=t.GetAllPoints.bind(this.MainGameStateStore),this.UpdateState=t.UpdateState.bind(this.MainGameStateStore),this.PointCreationCallback=e,this.GetGameStateCallback=r}async PrepareStore(){if(this.PointCreationCallback&&this.GetGameStateCallback){const t=await this.GetAllPoints(),e=this.GetGameStateCallback();for(const r of t){const t=await this.PointCreationCallback(r.x,r.y,r.Status,r.Color),n=r.y*e.iGridWidth+r.x;this.store.set(n,t)}}return!0}async BeginBulkStorage(){await this.MainGameStateStore.BeginBulkStorage(this.MainGameStateStore.DB_POINT_STORE,"readwrite"),null===this.MainGameStateStore.pointBulkBuffer&&(this.MainGameStateStore.pointBulkBuffer=new Map)}async EndBulkStorage(){await this.MainGameStateStore.StoreAllPoints(),await this.MainGameStateStore.EndBulkStorage(this.MainGameStateStore.DB_POINT_STORE)}async has(t){return this.store.has(t)}async set(t,e){const r=this.GetGameStateCallback(),n=e.GetPosition(),i=e.GetFillColor(),s={x:n.x,y:n.y,Status:e.GetStatus(),Color:i};return await this.StorePoint(t,s),this.UpdateState&&!0===r.bPointsAndPathsLoaded&&await this.UpdateState(r.iGameID,r),this.store.set(t,e)}async get(t){return this.store.get(t)}async values(){let t=this.store.values();return t||(t=await this.GetAllPoints(),t)}},u=class extends a{constructor(t,e,r){super(),this.MainGameStateStore=t,this.GetAllPaths=t.GetAllPaths.bind(this.MainGameStateStore),this.StorePath=t.StorePath.bind(this.MainGameStateStore),this.UpdateState=t.UpdateState.bind(this.MainGameStateStore),this.PathCreationCallback=e,this.GetGameStateCallback=r}async PrepareStore(){if(this.PathCreationCallback){const t=await this.GetAllPaths();for(const e of t){const t=await this.PathCreationCallback(e.PointsAsString,e.Color,e.iId);this.store.push(t)}}return!0}async BeginBulkStorage(){await this.MainGameStateStore.BeginBulkStorage([this.MainGameStateStore.DB_POINT_STORE,this.MainGameStateStore.DB_PATH_STORE],"readwrite"),null===this.MainGameStateStore.pathBulkBuffer&&(this.MainGameStateStore.pathBulkBuffer=new Map)}async EndBulkStorage(){await this.MainGameStateStore.StoreAllPaths(),await this.MainGameStateStore.EndBulkStorage([this.MainGameStateStore.DB_POINT_STORE,this.MainGameStateStore.DB_PATH_STORE])}async push(t){const e=this.GetGameStateCallback(),r=t.GetID(),n={iId:r,Color:t.GetFillColor(),PointsAsString:t.GetPointsString().split(" ").map((t=>{const e=t.split(",");return`${parseInt(e[0])},${parseInt(e[1])}`})).join(" ")};return await this.StorePath(r,n),this.UpdateState&&!0===e.bPointsAndPathsLoaded&&await this.UpdateState(e.iGameID,e),this.store.push(t)}async all(){let t=this.store;return t||(t=await this.GetAllPaths(),t)}};!0===t?(this.DB_NAME="InkballGame",this.DB_POINT_STORE="points",this.DB_PATH_STORE="paths",this.DB_STATE_STORE="state",this.g_DB=null,this.bulkStores=null,this.pointBulkBuffer=null,this.pathBulkBuffer=null,!s||""===s||s.length<=0?this.DB_VERSION=null:this.DB_VERSION=parseInt(s.split(".").reduce(((t,e)=>(e=parseInt(e),10*t+(isNaN(e)?0:e))),0))-1010+4,this.PointStore=new l(this,e,i),this.PathStore=new u(this,n,i)):(this.PointStore=new o,this.PathStore=new a)}GetPointStore(){return this.PointStore}GetPathStore(){return this.PathStore}async OpenDb(){return e("OpenDb ..."),new Promise(((t,n)=>{let i;i=null!==this.DB_VERSION?indexedDB.open(this.DB_NAME,this.DB_VERSION):indexedDB.open(this.DB_NAME),i.onsuccess=function(r){this.g_DB=r.currentTarget.result,e("OpenDb DONE"),t(r.currentTarget.result)}.bind(this),i.onerror=function(t){r("OpenDb:",t.target.errorCode||t.target.error),n()}.bind(this),i.onupgradeneeded=function(t){e(`OpenDb.onupgradeneeded(version: ${this.DB_VERSION})`);const r=Array.from(t.currentTarget.result.objectStoreNames);r.includes(this.DB_POINT_STORE)&&t.currentTarget.result.deleteObjectStore(this.DB_POINT_STORE),r.includes(this.DB_PATH_STORE)&&t.currentTarget.result.deleteObjectStore(this.DB_PATH_STORE),r.includes(this.DB_STATE_STORE)&&t.currentTarget.result.deleteObjectStore(this.DB_STATE_STORE),t.currentTarget.result.createObjectStore(this.DB_POINT_STORE,{autoIncrement:!1}),t.currentTarget.result.createObjectStore(this.DB_PATH_STORE,{autoIncrement:!1}),t.currentTarget.result.createObjectStore(this.DB_STATE_STORE,{autoIncrement:!1})}.bind(this)}))}GetObjectStore(t,e){if(null!==this.bulkStores&&this.bulkStores.has(t))return this.bulkStores.get(t);return this.g_DB.transaction(t,e).objectStore(t)}async ClearAllStores(){const t=async function(t){return new Promise(((e,n)=>{const i=this.GetObjectStore(t,"readwrite").clear();i.onsuccess=function(){e()},i.onerror=function(t){r("clearObjectStore:",t.target.errorCode),n()}}))}.bind(this);await Promise.all([t(this.DB_POINT_STORE),t(this.DB_PATH_STORE),t(this.DB_STATE_STORE)])}async GetPoint(t){return new Promise(((e,r)=>{const n=this.GetObjectStore(this.DB_POINT_STORE,"readonly").get(t);n.onerror=function(t){r(new Error("GetPoint => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetAllPoints(){return new Promise(((t,e)=>{const r=this.GetObjectStore(this.DB_POINT_STORE,"readonly"),n=[],i=r.openCursor();i.onsuccess=function(e){const r=e.target.result;r?(n.push(r.value),r.continue()):t(n)},i.onerror=function(t){e(new Error("GetAllPoints => "+t))}}))}async GetState(t){return new Promise(((e,r)=>{const n=this.GetObjectStore(this.DB_STATE_STORE,"readonly").get(t);n.onerror=function(t){r(new Error("GetState => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetPath(t){return new Promise(((e,r)=>{const n=this.GetObjectStore(this.DB_PATH_STORE,"readonly").get(t);n.onerror=function(t){r(new Error("GetPath => "+t))},n.onsuccess=function(t){e(t.target.result)}}))}async GetAllPaths(){return new Promise(((t,e)=>{const r=this.GetObjectStore(this.DB_PATH_STORE,"readonly"),n=[],i=r.openCursor();i.onsuccess=function(e){const r=e.target.result;r?(n.push(r.value),r.continue()):t(n)},i.onerror=function(t){e(new Error("GetAllPaths => "+t))}}))}async StorePoint(t,e){return null!==this.bulkStores&&this.bulkStores.has(this.DB_POINT_STORE)?(null===this.pointBulkBuffer&&(this.pointBulkBuffer=new Map),this.pointBulkBuffer.set(t,e),Promise.resolve()):new Promise(((n,i)=>{const s=this.GetObjectStore(this.DB_POINT_STORE,"readwrite");let o;try{o=s.put(e,t)}catch(t){throw"DataCloneError"===t.name&&r("This engine doesn't know how to clone a Blob, use Firefox"),t}o.onsuccess=function(){n()},o.onerror=function(){r("StorePoint error",this.error),i()}}))}async StoreAllPoints(t=null){return t||(t=this.pointBulkBuffer),t&&null!==this.bulkStores?new Promise(((e,n)=>{const i=this.GetObjectStore(this.DB_POINT_STORE,"readwrite");try{t.forEach((function(t,e){i.add(t,e)})),this.pointBulkBuffer=null,e()}catch(t){r("This engine doesn't know how to clone a Blob, use Firefox"),n(t)}})):Promise.reject()}async StoreState(t,e){return new Promise(((n,i)=>{const s=this.GetObjectStore(this.DB_STATE_STORE,"readwrite");let o;try{o=s.add(e,t)}catch(t){throw"DataCloneError"===t.name&&r("This engine doesn't know how to clone a Blob, use Firefox"),t}o.onsuccess=function(){n()},o.onerror=function(){r("StoreState error",this.error),i()}}))}async UpdateState(t,e){return new Promise(((n,i)=>{const s=this.GetObjectStore(this.DB_STATE_STORE,"readwrite");let o;try{o=s.put(e,t)}catch(t){throw"DataCloneError"===t.name&&r("This engine doesn't know how to clone a Blob, use Firefox"),t}o.onsuccess=function(){n()},o.onerror=function(){r("UpdateState error",this.error),i()}}))}async StorePath(t,e){return null!==this.bulkStores&&this.bulkStores.has(this.DB_PATH_STORE)?(null===this.pathBulkBuffer&&(this.pathBulkBuffer=new Map),this.pathBulkBuffer.set(t,e),Promise.resolve()):new Promise(((n,i)=>{const s=this.GetObjectStore(this.DB_PATH_STORE,"readwrite");let o;try{o=s.add(e,t)}catch(t){throw"DataCloneError"===t.name&&r("This engine doesn't know how to clone a Blob, use Firefox"),t}o.onsuccess=function(){n()},o.onerror=function(){r("StorePath error",this.error),i()}}))}async StoreAllPaths(t=null){return t||(t=this.pathBulkBuffer),t&&null!==this.bulkStores?new Promise(((e,n)=>{const i=this.GetObjectStore(this.DB_PATH_STORE,"readwrite");try{t.forEach((function(t,e){i.add(t,e)})),this.pathBulkBuffer=null,e()}catch(t){r("This engine doesn't know how to clone a Blob, use Firefox"),n(t)}})):Promise.reject()}async PrepareStore(){if(!this.PointStore.GetAllPoints)return!1;if(null!==this.g_DB)return!1;await this.OpenDb();const t=this.PointStore.GetGameStateCallback(),e=await this.GetState(t.iGameID);if(!e)return await this.ClearAllStores(),await this.StoreState(t.iGameID,t),!1;if(e.sLastMoveGameTimeStamp!==t.sLastMoveGameTimeStamp)return await this.ClearAllStores(),!1;if(!1===t.bPointsAndPathsLoaded)try{return await this.BeginBulkStorage([this.DB_POINT_STORE,this.DB_PATH_STORE],"readonly"),!0===await this.PointStore.PrepareStore()&&!0===await this.PathStore.PrepareStore()||(await this.ClearAllStores(),!1)}finally{await this.EndBulkStorage([this.DB_POINT_STORE,this.DB_PATH_STORE])}}async BeginBulkStorage(t,e){null===this.bulkStores&&(this.bulkStores=new Map);const r=Array.isArray(t)?t:[t];let n=null;for(const t of r)this.bulkStores.has(t)||(null===n&&(n=this.g_DB.transaction(r,e)),this.bulkStores.set(t,n.objectStore(t)))}async EndBulkStorage(t){if(null!==this.bulkStores){const e=Array.isArray(t)?t:[t];for(const t of e)this.bulkStores.has(t)&&this.bulkStores.delete(t);this.bulkStores.size<=0&&(this.bulkStores=null)}}}export{l as SvgVml,t as StatusEnum,n as pnpoly,i as pnpoly2,e as LocalLog,r as LocalError,s as hasDuplicates,a as sortPointsClockwise,o as Sleep,u as GameStateStore};
//# sourceMappingURL=shared.min.js.map
