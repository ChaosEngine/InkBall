"use strict";const StatusEnum=Object.freeze({POINT_FREE_RED:-3,POINT_FREE_BLUE:-2,POINT_FREE:-1,POINT_STARTING:0,POINT_IN_PATH:1,POINT_OWNED_BY_RED:2,POINT_OWNED_BY_BLUE:3}),CommandKindEnum=Object.freeze({UNKNOWN:-1,PING:0,POINT:1,PATH:2,PLAYER_JOINING:3,PLAYER_SURRENDER:4,WIN:5,POINTS_AND_PATHS:6,USER_SETTINGS:7,STOP_AND_DRAW:8}),GameTypeEnum=Object.freeze({FIRST_CAPTURE:0,FIRST_5_CAPTURES:1,FIRST_5_PATHS:2,FIRST_5_ADVANTAGE_PATHS:3}),WinStatusEnum=Object.freeze({RED_WINS:0,GREEN_WINS:1,NO_WIN:2,DRAW_WIN:3});class DtoMsg{GetKind(){throw new Error("missing GetKind implementation!")}}class InkBallPointViewModel extends DtoMsg{constructor(t=0,i=0,e=0,s=0,n=0,o=StatusEnum.POINT_FREE,r=0){super(),this.iId=t,this.iGameId=i,this.iPlayerId=e,this.iX=s,this.iY=n,this.Status=o,this.iEnclosingPathId=r}GetKind(){return CommandKindEnum.POINT}static Format(t,i){let e="("+i.iX+","+i.iY+" - ";switch(i.Status||i.status){case StatusEnum.POINT_FREE_RED:e+="red";break;case StatusEnum.POINT_FREE_BLUE:e+="blue";break;case StatusEnum.POINT_FREE:e+="";break;case StatusEnum.POINT_STARTING:e+="starting";break;case StatusEnum.POINT_IN_PATH:e+="path";break;case StatusEnum.POINT_OWNED_BY_RED:e+="owned by red";break;case StatusEnum.POINT_OWNED_BY_BLUE:e+="owned by blue";break;default:throw new Error("Bad point type!")}return t+" places "+e+") point"}}class InkBallPathViewModel extends DtoMsg{constructor(t=0,i=0,e=0,s="",n=""){super(),this.iId=t,this.iGameId=i,this.iPlayerId=e,this.PointsAsString=s,this.OwnedPointsAsString=n}GetKind(){return CommandKindEnum.PATH}static Format(t,i){return`${t} places ${`(${i.PointsAsString||i.pointsAsString}) [${i.OwnedPointsAsString||i.ownedPointsAsString}]`} path`}}class PlayerJoiningCommand extends DtoMsg{constructor(t,i,e){super(),this.OtherPlayerId=t,this.OtherPlayerName=i,this.Message=e}GetKind(){return CommandKindEnum.PLAYER_JOINING}static Format(t){return t.Message||t.message}}class PlayerSurrenderingCommand extends DtoMsg{constructor(t,i,e){super(),this.OtherPlayerId=t,this.thisOrOtherPlayerSurrenders=i,this.Message=e}GetKind(){return CommandKindEnum.PLAYER_SURRENDER}static Format(t){return t.Message||t.message}}class PingCommand extends DtoMsg{constructor(t=""){super(),this.Message=t}GetKind(){return CommandKindEnum.PING}static Format(t,i){return t+" says '"+(i.Message||i.message)+"'"}}class WinCommand extends DtoMsg{constructor(t=WinStatusEnum.NO_WIN,i=0,e="null"){super(),this.Status=t,this.WinningPlayerId=i,this.Message=e}GetKind(){return CommandKindEnum.WIN}static Format(t){let i="";switch(t.Status||t.status){case WinStatusEnum.RED_WINS:i="red.";break;case WinStatusEnum.GREEN_WINS:i="blue.";break;case WinStatusEnum.NO_WIN:i="no one!";break;case WinStatusEnum.DRAW_WIN:i="draw!"}return"And the winner is... "+i}}class StopAndDrawCommand extends DtoMsg{constructor(){super()}GetKind(){return CommandKindEnum.STOP_AND_DRAW}static Format(t){return"User "+t+" started to draw path"}}class PlayerPointsAndPathsDTO extends DtoMsg{constructor(t=[],i=[]){super(),this.Points=t,this.Paths=i}GetKind(){return CommandKindEnum.POINTS_AND_PATHS}static Deserialize(t){const i=`{ "Points": ${t.Points||t.points}, "Paths": ${t.Paths||t.paths} }`;return JSON.parse(i)}}class ApplicationUserSettings extends DtoMsg{constructor(t=!1){super(),this.DesktopNotifications=t}GetKind(){return CommandKindEnum.USER_SETTINGS}static Serialize(t){return JSON.stringify(t)}static Deserialize(t){return JSON.parse(t)}}class CountdownTimer{constructor({countdownSeconds:t=60,labelSelector:i=null,initialStart:e=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.timerID=-1,this.label=null,this.countdownReachedHandler=s,i&&(this.label=document.querySelector(i)),e&&this.Start()}setTimeFunc(){--this.totalSeconds<=0?(this.Stop(),this.countdownReachedHandler&&this.countdownReachedHandler(this.label)):this.label&&(this.label.innerHTML=this.pad(parseInt(this.totalSeconds/60))+":"+this.pad(this.totalSeconds%60))}pad(t){const i=t+"";return i.length<2?"0"+i:i}Start(){this.Stop(),this.timerID=setInterval(this.setTimeFunc.bind(this),1e3)}Stop(){this.timerID>0&&clearInterval(this.timerID),this.label&&(this.label.innerHTML="")}Reset({countdownSeconds:t=60,labelSelector:i=null,initialStart:e=!1,countdownReachedHandler:s}={}){this.countdownSeconds=t,this.totalSeconds=this.countdownSeconds,this.label=null,this.countdownReachedHandler=s,i&&(this.label=document.querySelector(i)),e&&this.Start()}}function CountPointsDebug(t){let i="";[{query:"circle:not([z-index])",display:"circles: %s, "},{query:"polyline",display:"lines: %s, "},{query:"circle[data-status='2']",display:"intercepted(P1:%s, "},{query:"circle[data-status='3']",display:"P2:%s)"}].forEach(function(t){const e=document.querySelectorAll(t.query);i+=t.display.replace("%s",e.length)}),document.querySelector(t).innerHTML="SVGs by tags: "+i}function LocalLog(t){console.log(t)}function LocalError(t){console.error(t)}class InkBallGame{constructor(t,i,e,s,n,o,r,a=!0,h=!0,l={width:32,height:32},m=!1,u=60,_=125){this.g_iGameID=null,this.g_iPlayerID=null,this.GameType=GameTypeEnum[r],this.iConnErrCount=0,this.iExponentialBackOffMillis=2e3,this.COLOR_RED="red",this.COLOR_BLUE="blue",this.COLOR_OWNED_RED="#DC143C",this.COLOR_OWNED_BLUE="#8A2BE2",this.DRAWING_PATH_COLOR="black",this.m_bIsWon=!1,this.m_bPointsAndPathsLoaded=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=_,this.m_Timer=null,this.m_ReconnectTimer=null,this.m_WaitStartTime=null,this.m_TimerOpts={countdownSeconds:u,labelSelector:"#debug2",initialStart:!0,countdownReachedHandler:this.CountDownReachedHandler.bind(this)},this.m_iSlowdownLevel=0,this.m_iGridSizeX=0,this.m_iGridSizeY=0,this.m_iGridWidth=0,this.m_iGridHeight=0,this.m_BoardSize=l,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_Screen=null,this.m_Debug=null,this.m_Player2Name=null,this.m_SurrenderButton=null,this.m_sMsgInputSel=null,this.m_sMsgSendButtonSel=null,this.m_CancelPath=null,this.m_StopAndDraw=null,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_bIsPlayingWithRed=a,this.m_bIsPlayerActive=h,this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_PointRadius=4,this.m_Line=null,this.m_Lines=[],this.m_Points=new Map,this.m_bViewOnly=m,this.m_MouseCursorOval=null,this.m_ApplicationUserSettings=null,null!==t&&""!==t&&(this.g_SignalRConnection=(new signalR.HubConnectionBuilder).withUrl(t,{transport:s,accessTokenFactory:o}).withHubProtocol(e).configureLogging(i).build(),this.g_SignalRConnection.serverTimeoutInMilliseconds=n,this.g_SignalRConnection.onclose(async t=>{null!=t&&(LocalError(t),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout(()=>this.Connect(),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5)))}))}async GetPlayerPointsAndPaths(){if(this.m_bPointsAndPathsLoaded)return!1;await this.g_SignalRConnection.invoke("GetPlayerPointsAndPaths",this.m_bViewOnly,this.g_iGameID).then(function(t){const i=PlayerPointsAndPathsDTO.Deserialize(t);return void 0!==i.Points&&this.SetAllPoints(i.Points),void 0!==i.Paths&&this.SetAllPaths2(i.Paths),this.m_bPointsAndPathsLoaded=!0,!0}.bind(this))}async Connect(){try{if(await this.g_SignalRConnection.start(),this.iConnErrCount=0,LocalLog("connected; iConnErrCount = "+this.iConnErrCount),!1===this.m_bViewOnly)if(null===sessionStorage.getItem("ApplicationUserSettings"))await this.g_SignalRConnection.invoke("GetUserSettings").then(function(t){if(LocalLog(t),t){t=ApplicationUserSettings.Deserialize(t);const i=ApplicationUserSettings.Serialize(t);sessionStorage.setItem("ApplicationUserSettings",i)}return t}.bind(this)).then(async function(t){return this.m_ApplicationUserSettings=new ApplicationUserSettings(t.DesktopNotifications),await this.GetPlayerPointsAndPaths()}.bind(this)).then(async function(){});else{const t=sessionStorage.getItem("ApplicationUserSettings"),i=ApplicationUserSettings.Deserialize(t);this.m_ApplicationUserSettings=new ApplicationUserSettings(i.DesktopNotifications)}this.m_bPointsAndPathsLoaded||await this.GetPlayerPointsAndPaths(),null!==this.m_ApplicationUserSettings&&!0===this.m_ApplicationUserSettings.DesktopNotifications&&this.SetupNotifications()}catch(t){LocalError(t+"; iConnErrCount = "+this.iConnErrCount),this.m_Screen.style.cursor="not-allowed",this.iConnErrCount++,setTimeout(()=>this.Connect(),4e3+this.iExponentialBackOffMillis*Math.max(this.iConnErrCount,5))}}SetupNotifications(){return window.Notification?"granted"===Notification.permission||void Notification.requestPermission().then(function(t){return"granted"===t||(LocalLog("User blocked notifications."),!1)}).catch(function(t){return LocalError(t),!1}):(LocalLog("Browser does not support notifications."),!1)}NotifyBrowser(t="Hi there!",i="How are you doing?"){return!!document.hidden&&(window.Notification?"granted"===Notification.permission?(new Notification(t,{body:i,icon:"../img/homescreen.webp"}),!0):void Notification.requestPermission().then(function(e){return"granted"===e?(new Notification(t,{body:i,icon:"../img/homescreen.webp"}),!0):(LocalLog("User blocked notifications."),!1)}).catch(function(t){return LocalError(t),!1}):(LocalLog("Browser does not support notifications."),!1))}StartSignalRConnection(t,i,e,s,n,o){null!==this.g_SignalRConnection&&(this.g_iGameID=t,this.g_iPlayerID=i,this.m_sMsgInputSel=o,this.m_sMsgSendButtonSel=n,this.m_bPointsAndPathsLoaded=!e,this.g_SignalRConnection.on("ServerToClientPoint",function(t){const i=this.m_Player2Name.innerHTML;let e=InkBallPointViewModel.Format(i,t);const n=document.createElement("li");n.textContent=e,document.querySelector(s).appendChild(n),this.ReceivedPointProcessing(t),this.NotifyBrowser("New Point",e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPath",function(t){if(Object.prototype.hasOwnProperty.call(t,"PointsAsString")||Object.prototype.hasOwnProperty.call(t,"pointsAsString")){let i=t;const e=this.m_Player2Name.innerHTML;let n=InkBallPathViewModel.Format(e,i);const o=document.createElement("li");o.textContent=n,document.querySelector(s).appendChild(o),this.ReceivedPathProcessing(i),this.NotifyBrowser("New Path",n)}else{if(!Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")&&!Object.prototype.hasOwnProperty.call(t,"winningPlayerId"))throw new Error("ServerToClientPath bad GetKind!");{let i=t,e=WinCommand.Format(i),n=document.createElement("li");n.textContent=e,document.querySelector(s).appendChild(n),this.ReceivedWinProcessing(i),this.NotifyBrowser("We have a winner",e)}}}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerJoin",function(t){let i=PlayerJoiningCommand.Format(t),e=document.createElement("li");e.innerHTML=`<strong class="text-primary">${i}</strong>`,document.querySelector(s).appendChild(e),null!==this.m_SurrenderButton&&""!==t.OtherPlayerName&&(this.m_Player2Name.innerHTML=t.OtherPlayerName||t.otherPlayerName,this.m_SurrenderButton.value="surrender",this.ShowMobileStatus("Your move")),this.NotifyBrowser("Player joininig",i),this.m_bHandlingEvent=!1}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerSurrender",function(t){let i=PlayerSurrenderingCommand.Format(t),e=document.createElement("li");e.innerHTML=`<strong class="text-warning">${i}</strong>`,document.querySelector(s).appendChild(e),this.m_bHandlingEvent=!1,i=""===i?"Game interrupted!":i,this.NotifyBrowser("Game interruption",i),alert(i),window.location.href="Games"}.bind(this)),this.g_SignalRConnection.on("ServerToClientPlayerWin",function(t){let i=WinCommand.Format(t),e=document.createElement("li");e.innerHTML=`<strong class="text-warning">${i}</strong>`,document.querySelector(s).appendChild(e),this.ReceivedWinProcessing(t),this.NotifyBrowser("We have a winner",i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientPing",function(t){const i=this.m_Player2Name.innerHTML;let e=PingCommand.Format(i,t),n=document.createElement("li");n.textContent=e,document.querySelector(s).appendChild(n),this.NotifyBrowser("User Message",e)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerDisconnected",function(t){const i={countdownSeconds:5,initialStart:!0,countdownReachedHandler:function(){let i=t,e=document.createElement("li");e.innerHTML=`<strong class="text-warning">${i}</strong>`,document.querySelector(s).appendChild(e),this.NotifyBrowser("User disconnected",i),this.m_ReconnectTimer=null}.bind(this)};this.m_ReconnectTimer?this.m_ReconnectTimer.Reset(i):this.m_ReconnectTimer=new CountdownTimer(i)}.bind(this)),this.g_SignalRConnection.on("ServerToClientOtherPlayerConnected",function(t){if(this.m_ReconnectTimer)this.m_ReconnectTimer.Stop(),this.m_ReconnectTimer=null;else{let i=t,e=document.createElement("li");e.innerHTML=`<strong class="text-primary">${i}</strong>`,document.querySelector(s).appendChild(e),this.NotifyBrowser("User disconnected",i),this.m_ReconnectTimer=null}}.bind(this)),this.g_SignalRConnection.on("ServerToClientStopAndDraw",function(t){if(!t)return;const i=this.m_Player2Name.innerHTML;let e=StopAndDrawCommand.Format(i),n=document.createElement("li");n.innerHTML=`<strong class="text-info">${e}</strong>`,document.querySelector(s).appendChild(n),this.NotifyBrowser("User "+i+" started drawing new path",e)}.bind(this)),document.querySelector(this.m_sMsgSendButtonSel).addEventListener("click",function(t){t.preventDefault();let i=document.querySelector(this.m_sMsgInputSel).value.trim();if(""===i)return;let e=new PingCommand(i);this.SendAsyncData(e)}.bind(this),!1),document.querySelector(this.m_sMsgInputSel).addEventListener("keyup",function(t){t.preventDefault(),13===t.keyCode&&document.querySelector(this.m_sMsgSendButtonSel).click()}.bind(this),!1),this.Connect())}StopSignalRConnection(){null!==this.g_SignalRConnection&&(this.g_SignalRConnection.stop(),this.m_ReconnectTimer&&this.m_ReconnectTimer.Stop(),this.m_Timer&&this.m_Timer.Stop(),LocalLog("Stopped SignalR connection"))}Debug(...t){switch(t.length){case 1:this.m_Debug.innerHTML=t[0];break;case 2:document.getElementById("debug"+t[1]).innerHTML=t[0];break;default:for(let i=0;i<t.length;i++){const e=t[i];if(e){const t=document.getElementById("debug"+i);t&&(t.innerHTML=e)}}}}DisableSelection(t){void 0!==typeof t.onselectstart?t.onselectstart=function(){return!1}:void 0!==typeof t.style.MozUserSelect?t.style.MozUserSelect="none":t.onmousedown=function(){return!1}}f_clientWidth(){return this.f_filterResults(window.innerWidth?window.innerWidth:0,document.documentElement?document.documentElement.clientWidth:0,document.body?document.body.clientWidth:0)}f_clientHeight(){return this.f_filterResults(window.innerHeight?window.innerHeight:0,document.documentElement?document.documentElement.clientHeight:0,document.body?document.body.clientHeight:0)}f_scrollLeft(){return this.f_filterResults(window.pageXOffset?window.pageXOffset:0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)}f_scrollTop(){return this.f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}f_filterResults(t,i,e){let s=t||0;return i&&(!s||s>i)&&(s=i),e&&(!s||s>e)?e:s}SetPoint(t,i,e,s){if(this.m_Points.has(i*this.m_iGridWidth+t))return;const n=t*this.m_iGridSizeX,o=i*this.m_iGridSizeY,r=$createOval(this.m_PointRadius,"true");let a;switch(r.$move(n,o,this.m_PointRadius),e){case StatusEnum.POINT_FREE_RED:a=this.COLOR_RED,r.$SetStatus(e);break;case StatusEnum.POINT_FREE_BLUE:a=this.COLOR_BLUE,r.$SetStatus(e);break;case StatusEnum.POINT_FREE:a=this.m_sDotColor,r.$SetStatus(e),console.warn("TODO: generic FREE point, really? change it!");break;case StatusEnum.POINT_STARTING:a=this.m_sDotColor,r.$SetStatus(e);break;case StatusEnum.POINT_IN_PATH:a=this.g_iPlayerID===s?!0===this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE:!0===this.m_bIsPlayingWithRed?this.COLOR_BLUE:this.COLOR_RED,r.$SetStatus(e);break;case StatusEnum.POINT_OWNED_BY_RED:a=this.COLOR_OWNED_RED,r.$SetStatus(e);break;case StatusEnum.POINT_OWNED_BY_BLUE:a=this.COLOR_OWNED_BLUE,r.$SetStatus(e);break;default:alert("bad point")}r.$SetFillColor(a),r.$SetStrokeColor(a),this.m_Points.set(i*this.m_iGridWidth+t,r)}SetAllPoints(t){t.forEach(t=>{this.SetPoint(t[0],t[1],t[2],t[3])})}SetPath(t,i,e,s=0){const n=t.split(" ");let o,r,a="",h="",l=null,m=StatusEnum.POINT_STARTING;for(const t of n)l=t.split(","),o=parseInt(l[0]),r=parseInt(l[1]),null!=(l=this.m_Points.get(r*this.m_iGridWidth+o))&&(l.$SetStatus(m),m=StatusEnum.POINT_IN_PATH),h+=`${a}${o*=this.m_iGridSizeX},${r*=this.m_iGridSizeY}`,a=" ";l=n[0].split(","),o=parseInt(l[0]),r=parseInt(l[1]),null!=(l=this.m_Points.get(r*this.m_iGridWidth+o))&&l.$SetStatus(m),h+=`${a}${o*=this.m_iGridSizeX},${r*=this.m_iGridSizeY}`;const u=$createPolyline(3,h,e?this.m_sDotColor:i?this.COLOR_BLUE:this.COLOR_RED);u.$SetID(s),this.m_Lines.push(u)}SetAllPaths2(t){t.forEach(t=>{if(t.iGameId!==this.g_iGameID)throw new Error("Bad game from path!");this.SetPath(t.PointsAsString,this.m_bIsPlayingWithRed,t.iPlayerId===this.g_iPlayerID,t.iId)})}IsPointBelongingToLine(t,i,e){for(const s of t){const t=s.split(","),n=t[0],o=t[1];if(n===i&&o===e)return!0}return!1}pnpoly(t,i,e,s,n){let o,r,a=!1;for(o=0,r=t-1;o<t;r=o++)(e[o]<=n&&n<e[r]||e[r]<=n&&n<e[o])&&s<(i[r]-i[o])*(n-e[o])/(e[r]-e[o])+i[o]&&(a=!a);return a}pnpoly2(t,i,e){const s=t.length;let n,o,r=!1;for(n=0,o=s-1;n<s;o=n++){const s=t[n],a=t[o];(s.y<=e&&e<a.y||a.y<=e&&e<s.y)&&i<(a.x-s.x)*(e-s.y)/(a.y-s.y)+s.x&&(r=!r)}return r}SurroundOponentPoints(){const t=this.m_Line.$GetPointsArray();if(hasDuplicates(t.slice(0,-1).map(t=>t.x+"_"+t.y))||t[0].x!==t[t.length-1].x||t[0].y!==t[t.length-1].y)return{OwnedPoints:void 0,owned:"",path:"",errorDesc:"Points not unique"};const i=this.m_sDotColor===this.COLOR_RED?this.COLOR_BLUE:this.COLOR_RED,e=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,s=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE;let n,o,r="",a="",h="",l=[];for(const r of this.m_Points.values())if(void 0!==r&&r.$GetFillColor()===i&&(r.$GetStatus()===StatusEnum.POINT_FREE_BLUE||r.$GetStatus()===StatusEnum.POINT_FREE_RED)){const i=r.$GetPosition();n=i.x,o=i.y,!1!==this.pnpoly2(t,n,o)&&(n/=this.m_iGridSizeX,o/=this.m_iGridSizeY,a+=`${h}${n},${o}`,h=" ",l.push({point:r,revertStatus:r.$GetStatus(),revertFillColor:r.$GetFillColor(),revertStrokeColor:r.$GetStrokeColor()}),r.$SetStatus(e,!0),r.$SetFillColor(s),r.$SetStrokeColor(s))}return""!==a&&(r=t.map(function(t){return n=t.x,o=t.y,null===n||null===o?"":(n/=this.m_iGridSizeX,o/=this.m_iGridSizeY,`${n},${o}`)}.bind(this)).join(" ")),{OwnedPoints:l,owned:a,PathPoints:[],path:r,errorDesc:"No surrounded points"}}IsPointOutsideAllPaths(t,i){const e=t*this.m_iGridSizeX,s=i*this.m_iGridSizeY;for(const t of this.m_Lines){const i=t.$GetPointsArray();if(!1!==this.pnpoly2(i,e,s))return!1}return!0}CreateXMLWaitForPlayerRequest(){}CreateXMLPutPointRequest(t,i){return new InkBallPointViewModel(0,this.g_iGameID,this.g_iPlayerID,t,i,this.m_bIsPlayingWithRed?StatusEnum.POINT_FREE_RED:StatusEnum.POINT_FREE_BLUE,0)}CreateXMLPutPathRequest(t){return new InkBallPathViewModel(0,this.g_iGameID,this.g_iPlayerID,t.path,t.owned)}SendAsyncData(t,i){switch(t.GetKind()){case CommandKindEnum.POINT:LocalLog(InkBallPointViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPoint",t).then(function(t){this.ReceivedPointProcessing(t)}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==i&&i()}.bind(this));break;case CommandKindEnum.PATH:LocalLog(InkBallPathViewModel.Format("some player",t)),this.m_bHandlingEvent=!0,this.g_SignalRConnection.invoke("ClientToServerPath",t).then(function(t){if(Object.prototype.hasOwnProperty.call(t,"WinningPlayerId")||Object.prototype.hasOwnProperty.call(t,"winningPlayerId")){let i=t;this.ReceivedWinProcessing(i)}else{if(!Object.prototype.hasOwnProperty.call(t,"PointsAsString")&&!Object.prototype.hasOwnProperty.call(t,"pointsAsString"))throw new Error("ClientToServerPath bad GetKind!");{let i=t;this.ReceivedPathProcessing(i)}}}.bind(this)).catch(function(t){LocalError(t.toString()),void 0!==i&&i()}.bind(this));break;case CommandKindEnum.PING:this.g_SignalRConnection.invoke("ClientToServerPing",t).then(function(){document.querySelector(this.m_sMsgInputSel).value="",document.querySelector(this.m_sMsgSendButtonSel).disabled="disabled"}.bind(this)).catch(function(t){LocalError(t.toString())});break;case CommandKindEnum.STOP_AND_DRAW:this.g_SignalRConnection.invoke("ClientToServerStopAndDraw",t).then(function(){this.m_bDrawLines=!0,this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!0,this.m_StopAndDraw.disabled="disabled"}.bind(this)).catch(function(t){LocalError(t.toString())});break;default:LocalError("unknown object")}}CountDownReachedHandler(t){t&&(t.innerHTML=""),this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled",this.m_Timer=null,this.m_bIsPlayerActive=!1}ReceivedPointProcessing(t){let i=t.iX,e=t.iY,s=t.Status||t.status;this.SetPoint(i,e,s,t.iPlayerId),this.g_iPlayerID!==t.iPlayerId?(this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&this.OnCancelClick(),this.m_StopAndDraw.disabled="",this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)):(this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_CancelPath.disabled="disabled",this.m_StopAndDraw.disabled="",this.m_StopAndDraw.value="Stop and Draw",this.m_Timer?this.m_Timer.Reset(this.m_TimerOpts):this.m_Timer=new CountdownTimer(this.m_TimerOpts)),this.m_bHandlingEvent=!1}ReceivedPathProcessing(t){if(this.g_iPlayerID!==t.iPlayerId){const i=t.PointsAsString||t.pointsAsString,e=t.OwnedPointsAsString||t.ownedPointsAsString;this.SetPath(i,this.m_sDotColor===this.COLOR_RED,!1,t.iId);const s=e.split(" "),n=this.m_sDotColor===this.COLOR_RED?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,o=this.m_sDotColor===this.COLOR_RED?this.COLOR_OWNED_RED:this.COLOR_OWNED_BLUE;for(const t of s){let i=t.split(",");const e=parseInt(i[0]),s=parseInt(i[1]);void 0!==(i=this.m_Points.get(s*this.m_iGridWidth+e))&&(i.$SetStatus(n),i.$SetFillColor(o),i.$SetStrokeColor(o))}this.m_bIsPlayerActive=!0,this.ShowMobileStatus("Oponent has moved, your turn"),this.m_Screen.style.cursor="crosshair",null!==this.m_Line&&this.OnCancelClick(),this.m_StopAndDraw.disabled=""}else{const i=this.m_Line.$GetPointsArray();let e=i[0].x,s=i[0].y;e/=this.m_iGridSizeX,s/=this.m_iGridSizeY;const n=this.m_Points.get(s*this.m_iGridWidth+e);void 0!==n&&n.$SetStatus(StatusEnum.POINT_IN_PATH),this.m_Line.$SetWidthAndColor(3,this.m_sDotColor),this.m_Line.$SetID(t.iId),this.m_Lines.push(this.m_Line),this.m_iLastX=this.m_iLastY=-1,this.m_Line=null,this.m_bIsPlayerActive=!1,this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait",this.m_StopAndDraw.disabled=this.m_CancelPath.disabled="disabled"}this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line",this.m_bHandlingEvent=!1,this.m_Timer&&(this.m_Timer.Stop(),this.m_Timer=null)}ReceivedWinProcessing(t){this.ShowMobileStatus("Win situation"),this.m_bHandlingEvent=!1;let i=WinCommand.Format(t);const e=t.Status||t.status,s=t.WinningPlayerId||t.winningPlayerId;((e===WinStatusEnum.RED_WINS||e===WinStatusEnum.GREEN_WINS)&&s>0||e===WinStatusEnum.DRAW_WIN)&&(alert(""===i?"Game won!":i),window.location.href="Games")}Check4Win(t,i,e,s){let n,o;switch(this.GameType){case GameTypeEnum.FIRST_CAPTURE:return t.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:i.length>0?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_CAPTURES:return n=this.m_bIsPlayingWithRed?StatusEnum.POINT_OWNED_BY_BLUE:StatusEnum.POINT_OWNED_BY_RED,(o=s.filter(function(t){return null!==t.iEnclosingPathId&&t.$GetStatus()===n}).length)>=5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:(n=this.m_bIsPlayingWithRed?StatusEnum.POINT_OWNED_BY_RED:StatusEnum.POINT_OWNED_BY_BLUE,(o=e.filter(function(t){return null!==t.iEnclosingPathId&&t.$GetStatus()===n}).length)>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:WinStatusEnum.NO_WIN);case GameTypeEnum.FIRST_5_PATHS:return i.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS:t.length>=5?this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS:WinStatusEnum.NO_WIN;case GameTypeEnum.FIRST_5_ADVANTAGE_PATHS:{const e=t.length-i.length;if(e>=5)return this.m_bIsPlayingWithRed?WinStatusEnum.RED_WINS:WinStatusEnum.GREEN_WINS;if(e<=-5)return this.m_bIsPlayingWithRed?WinStatusEnum.GREEN_WINS:WinStatusEnum.RED_WINS}return WinStatusEnum.NO_WIN;default:throw new Error("Wrong game type")}}ShowMobileStatus(t=""){"???"===this.m_Player2Name.innerHTML?this.m_bIsPlayerActive?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayerActive?this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_RED:this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_bIsPlayingWithRed?this.m_GameStatus.style.color=this.COLOR_BLUE:this.m_GameStatus.style.color=this.COLOR_RED,null!==t&&""!==t?this.Debug(t,0):this.Debug("",0)}OnMouseMove(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return void(this.iConnErrCount<=0&&!this.m_bIsPlayerActive&&(this.m_Screen.style.cursor="wait"));let i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,e=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;i=parseInt(i/this.m_iGridSizeX),e=parseInt(e/this.m_iGridSizeY);let s=i*this.m_iGridSizeX,n=e*this.m_iGridSizeY;if(this.m_MouseCursorOval.$move(s,n,this.m_PointRadius),this.m_MouseCursorOval.$Show(),this.Debug(`[${i},${e}]`,1),this.m_bDrawLines){if(null!==this.m_Line?this.m_Screen.style.cursor="move":this.m_Screen.style.cursor="crosshair",!0===this.m_bMouseDown&&(this.m_iLastX!==i||this.m_iLastY!==e)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-e))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),o=this.m_Points.get(e*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.$GetLength()>=2?"":"disabled",void 0!==t&&void 0!==o&&t.$GetFillColor()===this.m_sDotColor&&o.$GetFillColor()===this.m_sDotColor){const r=this.m_Line.$ContainsPoint(s,n);if(r<1&&o.$GetStatus()!==StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(s,n,this.m_iGridSizeX))o.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=e;else if(1===r&&o.$GetStatus()===StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(s,n,this.m_iGridSizeX)){const t=this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(t),()=>{this.OnCancelClick(),t.OwnedPoints.forEach(t=>{const i=t.point,e=t.revertFillColor,s=t.revertStrokeColor;i.$RevertOldStatus(),i.$SetFillColor(e),i.$SetStrokeColor(s)}),this.m_bHandlingEvent=!1})):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=i,this.m_iLastY=e}else r>=1&&t.$GetStatus()===StatusEnum.POINT_IN_PATH&&this.m_Line.$GetPointsString().endsWith(`${this.m_iLastX*this.m_iGridSizeX},${this.m_iLastY*this.m_iGridSizeY}`)&&(this.m_Line.$GetLength()>2?(t.$RevertOldStatus(),this.m_Line.$RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=e):this.OnCancelClick())}}else{let t=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),o=this.m_Points.get(e*this.m_iGridWidth+i);if(void 0!==t&&void 0!==o&&t.$GetFillColor()===this.m_sDotColor&&o.$GetFillColor()===this.m_sDotColor){const r=this.m_iLastX*this.m_iGridSizeX,a=this.m_iLastY*this.m_iGridSizeY;this.m_Line=$createPolyline(6,r+","+a+" "+s+","+n,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.$SetStatus(StatusEnum.POINT_STARTING,!0),o.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=e}}}else this.m_Screen.style.cursor="crosshair"}OnMouseDown(t){if(!this.m_bIsPlayerActive||"???"===this.m_Player2Name.innerHTML||!0===this.m_bHandlingEvent||this.iConnErrCount>0)return;let i=(t?t.clientX:window.event.clientX)-this.m_Screen.offsetLeft+this.f_scrollLeft()+.5*this.m_iGridSizeX,e=(t?t.clientY:window.event.clientY)-this.m_Screen.offsetTop+this.f_scrollTop()+.5*this.m_iGridSizeY;if(i=this.m_iMouseX=parseInt(i/this.m_iGridSizeX),e=this.m_iMouseY=parseInt(e/this.m_iGridSizeY),this.m_bMouseDown=!0,this.m_bDrawLines){if((this.m_iLastX!==i||this.m_iLastY!==e)&&Math.abs(parseInt(this.m_iLastX-i))<=1&&Math.abs(parseInt(this.m_iLastY-e))<=1&&this.m_iLastX>=0&&this.m_iLastY>=0)if(null!==this.m_Line){let t=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),s=this.m_Points.get(e*this.m_iGridWidth+i);if(this.m_CancelPath.disabled=this.m_Line.$GetLength()>=2?"":"disabled",void 0!==t&&void 0!==s&&t.$GetFillColor()===this.m_sDotColor&&s.$GetFillColor()===this.m_sDotColor){const n=i*this.m_iGridSizeX,o=e*this.m_iGridSizeY,r=this.m_Line.$ContainsPoint(n,o);if(r<1&&s.$GetStatus()!==StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(n,o,this.m_iGridSizeX))s.$SetStatus(StatusEnum.POINT_IN_PATH,!0),this.m_iLastX=i,this.m_iLastY=e;else if(1===r&&s.$GetStatus()===StatusEnum.POINT_STARTING&&!0===this.m_Line.$AppendPoints(n,o,this.m_iGridSizeX)){const t=this.SurroundOponentPoints();t.owned.length>0?(this.Debug("Closing path",0),this.SendAsyncData(this.CreateXMLPutPathRequest(t),()=>{this.OnCancelClick(),t.OwnedPoints.forEach(t=>{const i=t.point,e=t.revertFillColor,s=t.revertStrokeColor;i.$RevertOldStatus(),i.$SetFillColor(e),i.$SetStrokeColor(s)}),this.m_bMouseDown=!1,this.m_bHandlingEvent=!1})):this.Debug(`${t.errorDesc?t.errorDesc:"Wrong path"}, cancell it or refresh page`,0),this.m_iLastX=i,this.m_iLastY=e}else r>=1&&t.$GetStatus()===StatusEnum.POINT_IN_PATH&&this.m_Line.$GetPointsString().endsWith(`${this.m_iLastX*this.m_iGridSizeX},${this.m_iLastY*this.m_iGridSizeY}`)&&(this.m_Line.$GetLength()>2?(t.$RevertOldStatus(),this.m_Line.$RemoveLastPoint(),this.m_iLastX=i,this.m_iLastY=e):this.OnCancelClick())}}else{let t=this.m_Points.get(this.m_iLastY*this.m_iGridWidth+this.m_iLastX),s=this.m_Points.get(e*this.m_iGridWidth+i);if(void 0!==t&&void 0!==s&&t.$GetFillColor()===this.m_sDotColor&&s.$GetFillColor()===this.m_sDotColor){const n=this.m_iLastX*this.m_iGridSizeX,o=this.m_iLastY*this.m_iGridSizeY,r=i*this.m_iGridSizeX,a=e*this.m_iGridSizeY;this.m_Line=$createPolyline(6,n+","+o+" "+r+","+a,this.DRAWING_PATH_COLOR),this.m_CancelPath.disabled="",t.$SetStatus(StatusEnum.POINT_STARTING,!0),s.$SetStatus(StatusEnum.POINT_IN_PATH,!0)}this.m_iLastX=i,this.m_iLastY=e}else if(this.m_iLastX<0||this.m_iLastY<0){let t=this.m_Points.get(e*this.m_iGridWidth+i);void 0!==t&&t.$GetFillColor()===this.m_sDotColor&&(this.m_iLastX=i,this.m_iLastY=e)}}else{this.m_iLastX=i,this.m_iLastY=e;const t=i,s=e;if(i=t*this.m_iGridSizeX,e=s*this.m_iGridSizeY,void 0!==this.m_Points.get(s*this.m_iGridWidth+t))return void this.Debug("Wrong point - already existing",0);if(!this.IsPointOutsideAllPaths(t,s))return void this.Debug("Wrong point, Point is not outside all paths",0);this.SendAsyncData(this.CreateXMLPutPointRequest(t,s),()=>{this.m_bMouseDown=!1,this.m_bHandlingEvent=!1})}}OnMouseUp(){this.m_bMouseDown=!1}OnMouseLeave(){this.m_MouseCursorOval.$Hide()}OnStopAndDraw(t){if(this.m_Timer)null===this.m_Line&&this.SendAsyncData(new StopAndDrawCommand);else{null!==this.m_Line&&this.OnCancelClick(),this.m_bDrawLines=!this.m_bDrawLines;const i=t.target;this.m_bDrawLines?i.value="Draw dot":i.value="Draw line",this.m_iLastX=this.m_iLastY=-1,this.m_Line=null}}OnCancelClick(){if(this.m_bDrawLines){if(null!==this.m_Line){const t=this.m_Line.$GetPointsArray();this.m_CancelPath.disabled="disabled";for(const i of t){let t=i.x,e=i.y;if(null===t||null===e)continue;t/=this.m_iGridSizeX,e/=this.m_iGridSizeY;const s=this.m_Points.get(e*this.m_iGridWidth+t);void 0!==s&&s.$RevertOldStatus()}$RemovePolyline(this.m_Line),this.m_Line=null}this.m_iLastX=this.m_iLastY=-1,this.m_Timer&&(this.m_StopAndDraw.disabled="disabled"),this.Debug("",0)}}PrepareDrawing(t,i,e,s,n,o,r,a=125){if(this.m_bIsWon=!1,this.m_iDelayBetweenMultiCaptures=4e3,this.m_iTooLong2Duration=a,this.m_Timer=null,this.m_WaitStartTime=null,this.m_iSlowdownLevel=0,this.m_iLastX=-1,this.m_iLastY=-1,this.m_iMouseX=0,this.m_iMouseY=0,this.m_iPosX=0,this.m_iPosY=0,this.m_bMouseDown=!1,this.m_bHandlingEvent=!1,this.m_bDrawLines=!1,this.m_sMessage="",this.m_sDotColor=this.m_bIsPlayingWithRed?this.COLOR_RED:this.COLOR_BLUE,this.m_Line=null,this.m_Lines=[],this.m_Points=new Map,this.m_Debug=document.getElementById("debug0"),this.m_Player2Name=document.querySelector(i),this.m_GameStatus=document.querySelector(e),this.m_SurrenderButton=document.querySelector(s),this.m_CancelPath=document.querySelector(n),this.m_StopAndDraw=document.querySelector(r),this.m_Screen=document.querySelector(t),!this.m_Screen)return void alert("no board");this.m_iPosX=this.m_Screen.offsetLeft,this.m_iPosY=this.m_Screen.offsetTop,this.m_Screen.style.width=`calc(1em * ${this.m_BoardSize.width})`,this.m_Screen.style.height=`calc(1em * ${this.m_BoardSize.height})`;let h=this.m_Screen.clientWidth,l=this.m_Screen.clientHeight;this.m_iGridSizeX=parseInt(Math.ceil(h/this.m_BoardSize.width)),this.m_iGridSizeY=parseInt(Math.ceil(l/this.m_BoardSize.height)),this.m_iGridWidth=parseInt(Math.ceil(h/this.m_iGridSizeX)),this.m_iGridHeight=parseInt(Math.ceil(l/this.m_iGridSizeY)),$createSVGVML(this.m_Screen,this.m_Screen.style.width,this.m_Screen.style.height,!0),this.DisableSelection(this.m_Screen),this.m_bViewOnly?document.querySelector(o).innerHTML="back to Game List":(null===this.m_MouseCursorOval&&(this.m_MouseCursorOval=$createOval(this.m_PointRadius,"true"),this.m_MouseCursorOval.$SetFillColor(this.m_sDotColor),this.m_MouseCursorOval.$SetStrokeColor(this.m_sDotColor),this.m_MouseCursorOval.$SetZIndex(-1),this.m_MouseCursorOval.$Hide()),this.m_Screen.onmousedown=this.OnMouseDown.bind(this),this.m_Screen.onmousemove=this.OnMouseMove.bind(this),this.m_Screen.onmouseup=this.OnMouseUp.bind(this),this.m_Screen.onmouseleave=this.OnMouseLeave.bind(this),this.m_CancelPath.onclick=this.OnCancelClick.bind(this),this.m_StopAndDraw.onclick=this.OnStopAndDraw.bind(this),document.querySelector(this.m_sMsgInputSel).disabled="",this.m_SurrenderButton.disabled="","???"===this.m_Player2Name.innerHTML?(this.ShowMobileStatus("Waiting for other player to connect"),this.m_Screen.style.cursor="wait"):(this.m_SurrenderButton.value="surrender",this.m_bIsPlayerActive?(this.ShowMobileStatus("Your move"),this.m_Screen.style.cursor="crosshair",this.m_StopAndDraw.disabled=""):(this.ShowMobileStatus("Waiting for oponent move"),this.m_Screen.style.cursor="wait"),this.m_bDrawLines?this.m_StopAndDraw.value="Draw dot":this.m_StopAndDraw.value="Draw line"))}}